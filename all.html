---
permalink: /en/all/
root: true
layout: plain
---
<div class="chapter">
      <h1 id="s:en">JavaScript versus Data Science</h1>
      



      
      <p>We were going to call this book <em>JavaScript for Scientists and Engineers</em>,
but <a href="https://www.dabeaz.com/">David Beazley</a> thought that “versus” would make a better title.
While that one-word change sums up how many people view the language,
we hope we can convince you that modern JavaScript is usable as well as useful.
We changed the second half of the title because hey, data science.
We also hope that these lessons will help librarians,
digital humanists,
and everyone else who uses computing in their research,
not just scientists and engineers.</p>

<p>We will cover:</p>

<ul>
  <li>Core features of modern JavaScript</li>
  <li>Programming with callbacks and promises</li>
  <li>Creating objects and classes</li>
  <li>Writing HTML and CSS</li>
  <li>Creating interactive pages with React</li>
  <li>Building data services</li>
  <li>Testing</li>
  <li>Data visualization</li>
  <li>Combining everything to create a three-tier web application</li>
</ul>

<h2 id="s:intro-audience">Intended Audience</h2>

<p>We assume that you:</p>

<ul>
  <li>can write two-page programs that use lists, loops, conditionals, and functions,</li>
  <li>can run commands in the Unix shell to navigate the filesystem and create and delete directories and files, and</li>
  <li>have reliable access to the Internet.</li>
</ul>

<p>Unlike most introductions to JavaScript,
these lessons present an even mix of browser programming and server programming.
We give each topic only shallow coverage;
if you want to know more,
there are many other free tutorials you can dive into once you’ve mastered the basics,
some of which are both up-to-date and well designed.</p>

<h2 id="s:intro-contrib">Contributing</h2>

<p>Contributions of all kinds are welcome,
from errata and minor improvements to entirely new sections and chapters.
Please <a href="mailto:gvwilson@third-bit.com">email us</a>,
<a href="https://github.com/software-tools-in-javascript/js-vs-ds/issues">file an issue</a> in <a href="https://github.com/software-tools-in-javascript/js-vs-ds/">our GitHub repository</a>,
or <a href="https://github.com/software-tools-in-javascript/js-vs-ds/pulls">submit a pull request</a>.
Everyone whose work is incorporated will be acknowledged.
Please see <a href="#s:contributing">the contributors’s guide</a> for more information,
and please note that all contributors are required to abide by
our <a href="#s:conduct">Code of Conduct</a>.</p>


      



    </div>
<div class="chapter">
      <h1 id="s:intro">Introduction</h1>
      


<div class="listblock">
  <h2>Questions</h2>
  <ul>
    <li>Is this the right course for me?
</li><li>How do I set up my computer to do the exercises?
</li>
  </ul>
</div>


      
      <h2 id="s:intro-personas">Who You Are</h2>

<p>Every lesson should aim to <a href="http://teachtogether.tech/en/process/">meet the needs of specific learners</a> [<a href="#b:Wils2018">Wils2018</a>].
The three people described below define the intended audience for this one.</p>

<dl>
  <dt>Bhadra</dt>
  <dd>received a BSc in microbiology five years ago,
and has worked since then for a biotech firm with labs in four countries.
She did a statistics class using R as an undergrad,
then learned some more R and some Unix shell scripting
in a <a href="http://software-carpentry.org/">Software Carpentry</a> workshop,
but has no other training as a programmer.
Bhadra’s team is developing tools
to detect structural similarities between proteins.
They would like to build a browser interface to their tools
so that people can test different algorithms on various data sets.
This book will show Bhadra how to build, test, and deploy that interface.</dd>
  <dt>Efraim</dt>
  <dd>did fieldwork for the Ministry of Natural Resources for thirty-one years.
He learned Visual Basic so that he could write Excel macros,
then mastered C in order to maintain the control software
for some second-hand remote sensing equipment.
Efraim recently retired,
and is now an active member of several citizen science projects.
This book will show him how to create a service
to share those projects’ data with the world,
and how to build a web-based administrative interface for it.</dd>
  <dt>Sumi</dt>
  <dd>is completing a PhD in 19th Century history.
As part of her research,
she is transcribing and cataloging the records of several dozen Japanese-American midwives.
She has been creating and customizing WordPress sites for several years,
and has picked up bits and pieces of JavaScript while doing so.
Sumi is about to start looking for a job,
and wants to create an interactive website to showcase her research.
This book will fill in some of the gaps in her knowledge
and show her how to take advantage of JavaScript’s more modern features.</dd>
</dl>

<h2 id="s:intro-setup">Setting Up</h2>

<p>The exercises at the end of each chapter include new information
that you will need later in the book,
and are therefore not optional.
You can do the first few online,
using a service like <a href="https://runkit.com/">RunKit</a>,
which gives you an interactive JavaScript playground in your browser.
For larger things,
and for chapters starting with the one on <a href="#s:dynamic">creating dynamic web pages</a>,
you should <a href="https://nodejs.org/en/download/">download and install</a> the latest Long-term Support (LTS) versions of Node and NPM.</p>

<p><a href="#g:node-js">Node</a> is an open source implementation of JavaScript
that includes a command-line interpreter like those for languages such as Python and R.
The command <code class="highlighter-rouge">node</code> on its own starts a <a href="#g:repl">read-evaluate-print loop</a>
that executes commands as they are typed in and displays their output.
The command <code class="highlighter-rouge">node filename.js</code> reads and runs the commands in <code class="highlighter-rouge">filename.js</code>;
we will see <a href="#s:pages">later</a> how to run JavaScript in a browser.</p>

<p><code class="highlighter-rouge">npm</code> is the Node <a href="#g:package-manager">Package Manager</a>,
a command-line tool for finding, installing, and updating JavaScript libraries.
The command <code>npm install --global <em>library-name</em></code> (without a <code class="highlighter-rouge">.js</code> extension)
installs a library <a href="#g:global-installation">globally</a> so that all projects can use it,
while <code>npm install --save <em>library-name</em></code> installs the library <a href="#g:local-installation">locally</a>
(i.e., in the current project folder).
Local installation is usually a better idea,
since it isolates projects from one another.</p>

<h2 id="s:intro-contributors">Who We Are</h2>

<p><img src="../../files/hodges-toby.png" alt="Toby Hodges" width="200"></p>

<p><strong><a href="https://tbyhdgs.info/">Toby Hodges</a></strong> is a bioinformatician turned community
coordinator, working on the <a href="https://bio-it.embl.de">Bio-IT Project</a> at
<a href="https://www.embl.de">EMBL</a>. He teaches a lot of courses in computing, organizes
a lot of community-building events, listens to a lot of punk rock, and
occasionally still finds time to write code and ride his bike.  Toby would like
to thank his wife for her support and patience while he swore about how annoying
JavaScript is to debug.</p>

<!-- == \noindent -->
<p><img src="../../files/wilson-greg.png" alt="Greg Wilson" width="200"></p>

<p><strong><a href="http://third-bit.com/">Greg Wilson</a></strong> has worked for 35 years in both industry and
academia, and is the author or editor of several books on computing and two for
children. He co-founded of <a href="http://carpentries.org">Software Carpentry</a>, a non-profit
organization that teaches basic computing skills to researchers, and is now part
of the education team at <a href="http://rstudio.com">RStudio</a>.  Greg would like to
thank everyone at <a href="https://rangle.io/">Rangle</a> who was so patient with him when
he was learning JavaScript.</p>

<h3 id="s:intro-acknowledgments">Acknowledgments</h3>

<p>We are also grateful for fixes from:</p>

<ul>
  <li><a href="https://github.com/sdruskat">Stephan Druskat</a></li>
  <li><a href="https://github.com/pdm55">Peter Munro</a></li>
</ul>

<h2 id="s:intro-exercises">Exercises</h2>

<h3 id="setting-up">Setting Up</h3>

<p>Install Node and NPM on your computer,
then run the commands <code class="highlighter-rouge">node --version</code> and <code class="highlighter-rouge">npm --version</code>
to see which versions you have.</p>


      


<div class="listblock">
  <h2>Key Points</h2>
  <ul>
    <li>Modern JavaScript is a good tool for building desktop and web-based applications.
</li><li>This course is for people who know what loops and functions are, but have never used JavaScript or built web applications.
</li><li>Node is a command-line interpreter for JavaScript, which can be used interactively or to run scripts in files.
</li><li>NPM is the Node Package Manager, which can be used to find, install, and update libraries.
</li>
  </ul>
</div>


    </div>
<div class="chapter">
      <h1 id="s:basics">Basic Features</h1>
      


<div class="listblock">
  <h2>Questions</h2>
  <ul>
    <li>How can I execute short snippets of JavaScript interactively?
</li><li>How can I run small JavaScript programs from the command line?
</li><li>How can I print text in JavaScript?
</li><li>What are JavaScript’s basic data types?
</li><li>How can I find out what type something is?
</li><li>How do I write loops?
</li><li>How do I write conditionals?
</li><li>What counts as true and false?
</li><li>How do I format text?
</li><li>How do I format JavaScript code?
</li><li>How do I store lists of values?
</li><li>How do I store values by name?
</li><li>How do I define functions?
</li><li>How do I divide source code into multiple files?
</li>
  </ul>
</div>


      
      <p>This lesson introduces the core features of JavaScript,
including how to run programs,
the language’s basic data types,
arrays and objects,
loops,
conditionals,
functions,
and modules.
All of these concepts should be familiar if you have programmed before.</p>

<h2 id="s:basics-hello-world">Hello, World</h2>

<p>Use your favorite text editor to put the following line in a file called <code class="highlighter-rouge">hello.js</code>:</p>

<div title="src/basics/hello.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'hello, world'</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">console</code> is a built-in <a href="#g:module">module</a> that provides basic printing services
(among other things).
As in many languages,
we use the <a href="#g:dotted-notation">dotted notation</a> <code class="highlighter-rouge">X.Y</code> to get part <code class="highlighter-rouge">Y</code> of thing <code class="highlighter-rouge">X</code>—in this case,
to get <code class="highlighter-rouge">console</code>’s <code class="highlighter-rouge">log</code> function.
<a href="#g:string">Character strings</a> like <code class="highlighter-rouge">'hello, world'</code> can be written with either single quotes or double quotes,
so long as the quotation marks match,
and semi-colons at the ends of statements are now (mostly) optional.</p>

<p>To run a program,
type <code>node <em>program_name.js</em></code> at the command line.
(We will preface shell commands with <code class="highlighter-rouge">$</code> to make them easier to spot.)</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>node src/basics/hello.js
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hello, world
</code></pre></div></div>

<h2 id="s:basics-data-types">Basic Data Types</h2>

<p>JavaScript has the usual datatypes,
though unlike C, Python, and many other languages,
there is no separate type for integers:
it stores all numbers as 64-bit floating-point values,
which is accurate up to about 15 decimal digits.
We can check this using <code class="highlighter-rouge">typeof</code>,
which is an operator, <em>not</em> a function,
and which returns a string:</p>

<div title="src/basics/types.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">aNumber</span> <span class="o">=</span> <span class="mf">123.45</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'the type of'</span><span class="p">,</span> <span class="nx">aNumber</span><span class="p">,</span> <span class="s1">'is'</span><span class="p">,</span> <span class="k">typeof</span> <span class="nx">aNumber</span><span class="p">)</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>the type of 123.45 is number
</code></pre></div></div>

<div title="src/basics/types.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">anInteger</span> <span class="o">=</span> <span class="mi">123</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'the type of'</span><span class="p">,</span> <span class="nx">anInteger</span><span class="p">,</span> <span class="s1">'is'</span><span class="p">,</span> <span class="k">typeof</span> <span class="nx">anInteger</span><span class="p">)</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>the type of 123 is number
</code></pre></div></div>

<p>We have already met strings,
which may contain any <a href="#g:unicode">Unicode</a> character:</p>

<div title="src/basics/types.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">aString</span> <span class="o">=</span> <span class="s1">'some text'</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'the type of'</span><span class="p">,</span> <span class="nx">aString</span><span class="p">,</span> <span class="s1">'is'</span><span class="p">,</span> <span class="k">typeof</span> <span class="nx">aString</span><span class="p">)</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>the type of some text is string
</code></pre></div></div>

<p>Functions are also a type of data,
a fact whose implications we will explore in <a href="#s:callbacks">the next lesson</a>:</p>

<div title="src/basics/types.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'the type of'</span><span class="p">,</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">,</span> <span class="s1">'is'</span><span class="p">,</span> <span class="k">typeof</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>the type of function () { [native code] } is function
</code></pre></div></div>

<p>Rather than showing the other basic types one by one,
we will put three values in a list and loop over it:</p>

<div title="src/basics/types.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">otherValues</span> <span class="o">=</span> <span class="p">[</span><span class="kc">true</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="kc">null</span><span class="p">]</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">otherValues</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'the type of'</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="s1">'is'</span><span class="p">,</span> <span class="k">typeof</span> <span class="nx">value</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>the type of true is boolean
the type of undefined is undefined
the type of null is object
</code></pre></div></div>

<p>As the example above shows,
we use <code class="highlighter-rouge">let</code> to define a <a href="#g:variable">variable</a>
and <code class="highlighter-rouge">const</code> to define a <a href="#g:constant">constant</a>,
put values separated by commas inside <code class="highlighter-rouge">[]</code> to create an <a href="#g:array">array</a>,
and use <code class="highlighter-rouge">for...of</code> to loop over the values in that array.
Note that we use <code class="highlighter-rouge">let</code> rather than the older <code class="highlighter-rouge">var</code> and <code class="highlighter-rouge">of</code> and not <code class="highlighter-rouge">in</code>:
the latter returns the indexes of the collection (e.g., 0, 1, 2),
which has some <a href="#s:legacy-iteration">traps for the unwary</a>.
Note also that indexing starts from 0 rather than 1,
and that indentation is optional and for readability purposes only.
This may be different from the language that you’re used to.</p>

<p>After all this,
the types themselves are somewhat anticlimactic.
JavaScript’s <code class="highlighter-rouge">boolean</code> type can be either <code class="highlighter-rouge">true</code> and <code class="highlighter-rouge">false</code>,
though we will see below that other things can be treated as Booleans.
<code class="highlighter-rouge">undefined</code> means “hasn’t been given a value”,
while <code class="highlighter-rouge">null</code> means “has a value, which is nothing”.</p>

<h2 id="s:basics-control-flow">Control Flow</h2>

<p>We have already seen <code class="highlighter-rouge">for</code> loops and flat arrays,
so let’s have a look at conditionals and nested arrays:</p>

<div title="src/basics/control-flow.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">values</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="s1">''</span><span class="p">,</span> <span class="s1">'text'</span><span class="p">],</span> <span class="p">[</span><span class="kc">undefined</span><span class="p">,</span> <span class="kc">null</span><span class="p">],</span> <span class="p">[[],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]]</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">pair</span> <span class="k">of</span> <span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">element</span> <span class="k">of</span> <span class="nx">pair</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">'of type'</span><span class="p">,</span> <span class="k">typeof</span> <span class="nx">element</span><span class="p">,</span> <span class="s1">'is truthy'</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">'of type'</span><span class="p">,</span> <span class="k">typeof</span> <span class="nx">element</span><span class="p">,</span> <span class="s1">'is falsy'</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0 of type number is falsy
1 of type number is truthy
 of type string is falsy
text of type string is truthy
undefined of type undefined is falsy
null of type object is falsy
 of type object is truthy
2,3 of type object is truthy
</code></pre></div></div>

<p>This example shows that arrays are <a href="#g:heterogeneous">heterogeneous</a>,
i.e.,
that they can contain values of many different types
(including other arrays).
It also shows that <code class="highlighter-rouge">if</code> and <code class="highlighter-rouge">else</code> work as they do in other languages:
it’s the truthiness of things that may be different.
For numbers,
0 is <a href="#g:falsy">falsy</a>, all others are <a href="#g:truthy">truthy</a>;
Similarly,
the empty string is falsy and all other strings are truthy.
<code class="highlighter-rouge">undefined</code> and <code class="highlighter-rouge">null</code> are both falsy,
as most programmers would expect.</p>

<p>But as the last two lines of output show,
an empty array is truthy,
which is different from its treatment in most programming languages.
The argument made by JavaScript’s advocates is that an empty array is there,
it just happens to be empty,
but this behavior is still a common cause of bugs.
When testing an array,
check that <code class="highlighter-rouge">Array.length</code> is zero.
(Note that this is a <a href="#g:property">property</a>,
not a <a href="#g:method">method</a>,
i.e.,
it should be treated as a variable,
not called like a function.)</p>

<blockquote>
  <p><strong>Safety Tip</strong></p>

  <p>Always use <code class="highlighter-rouge">===</code> (triple equals) and <code class="highlighter-rouge">!==</code> when testing for equality and inequality in JavaScript.
<code class="highlighter-rouge">==</code> and <code class="highlighter-rouge">!=</code> do type conversion,
which can produce some <a href="#s:legacy-equality">ugly surprises</a>.</p>
</blockquote>

<h2 id="s:basics-formatting">Formatting Strings</h2>

<p>Rather than printing multiple strings and expressions,
we can <a href="#g:string-interpolation">interpolate</a> values into a back-quoted string.
(We have to use back quotes because this feature was added to JavaScript
long after the language was first created.)
As the example below shows,
the value to be interpolated is put in <code class="highlighter-rouge">${...}</code>,
and can be any valid JavaScript expression,
including a function or method call.</p>

<div title="src/basics/formatting.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">color</span> <span class="k">of</span> <span class="p">[</span><span class="s1">'red'</span><span class="p">,</span> <span class="s1">'green'</span><span class="p">,</span> <span class="s1">'blue'</span><span class="p">])</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">message</span> <span class="o">=</span> <span class="s2">`color is </span><span class="p">${</span><span class="nx">color</span><span class="p">}</span><span class="s2">`</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="s2">`and capitalized is </span><span class="p">${</span><span class="nx">color</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()}</span><span class="s2">`</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>color is red and capitalized is RED
color is green and capitalized is GREEN
color is blue and capitalized is BLUE
</code></pre></div></div>

<h2 id="s:basics-objects">Objects</h2>

<p>An <a href="#g:object">object</a> in JavaScript is a collection of key-value pairs,
and is equivalent in simple cases to what Python would call a dictionary.
The keys do not have to be strings,
but almost always are;
the values can be anything.
We can create an object by putting key-value pairs in curly brackets
with colons between the keys and values
and commas between the pairs:</p>

<div title="src/basics/objects.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">creature</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'order'</span><span class="p">:</span> <span class="s1">'Primates'</span><span class="p">,</span>
  <span class="s1">'family'</span><span class="p">:</span> <span class="s1">'Callitrichidae'</span><span class="p">,</span>
  <span class="s1">'genus'</span><span class="p">:</span> <span class="s1">'Callithrix'</span><span class="p">,</span>
  <span class="s1">'species'</span><span class="p">:</span> <span class="s1">'Jacchus'</span>
<span class="p">}</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`creature is </span><span class="p">${</span><span class="nx">creature</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`creature.genus is </span><span class="p">${</span><span class="nx">creature</span><span class="p">.</span><span class="nx">genus</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">creature</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`creature[</span><span class="p">${</span><span class="nx">key</span><span class="p">}</span><span class="s2">] is </span><span class="p">${</span><span class="nx">creature</span><span class="p">[</span><span class="nx">key</span><span class="p">]}</span><span class="s2">`</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>creature is [object Object]
creature.genus is Callithrix
creature[order] is Primates
creature[family] is Callitrichidae
creature[genus] is Callithrix
creature[species] is Jacchus
</code></pre></div></div>

<p>The type of an object is always <code class="highlighter-rouge">object</code>.
We can get the value associated with a key using <code class="highlighter-rouge">object[key]</code>,
but if the key has a simple name,
we can use <code class="highlighter-rouge">object.key</code> instead.
Note that the square bracket form can be used with variables for keys,
but the dotted notation cannot:
i.e.,
<code class="highlighter-rouge">creature.genus</code> is the same as <code class="highlighter-rouge">creature['genus']</code>,
but the assignment <code class="highlighter-rouge">g = 'genus'</code> followed by <code class="highlighter-rouge">creature.g</code> does not work.</p>

<p>Because string keys are so common,
and because programmers use simple names so often,
JavaScript allows us to create objects without quoting the names of the keys:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">creature</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">order</span><span class="p">:</span> <span class="s1">'Primates'</span><span class="p">,</span>
  <span class="na">family</span><span class="p">:</span> <span class="s1">'Callitrichidae'</span><span class="p">,</span>
  <span class="na">genus</span><span class="p">:</span> <span class="s1">'Callithrix'</span><span class="p">,</span>
  <span class="na">species</span><span class="p">:</span> <span class="s1">'Jacchus'</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">[object Object]</code> is not particularly useful output when we want to see what an object contains.
To get a ore helpful string representation,
use <code class="highlighter-rouge">JSON.stringify(object)</code>:</p>

<div title="src/basics/objects.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">creature</span><span class="p">))</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{"order":"Primates","family":"Callitrichidae","genus":"Callithrix","species":"Jacchus"}
</code></pre></div></div>

<p>Here,
“JSON” stands for “JavaScript Object Notation”;
we will learn more about it <a href="#s:dataman">later</a>.</p>

<h2 id="s:basics-functions">Functions</h2>

<p>Functions make it possible for mere mortals to understand programs
by allowing us to think about them one piece at a time.
Here is a function that finds the lowest and highest values in an array:</p>

<div title="src/basics/functions-classic.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">limits</span> <span class="p">(</span><span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="kc">undefined</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">]</span>
  <span class="p">}</span>
  <span class="kd">let</span> <span class="nx">low</span> <span class="o">=</span> <span class="nx">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="kd">let</span> <span class="nx">high</span> <span class="o">=</span> <span class="nx">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">v</span> <span class="o">&lt;</span> <span class="nx">low</span><span class="p">)</span> <span class="nx">low</span> <span class="o">=</span> <span class="nx">v</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">v</span> <span class="o">&gt;</span> <span class="nx">high</span><span class="p">)</span> <span class="nx">high</span> <span class="o">=</span> <span class="nx">v</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">[</span><span class="nx">low</span><span class="p">,</span> <span class="nx">high</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Its definition consists of the keyword <code class="highlighter-rouge">function</code>,
its name,
a parameterized list of <a href="#g:parameter">parameters</a> (which might be empty),
and its body.
We can use <code class="highlighter-rouge">return</code> to explicitly return a value at any time;
if nothing is returned,
the function’s result is <code class="highlighter-rouge">undefined</code>.</p>

<p>One oddity of JavaScript is that almost anything can be compared to almost anything else.
Here are a few tests that demonstrate this:</p>

<div title="src/basics/functions-classic.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">allTests</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">[],</span>
  <span class="p">[</span><span class="mi">9</span><span class="p">],</span>
  <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">300</span><span class="p">],</span>
  <span class="p">[</span><span class="s1">'apple'</span><span class="p">,</span> <span class="s1">'Grapefruit'</span><span class="p">,</span> <span class="s1">'banana'</span><span class="p">],</span>
  <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="s1">'apple'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'sub-array'</span><span class="p">]]</span>
<span class="p">]</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">test</span> <span class="k">of</span> <span class="nx">allTests</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`limits of </span><span class="p">${</span><span class="nx">test</span><span class="p">}</span><span class="s2"> are </span><span class="p">${</span><span class="nx">limits</span><span class="p">(</span><span class="nx">test</span><span class="p">)}</span><span class="s2">`</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>limits of  are ,
limits of 9 are 9,9
limits of 3,30,300 are 3,300
limits of apple,Grapefruit,banana are Grapefruit,banana
limits of 3,apple,sub-array are 3,3
</code></pre></div></div>

<p>Programmers generally don’t write functions this way any longer,
since it interacts in odd ways with other features of the language;
the <a href="#s:legacy-prototypes">section on legacy issues</a> explains why and how in more detail.
Instead,
most programmers now write <a href="#g:fat-arrow">fat arrow functions</a>
consisting of a parameter list,
the <code class="highlighter-rouge">=&gt;</code> symbol,
and a body.
Fat arrow functions don’t have names,
so the function must be assigned that to a constant or variable for later use:</p>

<div title="src/basics/functions-modern.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">limits</span> <span class="o">=</span> <span class="p">(</span><span class="nx">values</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="kc">undefined</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">]</span>
  <span class="p">}</span>
  <span class="kd">let</span> <span class="nx">low</span> <span class="o">=</span> <span class="nx">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="kd">let</span> <span class="nx">high</span> <span class="o">=</span> <span class="nx">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">v</span> <span class="o">&lt;</span> <span class="nx">low</span><span class="p">)</span> <span class="nx">low</span> <span class="o">=</span> <span class="nx">v</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">v</span> <span class="o">&gt;</span> <span class="nx">high</span><span class="p">)</span> <span class="nx">high</span> <span class="o">=</span> <span class="nx">v</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">[</span><span class="nx">low</span><span class="p">,</span> <span class="nx">high</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>No matter how functions are defined,
each one is a <a href="#g:scope">scope</a>,
which means its parameters and any variables created inside it are <a href="#g:local-variable">local</a> to the function.
We will discuss scope in more detail <a href="#s:callbacks">later</a>.</p>

<blockquote>
  <p><strong>Stuck in the Past</strong></p>

  <p>Why did JavaScript introduce another syntax
rather than fixing the behavior of those defined with <code class="highlighter-rouge">function</code>?
The twin answers are that changes would break legacy programs that rely on the old behavior,
and that the language’s developers wanted to make it really easy to define little functions.
Here and elsewhere,
we will see how a language’s history and the way it is used shape its evolution.</p>
</blockquote>

<h2 id="s:basics-modules">Modules</h2>

<p>As our programs grow larger,
we will want to put code in multiple files.
The unavoidable bad news is that JavaScript has several module systems:
Node still uses one called CommonJS,
but is converting to the modern standard called ES6,
so what we use on the command line is different from what we use in the browser (for now).</p>

<blockquote>
  <p><strong>Ee Ess</strong></p>

  <p>JavaScript’s official name is ECMAScript,
though only people who use the word “datum” in everyday conversation ever call it that.
Successive versions of the language are therefore known as ES5, ES6, and so on,
except when they’re referred to as (for example) ES2018.</p>
</blockquote>

<p>Since we’re going to build command-line programs before doing anything in the browser,
we will introduce Node’s module system first.
We start by putting this code in a file called <code class="highlighter-rouge">utilities.js</code>:</p>

<div title="src/basics/utilities.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">DEFAULT_BOUND</span> <span class="o">=</span> <span class="mi">3</span>

<span class="kd">const</span> <span class="nx">clip</span> <span class="o">=</span> <span class="p">(</span><span class="nx">values</span><span class="p">,</span> <span class="nx">bound</span> <span class="o">=</span> <span class="nx">DEFAULT_BOUND</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">v</span> <span class="o">&lt;=</span> <span class="nx">bound</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">result</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">clip</span><span class="p">:</span> <span class="nx">clip</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The function definition is straightforward;
as you may have guessed, <code class="highlighter-rouge">bound = DEFAULT_BOUND</code> sets a default value for that parameter
so that <code class="highlighter-rouge">clip</code> can be called with just an array.
You may also have guessed that <code class="highlighter-rouge">Array.push</code> appends a value to the end of an array;
if you didn’t,
well,
now you know.</p>

<p>What’s more important is assigning an object to <code class="highlighter-rouge">module.exports</code>.
Only those things named in this object are visible to the outside world,
so <code class="highlighter-rouge">DEFAULT_BOUND</code> won’t be.
Remember,
keys that are simple names don’t have to be quoted,
so <code class="highlighter-rouge">clip: clip</code> means “associate a reference to the function <code class="highlighter-rouge">clip</code> with the string key <code class="highlighter-rouge">"clip"</code>.</p>

<p>To use our newly-defined module we must <code class="highlighter-rouge">require</code> it.
For example,
we can put this in <code class="highlighter-rouge">import.js</code>:</p>

<div title="src/basics/import.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">utilities</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./utilities'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`clip(</span><span class="p">${</span><span class="nx">data</span><span class="p">}</span><span class="s2">) -&gt; </span><span class="p">${</span><span class="nx">utilities</span><span class="p">.</span><span class="nx">clip</span><span class="p">(</span><span class="nx">data</span><span class="p">)}</span><span class="s2">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`clip(</span><span class="p">${</span><span class="nx">data</span><span class="p">}</span><span class="s2">, 5) -&gt; </span><span class="p">${</span><span class="nx">utilities</span><span class="p">.</span><span class="nx">clip</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="mi">5</span><span class="p">)}</span><span class="s2">`</span><span class="p">)</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>clip(-1,5,3,0,10) -&gt; 0,1,2,3
clip(-1,5,3,0,10, 5) -&gt; 0,1,2,3,4
</code></pre></div></div>

<p><code class="highlighter-rouge">require</code> returns the object that was assigned to <code class="highlighter-rouge">module.exports</code>,
so if we have assigned its result to a variable called <code class="highlighter-rouge">utilities</code>,
we must then call our function as <code class="highlighter-rouge">utilities.clip</code>.
We use a relative path starting with <code class="highlighter-rouge">./</code> or <code class="highlighter-rouge">../</code> to import local files;
paths that start with names are taken from installed Node libraries.</p>

<h2 id="s:basics-exercises">Exercises</h2>

<h3 id="typeof">Typeof</h3>

<p>What kind of thing is <code class="highlighter-rouge">typeof</code>?
Is it an expression?
A function?
Something else?
(You might notice that <code class="highlighter-rouge">typeof typeof</code> is syntactically invalid.
In such circumstances,
an internet search engine is your friend,
as is the Mozilla Developer Network (MDN) JavaScript reference
at <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference</a>.</p>

<h3 id="fill-in-the-blanks">Fill in the Blanks</h3>

<p>Answer these questions about the program below:</p>

<ol>
  <li>What does <code class="highlighter-rouge">Array.push</code> do?</li>
  <li>How does a <code class="highlighter-rouge">while</code> loop work?</li>
  <li>What does <code class="highlighter-rouge">+=</code> do?</li>
  <li>What does <code class="highlighter-rouge">Array.reverse</code> do, and what does it return?</li>
</ol>

<div title="src/basics/table-of-squares.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">current</span> <span class="o">=</span> <span class="mi">0</span>
<span class="kd">let</span> <span class="nx">table</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">while</span> <span class="p">(</span><span class="nx">current</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">entry</span> <span class="o">=</span> <span class="s2">`square of </span><span class="p">${</span><span class="nx">current</span><span class="p">}</span><span class="s2"> is </span><span class="p">${</span><span class="nx">current</span> <span class="o">*</span> <span class="nx">current</span><span class="p">}</span><span class="s2">`</span>
  <span class="nx">table</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">entry</span><span class="p">)</span>
  <span class="nx">current</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="p">}</span>
<span class="nx">table</span><span class="p">.</span><span class="nx">reverse</span><span class="p">()</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">line</span> <span class="k">of</span> <span class="nx">table</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>square of 4 is 16
square of 3 is 9
square of 2 is 4
square of 1 is 1
square of 0 is 0
</code></pre></div></div>

<h3 id="what-is-truth">What Is Truth?</h3>

<p>Write a function called <code class="highlighter-rouge">isTruthy</code> that returns <code class="highlighter-rouge">true</code> for everything that JavaScript considers truthy,
and <code class="highlighter-rouge">false</code> for everything it considers <code class="highlighter-rouge">falsy</code> <em>except</em> empty arrays:
<code class="highlighter-rouge">isTruthy</code> should return <code class="highlighter-rouge">false</code> for those.</p>

<h3 id="combining-different-types">Combining Different Types</h3>

<p>What output would you expect from the code below?
Try running it and see whether the results match your expectations.
What are the implications of this behavior when working with real-world data?</p>

<div title="src/basics/aggregating.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">first</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`aggregating </span><span class="p">${</span><span class="nx">first</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
<span class="kd">let</span> <span class="nx">total</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">d</span> <span class="k">of</span> <span class="nx">first</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">total</span> <span class="o">+=</span> <span class="nx">d</span>
<span class="p">}</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">total</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">second</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">NaN</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`aggregating </span><span class="p">${</span><span class="nx">second</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
<span class="nx">total</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">d</span> <span class="k">of</span> <span class="nx">second</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">total</span> <span class="o">+=</span> <span class="nx">d</span>
<span class="p">}</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">total</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="what-does-this-do">What Does This Do?</h3>

<p>Explain what is happening in the assignment statement that creates the constant <code class="highlighter-rouge">creature</code>.</p>

<div title="src/basics/implied.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">genus</span> <span class="o">=</span> <span class="s1">'Callithrix'</span>
<span class="kd">const</span> <span class="nx">species</span> <span class="o">=</span> <span class="s1">'Jacchus'</span>
<span class="kd">const</span> <span class="nx">creature</span> <span class="o">=</span> <span class="p">{</span><span class="nx">genus</span><span class="p">,</span> <span class="nx">species</span><span class="p">}</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">creature</span><span class="p">)</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{ genus: 'Callithrix', species: 'Jacchus' }
</code></pre></div></div>

<h3 id="what-does-this-code-do">What Does This Code Do?</h3>

<p>Explain what is happening in the assignment statement in this program.
Use this technique to rewrite <code class="highlighter-rouge">src/basics/import.js</code>
so that <code class="highlighter-rouge">clip</code> can be called directly as <code class="highlighter-rouge">clip(...)</code> rather than <code class="highlighter-rouge">utilities.clip(...)</code>.</p>

<div title="src/basics/destructuring.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">creature</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">genus</span><span class="p">:</span> <span class="s1">'Callithrix'</span><span class="p">,</span>
  <span class="na">species</span><span class="p">:</span> <span class="s1">'Jacchus'</span>
<span class="p">}</span>
<span class="kd">const</span> <span class="p">{</span><span class="nx">genus</span><span class="p">,</span> <span class="nx">species</span><span class="p">}</span> <span class="o">=</span> <span class="nx">creature</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`genus is </span><span class="p">${</span><span class="nx">genus</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`species is </span><span class="p">${</span><span class="nx">species</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="return-to-me-for-my-heart-wants-you-only">Return To Me, For My Heart Wants You Only</h3>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">verbose_sum</span> <span class="o">=</span> <span class="p">(</span><span class="nx">first</span><span class="p">,</span> <span class="nx">second</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Going to add </span><span class="p">${</span><span class="nx">first</span><span class="p">}</span><span class="s2"> to </span><span class="p">${</span><span class="nx">second</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
  <span class="kd">let</span> <span class="nx">total</span> <span class="o">=</span> <span class="nx">first</span> <span class="o">+</span> <span class="nx">second</span>
  <span class="k">return</span> <span class="nx">total</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Finished summing`</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">verbose_sum</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
</code></pre></div></div>

<p>What output would you see in the console if you ran the code above?</p>

<ol>
  <li><code class="highlighter-rouge">Going to add ${first} to ${second}</code> <br> <code class="highlighter-rouge">9</code></li>
  <li><code class="highlighter-rouge">Going to add 3 to 6</code> <br> <code class="highlighter-rouge">9</code> <br> <code class="highlighter-rouge">Finished summing</code></li>
  <li><code class="highlighter-rouge">Going to add 3 to 6</code> <br> <code class="highlighter-rouge">9</code></li>
  <li><code class="highlighter-rouge">Going to add 3 to 6</code> <br> <code class="highlighter-rouge">36</code></li>
</ol>


      


<div class="listblock">
  <h2>Key Points</h2>
  <ul>
    <li>Use <code class="highlighter-rouge">console.log</code> to print messages.
</li><li>Use dotted notation <code class="highlighter-rouge">X.Y</code> to get part <code class="highlighter-rouge">Y</code> of object <code class="highlighter-rouge">X</code>.
</li><li>Basic data types are Booleans, numbers, and character strings.
</li><li>Arrays store multiple values in order.
</li><li>The special values <code class="highlighter-rouge">null</code> and <code class="highlighter-rouge">undefined</code> mean ‘no value’ and ‘does not exist’.
</li><li>Define constants with <code class="highlighter-rouge">const</code> and variables with <code class="highlighter-rouge">let</code>.
</li><li><code class="highlighter-rouge">typeof</code> returns the type of a value.
</li><li><code class="highlighter-rouge">for (let variable of collection) {...}</code> iterates through the values in an array.
</li><li><code class="highlighter-rouge">if (condition) {...} else {...}</code> conditionally executes some code.
</li><li><code class="highlighter-rouge">false</code>, 0, the empty string, <code class="highlighter-rouge">null</code>, and <code class="highlighter-rouge">undefined</code> are false; everything else is true.
</li><li>Use back quotes and <code class="highlighter-rouge">${...}</code> to interpolate values into strings.
</li><li>An object is a collection of name/value pairs written in `{…}.
</li><li><code class="highlighter-rouge">object[key]</code> or <code class="highlighter-rouge">object.key</code> gets a value from an object.
</li><li>Functions are objects that can be assigned to variables, stored in lists, etc.
</li><li><code class="highlighter-rouge">function (...parameters...) {...body...}</code> is the old way to define a function.
</li><li><code class="highlighter-rouge">name = (...parameters...) =&gt; {...body...}</code> is the new way to define a function.
</li><li>Use <code class="highlighter-rouge">return</code> inside a function body to return a value at any point.
</li><li>Use modules to divide code between multiple files for re-use.
</li><li>Assign to <code class="highlighter-rouge">module.exports</code> to specify what a module exports.
</li><li><code class="highlighter-rouge">require(...path...)</code> imports a module.
</li><li>Paths beginning with ‘.’ or ‘/’ are imported locally, but paths without ‘.’ or ‘/’ look in the library.
</li>
  </ul>
</div>


    </div>
<div class="chapter">
      <h1 id="s:callbacks">Callbacks</h1>
      


<div class="listblock">
  <h2>Questions</h2>
  <ul>
    <li>What happens when a function is defined?
</li><li>How can I pass a function to another function?
</li><li>Why would I want to do that?
</li><li>What are higher-order functions?
</li><li>What higher-order functions do JavaScript arrays provide?
</li><li>What is a closure?
</li><li>When and why are closures useful?
</li>
  </ul>
</div>


      
      <p>JavaScript relies heavily on <a href="#g:callback-function">callback functions</a>:
Instead of a function giving us a result immediately,
we give it another function that tells it what to do next.
Many other languages use them as well,
but JavaScript is often the first place that programmers with data science backgrounds encounter them.
In order to understand how they work and how to use them,
we must first understand what actually happens when functions are defined and called.</p>

<h2 id="s:callbacks-callstack">The Call Stack</h2>

<p>When JavaScript <a href="#g:parse">parses</a> the expression <code class="highlighter-rouge">let name = "text"</code>,
it allocates a block of memory big enough for four characters
and stores a reference to that block of characters in the variable <code class="highlighter-rouge">name</code>.
We can show this by drawing a <a href="#g:memory-diagram">memory diagram</a>:</p>

<figure id="f:callbacks-name-value"> <img src="../../files/callbacks-name-value.svg"> <figcaption>Name and Value</figcaption> </figure>

<p>When we write:</p>

<div title="src/callbacks/one-more.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">oneMore</span> <span class="o">=</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">x</span> <span class="o">+</span> <span class="mi">1</span>
<span class="p">}</span>
</code></pre></div></div>

<p>JavaScript allocates a block of memory big enough to store several instructions,
translates the text of the function into instructions,
and stores a reference to those instructions in the variable <code class="highlighter-rouge">oneMore</code>:</p>

<figure id="f:callbacks-one-more"> <img src="../../files/callbacks-one-more.svg"> <figcaption>Functions in Memory</figcaption> </figure>

<p>The only difference between these two cases is what’s on the other end of the reference:
four characters or a bunch of instructions that add one to a number.
This means that we can assign the function to another variable,
just as we would assign a number:</p>

<div title="src/callbacks/one-more.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">anotherName</span> <span class="o">=</span> <span class="nx">oneMore</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">anotherName</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>6
</code></pre></div></div>

<p>Doing this does <em>not</em> call the function:
as the memory diagram below shows,
it creates a second name that refers to the same block of instructions.</p>

<figure id="f:callbacks-alias-function"> <img src="../../files/callbacks-alias-function.svg"> <figcaption>Aliasing a Function</figcaption> </figure>

<p>As explained in <a href="#s:basics">the previous lesson</a>,
when JavaScript calls a function it assigns the arguments in the call to the function’s parameters.
In order for this to be safe,
we need to ensure that there are no <a href="#g:name-collision">name collisions</a>,
i.e.,
that if there is a variable called <code class="highlighter-rouge">something</code> and one of the function’s parameters is also called <code class="highlighter-rouge">something</code>,
the function will use the right one.
The way every modern language implements this is to use a <a href="#g:call-stack">call stack</a>.
Instead of putting all our variables in one big table,
we have one table for global variables
and one extra table for each function call.
This means that if we assign 100 to <code class="highlighter-rouge">x</code>,
call <code class="highlighter-rouge">oneMore(2 * x + 1)</code>,
and look at memory in the middle of that call,
we will find this:</p>

<figure id="f:callbacks-call-stack"> <img src="../../files/callbacks-call-stack.svg"> <figcaption>The Call Stack</figcaption> </figure>

<h2 id="s:callbacks-func">Functions of Functions</h2>

<p>The call stack allows us to write and call functions
without worrying about whether we’re accidentally going to refer to the wrong variable.
And since functions are just another kind of data,
we can pass one function into another.
For example,
we can write a function called <code class="highlighter-rouge">doTwice</code> that calls some other function two times:</p>

<div title="src/callbacks/do-twice.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">doTwice</span> <span class="o">=</span> <span class="p">(</span><span class="nx">action</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">action</span><span class="p">()</span>
  <span class="nx">action</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">hello</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">doTwice</span><span class="p">(</span><span class="nx">hello</span><span class="p">)</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hello
hello
</code></pre></div></div>

<p>Again,
this is clearer when we look at the state of memory while <code class="highlighter-rouge">doTwice</code> is running:</p>

<figure id="f:callbacks-do-twice"> <img src="../../files/callbacks-do-twice.svg"> <figcaption>Functions of Functions</figcaption> </figure>

<p>This becomes more useful when the function or functions passed in have parameters of their own.
For example,
the function <code class="highlighter-rouge">pipeline</code> passes a value to one function,
then takes that function’s result and passes it to a second,
and returns the final result:</p>

<div title="src/callbacks/two-functions.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">pipeline</span> <span class="o">=</span> <span class="p">(</span><span class="nx">initial</span><span class="p">,</span> <span class="nx">first</span><span class="p">,</span> <span class="nx">second</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">temp</span> <span class="o">=</span> <span class="nx">first</span><span class="p">(</span><span class="nx">initial</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">second</span><span class="p">(</span><span class="nx">temp</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Let’s use this to combine
a function that trims blanks off the starts and ends of strings
and another function that replaces spaces with dots:</p>

<div title="src/callbacks/two-functions.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">trim</span> <span class="o">=</span> <span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">text</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="p">}</span>
<span class="kd">const</span> <span class="nx">dot</span> <span class="o">=</span> <span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/ /g</span><span class="p">,</span> <span class="s1">'.'</span><span class="p">)</span> <span class="p">}</span>

<span class="kd">const</span> <span class="nx">original</span> <span class="o">=</span> <span class="s1">'  this example uses text  '</span>

<span class="kd">const</span> <span class="nx">trimThenDot</span> <span class="o">=</span> <span class="nx">pipeline</span><span class="p">(</span><span class="nx">original</span><span class="p">,</span> <span class="nx">trim</span><span class="p">,</span> <span class="nx">dot</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`trim then dot: |</span><span class="p">${</span><span class="nx">trimThenDot</span><span class="p">}</span><span class="s2">|`</span><span class="p">)</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>trim then dot: |this.example.uses.text|
</code></pre></div></div>

<p>During the call to <code class="highlighter-rouge">temp = first(initial)</code>,
but before a value has been returned to be assigned to <code class="highlighter-rouge">temp</code>,
memory looks like this:</p>

<figure id="f:callbacks-pipeline"> <img src="../../files/callbacks-pipeline.svg"> <figcaption>Implementing a Pipeline</figcaption> </figure>

<p>Reversing the order of the functions changes the result:</p>

<div title="src/callbacks/two-functions.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">dotThenTrim</span> <span class="o">=</span> <span class="nx">pipeline</span><span class="p">(</span><span class="nx">original</span><span class="p">,</span> <span class="nx">dot</span><span class="p">,</span> <span class="nx">trim</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`dot then trim: |</span><span class="p">${</span><span class="nx">dotThenTrim</span><span class="p">}</span><span class="s2">|`</span><span class="p">)</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dot then trim: |..this.example.uses.text..|
</code></pre></div></div>

<p>We can make a more general pipeline by passing an array of functions:</p>

<div title="src/callbacks/general-pipeline.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">pipeline</span> <span class="o">=</span> <span class="p">(</span><span class="nx">initial</span><span class="p">,</span> <span class="nx">operations</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">current</span> <span class="o">=</span> <span class="nx">initial</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">op</span> <span class="k">of</span> <span class="nx">operations</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">current</span> <span class="o">=</span> <span class="nx">op</span><span class="p">(</span><span class="nx">current</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">current</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Let’s add a function <code class="highlighter-rouge">double</code> to our suite of text manglers:</p>

<div title="src/callbacks/general-pipeline.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="kr">double</span> <span class="o">=</span> <span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">text</span> <span class="o">+</span> <span class="nx">text</span> <span class="p">}</span>
</code></pre></div></div>

<p>and then try it out:</p>

<div title="src/callbacks/general-pipeline.js" class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const original = ' some text '
const final = pipeline(original, [double, trim, dot])
console.log(`|${original}| -&gt; |${final}|`)
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| some text | -&gt; |some.text..some.text|
</code></pre></div></div>

<h2 id="s:callbacks-anonymous">Anonymous Functions</h2>

<p>Remember the function <code class="highlighter-rouge">oneMore</code>?
We can pass it a value that we have calculated on the fly:</p>

<div title="src/callbacks/on-the-fly.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">oneMore</span> <span class="o">=</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">x</span> <span class="o">+</span> <span class="mi">1</span>
<span class="p">}</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">oneMore</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>7
</code></pre></div></div>

<p>Behind the scenes,
JavaScript allocates a nameless temporary variable to hold the value of <code class="highlighter-rouge">3 * 2</code>,
then passes a reference to that temporary variable into <code class="highlighter-rouge">oneMore</code>.
We can do the same thing with functions,
i.e., create one on the fly without giving it a name as we’re passing it into some other function.
For example,
suppose that instead of pushing one value through a pipeline of functions,
we want to call a function once for each value in an array:</p>

<div title="src/callbacks/transform.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">transform</span> <span class="o">=</span> <span class="p">(</span><span class="nx">values</span><span class="p">,</span> <span class="nx">operation</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">operation</span><span class="p">(</span><span class="nx">v</span><span class="p">))</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">result</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">]</span>
<span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">transform</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">oneMore</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[ 11, 21, 31 ]
</code></pre></div></div>

<p>Adding one to a number is such a simple thing to do that it’s hardly worth giving the function a name,
so let’s define it on the fly:</p>

<div title="src/callbacks/transform.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">result</span> <span class="o">=</span> <span class="nx">transform</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="k">return</span> <span class="nx">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
</code></pre></div></div>
<pre><code class="language-test">[ 11, 21, 31 ]
</code></pre>

<p>A function that is created this way is sometimes called an <a href="#g:anonymous-function">anonymous function</a>,
since its creator doesn’t give it a name.
When JavaScript programmers use the term “callback function”,
they usually mean a function defined and used like this.</p>

<h2 id="s:callbacks-functional">Functional Programming</h2>

<p><a href="#g:functional-programming">Functional programming</a> is a style of programming
that relies heavily on <a href="#g:higher-order-function">higher-order functions</a> like <code class="highlighter-rouge">pipeline</code>
that take other functions as parameters.
In addition,
functional programming expects that functions won’t modify data in place,
but will instead create new data from old.
For example,
a true believer in functional programming would be saddened by this:</p>

<div title="src/callbacks/impure.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">impure</span> <span class="o">=</span> <span class="p">(</span><span class="nx">values</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">values</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<!-- == \noindent -->
<p>and would politely, even patiently, suggest that it be rewritten like this:</p>

<div title="src/callbacks/pure.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">pure</span> <span class="o">=</span> <span class="p">(</span><span class="nx">values</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span>
  <span class="nx">result</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">v</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">result</span>
<span class="p">}</span>
</code></pre></div></div>

<p>JavaScript arrays provide several methods to support functional programming.
For example,
<code class="highlighter-rouge">Array.some</code> returns <code class="highlighter-rouge">true</code> if <em>any</em> element in an array passes a test,
while <code class="highlighter-rouge">Array.every</code> returns <code class="highlighter-rouge">true</code> if <em>all</em> elements in an array pass a test.</p>

<p>Here’s how they work:</p>

<div title="src/callbacks/some-every.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'this'</span><span class="p">,</span> <span class="s1">'is'</span><span class="p">,</span> <span class="s1">'a'</span><span class="p">,</span> <span class="s1">'test'</span><span class="p">]</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'some longer than 3:'</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">some</span><span class="p">((</span><span class="nx">x</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">x</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="p">}))</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'all longer than 3:'</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">every</span><span class="p">((</span><span class="nx">x</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">x</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="p">}))</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>some longer than 3: true
all longer than 3: false
</code></pre></div></div>

<p><code class="highlighter-rouge">Array.filter</code> creates a new array containing only values that pass a test:</p>

<div title="src/callbacks/filter.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'this'</span><span class="p">,</span> <span class="s1">'is'</span><span class="p">,</span> <span class="s1">'a'</span><span class="p">,</span> <span class="s1">'test'</span><span class="p">]</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'those longer than 3:'</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">filter</span><span class="p">((</span><span class="nx">x</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">x</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="p">}))</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>those longer than 3: [ 'this', 'test' ]
</code></pre></div></div>

<p>So do all of the elements with more than 3 characters start with a ‘t’?</p>

<div title="src/callbacks/filter-every.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'this'</span><span class="p">,</span> <span class="s1">'is'</span><span class="p">,</span> <span class="s1">'a'</span><span class="p">,</span> <span class="s1">'test'</span><span class="p">]</span>
<span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">data</span>
               <span class="p">.</span><span class="nx">filter</span><span class="p">((</span><span class="nx">x</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">x</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="p">})</span>
               <span class="p">.</span><span class="nx">every</span><span class="p">((</span><span class="nx">x</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">'t'</span> <span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`all longer than 3 start with t: </span><span class="p">${</span><span class="nx">result</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>all longer than 3 start with t: true
</code></pre></div></div>

<p><code class="highlighter-rouge">Array.map</code> creates a new array by calling a function for each element of an existing array:</p>

<div title="src/callbacks/map.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'this'</span><span class="p">,</span> <span class="s1">'is'</span><span class="p">,</span> <span class="s1">'a'</span><span class="p">,</span> <span class="s1">'test'</span><span class="p">]</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'shortened'</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">x</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">x</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="p">}))</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>shortened [ 'th', 'is', 'a', 'te' ]
</code></pre></div></div>

<p>And finally,
<code class="highlighter-rouge">Array.reduce</code> reduces an array to a single value
using a combining function and a starting value.
The combining function must take two values,
which are the current running total and the next value from the array;
if the array is empty,
<code class="highlighter-rouge">Array.reduce</code> returns the starting value.</p>

<div title="src/callbacks/reduce.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'this'</span><span class="p">,</span> <span class="s1">'is'</span><span class="p">,</span> <span class="s1">'a'</span><span class="p">,</span> <span class="s1">'test'</span><span class="p">]</span>

<span class="kd">const</span> <span class="nx">concatFirst</span> <span class="o">=</span> <span class="p">(</span><span class="nx">accumulator</span><span class="p">,</span> <span class="nx">nextValue</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">accumulator</span> <span class="o">+</span> <span class="nx">nextValue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">}</span>
<span class="kd">let</span> <span class="nx">acronym</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">concatFirst</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`acronym of </span><span class="p">${</span><span class="nx">data</span><span class="p">}</span><span class="s2"> is </span><span class="p">${</span><span class="nx">acronym</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>

<span class="c1">// In one step.</span>
<span class="nx">acronym</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">accum</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">accum</span> <span class="o">+</span> <span class="nx">next</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">},</span> <span class="s1">''</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'all in one step:'</span><span class="p">,</span> <span class="nx">acronym</span><span class="p">)</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>acronym of this,is,a,test is tiat
all in one step: tiat
</code></pre></div></div>

<p>The indentation of the “in one step” call may look a little odd,
but this is the style the JavaScript community has settled on.</p>

<h2 id="s:callbacks-closures">Closures</h2>

<p>The last tool we need to introduce is an extremely useful side-effect of the way memory is handled
called a <a href="#g:closure">closure</a>.
The easiest way to explain it is by example.
We have already defined a function called <code class="highlighter-rouge">pipeline</code> that chains any number of other functions together:</p>

<div title="src/callbacks/general-pipeline.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">pipeline</span> <span class="o">=</span> <span class="p">(</span><span class="nx">initial</span><span class="p">,</span> <span class="nx">operations</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">current</span> <span class="o">=</span> <span class="nx">initial</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">op</span> <span class="k">of</span> <span class="nx">operations</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">current</span> <span class="o">=</span> <span class="nx">op</span><span class="p">(</span><span class="nx">current</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">current</span>
<span class="p">}</span>
</code></pre></div></div>

<p>However,
<code class="highlighter-rouge">pipeline</code> only works if each function in the array <code class="highlighter-rouge">operations</code> has a single parameter.
If we want to be able to add 1,
add 2,
and so on,
we have to write separate functions,
which is annoying.</p>

<p>A better option is to write a function that creates the function we want:</p>

<div title="src/callbacks/adder.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">adder</span> <span class="o">=</span> <span class="p">(</span><span class="nx">increment</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">f</span> <span class="o">=</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">value</span> <span class="o">+</span> <span class="nx">increment</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">f</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">add_1</span> <span class="o">=</span> <span class="nx">adder</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">add_2</span> <span class="o">=</span> <span class="nx">adder</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`add_1(100) is </span><span class="p">${</span><span class="nx">add_1</span><span class="p">(</span><span class="mi">100</span><span class="p">)}</span><span class="s2"> and add_2(100) is </span><span class="p">${</span><span class="nx">add_2</span><span class="p">(</span><span class="mi">100</span><span class="p">)}</span><span class="s2">`</span><span class="p">)</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>add_1(100) is 101 and add_2(100) is 102
</code></pre></div></div>

<p>The best way to understand what’s going on is to draw a step-by-step memory diagram.
In step 1, we call <code class="highlighter-rouge">adder(1)</code>:</p>

<figure id="f:callbacks-adder-1"> <img src="../../files/callbacks-adder-1.svg"> <figcaption>Creating an Adder (Step 1)</figcaption> </figure>

<p><code class="highlighter-rouge">adder</code> creates a new function that includes a reference to that 1 we just passed in:</p>

<figure id="f:callbacks-adder-2"> <img src="../../files/callbacks-adder-2.svg"> <figcaption>Creating an Adder (Step 2)</figcaption> </figure>

<p>In step 3,
<code class="highlighter-rouge">adder</code> returns that function, which is assigned to <code class="highlighter-rouge">add_1</code>:</p>

<figure id="f:callbacks-adder-3"> <img src="../../files/callbacks-adder-3.svg"> <figcaption>Creating an Adder (Step 3)</figcaption> </figure>

<p>Crucially,
the function that <code class="highlighter-rouge">add_1</code> refers to still has a reference to the value 1,
even though that value isn’t referred to any longer by anyone else.</p>

<p>In steps 4-6,
we repeat these three steps to create another function that has a reference to the value 2,
and assign that function to <code class="highlighter-rouge">add_2</code>:</p>

<figure id="f:callbacks-adder-4"> <img src="../../files/callbacks-adder-4.svg"> <figcaption>Creating an Adder (Steps 4-6)</figcaption> </figure>

<p>When we now call <code class="highlighter-rouge">add_1</code> or <code class="highlighter-rouge">add_2</code>,
they add the value passed in and the value they’ve kept a reference to.</p>

<p>This trick of capturing a reference to a value inside something else
is called a <a href="#g:closure">closure</a>.
It works because JavaScript holds on to values as long as anything,
anywhere,
still refers to them.
Closures solve our pipeline problem by letting us define little functions
on the fly
and give them extra data to work with:</p>

<div title="src/callbacks/closure.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">pipeline</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="p">[</span><span class="nx">adder</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nx">adder</span><span class="p">(</span><span class="mi">2</span><span class="p">)])</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`adding 1 and 2 to 100 -&gt; </span><span class="p">${</span><span class="nx">result</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>adding 1 and 2 to 100 -&gt; 103
</code></pre></div></div>

<p>Again, <code class="highlighter-rouge">adder(1)</code> and <code class="highlighter-rouge">adder(2)</code> do not add anything to anything:
they define new (unnamed) functions that add 1 and 2 respectively when called.</p>

<p>Programmers often go one step further and define little functions like this inline:</p>

<div title="src/callbacks/closure-inline.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">pipeline</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="p">[(</span><span class="nx">x</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">x</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`adding 1 and 2 to 100 -&gt; </span><span class="p">${</span><span class="nx">result</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>adding 1 and 2 to 100 -&gt; 103
</code></pre></div></div>

<p>As this example shows,
if the body of a function is a single expression,
it doesn’t have to be enclosed in <code class="highlighter-rouge">{...}</code> and <code class="highlighter-rouge">return</code> doesn’t need to be used.</p>

<h2 id="s:callbacks-exercises">Exercises</h2>

<h3 id="side-effects-with-foreach">Side Effects With <code class="highlighter-rouge">forEach</code></h3>

<p>JavaScript arrays have a method called <code class="highlighter-rouge">forEach</code>,
which calls a callback function once for each element of the array.
Unlike <code class="highlighter-rouge">map</code>,
<code class="highlighter-rouge">forEach</code> does <em>not</em> save the values returned by these calls
or return an array of results.
The full syntax is:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">someArray</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">value</span><span class="p">,</span> <span class="nx">location</span><span class="p">,</span> <span class="nx">container</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// 'value' is the value in 'someArray'</span>
  <span class="c1">// 'location' is the index of that value</span>
  <span class="c1">// 'container' is the containing array (in this case, 'someArray')</span>
<span class="p">})</span>
</code></pre></div></div>

<p>If you only need the value,
you can provide a callback that only takes one parameter;
if you only need the value and its location,
you can provide a callback that takes two.</p>

<p>Use this to write a function <code class="highlighter-rouge">doubleInPlace</code>
that doubles all the values in an array in place:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">vals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="nx">doubleInPlace</span><span class="p">(</span><span class="nx">vals</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`vals after change: </span><span class="p">${</span><span class="nx">vals</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vals after change: 2,4,6
</code></pre></div></div>

<h3 id="annotating-data">Annotating Data</h3>

<p>Given an array of objects representing observations of wild animals:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">data</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span><span class="s1">'date'</span><span class="p">:</span> <span class="s1">'1977-7-16'</span><span class="p">,</span> <span class="s1">'sex'</span><span class="p">:</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'species'</span><span class="p">:</span> <span class="s1">'NL'</span><span class="p">},</span>
  <span class="p">{</span><span class="s1">'date'</span><span class="p">:</span> <span class="s1">'1977-7-16'</span><span class="p">,</span> <span class="s1">'sex'</span><span class="p">:</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'species'</span><span class="p">:</span> <span class="s1">'NL'</span><span class="p">},</span>
  <span class="p">{</span><span class="s1">'date'</span><span class="p">:</span> <span class="s1">'1977-7-16'</span><span class="p">,</span> <span class="s1">'sex'</span><span class="p">:</span> <span class="s1">'F'</span><span class="p">,</span> <span class="s1">'species'</span><span class="p">:</span> <span class="s1">'DM'</span><span class="p">},</span>
  <span class="p">{</span><span class="s1">'date'</span><span class="p">:</span> <span class="s1">'1977-7-16'</span><span class="p">,</span> <span class="s1">'sex'</span><span class="p">:</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'species'</span><span class="p">:</span> <span class="s1">'DM'</span><span class="p">},</span>
  <span class="p">{</span><span class="s1">'date'</span><span class="p">:</span> <span class="s1">'1977-7-16'</span><span class="p">,</span> <span class="s1">'sex'</span><span class="p">:</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'species'</span><span class="p">:</span> <span class="s1">'DM'</span><span class="p">},</span>
  <span class="p">{</span><span class="s1">'date'</span><span class="p">:</span> <span class="s1">'1977-7-16'</span><span class="p">,</span> <span class="s1">'sex'</span><span class="p">:</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'species'</span><span class="p">:</span> <span class="s1">'PF'</span><span class="p">},</span>
  <span class="p">{</span><span class="s1">'date'</span><span class="p">:</span> <span class="s1">'1977-7-16'</span><span class="p">,</span> <span class="s1">'sex'</span><span class="p">:</span> <span class="s1">'F'</span><span class="p">,</span> <span class="s1">'species'</span><span class="p">:</span> <span class="s1">'PE'</span><span class="p">},</span>
  <span class="p">{</span><span class="s1">'date'</span><span class="p">:</span> <span class="s1">'1977-7-16'</span><span class="p">,</span> <span class="s1">'sex'</span><span class="p">:</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'species'</span><span class="p">:</span> <span class="s1">'DM'</span><span class="p">}</span>
<span class="p">]</span>
</code></pre></div></div>

<!-- == \noindent -->
<p>write a function that returns a new array of objects like this:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">newData</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span><span class="s1">'seq'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">'year'</span><span class="p">:</span> <span class="s1">'1977'</span><span class="p">,</span> <span class="s1">'sex'</span><span class="p">:</span> <span class="s1">'F'</span><span class="p">,</span> <span class="s1">'species'</span><span class="p">:</span> <span class="s1">'DM'</span><span class="p">},</span>
  <span class="p">{</span><span class="s1">'seq'</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">'year'</span><span class="p">:</span> <span class="s1">'1977'</span><span class="p">,</span> <span class="s1">'sex'</span><span class="p">:</span> <span class="s1">'F'</span><span class="p">,</span> <span class="s1">'species'</span><span class="p">:</span> <span class="s1">'PE'</span><span class="p">}</span>
<span class="p">]</span>
</code></pre></div></div>

<p><em>without</em> using any loops.
The changes are:</p>

<ul>
  <li>The <code class="highlighter-rouge">date</code> field is replaced with just the `year.</li>
  <li>Only observations of female animals are retained.</li>
  <li>The retained records are given sequence numbers to relate them back to the original data.
(These sequence numbers are 1-based rather than 0-based.)</li>
</ul>

<p>You will probably want to use <code class="highlighter-rouge">Array.reduce</code> to generate the sequence numbers.</p>


      


<div class="listblock">
  <h2>Key Points</h2>
  <ul>
    <li>JavaScript stores the instructions making up a function in memory like any other object.
</li><li>Function objects can be assigned to variables, put in lists, passed as arguments to other functions, etc.
</li><li>Functions can be defined in place without ever being given a name.
</li><li>A callback function is one that is passed in to another function for it to execute at a particular moment.
</li><li>Functional programming uses higher-order functions on immutable data.
</li><li><code class="highlighter-rouge">Array.some</code> is true if any element in an array passes a test, while <code class="highlighter-rouge">Array.every</code> is true if they all do.
</li><li><code class="highlighter-rouge">Array.filter</code> selects elements of an array that pass a test.
</li><li><code class="highlighter-rouge">Array.map</code> creates a new array by transforming values in an existing one.
</li><li><code class="highlighter-rouge">Array.reduce</code> reduces an array to a single value.
</li><li>A closure is a set of variables captured during the definition of a function.
</li>
  </ul>
</div>


    </div>
<div class="chapter">
      <h1 id="s:oop">Objects and Classes</h1>
      


<div class="listblock">
  <h2>Questions</h2>
  <ul>
    <li>How can I use classes to keep code and data together?
</li><li>What are the benefits of doing this?
</li><li>How can I create an object from a class?
</li><li>How can I initialize that object?
</li><li>How can I create new classes from old?
</li><li>How does JavaScript decide what to do when two classes define the same thing?
</li><li>When should I create new classes and when should I combine existing ones?
</li><li>How can old code use new code?
</li>
  </ul>
</div>


      
      <p>Making new code use old code is easy:
just load the libraries you want and write calls to the functions you need.
Making <em>old</em> code use <em>new</em> code without rewriting it is trickier,
but object-oriented programming can help.</p>

<h2 id="s:oop-manual">Doing It By Hand</h2>

<p>As we saw <a href="#s:basics">earlier</a>,
an object in JavaScript is a set of key-value pairs.
Since functions are just another kind of data,
an object’s values can be functions,
so data can carry around functions that work on it.
For example,
we can create an object to represent a square:</p>

<div title="src/oop/clumsy-objects.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">square</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span> <span class="s1">'square'</span><span class="p">,</span>
  <span class="na">size</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
  <span class="na">area</span><span class="p">:</span> <span class="p">(</span><span class="nx">it</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">it</span><span class="p">.</span><span class="nx">size</span> <span class="o">*</span> <span class="nx">it</span><span class="p">.</span><span class="nx">size</span> <span class="p">},</span>
  <span class="na">perimeter</span><span class="p">:</span> <span class="p">(</span><span class="nx">it</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">4</span> <span class="o">*</span> <span class="nx">it</span><span class="p">.</span><span class="nx">size</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<!-- == \noindent -->
<p>and then pass the object itself into each of its own functions:</p>

<div title="src/oop/clumsy-objects.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">square</span><span class="p">.</span><span class="nx">area</span><span class="p">(</span><span class="nx">square</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`area of square is </span><span class="p">${</span><span class="nx">a</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>area of square is 25
</code></pre></div></div>

<p>This is a bit clumsy—we’ll often forget to pass the object into its functions—but
it allows us to handle many different kinds of things in the same way.
For example,
we can create another object to represent a circle:</p>

<div title="src/oop/clumsy-objects.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">circle</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span> <span class="s1">'circle'</span><span class="p">,</span>
  <span class="na">radius</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
  <span class="na">area</span><span class="p">:</span> <span class="p">(</span><span class="nx">it</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">*</span> <span class="nx">it</span><span class="p">.</span><span class="nx">radius</span> <span class="o">*</span> <span class="nx">it</span><span class="p">.</span><span class="nx">radius</span> <span class="p">},</span>
  <span class="na">perimeter</span><span class="p">:</span> <span class="p">(</span><span class="nx">it</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">*</span> <span class="nx">it</span><span class="p">.</span><span class="nx">radius</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<!-- == \noindent -->
<p>and then put all of these different objects in an array
and operate on them in the same way
without knowing precisely what kind of object we’re dealing with:</p>

<div title="src/oop/clumsy-objects.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">show_all</span> <span class="o">=</span> <span class="p">(</span><span class="nx">shapes</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">s</span> <span class="k">of</span> <span class="nx">shapes</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">area</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
    <span class="kd">const</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">perimeter</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">s</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="s2">: area </span><span class="p">${</span><span class="nx">a</span><span class="p">}</span><span class="s2"> perimeter </span><span class="p">${</span><span class="nx">p</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">show_all</span><span class="p">([</span><span class="nx">square</span><span class="p">,</span> <span class="nx">circle</span><span class="p">])</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>square: area 25 perimeter 20
circle: area 28.274333882308138 perimeter 18.84955592153876
</code></pre></div></div>

<p>As long as we only use the value <code class="highlighter-rouge">name</code> and the functions <code class="highlighter-rouge">area</code> and <code class="highlighter-rouge">perimeter</code>
we don’t need to know what kind of shape we have.
This is called <a href="#g:polymorphism">polymorphism</a>,
and it allows us to add new shapes without changing the code in our loop.
In other words,
it allows old code (in this case, the function <code class="highlighter-rouge">show_all</code>)
to use new code (the new object <code class="highlighter-rouge">rectangle</code>).</p>

<div title="src/oop/clumsy-objects.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">rectangle</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span> <span class="s1">'rectangle'</span><span class="p">,</span>
  <span class="na">width</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="na">height</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
  <span class="na">area</span><span class="p">:</span> <span class="p">(</span><span class="nx">it</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">it</span><span class="p">.</span><span class="nx">width</span> <span class="o">*</span> <span class="nx">it</span><span class="p">.</span><span class="nx">height</span> <span class="p">},</span>
  <span class="na">perimeter</span><span class="p">:</span> <span class="p">(</span><span class="nx">it</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">width</span> <span class="o">+</span> <span class="nx">it</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span> <span class="p">}</span>
<span class="p">}</span>

<span class="nx">show_all</span><span class="p">([</span><span class="nx">square</span><span class="p">,</span> <span class="nx">circle</span><span class="p">,</span> <span class="nx">rectangle</span><span class="p">])</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>square: area 25 perimeter 20
circle: area 28.274333882308138 perimeter 18.84955592153876
rectangle: area 6 perimeter 10
</code></pre></div></div>

<h2 id="s:oop-classes">Classes</h2>

<p>Building every object by hand and calling <code class="highlighter-rouge">thing.function(thing)</code> is clumsy.
JavaScript solved these problems using <a href="#g:prototype">prototypes</a>,
which also turned out to be <a href="#s:legacy-prototypes">clumsy</a>.
Most object-oriented languages use <a href="#g:class">classes</a> instead;
these were added to JavaScript in ES6,
and we will use them instead of prototypes throughout.
Here’s how we create a class that defines the properties of a square,
without actually creating any specific squares:</p>

<div title="src/oop/es6-objects.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">Square</span> <span class="p">{</span>
  <span class="kd">constructor</span> <span class="p">(</span><span class="nx">size</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">'square'</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">size</span> <span class="o">=</span> <span class="nx">size</span>
  <span class="p">}</span>
  <span class="nx">area</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">size</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">size</span> <span class="p">}</span>
  <span class="nx">perimeter</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">4</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">size</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<!-- == \noindent -->
<p>(Class names are written in CamelCase by convention.)
We can then create a specific square by using the class’s name as if it were a function:</p>

<div title="src/oop/es6-objects.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">sq</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Square</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`sq name </span><span class="p">${</span><span class="nx">sq</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="s2"> and area </span><span class="p">${</span><span class="nx">sq</span><span class="p">.</span><span class="nx">area</span><span class="p">()}</span><span class="s2">`</span><span class="p">)</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sq name square and area 9
</code></pre></div></div>

<p><code class="highlighter-rouge">new ClassName(...)</code> creates a new blank object
and inserts a (hidden) reference to the class
so that the object can find its <a href="#g:method">methods</a>.
<code class="highlighter-rouge">new</code> then calls the specially-named method <code class="highlighter-rouge">constructor</code> to initialize the object’s state.
Inside the constructor and other methods,
the object being operated on is referred to by the pronoun <code class="highlighter-rouge">this</code>.</p>

<p>Inside the class,
methods are defined with classic syntax rather than the <a href="#g:fat-arrow">fat arrows</a> we have been using.
The inconsistency is unfortunate
but this way of defining methods is what the current version of Node prefers;
we will explore this topic further in the <a href="#s:vis">discussion of visualization</a>.</p>

<p>Classes defined this way support polymorphism:
if two or more classes have some methods with the same names
that take the same parameters
and return the same kinds of values,
other code can use objects of those classes interchangeably.
For example,
here’s a class-based rewrite of our shapes code:</p>

<div title="src/oop/es6-objects.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">Circle</span> <span class="p">{</span>
  <span class="kd">constructor</span> <span class="p">(</span><span class="nx">radius</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">'circle'</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">radius</span> <span class="o">=</span> <span class="nx">radius</span>
  <span class="p">}</span>
  <span class="nx">area</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">radius</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">radius</span> <span class="p">}</span>
  <span class="nx">perimeter</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">radius</span> <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nx">Rectangle</span> <span class="p">{</span>
  <span class="kd">constructor</span> <span class="p">(</span><span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">'rectangle'</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">width</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">height</span>
  <span class="p">}</span>
  <span class="nx">area</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="p">}</span>
  <span class="nx">perimeter</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span> <span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">everything</span> <span class="o">=</span> <span class="p">[</span>
  <span class="k">new</span> <span class="nx">Square</span><span class="p">(</span><span class="mf">3.5</span><span class="p">),</span>
  <span class="k">new</span> <span class="nx">Circle</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
  <span class="k">new</span> <span class="nx">Rectangle</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="p">]</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">thing</span> <span class="k">of</span> <span class="nx">everything</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">thing</span><span class="p">.</span><span class="nx">area</span><span class="p">(</span><span class="nx">thing</span><span class="p">)</span>
  <span class="kd">const</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">thing</span><span class="p">.</span><span class="nx">perimeter</span><span class="p">(</span><span class="nx">thing</span><span class="p">)</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">thing</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="s2">: area </span><span class="p">${</span><span class="nx">a</span><span class="p">}</span><span class="s2"> perimeter </span><span class="p">${</span><span class="nx">p</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>square: area 12.25 perimeter 14
circle: area 19.634954084936208 perimeter 15.707963267948966
rectangle: area 0.75 perimeter 4
</code></pre></div></div>

<h2 id="s:oop-inheritance">Inheritance</h2>

<p>We can build new classes from old ones by adding or <a href="#g:override-method">overriding</a> methods.
To show this,
we’ll start by defining a person:</p>

<div title="src/oop/override.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">Person</span> <span class="p">{</span>
  <span class="kd">constructor</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span>
  <span class="p">}</span>

  <span class="nx">greeting</span> <span class="p">(</span><span class="nx">formal</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">formal</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s2">`Hello, my name is </span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="s2">`</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s2">`Hi, I'm </span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="s2">`</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">farewell</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">`Goodbye`</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We can now <a href="#g:extend">extend</a> <code class="highlighter-rouge">Person</code> to create a new class <code class="highlighter-rouge">Scientist</code>,
in which case we say that <code class="highlighter-rouge">Scientist</code> <a href="#g:inherit">inherits</a> from <code class="highlighter-rouge">Person</code>,
or that <code class="highlighter-rouge">Person</code> is a <a href="#g:parent-class">parent class</a> of <code class="highlighter-rouge">Scientist</code>
and <code class="highlighter-rouge">Scientist</code> is a <a href="#g:child-class">child class</a> of <code class="highlighter-rouge">Person</code>.</p>

<div title="src/oop/override.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">Scientist</span> <span class="kd">extends</span> <span class="nx">Person</span> <span class="p">{</span>
  <span class="kd">constructor</span> <span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">area</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">area</span> <span class="o">=</span> <span class="nx">area</span>
  <span class="p">}</span>

  <span class="nx">greeting</span> <span class="p">(</span><span class="nx">formal</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">`</span><span class="p">${</span><span class="k">super</span><span class="p">.</span><span class="nx">greeting</span><span class="p">(</span><span class="nx">formal</span><span class="p">)}</span><span class="s2">. Let me tell you about </span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">area</span><span class="p">}</span><span class="s2">...`</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This tells us that a <code class="highlighter-rouge">Scientist</code> is a <code class="highlighter-rouge">Person</code> who:</p>

<ul>
  <li>Has an area of specialization as well as a name.</li>
  <li>Says hello in a slightly longer way</li>
  <li>Says goodbye in the same way as a <code class="highlighter-rouge">Person</code>
(since <code class="highlighter-rouge">Scientist</code> <em>doesn’t</em> define its own <code class="highlighter-rouge">farewell</code> method)</li>
</ul>

<p>The word <code class="highlighter-rouge">super</code> is used in two ways here:</p>

<ul>
  <li>In the constructor for <code class="highlighter-rouge">Scientist</code>,
<code class="highlighter-rouge">super(...)</code> calls up to the constructor of the parent class <code class="highlighter-rouge">Person</code>
so that it can do whatever initialization it does
before <code class="highlighter-rouge">Scientist</code> does its own initialization.
This saves us from duplicating steps.</li>
  <li>Inside <code class="highlighter-rouge">greeting</code>,
the expression <code class="highlighter-rouge">super.greeting(formal)</code> means
“call the parent class’s <code class="highlighter-rouge">greeting</code> method for this object”.
This allows methods defined in child classes to add to or modify
the behavior of methods defined in parent classes,
again without duplicating code.</li>
</ul>

<p>Let’s try it out:</p>

<div title="src/oop/override.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">parent</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Person</span><span class="p">(</span><span class="s1">'Hakim'</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`parent: </span><span class="p">${</span><span class="nx">parent</span><span class="p">.</span><span class="nx">greeting</span><span class="p">(</span><span class="kc">true</span><span class="p">)}</span><span class="s2"> - </span><span class="p">${</span><span class="nx">parent</span><span class="p">.</span><span class="nx">farewell</span><span class="p">()}</span><span class="s2">`</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">child</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Scientist</span><span class="p">(</span><span class="s1">'Bhadra'</span><span class="p">,</span> <span class="s1">'microbiology'</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`child: </span><span class="p">${</span><span class="nx">child</span><span class="p">.</span><span class="nx">greeting</span><span class="p">(</span><span class="kc">false</span><span class="p">)}</span><span class="s2"> - </span><span class="p">${</span><span class="nx">child</span><span class="p">.</span><span class="nx">farewell</span><span class="p">()}</span><span class="s2">`</span><span class="p">)</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>parent: Hello, my name is Hakim - Goodbye
child: Hi, I'm Bhadra. Let me tell you about microbiology... - Goodbye
</code></pre></div></div>

<p>The diagram below shows what memory looks like after these classes have been defined
and the objects <code class="highlighter-rouge">parent</code> and <code class="highlighter-rouge">child</code> have been created.
It looks complex at first,
but allows us to see how JavaScript finds the right method
when <code class="highlighter-rouge">child.farewell()</code> is called:</p>

<ul>
  <li>It looks in the object <code class="highlighter-rouge">child</code> to see if there’s a function there with the right name.</li>
  <li>There isn’t, so it follows <code class="highlighter-rouge">child</code>’s link to its class <code class="highlighter-rouge">Scientist</code>
to see if a function is there.</li>
  <li>There isn’t, so it follows the link from <code class="highlighter-rouge">Scientist</code> to the parent class <code class="highlighter-rouge">Person</code>
and finds the function it’s looking for.</li>
</ul>

<figure id="f:oop-inheritance"> <img src="../../files/oop-inheritance.svg"> <figcaption>Object-Oriented Inheritance</figcaption> </figure>

<h2 id="s:oop-protocols">Protocols</h2>

<p>A common way to use object-oriented programming is to define a <a href="#g:protocol">protocol</a>.
The parent defines a method that invokes other methods at specific times or in a specific order.
Users then derive classes from the parent that implement those methods
to do those specific things.
In essence,
a protocol says,
“You will all follow this procedure, but you may follow it in different ways.”</p>

<p>For example,
how does a generic bird behave throughout the year?
The class <code class="highlighter-rouge">Bird</code> specifies that it forages, mates, and nests,
and provides default methods for each:</p>

<div title="src/oop/protocol.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">Bird</span> <span class="p">{</span>
  <span class="kd">constructor</span> <span class="p">(</span><span class="nx">species</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">species</span> <span class="o">=</span> <span class="nx">species</span>
  <span class="p">}</span>

  <span class="nx">daily</span> <span class="p">(</span><span class="nx">season</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">foraging</span><span class="p">(</span><span class="nx">season</span><span class="p">),</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">mating</span><span class="p">(</span><span class="nx">season</span><span class="p">),</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">nesting</span><span class="p">(</span><span class="nx">season</span><span class="p">)</span>
    <span class="p">]</span>
  <span class="p">}</span>

  <span class="nx">foraging</span> <span class="p">(</span><span class="nx">season</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">`</span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">species</span><span class="p">}</span><span class="s2"> looks for food`</span>
  <span class="p">}</span>

  <span class="nx">mating</span> <span class="p">(</span><span class="nx">season</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="s1">''</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">season</span> <span class="o">===</span> <span class="s1">'fall'</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">result</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">species</span><span class="p">}</span><span class="s2"> looks for a mate`</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">result</span>
  <span class="p">}</span>

  <span class="nx">nesting</span> <span class="p">(</span><span class="nx">season</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// do nothing</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>A specific kind of bird,
such as a penguin,
can then override these methods to provide its own behaviors
<em>without</em> changing its daily behavior:</p>

<div title="src/oop/protocol.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">Penguin</span> <span class="kd">extends</span> <span class="nx">Bird</span> <span class="p">{</span>
  <span class="kd">constructor</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">(</span><span class="s1">'penguin'</span><span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">hasEgg</span> <span class="o">=</span> <span class="kc">false</span>
  <span class="p">}</span>

  <span class="nx">mating</span> <span class="p">(</span><span class="nx">season</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">season</span> <span class="o">===</span> <span class="s1">'fall'</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">hasEgg</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.5</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">super</span><span class="p">.</span><span class="nx">mating</span><span class="p">(</span><span class="nx">season</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">nesting</span> <span class="p">(</span><span class="nx">season</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="s1">''</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hasEgg</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="nx">season</span> <span class="o">===</span> <span class="s1">'winter'</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">season</span> <span class="o">===</span> <span class="s1">'spring'</span><span class="p">)))</span> <span class="p">{</span>
      <span class="nx">result</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">species</span><span class="p">}</span><span class="s2"> is nesting`</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">season</span> <span class="o">===</span> <span class="s1">'spring'</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">hasEgg</span> <span class="o">=</span> <span class="kc">false</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">result</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">Penguin</code> has some extra state (the variable <code class="highlighter-rouge">this.hasEgg</code>),
and calls its parent’s constructor before setting this up.
It doesn’t override the default behavior for <code class="highlighter-rouge">foraging</code>,
but it extends the default behavior for <code class="highlighter-rouge">mating</code>
and completely replaces the default behavior for <code class="highlighter-rouge">nesting</code>.
Here are the results of watching one penguin for four seasons:</p>

<div title="src/oop/protocol.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">bird</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Penguin</span><span class="p">()</span>
<span class="kd">const</span> <span class="nx">seasons</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'summer'</span><span class="p">,</span> <span class="s1">'fall'</span><span class="p">,</span> <span class="s1">'winter'</span><span class="p">,</span> <span class="s1">'spring'</span><span class="p">]</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">season</span> <span class="k">of</span> <span class="nx">seasons</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`in </span><span class="p">${</span><span class="nx">season</span><span class="p">}</span><span class="s2">: </span><span class="p">${</span><span class="nx">bird</span><span class="p">.</span><span class="nx">daily</span><span class="p">(</span><span class="nx">season</span><span class="p">)}</span><span class="s2">`</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>in summer: penguin looks for food,,
in fall: penguin looks for food,penguin looks for a mate,
in winter: penguin looks for food,,
in spring: penguin looks for food,,
</code></pre></div></div>

<p>Here’s another:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>in summer: penguin looks for food,,
in fall: penguin looks for food,penguin looks for a mate,
in winter: penguin looks for food,,penguin is nesting
in spring: penguin looks for food,,penguin is nesting
</code></pre></div></div>

<p>Different random numbers produce different behaviors,
which makes testing hard:
we’ll see how to address this <a href="#s:testing">later</a>
The main idea,
though,
is how old code can use new code:
the old code defines expectations as an interface and a protocol,
and the new code implements that interface and respects that protocol.
We will see this idea over and over again
as we build applications using standard libraries.</p>

<h2 id="s:oop-exercises">Exercises</h2>

<h3 id="delays">Delays</h3>

<p>Define a class called <code class="highlighter-rouge">Delay</code> whose <code class="highlighter-rouge">call</code> method always returns
the value given in the <em>previous</em> call:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">example</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Delay</span><span class="p">(</span><span class="s1">'a'</span><span class="p">)</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">value</span> <span class="k">of</span> <span class="p">[</span><span class="s1">'b'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">,</span> <span class="s1">'d'</span><span class="p">])</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="s1">'-&gt;'</span><span class="p">,</span> <span class="nx">example</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>b -&gt; a
c -&gt; b
d -&gt; c
</code></pre></div></div>

<p>A class like <code class="highlighter-rouge">Delay</code> is sometimes called <a href="#g:stateful">stateful</a>,
since it remembers its state from call to call.</p>

<h3 id="filtering">Filtering</h3>

<p>Define a class called <code class="highlighter-rouge">Filter</code> whose <code class="highlighter-rouge">call</code> method returns <code class="highlighter-rouge">null</code>
if its input matches one of the values given to its constructor,
or the input as output otherwise:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">example</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Filter</span><span class="p">(</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'e'</span><span class="p">,</span> <span class="s1">'i'</span><span class="p">,</span> <span class="s1">'o'</span><span class="p">,</span> <span class="s1">'u'</span><span class="p">)</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">value</span> <span class="k">of</span> <span class="p">[</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">,</span> <span class="s1">'d'</span><span class="p">,</span> <span class="s1">'e'</span><span class="p">])</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="s1">'-&gt;'</span><span class="p">,</span> <span class="nx">example</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>a -&gt; null
b -&gt; b
c -&gt; c
d -&gt; d
e -&gt; null
</code></pre></div></div>

<p>A class like <code class="highlighter-rouge">Filter</code> is sometimes called <a href="#g:stateless">stateless</a>,
since it does not remember its state from call to call.</p>

<h3 id="pipelines">Pipelines</h3>

<p>Define a class called <code class="highlighter-rouge">Pipeline</code>
whose constructor takes one or more objects with a single-parameter <code class="highlighter-rouge">call</code> method,
and whose own <code class="highlighter-rouge">call</code> method passes a value through each of them in turn.
If any of the components’ <code class="highlighter-rouge">call</code> methods returns <code class="highlighter-rouge">null</code>,
<code class="highlighter-rouge">Pipeline</code> stops immediately and returns <code class="highlighter-rouge">null</code>.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">example</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Pipeline</span><span class="p">(</span><span class="k">new</span> <span class="nx">Filter</span><span class="p">(</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'e'</span><span class="p">,</span> <span class="s1">'i'</span><span class="p">,</span> <span class="s1">'o'</span><span class="p">,</span> <span class="s1">'u'</span><span class="p">),</span> <span class="k">new</span> <span class="nx">Delay</span><span class="p">(</span><span class="s1">'a'</span><span class="p">))</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">value</span> <span class="k">of</span> <span class="p">[</span><span class="s1">'a'</span> <span class="p">,</span><span class="s1">'b'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">,</span> <span class="s1">'d'</span><span class="p">,</span> <span class="s1">'e'</span><span class="p">])</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="s1">'-&gt;'</span><span class="p">,</span> <span class="nx">example</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>a -&gt; null
b -&gt; a
c -&gt; b
d -&gt; c
e -&gt; null
</code></pre></div></div>

<h3 id="active-expressions">Active Expressions</h3>

<p>Consider this class:</p>

<div title="src/oop/observe.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">Active</span> <span class="p">{</span>
  <span class="kd">constructor</span> <span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">transform</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">transform</span> <span class="o">=</span> <span class="nx">transform</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">subscribers</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="p">}</span>

  <span class="nx">subscribe</span> <span class="p">(</span><span class="nx">someone</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">subscribers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">someone</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">update</span> <span class="p">(</span><span class="nx">input</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="s1">'got'</span><span class="p">,</span> <span class="nx">input</span><span class="p">)</span>
    <span class="kd">const</span> <span class="nx">output</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">transform</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">s</span> <span class="k">of</span> <span class="k">this</span><span class="p">.</span><span class="nx">subscribers</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">s</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">output</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<!-- == \noindent -->
<p>and this program that uses it:</p>

<div title="src/oop/observe.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">start</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Active</span><span class="p">(</span><span class="s1">'start'</span><span class="p">,</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="kd">const</span> <span class="nx">left</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Active</span><span class="p">(</span><span class="s1">'left'</span><span class="p">,</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">x</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">right</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Active</span><span class="p">(</span><span class="s1">'right'</span><span class="p">,</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="kd">const</span> <span class="kr">final</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Active</span><span class="p">(</span><span class="s1">'final'</span><span class="p">,</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">x</span><span class="p">)</span>
<span class="nx">start</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">left</span><span class="p">)</span>
<span class="nx">start</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">right</span><span class="p">)</span>
<span class="nx">left</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="kr">final</span><span class="p">)</span>
<span class="nx">right</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="kr">final</span><span class="p">)</span>

<span class="nx">start</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
</code></pre></div></div>

<ol>
  <li>Trace what happens when the last line of the program is called.</li>
  <li>Modify <code class="highlighter-rouge">Active</code> so that it calls <code class="highlighter-rouge">transform</code> <em>if</em> that function was provided,
or a method <code class="highlighter-rouge">Active.transform</code> if a transformation function wasn’t provided.</li>
  <li>Create a new class <code class="highlighter-rouge">Delay</code> whose <code class="highlighter-rouge">transform</code> method always returns the previous value.
(Its constructor will need to take an initial value as a parameter.)</li>
</ol>

<p>This pattern is called <a href="#g:observer-observable">observer/observable</a>.</p>


      


<div class="listblock">
  <h2>Key Points</h2>
  <ul>
    <li>Create classes to define combinations of data and behavior.
</li><li>Use the class’s constructor to initialize objects.
</li><li><code class="highlighter-rouge">this</code> refers to the current object.
</li><li>Use polymorphism to express common behavior patterns.
</li><li>Extend existing classes to create new ones-sometimes.
</li><li>Override methods to change or extend their behavior.
</li><li>Creating extensible systems by defining interfaces and protocols.
</li>
  </ul>
</div>


    </div>
<div class="chapter">
      <h1 id="s:htmlcss">HTML and CSS</h1>
      


<div class="listblock">
  <h2>Questions</h2>
  <ul>
    <li>Where did HTML come from?
</li><li>What kinds of things can HTML pages contain?
</li><li>How do I create headings? Lists? Tables? Links?
</li><li>How do I include images?
</li><li>How can I change the appearance of elements on a page?
</li><li>How can I reference specific elements on a page?
</li>
  </ul>
</div>


      
      <p>HTML is the standard way to represent documents for presentation in web browsers,
and CSS is the standard way to describe how it should look.
Both are more complicated than they should have been,
but in order to create web applications,
we need to understand a little of both.</p>

<h2 id="s:htmlcss-formatting">Formatting</h2>

<p>An HTML <a href="#g:document">document</a> contains <a href="#g:element">elements</a> and text
(and possibly other things that we will ignore for now).
Elements are shown using <a href="#g:tag">tags</a>:
an opening tag <code class="highlighter-rouge">&lt;tagname&gt;</code> shows where the element begins,
and a corresponding closing tag <code class="highlighter-rouge">&lt;/tagname&gt;</code> (with a leading slash) shows where it ends.
If there’s nothing between the two, we can write <code class="highlighter-rouge">&lt;tagname/&gt;</code> (with a trailing slash).</p>

<p>A document’s elements must form a <a href="#g:tree">tree</a>,
i.e.,
they must be strictly nested.
This means that if Y starts inside X,
Y must end before X ends,
so <code class="highlighter-rouge">&lt;X&gt;...&lt;Y&gt;...&lt;/Y&gt;&lt;/X&gt;</code> is legal,
but <code class="highlighter-rouge">&lt;X&gt;...&lt;Y&gt;...&lt;/X&gt;&lt;/Y&gt;</code> is not.
Finally,
every document should have a single <a href="#g:root-element">root element</a> that encloses everything else,
although browsers aren’t strict about enforcing this.
In fact,
most browsers are pretty relaxed about enforcing any kind of rules at all,
since most people don’t obey them anyway.</p>

<h2 id="s:htmlcss-text">Text</h2>

<p>The text in an HTML page is normal printable text.
However,
since <code class="highlighter-rouge">&lt;</code> and <code class="highlighter-rouge">&gt;</code> are used to show where tags start and end,
we must use <a href="#g:escape-sequence">escape sequences</a> to represent them,
just as we use <code class="highlighter-rouge">\"</code> to represented a literal double-quote character
inside a double-quoted string in JavaScript.
In HTML,
escape sequences are written <code class="highlighter-rouge">&amp;name;</code>,
i.e.,
an ampersand, the name of the character, and a semi-colon.
A few common escape sequences include:</p>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Escape Sequence</th>
      <th>Character</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Less than</td>
      <td><code class="highlighter-rouge">&amp;lt;</code></td>
      <td>&lt;</td>
    </tr>
    <tr>
      <td>Greater than</td>
      <td><code class="highlighter-rouge">&amp;gt;</code></td>
      <td>&gt;</td>
    </tr>
    <tr>
      <td>Ampersand</td>
      <td><code class="highlighter-rouge">&amp;amp;</code></td>
      <td>&amp;</td>
    </tr>
    <tr>
      <td>Copyright</td>
      <td><code class="highlighter-rouge">&amp;copy;</code></td>
      <td>©</td>
    </tr>
    <tr>
      <td>Plus/minus</td>
      <td><code class="highlighter-rouge">&amp;plusmn;</code></td>
      <td>±</td>
    </tr>
    <tr>
      <td>Micro</td>
      <td><code class="highlighter-rouge">&amp;micro;</code></td>
      <td>µ</td>
    </tr>
  </tbody>
</table>

<p>The first two are self-explanatory,
and <code class="highlighter-rouge">&amp;amp;</code> is needed so that we can write a literal ampersand
(just as <code class="highlighter-rouge">\\</code> is needed in JavaScript strings so that we can write a literal backslash).
<code class="highlighter-rouge">&amp;copy;</code>, <code class="highlighter-rouge">&amp;plusmn;</code>, and <code class="highlighter-rouge">&amp;micro;</code> are usually not needed any longer,
since most editors will allow us to put non-ASCII characters directly into documents these days,
but occasionally we will run into older or stricter systems.</p>

<h2 id="s:htmlcss-pages">Pages</h2>

<p>An HTML page should have:</p>

<ul>
  <li>a single <code class="highlighter-rouge">html</code> element that encloses everything else</li>
  <li>a single <code class="highlighter-rouge">head</code> element that contains information about the page</li>
  <li>a single <code class="highlighter-rouge">body</code> element that contains the content to be displayed</li>
</ul>

<p>It doesn’t matter whether or how we indent the tags showing these elements and the content they contain,
but laying them out on separate lines
and indenting to show nesting
helps human readers.
Well-written pages also use comments, just like code:
these start with <code class="highlighter-rouge">&lt;!--</code> and end with <code class="highlighter-rouge">--&gt;</code>.
Unfortunately,
comments cannot be nested,
i.e.,
if you comment out a section of a page that already contains a comment,
the results are unpredictable.</p>

<p>Here’s an empty HTML page with the structure described above:</p>

<div title="src/htmlcss/empty-page.html" class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="c">&lt;!-- description of page goes here --&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="c">&lt;!-- content of page goes here --&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>Nothing shows up if we open this in a browser,
so let’s add a little content:</p>

<div title="src/htmlcss/first-page.html" class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>This text is displayed in the browser bar<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Displayed Content Starts Here<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      This course introduces core features of <span class="nt">&lt;em&gt;</span>JavaScript<span class="nt">&lt;/em&gt;</span>
      and shows where and how to use them.
    <span class="nt">&lt;/p&gt;</span>
    <span class="c">&lt;!-- The word "JavaScript" is in italics (emphasis) in the preceding paragraph. --&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<ul>
  <li>The <code class="highlighter-rouge">title</code> element inside <code class="highlighter-rouge">head</code> gives the page a title.
This is displayed in the browser bar when the page is open,
but is <em>not</em> displayed as part of the page itself.</li>
  <li>The <code class="highlighter-rouge">h1</code> element is a level-1 heading;
we can use <code class="highlighter-rouge">h2</code>, <code class="highlighter-rouge">h3</code>, and so on to create sub-headings.</li>
  <li>The <code class="highlighter-rouge">p</code> element is a paragraph.</li>
  <li>Inside a heading or a paragraph,
we can use <code class="highlighter-rouge">em</code> to <em>emphasize</em> text.
We can also use <code class="highlighter-rouge">strong</code> to make text <strong>stronger</strong>.
Tags like these are better than tags like <code class="highlighter-rouge">i</code> (for italics) or <code class="highlighter-rouge">b</code> (for bold)
because they signal intention rather than forcing a particular layout.
Someone who is visually impaired, or someone using a small-screen device,
may want emphasis of various kinds displayed in different ways.</li>
</ul>

<h2 id="s:htmlcss-attributes">Attributes</h2>

<p>Elements can be customized by giving them <a href="#g:attribute">attributes</a>,
which are written as <code class="highlighter-rouge">name="value"</code> pairs inside the element’s opening tag.
For example:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;h1</span> <span class="na">align=</span><span class="s">"center"</span><span class="nt">&gt;</span>A Centered Heading<span class="nt">&lt;/h1&gt;</span>
</code></pre></div></div>

<p>centers the <code class="highlighter-rouge">h1</code> heading on the page, while:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;p class="disclaimer"&gt;This planet provided as-is.&lt;/p&gt;
</code></pre></div></div>

<!-- == \noindent -->
<p>marks this paragraph as a disclaimer.
That doesn’t mean anything special to HTML,
but as we’ll see later,
we can define styles based on the <code class="highlighter-rouge">class</code> attributes of elements.</p>

<p>An attribute’s name may appear at most once in any element,
just like a key can only appear once in any JavaScript object,
so <code class="highlighter-rouge">&lt;p align="left" align="right"&gt;...&lt;/p&gt;</code> is illegal.
If we want to give an attribute multiple values—for example,
if we want an element to have several classes—we put all the values in one string.
Unfortunately,
as the example below shows,
HTML is inconsistent about whether values should be separated by spaces or semi-colons:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"disclaimer optional"</span> <span class="na">style=</span><span class="s">"color: blue; font-size: 200%;"</span><span class="nt">&gt;</span>
</code></pre></div></div>

<p>However they are separated,
values are supposed to be quoted,
but in practice we can often get away with <code class="highlighter-rouge">name=value</code>.
And for Boolean attributes whose values are just true or false,
we can even sometimes just get away with <code class="highlighter-rouge">name</code> on its own.</p>

<h2 id="s:htmlcss-lists">Lists</h2>

<p>Headings and paragraphs are all very well,
but data scientists need more.
To create an unordered (bulleted) list,
we use a <code class="highlighter-rouge">ul</code> element,
and wrap each item inside the list in <code class="highlighter-rouge">li</code>.
To create an ordered (numbered) list,
we use <code class="highlighter-rouge">ol</code> instead of <code class="highlighter-rouge">ul</code>,
but still use <code class="highlighter-rouge">li</code> for the list items.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;ul&gt;</span>
  <span class="nt">&lt;li&gt;</span>first<span class="nt">&lt;/li&gt;</span>
  <span class="nt">&lt;li&gt;</span>second<span class="nt">&lt;/li&gt;</span>
  <span class="nt">&lt;li&gt;</span>third<span class="nt">&lt;/li&gt;</span>
<span class="nt">&lt;/ul&gt;</span>
</code></pre></div></div>

<ul>
  <li>first</li>
  <li>second</li>
  <li>third</li>
</ul>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;ol&gt;</span>
  <span class="nt">&lt;li&gt;</span>first<span class="nt">&lt;/li&gt;</span>
  <span class="nt">&lt;li&gt;</span>second<span class="nt">&lt;/li&gt;</span>
  <span class="nt">&lt;li&gt;</span>third<span class="nt">&lt;/li&gt;</span>
<span class="nt">&lt;/ol&gt;</span>
</code></pre></div></div>

<ol>
  <li>first</li>
  <li>second</li>
  <li>third</li>
</ol>

<p>Lists can be nested by putting the inner list’s <code class="highlighter-rouge">ul</code> or <code class="highlighter-rouge">ol</code>
inside one of the outer list’s <code class="highlighter-rouge">li</code> elements:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;ol&gt;</span>
  <span class="nt">&lt;li&gt;</span>Major A
    <span class="nt">&lt;ol&gt;</span>
      <span class="nt">&lt;li&gt;</span>minor p<span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;li&gt;</span>minor q<span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;/ol&gt;</span>
  <span class="nt">&lt;/li&gt;</span>
  <span class="nt">&lt;li&gt;</span>Major B
    <span class="nt">&lt;ol&gt;</span>
      <span class="nt">&lt;li&gt;</span>minor r<span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;li&gt;</span>minor s<span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;/ol&gt;</span>
  <span class="nt">&lt;/li&gt;</span>
<span class="nt">&lt;/ol&gt;</span>
</code></pre></div></div>

<ol>
  <li>Major A
    <ol>
      <li>minor p</li>
      <li>minor q</li>
    </ol>
  </li>
  <li>Major B
    <ol>
      <li>minor r</li>
      <li>minor s</li>
    </ol>
  </li>
</ol>

<h2 id="s:htmlcss-tables">Tables</h2>

<p>Lists are a great way to get started,
but if we <em>really</em> want to impress people with our data science skills,
we need tables.
Unsurprisingly,
we use the <code class="highlighter-rouge">table</code> element to create these.
Each row is a <code class="highlighter-rouge">tr</code> (for “table row”),
and within rows,
column items are shown with <code class="highlighter-rouge">td</code> (for “table data”)
or <code class="highlighter-rouge">th</code> (for “table heading”).</p>

<div title="src/htmlcss/table.html" class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;table&gt;</span>
  <span class="nt">&lt;tr&gt;</span> <span class="nt">&lt;th&gt;</span>Alkali<span class="nt">&lt;/th&gt;</span>   <span class="nt">&lt;th&gt;</span>Noble Gas<span class="nt">&lt;/th&gt;</span> <span class="nt">&lt;/tr&gt;</span>
  <span class="nt">&lt;tr&gt;</span> <span class="nt">&lt;td&gt;</span>Hydrogen<span class="nt">&lt;/td&gt;</span> <span class="nt">&lt;td&gt;</span>Helium<span class="nt">&lt;/td&gt;</span>    <span class="nt">&lt;/tr&gt;</span>
  <span class="nt">&lt;tr&gt;</span> <span class="nt">&lt;td&gt;</span>Lithium<span class="nt">&lt;/td&gt;</span>  <span class="nt">&lt;td&gt;</span>Neon<span class="nt">&lt;/td&gt;</span>      <span class="nt">&lt;/tr&gt;</span>
  <span class="nt">&lt;tr&gt;</span> <span class="nt">&lt;td&gt;</span>Sodium<span class="nt">&lt;/td&gt;</span>   <span class="nt">&lt;td&gt;</span>Argon<span class="nt">&lt;/td&gt;</span>     <span class="nt">&lt;/tr&gt;</span>
<span class="nt">&lt;/table&gt;</span>
</code></pre></div></div>

<table>
  <tbody><tr> <th>Alkali</th>   <th>Noble Gas</th> </tr>
  <tr> <td>Hydrogen</td> <td>Helium</td>    </tr>
  <tr> <td>Lithium</td>  <td>Neon</td>      </tr>
  <tr> <td>Sodium</td>   <td>Argon</td>     </tr>
</tbody></table>

<p>Do <em>not</em> use tables to create multi-column layouts:
there’s a better way.</p>

<h2 id="s:htmlcss-links">Links</h2>

<p>Links to other pages are what makes HTML hypertext.
Confusingly,
the element used to show a link is called <code class="highlighter-rouge">a</code>.
The text inside the element is displayed and (usually) highlighted for clicking.
Its <code class="highlighter-rouge">href</code> attribute specifies what the link is pointing at;
both local filenames and URLs are supported.
Oh,
and we can use <code class="highlighter-rouge">&lt;br/&gt;</code> to force a line break in text
(with a trailing slash inside the tag, since the <code class="highlighter-rouge">br</code> element doesn’t contain any content):</p>

<div title="src/htmlcss/links.html" class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"https://nodejs.org/"</span><span class="nt">&gt;</span>Node.js<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;br/&gt;</span>
<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"https://facebook.github.io/react/"</span><span class="nt">&gt;</span>React<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;br/&gt;</span>
<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"../index.html"</span><span class="nt">&gt;</span>home page (relative path)<span class="nt">&lt;/a&gt;</span>
</code></pre></div></div>

<p>This appears as:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Node.js
React
home page (relative path)
</code></pre></div></div>

<!-- == \noindent -->
<p>with the usual clickability.</p>

<h2 id="s:htmlcss-images">Images</h2>

<p>Images can be stored inside HTML pages in two ways:
by using SVG (which we will discuss <a href="#s:vis">later</a>
or by encoding the image as text and including that text in the body of the page,
which is clever,
but makes the source of the pages very hard to read.</p>

<p>It is far more common to store each image in a separate file
and refer to that file using an <code class="highlighter-rouge">img</code> element
(which also allows us to use the image in many places without copying it).
The <code class="highlighter-rouge">src</code> attribute of the <code class="highlighter-rouge">img</code> tag specifies where to find the file;
as with the <code class="highlighter-rouge">href</code> attribute of an <code class="highlighter-rouge">a</code> element,
this can be either a URL or a local path.
Every <code class="highlighter-rouge">img</code> should also include a <code class="highlighter-rouge">title</code> attribute (whose purpose is self-explanatory)
and an <code class="highlighter-rouge">alt</code> attribute with some descriptive text to aid accessibility and search engines.</p>

<div title="src/htmlcss/images.html" class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"./html5.png"</span> <span class="na">title=</span><span class="s">"HTML5 Logo"</span> <span class="na">alt=</span><span class="s">"Displays the HTML5 logo using a local path"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"https://github.com/software-tools-in-javascript/js-vs-rc/blob/master/src/htmlcss/html5.png"</span>
     <span class="na">title=</span><span class="s">"HTML5 Logo"</span> <span class="na">alt=</span><span class="s">"Display the HTML5 logo using a URL"</span> <span class="nt">/&gt;</span>
</code></pre></div></div>

<p>Two things are worth noting here:</p>

<ol>
  <li>Since <code class="highlighter-rouge">img</code> elements don’t contain any text,
they are often written with the trailing-slash notation.
However,
they are also often written improperly as <code class="highlighter-rouge">&lt;img src="..."&gt;</code> without any slashes at all.
Browsers will understand this,
but some software packages will complain.</li>
  <li>If an image file is referred to using a path rather than a URL,
that path can be either <a href="#g:relative-path">relative</a> or <a href="#g:absolute-path">absolute</a>.
If it’s a relative path,
it’s interpreted starting from where the web page is located;
if it’s an absolute path,
it’s interpreted relative to wherever the web browser thinks the <a href="#g:root-directory">root directory</a> of the filesystem is.
As we will see <a href="#s:server">later</a>,
this can change from one installation to the next,
so you should always try to use relative paths,
except where you can’t.
It’s all very confusing…</li>
</ol>

<h2 id="s:htmlcss-css">Cascading Style Sheets</h2>

<p>When HTML first appeared, people styled elements by setting their attributes:</p>

<div title="src/htmlcss/style-with-attributes.html" class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1</span> <span class="na">align=</span><span class="s">"center"</span><span class="nt">&gt;</span>Heading is Centered<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      <span class="nt">&lt;b&gt;</span>Text<span class="nt">&lt;/b&gt;</span> can be highlighted
      or <span class="nt">&lt;font</span> <span class="na">color=</span><span class="s">"coral"</span><span class="nt">&gt;</span>colorized<span class="nt">&lt;/font&gt;</span>.
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>Many still do,
but a better way is to use <a href="#g:css">Cascading Style Sheets</a> (CSS).
These allow us to define a style once and use it many times,
which makes it much easier to maintain consistency.
(I was going to say “…and keep pages readable”,
but given how complex CSS can be,
that’s not a claim I feel I can make.)
Here’s a page that uses CSS instead of direct styling:</p>

<div title="src/htmlcss/style-with-css.html" class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"simple-style.css"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">"title"</span><span class="nt">&gt;</span>Heading is Centered<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"keyword"</span><span class="nt">&gt;</span>Text<span class="nt">&lt;/span&gt;</span> can be highlighted
      or <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"highlight"</span><span class="nt">&gt;</span>colorized<span class="nt">&lt;/span&gt;</span>.
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">head</code> contains a link to a CSS file stored in the same directory as the page itself;
we could use a URL here instead of a relative path,
but the <code class="highlighter-rouge">link</code> element <em>must</em> have the <code class="highlighter-rouge">rel="stylesheet"</code> attribute.
Inside the page,
we then set the <code class="highlighter-rouge">class</code> attribute of each element we want to style.</p>

<p>The file <code class="highlighter-rouge">simple-style.css</code> looks like this:</p>

<div title="src/htmlcss/simple-style.css" class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">h1</span><span class="nc">.title</span> <span class="p">{</span>
  <span class="nl">text-align</span><span class="p">:</span> <span class="nb">center</span><span class="p">;</span>
<span class="p">}</span>
<span class="nt">span</span><span class="nc">.keyword</span> <span class="p">{</span>
  <span class="nl">font-weight</span><span class="p">:</span> <span class="nb">bold</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.highlight</span> <span class="p">{</span>
  <span class="nl">color</span><span class="p">:</span> <span class="no">coral</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Each entry has the form <code class="highlighter-rouge">tag.class</code> followed by a group of properties inside curly braces,
and each property is a key-value pair.
We can omit the class and just write (for example):</p>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">p</span> <span class="p">{</span>
  <span class="nl">font-style</span><span class="p">:</span> <span class="nb">italic</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>in which case the style applies to everything with that tag.
If we do this,
we can override general rules with specific ones:
the style for a disclaimer paragraph is defined by <code class="highlighter-rouge">p</code> with overrides defined by <code class="highlighter-rouge">p.disclaimer</code>.
We can also omit the tag and simply use <code class="highlighter-rouge">.class</code>,
in which case every element with that class has that style.</p>

<p>As suggested by the earlier discussion of separators,
elements may have multiple values for class,
as in <code class="highlighter-rouge">&lt;span class="keyword highlight"&gt;...&lt;/span&gt;</code>.
(The <code class="highlighter-rouge">span</code> element simply marks a region of text,
but has no effect unless it’s styled.)</p>

<p>These two features are one
(but unfortunately not the only)
common source of confusion with CSS:
If one may override general rules with specific ones
but also provide multiple values for class,
how do we keep track of which rules will apply to an element with multiple classes?
A detailed discussion of the order of precedence for CSS rules
is outside the scope of this tutorial. We recommend that those
likely to work often with stylesheets read (and consider bookmarking)
<a href="https://www.w3schools.com/css/css_specificity.asp">this W3Schools page</a>.</p>

<p>One other thing CSS can do is match specific elements.
We can label particular elements uniquely within a page using the <code class="highlighter-rouge">id</code> attribute,
then refer to those elements using <code class="highlighter-rouge">#name</code> as a <a href="#g:selector">selector</a>.
For example,
if we create a page that gives two spans unique IDs:</p>

<div title="src/htmlcss/selectors.html" class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"selector-style.css"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      First <span class="nt">&lt;span</span> <span class="na">id=</span><span class="s">"major"</span><span class="nt">&gt;</span>keyword<span class="nt">&lt;/span&gt;</span>.
    <span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      Full <span class="nt">&lt;span</span> <span class="na">id=</span><span class="s">"minor"</span><span class="nt">&gt;</span>explanation<span class="nt">&lt;/span&gt;</span>.
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<!-- == \noindent -->
<p>then we can style those spans like this:</p>

<div title="src/htmlcss/selector-style.css" class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">#major</span> <span class="p">{</span>
  <span class="nl">text-decoration</span><span class="p">:</span> <span class="nb">underline</span> <span class="no">red</span><span class="p">;</span>
<span class="p">}</span>
<span class="nf">#minor</span> <span class="p">{</span>
  <span class="nl">text-decoration</span><span class="p">:</span> <span class="nb">overline</span> <span class="no">blue</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p><strong>Internal Links</strong></p>

  <p>We can also link directly to an element within a page using <code class="highlighter-rouge">#name</code>
inside the <code class="highlighter-rouge">href</code> attribute of a link.
For example,
<code class="highlighter-rouge">&lt;a href="selectors.html#major"&gt;some text&lt;/a&gt;</code> refers to the <code class="highlighter-rouge">#major</code> element in <code class="highlighter-rouge">selectors.html</code>,
while <code class="highlighter-rouge">&lt;a href="selectors.html#minor"&gt;some text&lt;/a&gt;</code> refers to the <code class="highlighter-rouge">#minor</code> element.
This is particularly useful <em>within</em> pages:
<code class="highlighter-rouge">&lt;a href="#major"&gt;jump&lt;/a&gt;</code> takes us straight to the <code class="highlighter-rouge">#major</code> element within this page.
Internal links like this are often used for cross-referencing and to create a table of contents.</p>
</blockquote>

<h2 id="s:htmlcss-bootstrap">Bootstrap</h2>

<p>CSS can become very complicated very quickly,
so most people use a framework to take care of the details.
One of the most popular is <a href="https://getbootstrap.com/">Bootstrap</a>
(which is what we’re using to style this website).
Here’s the entire source of a page that uses Bootstrap
to create a two-column layout with a banner at the top:</p>

<div title="src/htmlcss/bootstrap.html" class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;style&gt;</span>
      <span class="nt">div</span> <span class="p">{</span>
        <span class="nl">border</span><span class="p">:</span> <span class="nb">solid</span> <span class="m">1px</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="nt">&lt;/style&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>

    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"jumbotron text-center"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;h1&gt;</span>Page Title<span class="nt">&lt;/h1&gt;</span>
      <span class="nt">&lt;p&gt;</span>Resize this page to see how the layout adjusts dynamically.<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;/div&gt;</span>

    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-sm-4"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;h2&gt;</span>First column is 4 wide<span class="nt">&lt;/h2&gt;</span>
          <span class="nt">&lt;p&gt;</span>Text here goes<span class="nt">&lt;/p&gt;</span>
          <span class="nt">&lt;p&gt;</span>in the column<span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-sm-8"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;h2&gt;</span>Second column is 8 wide<span class="nt">&lt;/h2&gt;</span>
          <span class="nt">&lt;p&gt;</span>Text over here goes<span class="nt">&lt;/p&gt;</span>
          <span class="nt">&lt;p&gt;</span>in the other column<span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>The page opens by loading Bootstrap from the web;
we can also download <code class="highlighter-rouge">bootstrap.min.css</code> and refer to it with a local path.
(The <code class="highlighter-rouge">.min</code> in the file’s name signals that the file has been <a href="#g:minimization">minimized</a>
so that it will load more quickly.)</p>

<p>The page then uses a <code class="highlighter-rouge">style</code> element to create an <a href="#g:internal-style-sheet">internal style sheet</a>
to put a solid one-pixel border around every <code class="highlighter-rouge">div</code>
so that we can see the regions of the page more clearly.
Defining styles in the page header is generally a bad idea,
but it’s a good way to test things quickly.
Oh,
and a <code class="highlighter-rouge">div</code> just marks a region of a page without doing anything to it,
just as a <code class="highlighter-rouge">span</code> marks a region of text without changing its appearance
unless we apply a style.</p>

<p>The first <code class="highlighter-rouge">div</code> creates a header box (called a “jumbotron”) and centers its text.
The second <code class="highlighter-rouge">div</code> is a container,
which creates a bit of margin on the left and right sides of our content.
Inside that container is a row with two columns,
one 4/12 as wide as the row and the other 8/12 as wide.
(Bootstrap uses a 12-column system because 12 has lots of divisors.)</p>

<p>Bootstrap is <a href="#g:responsive-design">responsive</a>:
elements change size as the page grows narrower,
and are then stacked when the screen becomes too small to display them side by side.</p>

<p>We’ve left out many other aspects of HTML and CSS as well,
such as figure captions,
multi-column table cells,
and why it’s so hard to center text vertically within a <code class="highlighter-rouge">div</code>.
One thing we will return to <a href="#s:interactive">later</a> is
how to include interactive elements like buttons and forms in a page.
Handling those is part of why JavaScript was invented in the first place,
but we need more experience before tackling them.</p>

<h2 id="s:htmlcss-exercises">Exercises</h2>

<h3 id="cutting-corners">Cutting Corners</h3>

<p>What does your browser display if you forget to close a paragraph or list item tag
like this:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;p&gt;</span>This paragraph starts but doesn't officially end.

<span class="nt">&lt;p&gt;</span>Another paragraph starts here but also doesn't end.

<span class="nt">&lt;ul&gt;</span>
  <span class="nt">&lt;li&gt;</span>First item in the list isn't closed.
  <span class="nt">&lt;li&gt;</span>Neither is the second.
<span class="nt">&lt;/ul&gt;</span>
</code></pre></div></div>

<ol>
  <li>What happens if you don’t close a <code class="highlighter-rouge">ul</code> or <code class="highlighter-rouge">ol</code> list?</li>
  <li>Is that behavior consistent with what happens when you omit <code class="highlighter-rouge">&lt;/p&gt;</code> or <code class="highlighter-rouge">&lt;/li&gt;</code>?</li>
</ol>

<h3 id="mix-and-match">Mix and Match</h3>

<ol>
  <li>Create a page that contains a 2x2 table,
each cell of which has a three-item bullet-point list.
How can you reduce the indentation of the list items within their cells using CSS?</li>
  <li>Open your page in a different browser (e.g., Firefox or Edge).
Do they display your indented lists consistently?</li>
  <li>Why do programs behave inconsistently?
Why do programmers do this to us?
Why?
Why why why why why?</li>
</ol>

<h3 id="naming">Naming</h3>

<p>What does the <code class="highlighter-rouge">sm</code> in Bootstrap’s <code class="highlighter-rouge">col-sm-4</code> and <code class="highlighter-rouge">col-sm-8</code> stand for?
What other options could you use instead?
Why do web developers still use FORTRAN-style names in the 21st Century?</p>

<h3 id="color">Color</h3>

<p>HTML and CSS define names for a small number of colors.
All other colors must be specified using <a href="#g:rgb">RGB</a> values.
Write a small JavaScript program that creates an HTML page
that displays the word <code class="highlighter-rouge">color</code> in 100 different randomly-generated colors.
Compare this to the color scheme used in your departmental website.
Which one hurts your eyes less?</p>

<h3 id="units">Units</h3>

<p>What different units can you use to specify text size in CSS?
What do they mean?
What does <em>anything</em> mean, when you get right down to it?</p>


      


<div class="listblock">
  <h2>Key Points</h2>
  <ul>
    <li>HTML is the latest in a long line of markup languages.
</li><li>HTML documents contain elements (represented by tags in angle brackets) and text.
</li><li>Elements must be strictly nested.
</li><li>Elements can contain attributes.
</li><li>Use escape sequences beginning with ampersand to represent special characters.
</li><li>Every page should have one <code class="highlighter-rouge">html</code> element containing a <code class="highlighter-rouge">head</code> and a <code class="highlighter-rouge">body</code>.
</li><li>Use <code class="highlighter-rouge">&lt;!--...--&gt;</code> to include comments in HTML.
</li><li>Use <code class="highlighter-rouge">ul</code> and <code class="highlighter-rouge">ol</code> for unordered and ordered lists, and <code class="highlighter-rouge">li</code> for list elements.
</li><li>Use <code class="highlighter-rouge">table</code> for tables, <code class="highlighter-rouge">tr</code> for rows, <code class="highlighter-rouge">th</code> for headings, and <code class="highlighter-rouge">td</code> for regular data.
</li><li>Use <code class="highlighter-rouge">&lt;a href="..."&gt;...&lt;/a&gt;</code> to create links.
</li><li>Use <code class="highlighter-rouge">&lt;img src="..." title="..." alt="..." /&gt;</code> to include images.
</li><li>Use CSS to define appearance of elements.
</li><li>Use <code class="highlighter-rouge">class</code> and <code class="highlighter-rouge">id</code> to identify elements.
</li><li>Use selectors to specify the elements that CSS applies to.
</li>
  </ul>
</div>


    </div>
<div class="chapter">
      <h1 id="s:pages">Manipulating Pages</h1>
      


<div class="listblock">
  <h2>Questions</h2>
  <ul>
    <li>How can I find things in pages?
</li><li>How can I change things in pages?
</li><li>How can I interact with JavaScript in the browser?
</li>
  </ul>
</div>


      
      <p>We have presented a lot of tools, but as yet no applications.
As a reward for your patience,
we will therefore work through several examples that show
how to do useful things to web pages.
These examples introduce some new concepts,
the most important of which is the way in which HTML pages are represented in,
and manipulated by,
JavaScript.</p>

<p>One thing these examples <em>don’t</em> show is how to build interactive web pages.
JavaScript was invented primarily to support buttons, forms, and the like,
but we will need to do a bit more background work before exploring them.
Still,
we can do a surprising number of useful things
simply by playing with the content of pages.</p>

<h2 id="s:pages-counting">Counting Paragraphs</h2>

<p>Let’s begin by counting the number of paragraphs in a page:</p>

<div title="src/pages/count-paragraphs.html" class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Title<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"fill"</span><span class="nt">&gt;&lt;/div&gt;</span>
    <span class="nt">&lt;h2</span> <span class="na">id=</span><span class="s">"one"</span><span class="nt">&gt;</span>First <span class="nt">&lt;em&gt;</span>emphasized<span class="nt">&lt;/em&gt;&lt;/h2&gt;</span>
    <span class="nt">&lt;p&gt;</span>stuff<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;h2</span> <span class="na">id=</span><span class="s">"two"</span><span class="nt">&gt;</span>Second <span class="nt">&lt;code&gt;</span>with code<span class="nt">&lt;/code&gt;&lt;/h2&gt;</span>
    <span class="nt">&lt;h3&gt;</span>stuff<span class="nt">&lt;/h3&gt;</span>
    <span class="nt">&lt;h2</span> <span class="na">id=</span><span class="s">"three"</span><span class="nt">&gt;</span>Third<span class="nt">&lt;/h2&gt;</span>
    <span class="nt">&lt;p&gt;</span>stuff<span class="nt">&lt;/p&gt;</span>

    <span class="nt">&lt;script&gt;</span>
      <span class="kd">const</span> <span class="nx">counter</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">paragraphs</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">'p'</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">paragraphs</span><span class="p">.</span><span class="nx">length</span>
      <span class="p">}</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`number of paragraphs: </span><span class="p">${</span><span class="nx">counter</span><span class="p">()}</span><span class="s2">`</span><span class="p">)</span>
    <span class="nt">&lt;/script&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>This page has three main parts:</p>

<ol>
  <li>
    <p>The <code class="highlighter-rouge">head</code> contains a <code class="highlighter-rouge">meta</code> tag that specifies the page’s
<a href="#g:character-encoding">character encoding</a>,
i.e.,
the scheme used to represent characters
not found on a standard American keyboard in the 1970s.
Character sets and character encodings are out of scope for this lesson;
see <a href="https://www.joelonsoftware.com/2003/10/08/the-absolute-minimum-every-software-developer-absolutely-positively-must-know-about-unicode-and-character-sets-no-excuses/">this essay</a> for an unfortunately timeless discussion.</p>
  </li>
  <li>
    <p>The top half of the <code class="highlighter-rouge">body</code> has some headings and paragraphs
for the JavaScript to play with.
It also contains a <code class="highlighter-rouge">div</code> marked with <code class="highlighter-rouge">class="fill"</code>
that our script will eventually fill in with a count.</p>
  </li>
  <li>
    <p>The script itself is contained in a <code class="highlighter-rouge">script</code> tag at the bottom of the page;
we will explore it in depth below.</p>
  </li>
</ol>

<blockquote>
  <p><strong>When Scripts Run</strong></p>

  <p>We have put the script at the bottom of the page
because we want to be sure that the page’s contents actually exist in  memory
before trying to process them.
If we put the <code class="highlighter-rouge">script</code> tag and its contents at the top of the page,
the browser might run our JavaScript <em>after</em> the page has been read
but <em>before</em> its elements and text have been parsed and stored in memory.
<a href="#g:race-condition">Race conditions</a> like this bedevil web programming;
we will see more robust ways to deal with them later.</p>
</blockquote>

<p>Inside the <code class="highlighter-rouge">script</code> tag,
we define a function called <code class="highlighter-rouge">counter</code> that takes no arguments,
then use <code class="highlighter-rouge">console.log</code> to display the result of calling it.
The only thing inside the function that we haven’t encountered before
is the call <code class="highlighter-rouge">document.querySelectorAll('p')</code>.
As you might guess from its name,
<code class="highlighter-rouge">document</code> is an object that gives us a handle on the page the script is in;
it is created and provided automatically by the browser.
Its <code class="highlighter-rouge">querySelectorAll</code> method finds all elements in the page
that match the selector we provide.
In this case,
we’re looking for all paragraphs,
so we simply search for <code class="highlighter-rouge">'p'</code>.</p>

<p>To see the JavaScript in action,
run a browser,
open its developer tools so that you can see the JavaScript console,
and then load the page.
The page’s elements will be displayed as usual,
and the console will show:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>number of paragraphs: 2
</code></pre></div></div>

<blockquote>
  <p><strong>Developer Tools</strong></p>

  <p>If you are using the Firefox browser,
you can open the developer tools pane by going to the main menu
and selecting <code class="highlighter-rouge">Tools... Web Developer... Toggle Tools</code>.
A tabbed display will open in the bottom of your page;
choose <code class="highlighter-rouge">Console</code> to view the output of your JavaScript,
or to write a little bit to run immediately.</p>
</blockquote>

<p>Showing results in the console is good enough for development work,
but we would like to see the result in the page itself.
To do this,
we can replace the call to <code class="highlighter-rouge">console.log</code> with the two lines shown below:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">counter</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">paragraphs</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">'p'</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">paragraphs</span><span class="p">.</span><span class="nx">length</span>
<span class="p">}</span>
<span class="kd">const</span> <span class="nx">fill</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'fill'</span><span class="p">)</span>
<span class="nx">fill</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">`number of paragraphs: </span><span class="p">${</span><span class="nx">counter</span><span class="p">()}</span><span class="s2">`</span>
</code></pre></div></div>

<p>Where <code class="highlighter-rouge">document.querySelectorAll</code> returns all nodes that match a selector,
<code class="highlighter-rouge">document.getElementById</code> returns a single element that has the specified ID
(which is set inside the element’s opening tag with <code class="highlighter-rouge">id="some_name"</code>).
The variable <code class="highlighter-rouge">fill</code> is therefore assigned a reference to our <code class="highlighter-rouge">div</code>.
We can then change the text inside that element by assigning to its <code class="highlighter-rouge">innerHTML</code> property.
When we do this,
JavaScript parses the string we provided as if it were HTML
and creates whatever nodes it needs to represent the result.
In this case,
the content is just text,
so JavaScript will create a single text node,
store <code class="highlighter-rouge">"number of paragraphs: 2"</code> as its content,
and add it to the in-memory structure that represents the page.</p>

<p>…at which point some magic happens behind the scenes.
The browser stores the elements and text of the current page in a data structure called
the Document Object Model,
or more commonly, the <a href="#g:dom">DOM</a>.
Any time the browser detects a change to the DOM,
it automatically refreshes just as much of its display as it needs to.
We can insert or remove text,
change elements’ styles,
or copy in entire sub-pages:
each time,
the browser will do only the work required to reflect that change
as quickly as possible.</p>

<h2 id="s:pages-toc">Creating a Table of Contents</h2>

<p>Reporting the number of paragraphs is a good way to see how JavaScript works in the browser,
but isn’t particularly useful
(although counting the number of words is—we will tackle that in the exercises).
Something we’re more likely to put in a real page is a table of contents,
which takes only a little more code than what we’ve already seen:</p>

<div title="src/pages/create-toc.html" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">container</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'fill'</span><span class="p">)</span>
  <span class="kd">const</span> <span class="nx">headings</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">'h2'</span><span class="p">))</span>
  <span class="kd">const</span> <span class="nx">items</span> <span class="o">=</span> <span class="nx">headings</span>
        <span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">h</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="s2">`&lt;li&gt;&lt;a href="#</span><span class="p">${</span><span class="nx">h</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">"&gt;</span><span class="p">${</span><span class="nx">h</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">}</span><span class="s2">&lt;/a&gt;&lt;/li&gt;`</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
  <span class="nx">container</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">'&lt;ul&gt;'</span> <span class="o">+</span> <span class="nx">items</span> <span class="o">+</span> <span class="s1">'&lt;/ul&gt;'</span>
<span class="p">})()</span>
</code></pre></div></div>

<p>Let’s start with the first and last lines,
since they demonstrate a commonly-used idiom.
We’ve seen how to define a function and then call it:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">f</span> <span class="o">=</span> <span class="p">(</span><span class="nx">param</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// body</span>
<span class="p">}</span>
<span class="nx">f</span><span class="p">()</span>
</code></pre></div></div>

<p>If we’re only going to call the function once,
we might as well define it and call it immediately without giving it a name:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nx">param</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// body</span>
<span class="p">}(</span><span class="nx">actual_value</span><span class="p">)</span>
</code></pre></div></div>

<p>However,
this doesn’t reliably work as written;
in order to make JavaScript happy,
we have to parenthesize the function definition
so that it’s clear exactly what’s being called:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">((</span><span class="nx">param</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// body</span>
<span class="p">})(</span><span class="nx">actual_value</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">()</code> before the fat arrow means “this function doesn’t take any parameters”.
The second <code class="highlighter-rouge">()</code> after the closing curly brace means “call the function”.
If the function doesn’t take any arguments,
this becomes:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// body</span>
<span class="p">})()</span>
</code></pre></div></div>

<!-- == \noindent -->
<p>which is a lot of parentheses in a row,
but that’s what people write.</p>

<p>Let’s come back to the body of the function:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">const</span> <span class="nx">container</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'fill'</span><span class="p">)</span>
  <span class="kd">const</span> <span class="nx">headings</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">'h2'</span><span class="p">))</span>
  <span class="kd">const</span> <span class="nx">items</span> <span class="o">=</span> <span class="nx">headings</span>
        <span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">h</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="s2">`&lt;li&gt;&lt;a href="#</span><span class="p">${</span><span class="nx">h</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">"&gt;</span><span class="p">${</span><span class="nx">h</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">}</span><span class="s2">&lt;/a&gt;&lt;/li&gt;`</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
  <span class="nx">container</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">'&lt;ul&gt;'</span> <span class="o">+</span> <span class="nx">items</span> <span class="o">+</span> <span class="s1">'&lt;/ul&gt;'</span>
</code></pre></div></div>

<p>As before,
the first line gets the <code class="highlighter-rouge">div</code> we’re going to fill in.
The second line grabs all the <code class="highlighter-rouge">h2</code> headings,
which we have arbitrarily decided are the only things worthy of inclusion
in the table of contents.
We wrap the call in <code class="highlighter-rouge">document.querySelectorAll</code> with <code class="highlighter-rouge">Array.from</code>
because the former’s result isn’t actually a JavaScript array:
For reasons that probably made sense to someone, somewhere,
it’s a thing called a <code class="highlighter-rouge">NodeList</code>
that lacks most of <code class="highlighter-rouge">Array</code>’s useful methods.</p>

<p>We then have three lines that do most of the function’s work.
The first tells us that <code class="highlighter-rouge">items</code> is going to be assigned
something derived from <code class="highlighter-rouge">headings</code>;
the second transforms the array of headings into an array of strings,
and the third joins those strings to create a single string.
Looking at the <code class="highlighter-rouge">map</code> call,
each heading becomes a list item (<code class="highlighter-rouge">li</code>)
containing a link (<code class="highlighter-rouge">a</code>)
whose <code class="highlighter-rouge">href</code> attribute is the ID of the heading
and whose displayed content (the text between <code class="highlighter-rouge">&lt;a...&gt;</code> and <code class="highlighter-rouge">&lt;/a&gt;</code>)
is the text of the heading.
The <code class="highlighter-rouge">href</code> attribute’s value starts with <code class="highlighter-rouge">#</code>,
which makes this a local link
(i.e., it links to something inside the same page).
If one of our <code class="highlighter-rouge">h2</code> headings doesn’t have an <code class="highlighter-rouge">id</code> set,
this <code class="highlighter-rouge">map</code> will fail;
we’ll explore ways to handle this in the exercises.</p>

<p>Finally,
the last line of the code shown above
fills in the content of the container (i.e., the <code class="highlighter-rouge">div</code>)
with an unordered list (<code class="highlighter-rouge">ul</code>)
that contains all of the items we just constructed.
Again,
when we assign to an element’s <code class="highlighter-rouge">innerHTML</code> property,
JavaScript parses the string we give it
and constructs the HTML nodes we need.
It would be marginally faster to build these nodes ourselves
(which we will do in the exercises),
but building and parsing strings is usually easier to read,
and the performance differences are small enough in modern browsers
that we should only worry about them if they actually prove themselves a problem.</p>

<h2 id="s:pages-sort-list">Sortable Lists</h2>

<p>Creating nodes allows us to add content to a page,
but we can also rearrange the nodes that are there.
Our next exercise is to sort the elements of a list,
so that if the author writes:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;ul&gt;</span>
  <span class="nt">&lt;li&gt;</span>pee (P)<span class="nt">&lt;/li&gt;</span>
  <span class="nt">&lt;li&gt;</span>cue (Q)<span class="nt">&lt;/li&gt;</span>
  <span class="nt">&lt;li&gt;</span>are (R)<span class="nt">&lt;/li&gt;</span>
<span class="nt">&lt;/ul&gt;</span>
</code></pre></div></div>

<!-- == \noindent -->
<p>we will automatically rearrange the items to be:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;ul&gt;</span>
  <span class="nt">&lt;li&gt;</span>are (R)<span class="nt">&lt;/li&gt;</span>
  <span class="nt">&lt;li&gt;</span>cue (Q)<span class="nt">&lt;/li&gt;</span>
  <span class="nt">&lt;li&gt;</span>pee (P)<span class="nt">&lt;/li&gt;</span>
<span class="nt">&lt;/ul&gt;</span>
</code></pre></div></div>

<p>Our first attempt uses this as the HTML page:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"sort-lists.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;/head&gt;</span>

  <span class="nt">&lt;body</span> <span class="na">onload=</span><span class="s">"sortLists()"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"sorted"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;li&gt;</span>first<span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;li&gt;</span>second<span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;li&gt;</span>third<span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;li&gt;</span>fourth<span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;li&gt;</span>fifth<span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>

    <span class="nt">&lt;ol</span> <span class="na">class=</span><span class="s">"sorted"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;li&gt;</span>one<span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;li&gt;</span>two<span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;li&gt;</span>three<span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;li&gt;</span>four<span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;li&gt;</span>five<span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;/ol&gt;</span>

  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<!-- == \noindent -->
<p>and this as the script:</p>

<div title="src/pages/sort-lists.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">sortLists</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">allLists</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">'#sorted'</span><span class="p">))</span>
  <span class="nx">lists</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">list</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">children</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">list</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">c</span> <span class="o">=&gt;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">nodeName</span> <span class="o">!==</span> <span class="s1">'#text'</span><span class="p">)</span>
    <span class="nx">children</span><span class="p">.</span><span class="nx">sort</span><span class="p">((</span><span class="nx">left</span><span class="p">,</span> <span class="nx">right</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">left</span><span class="p">.</span><span class="nx">textContent</span><span class="p">.</span><span class="nx">localeCompare</span><span class="p">(</span><span class="nx">right</span><span class="p">.</span><span class="nx">textContent</span><span class="p">))</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">list</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">list</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">list</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">children</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">c</span> <span class="o">=&gt;</span> <span class="nx">list</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">c</span><span class="p">))</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>

<p>When we load the page,
though,
the items aren’t sorted.
A bit of trial and error reveals that we have tripped over the race condition alluded to earlier:
if we call our function in the <code class="highlighter-rouge">onload</code> attribute of the <code class="highlighter-rouge">body</code> tag,
it is run when the page is loaded into memory
but <em>before</em> the page’s content has been parsed and turned into a DOM tree.
After searching online for “run JavaScript when page loaded”,
we go back to this:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"sort-lists-event.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;/head&gt;</span>

  <span class="nt">&lt;body&gt;</span>
    ...lists as before...
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<!-- == \noindent -->
<p>and write our JavaScript like this:</p>

<div title="src/pages/sort-lists-event.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">sortLists</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...function to sort lists...</span>
<span class="p">}</span>

<span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">"DOMContentLoaded"</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">sortLists</span><span class="p">()</span>
<span class="p">})</span>
</code></pre></div></div>

<p>An <a href="#g:event-listener">event listener</a> is a function that the browser calls
when some kind of event occurs.
In our example,
the event we care about is “DOM content has been loaded”.
When that occurs,
the browser will call <code class="highlighter-rouge">sortLists()</code>.
(The <code class="highlighter-rouge">event</code> parameter to our function will be given an object that stores details about what precisely happened.
We don’t need that information now,
but will use it later when we start handling button clicks and the like.)</p>

<p>Let’s return to the function:</p>

<div title="src/pages/sort-lists-events.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">sortLists</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">lists</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">'.sorted'</span><span class="p">))</span>
  <span class="nx">lists</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">list</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">children</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">list</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">c</span> <span class="o">=&gt;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">nodeName</span> <span class="o">!==</span> <span class="s1">'#text'</span><span class="p">)</span>
    <span class="nx">children</span><span class="p">.</span><span class="nx">sort</span><span class="p">((</span><span class="nx">left</span><span class="p">,</span> <span class="nx">right</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">left</span><span class="p">.</span><span class="nx">textContent</span><span class="p">.</span><span class="nx">localeCompare</span><span class="p">(</span><span class="nx">right</span><span class="p">.</span><span class="nx">textContent</span><span class="p">))</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">list</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">list</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">list</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">children</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">c</span> <span class="o">=&gt;</span> <span class="nx">list</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">c</span><span class="p">))</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As before,
it starts by creating an array containing the nodes we want to operate on.
(We use the selector <code class="highlighter-rouge">.sorted</code> (with a dot <code class="highlighter-rouge">.</code>) to select everything with the class <code class="highlighter-rouge">sorted</code>,
rather than <code class="highlighter-rouge">#sorted</code>,
which would find nodes with the ID <code class="highlighter-rouge">sorted</code>.)
This array will then have all the <code class="highlighter-rouge">ul</code> or <code class="highlighter-rouge">ol</code> lists that the function is to sort.</p>

<p>We process each list separately with <code class="highlighter-rouge">lists.forEach</code>.
The callback function inside <code class="highlighter-rouge">forEach</code> creates an array containing the child nodes of the main list element,
then filters that list to remove any top-level text nodes.
We need the <code class="highlighter-rouge">Array.from</code> call because (once again) the DOM doesn’t use a JavaScript array to store children,
but a structure of its own devising that lacks the methods we want to call.
The exercises will explore why we remove the top-level text nodes with
<code class="highlighter-rouge">c.nodeName !== '#text'</code>.</p>

<blockquote>
  <p><strong>Identifying Text Nodes</strong></p>

  <p>We could check <code class="highlighter-rouge">c.nodeType</code> instead of <code class="highlighter-rouge">c.nodeName</code> to spot text nodes,
but we felt that <code class="highlighter-rouge">nodeName</code> made the code easier to understand.
Note that we use <code class="highlighter-rouge">!==</code> for the comparison
in order to prevent <a href="#s:legacy-equality">unpleasant surprises</a>.</p>
</blockquote>

<p>Now that we have an array of the <code class="highlighter-rouge">li</code> elements to be sorted,
we can use <code class="highlighter-rouge">Array.sort</code> to order them.
Since we want to sort them by the text they contain,
we have to provide our own sorting function
that returns a negative number, 0, or a positive number to show whether its <code class="highlighter-rouge">left</code> argument is less than,
equal to,
or greater than its <code class="highlighter-rouge">right</code> argument.
We use the <code class="highlighter-rouge">textContent</code> member of the node to get the text it contains,
and the string object’s <code class="highlighter-rouge">localeCompare</code> to get a -1/0/1 result.
All of this was discovered by searching online,
primarily on the <a href="https://www.w3schools.com/">W3Schools</a> site.</p>

<p>Unfortunately,
searching for “remove all children from node” tells us that we have to do it ourselves,
so we use a <code class="highlighter-rouge">while</code> loop to remove all the children
(including the unwanted top-level text elements)
from the <code class="highlighter-rouge">ul</code> or <code class="highlighter-rouge">ol</code> list,
then add all of the children back in sorted order.
Sure enough,
the page now displays the nodes in the right order.</p>

<h2 id="s:pages-citations">Bibliographic Citations</h2>

<p>And so we come to the largest example in this lesson.
HTML has a <code class="highlighter-rouge">cite</code> tag for formatting citations,
but it doesn’t allow us to link directly to a bibliography entry.
In order to minimize typing in scholarly papers,
we’d like to find links like this:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#b"</span><span class="nt">&gt;</span>key1, key2<span class="nt">&lt;/a&gt;</span>
</code></pre></div></div>

<!-- == \noindent -->
<p>and turn them into this:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"../bib/#key1"</span><span class="nt">&gt;</span>key1<span class="nt">&lt;/a&gt;</span>, <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"../bib/#key2"</span><span class="nt">&gt;</span>key2<span class="nt">&lt;/a&gt;</span>]
</code></pre></div></div>

<p>The typed-in form is about as little typing as we can get away with;
the displayed form then wraps the citations in <code class="highlighter-rouge">[...]</code>
and turns each individual citation into a link to our bibliography.
For now,
we’ll assume that the bibliography can be found at <code class="highlighter-rouge">../bib/</code>,
i.e.,
in a file called <code class="highlighter-rouge">index.html</code> that’s in a directory called <code class="highlighter-rouge">bib</code>
that’s a sibling of the directory containing whatever page the citation is in.
This is very fragile,
and we should be ashamed of ourselves,
but we can tell ourselves that we’re going to fix it later
and get on with learning JavaScript for now.</p>

<p>Here’s our test page:</p>

<div title="src/pages/citations.html" class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"citations.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>

    <span class="nt">&lt;p&gt;</span>As <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#b"</span><span class="nt">&gt;</span>Moreau1896<span class="nt">&lt;/a&gt;</span> shows...<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;p&gt;</span>We can look to <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#b"</span><span class="nt">&gt;</span>Brundle1982, Brundle1984<span class="nt">&lt;/a&gt;</span> for answers.<span class="nt">&lt;/p&gt;</span>

  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<!-- == \noindent -->
<p>and here’s our function
(which we’ll call from an event listener as before):</p>

<div title="src/pages/citations.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">citations</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">'a'</span><span class="p">))</span>
    <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">link</span> <span class="o">=&gt;</span> <span class="nx">link</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">'href'</span><span class="p">)</span> <span class="o">===</span> <span class="s1">'#b'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">link</span> <span class="o">=&gt;</span> <span class="p">({</span><span class="na">node</span><span class="p">:</span> <span class="nx">link</span><span class="p">,</span>
                   <span class="na">text</span><span class="p">:</span> <span class="nx">link</span><span class="p">.</span><span class="nx">textContent</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">','</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">s</span> <span class="o">=&gt;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">trim</span><span class="p">())}))</span>
    <span class="p">.</span><span class="nx">map</span><span class="p">(({</span><span class="nx">node</span><span class="p">,</span> <span class="nx">text</span><span class="p">})</span> <span class="o">=&gt;</span> <span class="p">({</span><span class="nx">node</span><span class="p">,</span>
                             <span class="na">text</span><span class="p">:</span> <span class="nx">text</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">cite</span> <span class="o">=&gt;</span> <span class="s2">`&lt;a href="../bib/#</span><span class="p">${</span><span class="nx">cite</span><span class="p">}</span><span class="s2">"&gt;</span><span class="p">${</span><span class="nx">cite</span><span class="p">}</span><span class="s2">&lt;/a&gt;`</span><span class="p">)}))</span>
    <span class="p">.</span><span class="nx">map</span><span class="p">(({</span><span class="nx">node</span><span class="p">,</span> <span class="nx">text</span><span class="p">})</span> <span class="o">=&gt;</span> <span class="p">({</span><span class="nx">node</span><span class="p">,</span>
                             <span class="na">text</span><span class="p">:</span> <span class="s2">`[</span><span class="p">${</span><span class="nx">text</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">', '</span><span class="p">)}</span><span class="s2">]`</span><span class="p">}))</span>
    <span class="p">.</span><span class="nx">forEach</span><span class="p">(({</span><span class="nx">node</span><span class="p">,</span> <span class="nx">text</span><span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">span</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'span'</span><span class="p">)</span>
      <span class="nx">span</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">text</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">replaceChild</span><span class="p">(</span><span class="nx">span</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span>
    <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>

<p>There is a lot going on here,
but it all uses patterns we have seen before.
It starts by building an array of all the links in the document
(i.e., every <code class="highlighter-rouge">a</code> element):</p>

<div title="src/pages/citations.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">'a'</span><span class="p">))</span>
</code></pre></div></div>

<p>We then filter this array to find the links pointing at <code class="highlighter-rouge">#b</code>,
which is what we’re using to signal citations:</p>

<div title="src/pages/citations.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">link</span> <span class="o">=&gt;</span> <span class="nx">link</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">'href'</span><span class="p">)</span> <span class="o">===</span> <span class="s1">'#b'</span><span class="p">)</span>
</code></pre></div></div>

<p>We now have a problem.
We could use a <code class="highlighter-rouge">map</code> call to get the text out of each link and process it,
but then all we’d have is an array of strings.
We’re going to want the nodes those strings came out of later on as well,
so somehow we have to pass the nodes and strings together through our pipeline.
One option would be to create a two-element array for each:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">link</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nx">link</span><span class="p">,</span> <span class="nx">link</span><span class="p">.</span><span class="nx">textContent</span><span class="p">.</span><span class="nx">whatever</span><span class="p">])</span>
</code></pre></div></div>

<!-- == \noindent -->
<p>but it’s more readable to create an object so that each component has a name:</p>

<div title="src/pages/citations.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">link</span> <span class="o">=&gt;</span> <span class="p">({</span><span class="na">node</span><span class="p">:</span> <span class="nx">link</span><span class="p">,</span>
                   <span class="na">text</span><span class="p">:</span> <span class="nx">link</span><span class="p">.</span><span class="nx">textContent</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">','</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">s</span> <span class="o">=&gt;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">trim</span><span class="p">())}))</span>
</code></pre></div></div>

<p>Here,
we are turning each link into an object whose <code class="highlighter-rouge">"node"</code> key has the link’s DOM node as its value,
and whose <code class="highlighter-rouge">"text"</code> key has the node’s text,
split on commas and with leading and trailing whitespace trimmed off.
But we’re not done looking at this stage of our pipeline:</p>

<ol>
  <li>We don’t need to quote the names <code class="highlighter-rouge">"node"</code> and <code class="highlighter-rouge">"text"</code>, though we could.</li>
  <li>JavaScript’s <code class="highlighter-rouge">String.split</code> returns an array,
so the value associated with <code class="highlighter-rouge">"text"</code> is an array.
We then <code class="highlighter-rouge">map</code> over its elements to trim leading and trailing space from each.</li>
  <li>If we wrote <code class="highlighter-rouge">link =&gt; {node: link, text: whatever}</code>,
JavaScript would interpret the curly braces <code class="highlighter-rouge">{...}</code> as meaning,
“Here is the body of a function,”
and then complain because what’s in those curly braces clearly <em>isn’t</em> a function body.
Putting parentheses around the curly braces,
i.e., writing <code class="highlighter-rouge">({...})</code>,
tells JavaScript that the function is returning an object.</li>
</ol>

<p>After all of this,
the next stage of the pipeline is almost a relief:</p>

<div title="src/pages/citations.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="p">.</span><span class="nx">map</span><span class="p">(({</span><span class="nx">node</span><span class="p">,</span> <span class="nx">text</span><span class="p">})</span> <span class="o">=&gt;</span> <span class="p">({</span><span class="nx">node</span><span class="p">,</span>
                             <span class="na">text</span><span class="p">:</span> <span class="nx">text</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">cite</span> <span class="o">=&gt;</span> <span class="s2">`&lt;a href="../bib/#</span><span class="p">${</span><span class="nx">cite</span><span class="p">}</span><span class="s2">"&gt;</span><span class="p">${</span><span class="nx">cite</span><span class="p">}</span><span class="s2">&lt;/a&gt;`</span><span class="p">)}))</span>
</code></pre></div></div>

<p>All right,
that’s not actually much of a relief,
but it does make a strange kind of sense.
First,
if we have an object whose keys are called <code class="highlighter-rouge">a</code> and <code class="highlighter-rouge">b</code>,
then the call <code class="highlighter-rouge">f({a, b})</code> means,
“Match the value of key <code class="highlighter-rouge">a</code> to a parameter called <code class="highlighter-rouge">a</code>
and the value of key <code class="highlighter-rouge">b</code> to a parameter called <code class="highlighter-rouge">b</code>.”
This is called <a href="#g:destructuring">destructuring</a>,
and can save a lot of wear and tear on our keyboard and eyes.</p>

<p>Second,
if we have a variable called <code class="highlighter-rouge">name</code>,
then define an object with <code class="highlighter-rouge">{name}</code>,
JavaScript helpfully assumes that what we mean is <code class="highlighter-rouge">{"name": name}</code>,
i.e.,
that we want a key called <code class="highlighter-rouge">"name"</code>
with whatever value <code class="highlighter-rouge">name</code> currently has.
This allows us to pass the value of <code class="highlighter-rouge">node</code> from call to call in our pipeline
without typing anything more than its name.</p>

<p>And after all of <em>this</em>,
the <code class="highlighter-rouge">text.map</code> call actually <em>is</em> a relief.
The value associated with the key <code class="highlighter-rouge">text</code> is an array of strings,
each of which is a bibliography key.
All the <code class="highlighter-rouge">map</code> does is convert each to the text we want:
a link that refers to <code class="highlighter-rouge">../bib/#citation_key</code> and whose displayed text is also the citation key.</p>

<p>On to the next stage,
which simply joins the string in <code class="highlighter-rouge">text</code> together to create a single string
with commas between the entries:</p>

<div title="src/pages/citations.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="p">.</span><span class="nx">map</span><span class="p">(({</span><span class="nx">node</span><span class="p">,</span> <span class="nx">text</span><span class="p">})</span> <span class="o">=&gt;</span> <span class="p">({</span><span class="nx">node</span><span class="p">,</span>
                             <span class="na">text</span><span class="p">:</span> <span class="s2">`[</span><span class="p">${</span><span class="nx">text</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">', '</span><span class="p">)}</span><span class="s2">]`</span><span class="p">}))</span>
</code></pre></div></div>

<p>The last stage in our pipeline uses <code class="highlighter-rouge">forEach</code> instead of <code class="highlighter-rouge">map</code>
because we want to do something for each element of the array,
but don’t need a value returned
(because what we’re doing has the side effect of modifying the document):</p>

<div title="src/pages/citations.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="p">.</span><span class="nx">forEach</span><span class="p">(({</span><span class="nx">node</span><span class="p">,</span> <span class="nx">text</span><span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">span</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'span'</span><span class="p">)</span>
      <span class="nx">span</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">text</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">replaceChild</span><span class="p">(</span><span class="nx">span</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span>
    <span class="p">})</span>
</code></pre></div></div>

<p>This is the point at which carrying the node itself forward through the pipeline pays off.
We create a <code class="highlighter-rouge">span</code> element,
fill it in by assigning to its <code class="highlighter-rouge">innerHTML</code> property,
and then replace the original link node with the node we have just created.
If we now load our page,
we see our citations formatted as we desired.</p>

<h2 id="s:pages-clock">A Real-time Clock</h2>

<p>We will wrap up this lesson with an example that is short,
but hints at the possibilities to come:</p>

<div title="src/pages/clock.html" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">html</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="nx">head</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>
      <span class="kd">const</span> <span class="nx">startTime</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">today</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
        <span class="kd">const</span> <span class="nx">fields</span> <span class="o">=</span> <span class="p">[</span><span class="nx">today</span><span class="p">.</span><span class="nx">getHours</span><span class="p">(),</span>
                        <span class="nx">today</span><span class="p">.</span><span class="nx">getMinutes</span><span class="p">(),</span>
                        <span class="nx">today</span><span class="p">.</span><span class="nx">getSeconds</span><span class="p">()]</span>
        <span class="kd">const</span> <span class="nx">current</span> <span class="o">=</span> <span class="nx">fields</span>
              <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">t</span> <span class="o">=&gt;</span> <span class="s2">`</span><span class="p">${</span><span class="nx">t</span><span class="p">}</span><span class="s2">`</span><span class="p">.</span><span class="nx">padStart</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">))</span>
              <span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">':'</span><span class="p">)</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'current'</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">current</span>
        <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">startTime</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
      <span class="p">}</span>

      <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">"DOMContentLoaded"</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">startTime</span><span class="p">()</span>
      <span class="p">})</span>
    <span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span>  <span class="o">&lt;</span><span class="sr">/head</span><span class="err">&gt;
</span>
  <span class="o">&lt;</span><span class="nx">body</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">p</span> <span class="nx">id</span><span class="o">=</span><span class="s2">"current"</span><span class="o">&gt;&lt;</span><span class="sr">/p</span><span class="err">&gt;
</span>  <span class="o">&lt;</span><span class="sr">/body</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/html</span><span class="err">&gt;
</span></code></pre></div></div>

<p>Defining a function: check.
Calling that function when the DOM is ready: check.
What about inside the function?
It’s pretty easy to guess that <code class="highlighter-rouge">Date()</code> creates an object that holds a date,
and from the fact that we’re assigning that object to a variable called <code class="highlighter-rouge">today</code>,
you might even guess that if we don’t specify which date we want,
we get today’s values.
We then pull the hours, minutes, and seconds out of the date and put them in an array
so that we can turn each value into a two-character string,
padded with a leading zero if necessary,
and then join those strings to create a time like <code class="highlighter-rouge">17:48:02</code>
to stuff into the element whose ID is <code class="highlighter-rouge">current</code>.</p>

<p>But what does <code class="highlighter-rouge">setTimeout</code> do?
It tells the browser to run a function after some number of milliseconds have passed.
In this case,
we’re running the same function <code class="highlighter-rouge">startTime</code> a second from now.
That call will change the displayed time,
then set up another callback to run a second later,
and so on forever.
When we load the page,
we see the current time updating itself second by second
to remind us just how quickly life is passing by.</p>

<h2 id="s:pages-exercises">Exercises</h2>

<h3 id="what-encoding-is-this">What Encoding Is This?</h3>

<ol>
  <li>Write a function that looks up the character encoding of the page the script is in
and prints it to the console.</li>
  <li>Extend the function to look up all the <code class="highlighter-rouge">meta</code> tags in the current page
and print their names and values.</li>
</ol>

<h3 id="word-count">Word Count</h3>

<ol>
  <li>Write a function called <code class="highlighter-rouge">countWords</code> that finds all the text nodes in a page,
splits them on white space,
and returns the total number of words in the page.</li>
  <li>Write a second function called <code class="highlighter-rouge">showWords</code> that uses the first to find the number of words,
then displays that number in a paragraph whose ID is <code class="highlighter-rouge">wordcount</code>.</li>
</ol>

<h3 id="removing-text-nodes">Removing Text Nodes</h3>

<p>In the example that sorts the items in lists,
we remove all the text nodes from the list of child nodes before sorting.
Why?
What happens if remove the line:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>          <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">c</span> <span class="o">=&gt;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">nodeName</span> <span class="o">!==</span> <span class="s1">'#text'</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="a-more-robust-table-of-contents">A More Robust Table of Contents</h3>

<p>Modify the table of contents example so that if an <code class="highlighter-rouge">h2</code> heading doesn’t have an <code class="highlighter-rouge">id</code>,
it is still included in the table of contents.</p>

<h3 id="explicitly-creating-nodes">Explicitly Creating Nodes</h3>

<p>Find documentation online for <code class="highlighter-rouge">document.createElement</code> and <code class="highlighter-rouge">document.createTextNode</code>,
then rewrite the table of contents example to use these methods
(and any others like them that you need)
instead of assigning to a node’s <code class="highlighter-rouge">innerHTML</code> property.</p>


      


<div class="listblock">
  <h2>Key Points</h2>
  <ul>
    <li>Use a <code class="highlighter-rouge">meta</code> tag in a page’s header to specify the page’s character encoding.
</li><li>Pages are represented in memory using a Document Object Model (DOM).
</li><li>The <code class="highlighter-rouge">document</code> object represents the page a script is in.
</li><li>Use the <code class="highlighter-rouge">querySelectorAll</code> method to find DOM nodes that match a condition.
</li><li>Assign HTML text to a node’s <code class="highlighter-rouge">innerHTML</code> property to change the node’s content.
</li><li>Use <code class="highlighter-rouge">((params) =&gt; {...})(arguments)</code> to create and call a function in a single step.
</li><li>An event listener is a function run by the browser when some specific event occurs.
</li><li>Create an event listener for <code class="highlighter-rouge">'DOMContentLoaded'</code> to trigger execution of scripts <em>after</em> the DOM has been constructed.
</li><li>Check the <code class="highlighter-rouge">nodeType</code> or <code class="highlighter-rouge">nodeName</code> property of a DOM node to find out what kind of node it is.
</li><li>Destructuring assignment allows us to assign to multiple variables by name in a single statement.
</li><li>Use <code class="highlighter-rouge">setTimeout</code> to trigger execution of a function after a delay.
</li><li>To make something run forever, have the function called by <code class="highlighter-rouge">setTimeout</code> set another timeout of the same function.
</li>
  </ul>
</div>


    </div>
<div class="chapter">
      <h1 id="s:dynamic">Dynamic Pages</h1>
      


<div class="listblock">
  <h2>Questions</h2>
  <ul>
    <li>What JavaScript libraries should I use to create a web pages?
</li><li>How can I use them to create basic HTML elements?
</li><li>How can I style those pages?
</li><li>How can I mix my JavaScript with HTML?
</li><li>How can I create reusable components for building web pages?
</li><li>How can separate my code into multiple files to make it more manageable?
</li>
  </ul>
</div>


      
      <p>In the beginning,
people created HTML pages by typing them in (just as we have been doing).
They quickly realized that a lot of pages share a lot of content:
navigation menus, contact info, and so on.
The nearly universal response was to create a <a href="#g:template">template</a>
and embed commands to include other snippets of HTML (like headers)
and loop over data structures to create lists and tables.
This is called <a href="#g:server-page-gen">server-side page generation</a>:
the HTML is generated on the <a href="#g:server">server</a>,
and it was popular because that’s where the data was,
and that was the only place complex code could be run.
(This tutorial uses a templating tool called <a href="https://jekyllrb.com/">Jekyll</a>.
It’s clumsy and limited, but it’s the default on <a href="http://github.com/">GitHub</a>.)</p>

<p>Server-side generation can be done statically or dynamically,
i.e.,
pages can be compiled once, stored on disk, and served thereafter,
or each page can be recompiled whenever it’s needed
(which makes it easy to include dynamic elements like today’s top news story):</p>

<figure id="f:dynamic-alternatives"> <img src="../../files/dynamic-alternatives.svg"> <figcaption>Page Generation Alternatives</figcaption> </figure>

<p>As browsers and JavaScript became more powerful,
the balance shifted toward <a href="#g:client-page-gen">client-side page generation</a>.
In this model,
the browser fetches data from one or more servers
and feeds that data to a JavaScript library that generates HTML in the browser for display.
This allows the <a href="#g:client">client</a> to decide how best to render data,
which is increasingly important as phones and tablets take over
from desktop and laptop computers.
It also moves the computational burden off the server
and onto the client device,
which lowers the cost of providing data.</p>

<p>Many, many JavaScript frameworks for client-side page generation have been created,
and more are probably being developed right now.
We have chosen <a href="https://reactjs.org/">React</a> because it is freely available,
widely used,
well documented,
simpler than many alternatives,
and has a cool logo.
Its central design principles are:</p>

<ol>
  <li>Page creators use functions to describe the HTML they want.</li>
  <li>They then let React decide which functions to run when data changes.</li>
</ol>

<p>We will show how to use it in pure JavaScript,
then introduce a tool called JSX that simplifies things.</p>

<h2 id="s:dynamic-hello">Hello, World</h2>

<p>Let’s begin by saying hello:</p>

<div title="src/dynamic/hello-react.html" class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>Hello React<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://fb.me/react-15.0.1.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://fb.me/react-dom-15.0.1.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"app"</span><span class="nt">&gt;</span>
      <span class="c">&lt;!-- this is filled in --&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;script&gt;</span>
      <span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span>
        <span class="nx">React</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">h1</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="s2">"Hello React"</span><span class="p">),</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"app"</span><span class="p">)</span>
      <span class="p">)</span>
    <span class="nt">&lt;/script&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">head</code> of the page loads two React libraries from the web;
we will use locally-installed libraries later.
The <code class="highlighter-rouge">body</code> contains a <code class="highlighter-rouge">div</code> with an ID to make it findable.
When our script runs,
React will put the HTML it generates into this <code class="highlighter-rouge">div</code>.</p>

<p>The script itself create an <code class="highlighter-rouge">h1</code> with the text “Hello, React” using <code class="highlighter-rouge">React.DOM.h1</code>,
then finds the document element whose ID is <code class="highlighter-rouge">"app"</code>
and uses <code class="highlighter-rouge">ReactDOM.render</code> to insert the former into the latter.
This alters the representation of the page in memory,
not the source of the page on disk;
if we want to inspect the HTML,
we have to do so in the browser.
Finally,
we put the script at the bottom of the page
so that the browser will have turned the HTML into a DOM tree in memory
before the script runs.
We will come back and fix this later.</p>

<blockquote>
  <p><strong>Inspection Tools</strong></p>

  <p>If you are using the Firefox browser,
you can open the developer tools pane by going to the main menu
and selecting <code class="highlighter-rouge">Tools... Web Developer... Toggle Tools</code>.
A tabbed display will open in the bottom of your page;
choose <code class="highlighter-rouge">Inspector</code> to view the content of your page and page’s CSS.
As you move your mouse around the page itself,
corresponding structural elements will be highlighted.
It’s actually pretty cool…</p>
</blockquote>

<p>The first parameter to <code class="highlighter-rouge">React.DOM.h1</code> is <code class="highlighter-rouge">null</code> in the example above,
but it can more generally be an object that specifies
the attributes we want the newly-created node to have.
There are a few quirks in this—for example,
we have to use <code class="highlighter-rouge">fontStyle</code> rather than <code class="highlighter-rouge">font-style</code>
so that the attribute object’s keys look like legal JavaScript variables—but
the mechanism is surprisingly easy to use:</p>

<div title="src/dynamic/stylish.html" class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"app"</span><span class="nt">&gt;&lt;/div&gt;</span>
    <span class="nt">&lt;script&gt;</span>
      <span class="kd">const</span> <span class="nx">attributes</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'style'</span><span class="p">:</span> <span class="p">{</span>
          <span class="s1">'background'</span><span class="p">:</span> <span class="s1">'pink'</span><span class="p">,</span>
          <span class="s1">'fontStyle'</span><span class="p">:</span> <span class="s1">'italic'</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span>
        <span class="nx">React</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">h1</span><span class="p">(</span><span class="nx">attributes</span><span class="p">,</span> <span class="s2">"Hello Stylish"</span><span class="p">),</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"app"</span><span class="p">)</span>
      <span class="p">)</span>
    <span class="nt">&lt;/script&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
</code></pre></div></div>

<h2 id="s:dynamic-jsx">JSX</h2>

<p>Writing nested functions is a clumsy way to write HTML,
so most React programmers use a tool called <a href="https://reactjs.org/docs/introducing-jsx.html">JSX</a>
that translates HTML into JavaScript function calls.
And yes,
those JavaScript function calls then produce HTML—it’s a funny world.
Here’s an example:</p>

<div title="src/dynamic/hello-jsx.html" class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>Hello JSX<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://fb.me/react-15.0.1.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://fb.me/react-dom-15.0.1.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://unpkg.com/babel-standalone@6/babel.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"app"</span><span class="nt">&gt;&lt;/div&gt;</span>
    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/babel"</span><span class="nt">&gt;</span>
      <span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span>
        <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Hello</span> <span class="nx">JSX</span><span class="o">&lt;</span><span class="sr">/h1&gt;</span><span class="err">,
</span>        <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'app'</span><span class="p">)</span>
      <span class="p">)</span>
    <span class="nt">&lt;/script&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>Along with the two React libraries,
this page includes a tool called <a href="https://babeljs.io/">Babel</a>
to translate a mixed of HTML and JavaScript into pure JavaScript.
To trigger translation,
we add the attribute <code class="highlighter-rouge">type="text/babel"</code> to the <code class="highlighter-rouge">script</code> tag.</p>

<p>Why bother?
Because as the example above shows,
it allows us to write <code class="highlighter-rouge">&lt;h1&gt;Hello JSX&lt;/h1&gt;</code> instead of calling a function.
More generally,
JSX lets us put JavaScript inside our HTML (inside our JavaScript (inside our HTML)),
so we can (for example) use <code class="highlighter-rouge">map</code> to turn a list of strings into an HTML list:</p>

<div title="src/dynamic/jsx-list.html" class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>JSX List<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"app"</span><span class="nt">&gt;&lt;/div&gt;</span>
    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/babel"</span><span class="nt">&gt;</span>
      <span class="kd">const</span> <span class="nx">allNames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'McNulty'</span><span class="p">,</span> <span class="s1">'Jennings'</span><span class="p">,</span> <span class="s1">'Snyder'</span><span class="p">,</span> <span class="s1">'Meltzer'</span><span class="p">,</span> <span class="s1">'Bilas'</span><span class="p">,</span> <span class="s1">'Lichterman'</span><span class="p">]</span>
      <span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span>
        <span class="o">&lt;</span><span class="nx">ul</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">allNames</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">name</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="o">&lt;</span><span class="nx">li</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">name</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/li&gt; </span><span class="se">)</span><span class="sr">}&lt;/</span><span class="nx">ul</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'app'</span><span class="p">)</span>
      <span class="p">)</span>
    <span class="nt">&lt;/script&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
</code></pre></div></div>

<p>We have to use <code class="highlighter-rouge">map</code> rather than a loop because whatever code we run has to return something
that can be inserted into the DOM,
and <code class="highlighter-rouge">for</code> loops don’t return anything.
(We could use a loop to build up a string through repeated concatenation,
but <code class="highlighter-rouge">map</code> is cleaner.)
And note: we must return exactly one node,
because this is one function call.
We will look in the exercises at why the curly braces immediately inside the <code class="highlighter-rouge">&lt;ul&gt;</code> element are necessary.</p>

<p>Note also that when we run this,
the browser console will warn us that each list element ought to have a unique <code class="highlighter-rouge">key</code> property,
because React wants each element of the page to be selectable.
We will add this later.</p>

<h2 id="s:dynamic-components">Creating Components</h2>

<p>One of the most powerful features of React is that it lets us create new components
that look like custom HTML tags,
but are associated with functions that we write.
React requires the names of these components to start with a capital letter
to differentiate them from regular tags.
We can,
for example,
define a function <code class="highlighter-rouge">ListOfNames</code> to generate our list of names,
then put that element directly in <code class="highlighter-rouge">ReactDOM.Render</code>
just as we would put an <code class="highlighter-rouge">h1</code> or <code class="highlighter-rouge">p</code>:</p>

<div title="src/dynamic/create-components.html" class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Create Component<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"app"</span><span class="nt">&gt;&lt;/div&gt;</span>
    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/babel"</span><span class="nt">&gt;</span>
      <span class="kd">const</span> <span class="nx">allNames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'McNulty'</span><span class="p">,</span> <span class="s1">'Jennings'</span><span class="p">,</span> <span class="s1">'Snyder'</span><span class="p">,</span> <span class="s1">'Meltzer'</span><span class="p">,</span> <span class="s1">'Bilas'</span><span class="p">,</span> <span class="s1">'Lichterman'</span><span class="p">]</span>

      <span class="kd">const</span> <span class="nx">ListOfNames</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="o">&lt;</span><span class="nx">ul</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">allNames</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">name</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="o">&lt;</span><span class="nx">li</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">name</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/li&gt; </span><span class="se">)</span><span class="sr">}&lt;/</span><span class="nx">ul</span><span class="o">&gt;</span><span class="p">)</span>
      <span class="p">}</span>

      <span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span>
        <span class="o">&lt;</span><span class="nx">ListOfNames</span> <span class="o">/&gt;</span><span class="p">,</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'app'</span><span class="p">)</span>
      <span class="p">)</span>
    <span class="nt">&lt;/script&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
</code></pre></div></div>

<p>What we really want to do,
though,
is pass parameters to these components:
after all,
JSX is turning them into functions,
and functions are far more useful when we can give them data.
In React,
all the attributes we put inside the component’s tag
are passed to our function in a single <code class="highlighter-rouge">props</code> object:</p>

<div title="src/dynamic/pass-parameters.html" class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Pass Parameters<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"app"</span><span class="nt">&gt;&lt;/div&gt;</span>
    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/babel"</span><span class="nt">&gt;</span>
      <span class="kd">const</span> <span class="nx">allNames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'McNulty'</span><span class="p">,</span> <span class="s1">'Jennings'</span><span class="p">,</span> <span class="s1">'Snyder'</span><span class="p">,</span> <span class="s1">'Meltzer'</span><span class="p">,</span> <span class="s1">'Bilas'</span><span class="p">,</span> <span class="s1">'Lichterman'</span><span class="p">]</span>

      <span class="kd">const</span> <span class="nx">ListElement</span> <span class="o">=</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="o">&lt;</span><span class="nx">li</span> <span class="nx">id</span><span class="o">=</span><span class="s2">"{props.name}"</span><span class="o">&gt;&lt;</span><span class="nx">em</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">props</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/em&gt;&lt;/</span><span class="nx">li</span><span class="o">&gt;</span><span class="p">)</span>

      <span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span>
        <span class="o">&lt;</span><span class="nx">ul</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">allNames</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">name</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="o">&lt;</span><span class="nx">ListElement</span> <span class="nx">name</span><span class="o">=</span><span class="p">{</span><span class="nx">name</span><span class="p">}</span> <span class="sr">/&gt; </span><span class="se">)</span><span class="sr">}&lt;/</span><span class="nx">ul</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'app'</span><span class="p">)</span>
      <span class="p">)</span>
    <span class="nt">&lt;/script&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
</code></pre></div></div>

<p>If you look carefully,
you’ll see that the <code class="highlighter-rouge">name</code> attribute passed to the use of <code class="highlighter-rouge">ListElement</code>
becomes the value of <code class="highlighter-rouge">prop.names</code> inside the function that implements <code class="highlighter-rouge">ListElement</code>.
This gives us exactly one logical place to do calculations, set style, etc.</p>

<h2 id="s:dynamic-parcel">Developing with Parcel</h2>

<p>Putting all of the source for an application in one HTML file is a bad practice,
but we’ve already seen the race conditions that can arise when we load JavaScript in a page’s header.
And what about <code class="highlighter-rouge">require</code> statements?
The browser will try to load the required files when those statements run,
but who is going to serve them?</p>

<p>The solution is use a <a href="#g:bundler">bundler</a> to combine everything into one big file,
and to run a <a href="#g:local-server">local server</a> to preview our application during development.
However,
this solution brings with it another problem:
which bundler to choose?
As with front-end frameworks,
there are many to choose from,
and new ones are being added almost weekly.
<a href="https://webpack.js.org/">Webpack</a> is probably the most widely used,
but it is rather complex,
so we will use <a href="https://parceljs.org/">Parcel</a>,
which is younger and therefore not yet bloated
(but give it time).</p>

<p>To install Parcel, run:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm <span class="nb">install </span>parcel-bundler
</code></pre></div></div>

<p>Once it’s in place,
we can tell it to run one of our test pages like this:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>node_modules/.bin/parcel serve <span class="nt">-p</span> 4000 src/dynamic/pass-parameters.html
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Server running at http://localhost:4000
+ Built in 128ms.
</code></pre></div></div>

<p>This works because when NPM installs a library in a project’s <code class="highlighter-rouge">node_modules</code> directory,
it will sometimes put a runnable script associated with that library in <code class="highlighter-rouge">node_modules/.bin</code>
(note that it’s <code class="highlighter-rouge">.bin</code> with a leading <code class="highlighter-rouge">.</code>, not <code class="highlighter-rouge">bin</code>).
When we ask Parcel to serve up an application, it:</p>

<ul>
  <li>looks in the named file to find JavaScript,</li>
  <li>looks recursively at what that file loads,</li>
  <li>copies some files into a directory called <code class="highlighter-rouge">./dist</code> (which stands for “distribution”), and</li>
  <li>serves the application out of there.</li>
</ul>

<p>Parcel also caches things in <code class="highlighter-rouge">./.cache</code> so that it doesn’t need to do redundant work;
both directories are normally added to <code class="highlighter-rouge">.gitignore</code>.
To learn more about Parcel, see <a href="https://medium.com/codingthesmartway-com-blog/getting-started-with-parcel-197eb85a2c8c">Sebastian Eschweiler’s quick tutorial</a>.</p>

<p>It’s very common to put tasks like “run my application” into NPM’s <code class="highlighter-rouge">package.json</code> file,
just as older programmers would put frequently-used commands into a project’s Makefile.
Look for the section in <code class="highlighter-rouge">package.json</code> whose key is <code class="highlighter-rouge">"scripts"</code> and add this:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="s2">"scripts"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">"dev"</span><span class="p">:</span> <span class="s2">"parcel serve -p 4000"</span><span class="p">,</span>
    <span class="p">...</span>
  <span class="p">},</span>
</code></pre></div></div>

<p>We can now use <code class="highlighter-rouge">npm run dev -- src/dynamic/pass-parameters.html</code>,
since everything after <code class="highlighter-rouge">--</code> is passed to the script being run.
This doesn’t just save us typing;
it also gives other developers a record of how to use the project.
Unfortunately,
there is no standard way to add comments to a JSON file…</p>

<blockquote>
  <p><strong>Whoops</strong></p>

  <p>Note:
if we accidentally specify the name of a directory like <code class="highlighter-rouge">src/dynamic</code>
instead of the name of an HTML file,
Parcel prints an error on the console saying “no entries found”.
This happens because it is trying to read the actual directory structure
as if it were a file.</p>
</blockquote>

<h2 id="s:dynamic-multiple">Multiple Files</h2>

<p>Now that we can bundle things up,
let’s move our JSX into <code class="highlighter-rouge">app.js</code> and load that in the <code class="highlighter-rouge">head</code> of the page:</p>

<div title="src/dynamic/hello-separate/index.html" class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>Hello Separate<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://fb.me/react-15.0.1.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://fb.me/react-dom-15.0.1.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://unpkg.com/babel-standalone@6/babel.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"app.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Hello Separate<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"app"</span><span class="nt">&gt;&lt;/div&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>For now,
the JavaScript in <code class="highlighter-rouge">app.js</code> is:</p>

<div title="src/dynamic/hello-separate/app.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span>
  <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">Rendered</span> <span class="nx">by</span> <span class="nx">React</span><span class="o">&lt;</span><span class="sr">/p&gt;</span><span class="err">,
</span>  <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"app"</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div></div>

<p>When we load this page we get the <code class="highlighter-rouge">h1</code> title but <em>not</em> the paragraph.
When we look in the browser console,
we see the message:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error: _registerComponent(...): Target container is not a DOM element.
</code></pre></div></div>

<p>This is the same race condition that has bitten us before.
After sighing in frustration and making ourselves another cup of tea,
we decide that,
to keep things simple,
we will load the script in the body of the page:</p>

<div title="src/dynamic/hello-bottom/index.html" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;!</span><span class="nx">DOCTYPE</span> <span class="nx">html</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">html</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="nx">head</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">meta</span> <span class="nx">charset</span><span class="o">=</span><span class="s2">"utf-8"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">title</span><span class="o">&gt;</span><span class="nx">Hello</span> <span class="nx">Bottom</span><span class="o">&lt;</span><span class="sr">/title</span><span class="err">&gt;
</span>  <span class="o">&lt;</span><span class="sr">/head</span><span class="err">&gt;
</span>  <span class="o">&lt;</span><span class="nx">body</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Hello</span> <span class="nx">Bottom</span><span class="o">&lt;</span><span class="sr">/h1</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s2">"app"</span><span class="o">&gt;&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">script</span> <span class="nx">src</span><span class="o">=</span><span class="s2">"./app.js"</span><span class="o">&gt;&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span>  <span class="o">&lt;</span><span class="sr">/body</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/html</span><span class="err">&gt;
</span></code></pre></div></div>

<p>More importantly,
we will rewrite <code class="highlighter-rouge">app.js</code> so that it loads the libraries it needs,
because there’s no guarantee that libraries loaded in <code class="highlighter-rouge">head</code> will be available when <code class="highlighter-rouge">app.js</code> runs:</p>

<div title="src/dynamic/hello-bottom/app.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">React</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'react'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">ReactDOM</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'react-dom'</span><span class="p">)</span>

<span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span>
  <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">Rendered</span> <span class="nx">by</span> <span class="nx">React</span><span class="o">&lt;</span><span class="sr">/p&gt;</span><span class="err">,
</span>  <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'app'</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div></div>

<p>We don’t have to shut down the server and restart it every time we make changes like this,
because Parcel watches for changes in files and relaunches itself as needed.
Each time it does so,
it looks at the libraries <code class="highlighter-rouge">app.js</code> loads and rebundles what it needs:
right now,
for example,
<code class="highlighter-rouge">dist/app.ef6b320b.js</code> is 19930 lines long.</p>

<p>A more modern option than loading in the bottom is to add the <code class="highlighter-rouge">async</code> attribute to the script in the head of the page,
which tells the browser not to do anything with the JavaScript until the page has finished building:</p>

<div title="src/dynamic/hello-parcel/index.html" class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>Hello Parcel<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"./app.js"</span> <span class="na">async</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"app"</span><span class="nt">&gt;&lt;/div&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<h2 id="s:dynamic-exercises">Exercises</h2>

<h3 id="those-damn-curly-braces">Those Damn Curly Braces</h3>

<p>Our list-building example includes this line of code:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="o">&lt;</span><span class="nx">ul</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">allNames</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">name</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="o">&lt;</span><span class="nx">li</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">name</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/li&gt; </span><span class="se">)</span><span class="sr">}&lt;/</span><span class="nx">ul</span><span class="o">&gt;</span><span class="p">,</span>
</code></pre></div></div>

<p>Why are the curly braces immediately inside the <code class="highlighter-rouge">&lt;ul&gt;</code> element necessary?
What happens if you take them out?</p>

<h3 id="real-data">Real Data</h3>

<ol>
  <li>Create a file called <code class="highlighter-rouge">programmers.js</code> that defines
a list of JSON objects called <code class="highlighter-rouge">programmers</code>
with <code class="highlighter-rouge">firstName</code> and <code class="highlighter-rouge">lastName</code> fields for our programmers.
(You can search the Internet to find their names.)</li>
  <li>Load that file in your page like any other JavaScript file.</li>
  <li>Delete the list <code class="highlighter-rouge">allNames</code> from the application
and modify it to use data from the list <code class="highlighter-rouge">programmers</code> instead.</li>
</ol>

<p>Loading constant data like this is a common practice during testing.</p>

<h3 id="ordering">Ordering</h3>

<p>What happens if you change the order in which the JavaScript files
are loaded in your web page?
For example,
what happens if you load <code class="highlighter-rouge">app.js</code> <em>before</em> you load <code class="highlighter-rouge">ListElement.js</code>?</p>

<h3 id="multiple-targets">Multiple Targets</h3>

<p>What happens if your HTML page contains two <code class="highlighter-rouge">div</code> elements with <code class="highlighter-rouge">id="app"</code>?</p>

<h3 id="creating-a-component-for-names">Creating a Component for Names</h3>

<p>Create a new React component that renders a name,
and modify the example to use it instead of always displaying names in <code class="highlighter-rouge">&lt;li&gt;</code> elements.</p>

<h3 id="striping">Striping</h3>

<p>Suppose we want to render every second list element in italics.
(This would be a horrible design,
but once we start creating tables,
we might want to highlight alternate rows in different background colors
to make it easier to read.)
Modify the application so that
even-numbered list elements are <code class="highlighter-rouge">&lt;li&gt;{name}&lt;/li&gt;</code>
and odd-numbered list elements are <code class="highlighter-rouge">&lt;li&gt;&lt;em&gt;{name}&lt;/em&gt;&lt;/li&gt;</code>.
(You may want to use the fact that a <code class="highlighter-rouge">map</code> callback can have two parameters
instead of one.)</p>


      


<div class="listblock">
  <h2>Key Points</h2>
  <ul>
    <li>Older dynamic web sites generated pages on the server.
</li><li>Newer dynamic web sites generate pages in the client.
</li><li>React is a JavaScript library for client-side page generation that represents HTML elements as function calls.
</li><li>React replaces page elements with dynamically-generated content in memory (not on disk).
</li><li>React functions can be customized with elements.
</li><li>JSX translates HTML into React function calls so that HTML and JavaScript can be mixed freely.
</li><li>Use Babel to translate JSX into JavaScript in the browser.
</li><li>Define new React components with a pseudo-HTML element and a corresponding function.
</li><li>Attributes to pseudo-HTML are passed to the JavaScript function as a <code class="highlighter-rouge">props</code> object.
</li>
  </ul>
</div>


    </div>
<div class="chapter">
      <h1 id="s:vis">Visualizing Data</h1>
      


<div class="listblock">
  <h2>Questions</h2>
  <ul>
    <li>How can I visualize data on the web?
</li><li>How does loading libraries in the browser differ from loading them on the server?
</li>
  </ul>
</div>


      
      <p>Tables and lists are great, but visualizations are often more effective—if
they’re well designed and your audience is sighted, that is.
There are even more ways to visualize data in the browser
than there are front-end toolkits for JavaScript.
We have chosen to use <a href="http://vega.github.io/">Vega-Lite</a>,
which is a <a href="#g:declarative">declarative</a> framework:
as a user,
you specify the data and settings,
and let the library take care of everything else.
It doesn’t do everything,
but it does common things well and easily,
and it interacts nicely with React.</p>

<h2 id="s:vis-vega-lite">Vega-Lite</h2>

<p>Let’s start by creating a skeleton web page to hold our visualization.
For now, we will load Vega, Vega-Lite, and Vega-Embed from the web;
we’ll worry about local installation later.
We will create a <code class="highlighter-rouge">div</code> to be filled in by the visualization—we
don’t have to give it the ID <code class="highlighter-rouge">vis</code>, but it’s common to do so—and
we will leave space for the script.
Our skeleton looks like this:</p>

<div title="src/vis/vega-skeleton.html" class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;title&gt;</span>Embedding Vega-Lite<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://cdnjs.cloudflare.com/ajax/libs/vega/3.0.7/vega.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://cdnjs.cloudflare.com/ajax/libs/vega-lite/2.0.1/vega-lite.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://cdnjs.cloudflare.com/ajax/libs/vega-embed/3.0.0-rc7/vega-embed.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"vis"</span><span class="nt">&gt;&lt;/div&gt;</span>

  <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>We can now start filling in the script with the beginning of a visualization specification.
This is a blob of <a href="#g:json">JSON</a> with certain required fields:</p>

<ul>
  <li><code class="highlighter-rouge">$schema</code> identifies the version of the spec being used (as a URL).</li>
  <li><code class="highlighter-rouge">description</code> is a comment to remind us what we thought we were doing when we created this.</li>
  <li><code class="highlighter-rouge">data</code> is the actual data.</li>
</ul>

<div title="src/vis/vega-values-only.html" class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...rest of page as before...
  &lt;script type="text/javascript"&gt;
    let spec = {
      "$schema": "https://vega.github.io/schema/vega-lite/v2.0.json",
      "description": "Create data array but do not display anything.",
      "data": {
        "values": [
          {"a": "A", "b": 28},
          {"a": "B", "b": 55},
          {"a": "C", "b": 43},
          {"a": "D", "b": 91},
          {"a": "E", "b": 81},
          {"a": "F", "b": 53},
          {"a": "G", "b": 19},
          {"a": "H", "b": 87},
          {"a": "I", "b": 52}
        ]
      }
    }
  &lt;/script&gt;
...rest of page as before...
</code></pre></div></div>

<p>In this case,
we represent a two-dimensional data table as objects with explicit indices <code class="highlighter-rouge">"a"</code> and <code class="highlighter-rouge">"b"</code>.
We have to do this because JSON (like JavaScript) doesn’t have a native representation
of two-dimensional arrays with row and column headers,
because programmers.</p>

<p>Once we have created our spec,
we can call <code class="highlighter-rouge">vegaEmbed</code> with the ID of the element that will hold the visualization,
the spec,
and some options (which for now we will leave empty):</p>

<div title="src/vis/vega-values-only.html" class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    let spec = {
      "$schema": "https://vega.github.io/schema/vega-lite/v2.0.json",
      "description": "Create data array but do not display anything.",
      "data": {
        "values": [
          // ...as above...
        ]
      }
    }
    vegaEmbed("#vis", spec, {})
</code></pre></div></div>

<p>When we open the page, though, nothing appears,
because we haven’t told Vega-Lite <em>how</em> to display the data.
To do that,
we need to add two more fields to the spec:</p>

<ul>
  <li><code class="highlighter-rouge">mark</code> specifies the visual element used to show the data</li>
  <li><code class="highlighter-rouge">encoding</code> tells Vega how to map values to marks</li>
</ul>

<p>Here’s our updated spec:</p>

<div title="src/vis/vega-mark-encoding.html" class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    let spec = {
      "$schema": "https://vega.github.io/schema/vega-lite/v2.0.json",
      "description": "Add mark and encoding for data.",
      "data": {
        "values": [
          // ...as above...
        ]
      },
      "mark": "bar",
      "encoding": {
        "x": {"field": "a", "type": "ordinal"},
        "y": {"field": "b", "type": "quantitative"}
      }
    }
    vegaEmbed("#vis", spec, {})
</code></pre></div></div>

<p>When we open the page now,
we see a bar chart,
and feel very proud of ourselves.</p>

<figure id="f:vis-mark-encoding"> <img src="../../files/vis-mark-encoding.png"> <figcaption>Mark and Encoding</figcaption> </figure>

<p>There are also some poorly-styled links for various controls that we’re not going to use.
We can fill in the options argument to <code class="highlighter-rouge">vegaEmbed</code> to turn those off:</p>

<div title="src/vis/vega-disable-controls.html" class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    let spec = {
      "$schema": "https://vega.github.io/schema/vega-lite/v2.0.json",
      "description": "Disable control links.",
      "data": {
        // ...as before...
      }
    }
    let options = {
      "actions": {
        "export": false,
        "source": false,
        "editor": false
      }
    }
    vegaEmbed("#vis", spec, options)
</code></pre></div></div>

<p>We now have the visualization we wanted:</p>

<figure id="f:vis-disable-controls"> <img src="../../files/vis-disable-controls.png"> <figcaption>Without Controls</figcaption> </figure>

<p>Vega-Lite has a <em>lot</em> of options:
for example,
we can use points and average the Y values.
(We will change the X data so that values aren’t distinct in order to show this off,
because otherwise averaging doesn’t do much.)
In our revised spec,
<code class="highlighter-rouge">x</code> is now <code class="highlighter-rouge">"nominal"</code> instead of <code class="highlighter-rouge">"ordinal"</code>
and <code class="highlighter-rouge">y</code> has an extra property <code class="highlighter-rouge">"aggregate"</code>,
which is set to <code class="highlighter-rouge">"average"</code>
(but can be used to specify other <a href="#g:aggregation-function">aggregation functions</a>):</p>

<div title="src/vis/vega-aggregate-points.html" class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    let spec = {
      "$schema": "https://vega.github.io/schema/vega-lite/v2.0.json",
      "description": "Disable control links.",
      "data": {
        "values": [
          {"a": "P", "b": 19},
          {"a": "P", "b": 28},
          {"a": "P", "b": 91},
          {"a": "Q", "b": 55},
          {"a": "Q", "b": 81},
          {"a": "Q", "b": 87},
          {"a": "R", "b": 43},
          {"a": "R", "b": 52},
          {"a": "R", "b": 53}
        ]
      },
      "mark": "point",
      "encoding": {
        "x": {"field": "a", "type": "nominal"},
        "y": {"field": "b", "type": "quantitative", "aggregate": "average"}
      }
    }
    let options = {
      ...disable controls as before...
    }
    vegaEmbed("#vis", spec, options)
</code></pre></div></div>

<figure id="f:vis-aggregate-points"> <img src="../../files/vis-aggregate-points.png"> <figcaption>Aggregating and Using Points</figcaption> </figure>

<h2 id="s:vis-vega-local">Local Installation</h2>

<p>Loading Vega from a <a href="#g:cdn">Content Delivery Network</a> (CDN) reduces the load on our server,
but prevents offline development.
Since we want to be able to work when we’re disconnected,
let’s load from local files.</p>

<p>Step 1 is to slim down our HTML file so that it only loads our application:</p>

<div title="src/vis/react-01/index.html" class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Load Vega from a File<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"app.js"</span> <span class="na">async</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"vis"</span><span class="nt">&gt;&lt;/div&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>In step 2,
we <code class="highlighter-rouge">npm install vega vega-lite vega-embed</code> and <code class="highlighter-rouge">require('vega-embed')</code> in <code class="highlighter-rouge">app.js</code>:</p>

<div title="src/vis/react-01/app.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">vegaEmbed</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'vega-embed'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">spec</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// ...as before...</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// ...as before...</span>
<span class="p">}</span>

<span class="nx">vegaEmbed</span><span class="p">(</span><span class="s2">"#vis"</span><span class="p">,</span> <span class="nx">spec</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
</code></pre></div></div>

<p>We launch this with Parcel via our saved <code class="highlighter-rouge">npm run</code> command:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm run dev <span class="nt">--</span> src/vis/react-01/index.html
</code></pre></div></div>

<p>But nothing appears when we open <code class="highlighter-rouge">http://localhost:4000</code> in our browser.
Looking in the browser console,
we see a message telling us that <code class="highlighter-rouge">vegaEmbed</code> is not a function.</p>

<p>What we have tripped over is something that’s still painful in 2018.
The old method of getting libraries is <code class="highlighter-rouge">require</code>,
and that’s still what Node supports as of Version 10.9.0.
The new standard is <code class="highlighter-rouge">import</code>,
which allows a module to define a default value so that <code class="highlighter-rouge">import 'something'</code> gets a function, a class, or whatever.
This is really handy, but <code class="highlighter-rouge">require</code> doesn’t work that way.</p>

<p>Using Node on the command line, we can either add the <code class="highlighter-rouge">--experimental-modules</code> flag
or rename our files with a <code class="highlighter-rouge">.mjs</code> extension,
both of which are annoying.
Alternatively,
we can get the thing we want by accessing <code class="highlighter-rouge">.default</code> during import,
or by referring to <code class="highlighter-rouge">vegaEmbed.default</code> when we call it.
These choices are also annoying,
but after a bit of fiddling and cursing,
we decide to make the fix as the library is loaded:</p>

<div title="src/vis/react-02/app.js" class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const vegaEmbed = require('vega-embed').default

// ...as before...
</code></pre></div></div>

<p>The third option is to use <code class="highlighter-rouge">import</code> where we can
and fix the <code class="highlighter-rouge">require</code> statements in the server-side code when Node is upgraded.
We can call the thing we import anything we want,
but we will stick to <code class="highlighter-rouge">vegaEmbed</code> for consistency with previous examples:</p>

<div title="src/vis/react-03/app.js" class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import vegaEmbed from 'vega-embed'

// ...as before...
</code></pre></div></div>

<p>If we do this,
the bundled file is 74.5K lines of JavaScript,
but at least it’s all in one place for distribution.</p>

<h2 id="s:vis-exercises">Exercises</h2>

<h3 id="binned-scatterplots">Binned Scatterplots</h3>

<p>Vega-Lite can create
<a href="https://vega.github.io/vega-lite/examples/circle_binned.html">binned scatterplots</a>
in which the sizes of markers indicate how many values were put in each bin.
Modify the aggregating scatterplot shown above
so that values are binned in this way.</p>

<h3 id="grouped-bar-charts">Grouped Bar Charts</h3>

<p>Vega-Lite can display
<a href="https://vega.github.io/vega-lite/examples/bar_grouped.html">grouped bar charts</a>
as well as simple ones.
Find or create a simple data set and construct a grouped bar chart.
How impressed will your supervisor, your committee, or a future employee be
by your chosen color scheme?</p>

<h3 id="limits-of-declarative-programming">Limits of Declarative Programming</h3>

<p>Look at Vega-Lite’s
<a href="https://vega.github.io/vega-lite/examples/">example gallery</a>
and identify one kind of plot or transformation you’ve used or seen
that <em>isn’t</em> included there.
Do you think this is because they just haven’t gotten around to it yet,
or is there something about that plot or transformation
that doesn’t lend itself to Vega-Lite’s declarative model?</p>

<h3 id="working-with-arrays">Working With Arrays</h3>

<p>Vega-Lite is built on top of a visualization toolkit called <a href="https://d3js.org/">D3</a>,
which includes <a href="https://github.com/d3/d3-array">a library for manipulating arrays</a>.
Write a small application that generates 1000 random values using <code class="highlighter-rouge">Math.random</code>
and reports the mean, standard deviation, and quartiles.
(You may also want to create a histogram showing the distribution of values.)</p>


      


<div class="listblock">
  <h2>Key Points</h2>
  <ul>
    <li>Vega-Lite is a simple way to build common visualizations.
</li><li>Vega-Lite is declarative: the user creates a data structure describing what they want, and the library creates the visualization.
</li><li>A Vega-List specification contains a schema identifier, a description, data, marks, and encodings.
</li><li>The overall layout of a Vega-Lite visualization can be controlled by setting options.
</li><li>Some applications will use <code class="highlighter-rouge">require</code> for server-side code and <code class="highlighter-rouge">import</code> for client-side code.
</li>
  </ul>
</div>


    </div>
<div class="chapter">
      <h1 id="s:promises">Promises</h1>
      


<div class="listblock">
  <h2>Questions</h2>
  <ul>
    <li>How does JavaScript implement delayed computation?
</li><li>Is there an easier way to handle delayed computation?
</li><li>How can a program wait for many promises to complete, or for one promise in a set to complete?
</li><li>Is there an even easier way to manage all of this?
</li>
  </ul>
</div>


      
      <p>By now we have got used to providing callback functions as arguments to other
functions.
Callbacks quickly become complicated because of:</p>

<ul>
  <li>Nesting: a delayed calculation may need the result of a delayed calculation that needs…</li>
  <li>Error handling: who notices and takes care of errors?
(This is often a problem in real life too.)</li>
</ul>

<p>For example,
suppose we want to turn a set of CSV files into HTML pages.
The inputs to our function are the name of a directory that contains one or more CSV files
and the name of an output directory;
the desired results are
that the output directory is created if it doesn’t already exist,
that one HTML file is created for each CSV file,
that any HTML files in the directory that <em>don’t</em> correspond to CSV files are removed,
and that an index page is created with links to all the pages.</p>

<p>We can do this with synchronous operations,
but that’s not the JavaScript way
(by which we mean that doing it that way won’t introduce you to tools we’re going to need later).
We can also try doing it with callbacks, but:</p>

<ul>
  <li>we can’t create the output directory until the existing one has been emptied;</li>
  <li>can’t generate the HTML pages until the output directory has been re-created; and</li>
  <li>we can’t generate the index page until the CSV files have been processed.</li>
</ul>

<p>Instead of a tangled nest of callbacks,
it’s better to use <a href="#g:promise">promises</a>,
and then to use <code class="highlighter-rouge">async</code> and <code class="highlighter-rouge">await</code> to make things even easier.
JavaScript offers three mechanisms because
its developers have invented better ways to do things as the language has evolved,
but the simple high-level ideas often don’t make sense unless you understand how they work.
(This too is often a problem in real life.)</p>

<h2 id="s:promises-queue">The Execution Queue</h2>

<p>In order for any of what follows to make sense,
it’s vital to understand JavaScript’s <a href="#g:event-loop">event loop</a>,
a full explanation of which can be found <a href="https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/">here</a>.
Most functions execute in order:</p>

<div title="src/promises/not-callbacks-alone.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1500</span><span class="p">,</span> <span class="mi">500</span><span class="p">].</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">t</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1000
1500
500
</code></pre></div></div>

<p>However,
a handful of built-in functions delay execution:
instead of running right away,
they add a callback to a list that the JavaScript interpreter uses
to keep track of things that want to be run.
When one task finishes,
the interpreter takes the next one from this queue and runs it.</p>

<p><code class="highlighter-rouge">setTimeout</code> is one of the most widely used functions of this kind.
Here it is in operation:</p>

<div title="src/promises/callbacks-with-timeouts.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1500</span><span class="p">,</span> <span class="mi">500</span><span class="p">].</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">t</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`about to setTimeout for </span><span class="p">${</span><span class="nx">t</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
  <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`inside timer handler for </span><span class="p">${</span><span class="nx">t</span><span class="p">}</span><span class="s2">`</span><span class="p">)},</span> <span class="nx">t</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>about to setTimeout for 1000
about to setTimeout for 1500
about to setTimeout for 500
inside timer handler for 500
inside timer handler for 1000
inside timer handler for 1500
</code></pre></div></div>

<p>That’s not surprising:
if we ask JavaScript to delay execution,
execution is delayed.
What may be surprising is that setting a timeout of zero also defers execution:</p>

<div title="src/promises/callbacks-with-zero-timeouts.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">values</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1500</span><span class="p">,</span> <span class="mi">500</span><span class="p">]</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'starting...'</span><span class="p">)</span>
<span class="nx">values</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">t</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`about to setTimeout for </span><span class="p">${</span><span class="nx">t</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
  <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`inside timer handler for </span><span class="p">${</span><span class="nx">t</span><span class="p">}</span><span class="s2">`</span><span class="p">)},</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'...finishing'</span><span class="p">)</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>starting...
about to setTimeout for 1000
about to setTimeout for 1500
about to setTimeout for 500
...finishing
inside timer handler for 1000
inside timer handler for 1500
inside timer handler for 500
</code></pre></div></div>

<p>Here’s what the run queue looks like just before the program prints <code class="highlighter-rouge">...finishing</code>:</p>

<figure id="f:promises-queue"> <img src="../../files/promises-queue.svg"> <figcaption>Run Queue</figcaption> </figure>

<p>We can use <code class="highlighter-rouge">setTimeout</code> to build a generic non-blocking function:</p>

<div title="src/promises/non-blocking.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">nonBlocking</span> <span class="o">=</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">}</span>

<span class="p">[</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">].</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">val</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`about to do nonBlocking for </span><span class="p">${</span><span class="nx">val</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
  <span class="nx">nonBlocking</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`inside callback for </span><span class="p">${</span><span class="nx">val</span><span class="p">}</span><span class="s2">`</span><span class="p">))</span>
<span class="p">})</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>about to do nonBlocking for a
about to do nonBlocking for b
about to do nonBlocking for c
inside callback for a
inside callback for b
inside callback for c
</code></pre></div></div>

<p>Why bother doing this?
Because we may want to give something else a chance to run.
In particular,
file I/O and anything involving a network request are incredibly slow from a computer’s point of view.
<a href="http://exple.tive.org/blarg/2018/08/15/time-dilation/">If a single CPU cycle was one second long</a>,
then getting data from RAM would take several minutes,
getting it from a solid-state disk would take six to eight days,
and getting it over the network is the equivalent of eight years.
Rather than wasting that time,
JavaScript is designed to let us (or our browser) switch tasks and do something else.</p>

<p>Using a timeout of zero is a clever trick,
but Node provides another function called <code class="highlighter-rouge">setImmediate</code> to do this for us.
(There is also <code class="highlighter-rouge">process.nextTick</code>,
which doesn’t do quite the same thing.
You should probably not use it.)</p>

<div title="src/promises/set-immediate.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">].</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">val</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`about to do setImmediate for </span><span class="p">${</span><span class="nx">val</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
  <span class="nx">setImmediate</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`inside immediate handler for </span><span class="p">${</span><span class="nx">val</span><span class="p">}</span><span class="s2">`</span><span class="p">))</span>
<span class="p">})</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>about to do setImmediate for a
about to do setImmediate for b
about to do setImmediate for c
inside immediate handler for a
inside immediate handler for b
inside immediate handler for c
</code></pre></div></div>

<h2 id="s:promises-promises">Promises</h2>

<p>Recent versions of JavaScript encourage programmers to use <a href="#g:promise">promises</a>
to manage delayed actions.
For example,
if we want to find the size of a file,
we can write this:</p>

<div title="src/promises/promise-stats.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'fs-extra'</span><span class="p">)</span>
<span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="s1">'moby-dick.txt'</span><span class="p">).</span><span class="nx">then</span><span class="p">((</span><span class="nx">stats</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">stats</span><span class="p">.</span><span class="nx">size</span><span class="p">))</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1276201
</code></pre></div></div>

<p><code class="highlighter-rouge">fs-extra.stat</code> will eventually produce some statistics about the file,
but this will take a while,
so <code class="highlighter-rouge">fs-extra.stat</code> returns a object of the class <code class="highlighter-rouge">Promise</code> right away.
<code class="highlighter-rouge">Promise</code> has a method <code class="highlighter-rouge">then</code> that takes a callback as an argument and stores it in the promise object.
When the <code class="highlighter-rouge">stat</code> call completes,
the remembered callback is called,
and passed yet another object with statistics about the file (including its size).</p>

<p>To understand this a little better,
let’s create our own promise to fetch a file from the web:</p>

<div title="src/promises/nasa-fetch.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">fetch</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'node-fetch'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">prom</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">fetch</span><span class="p">(</span><span class="s1">'https://api.nasa.gov/neo/rest/v1/feed?api_key=DEMO_KEY&amp;start_date=2018-08-20'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">resolve</span><span class="p">(</span><span class="s1">'fetched page successfully'</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="nx">message</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">message</span><span class="p">))</span>
</code></pre></div></div>

<p>This code constructs a new <code class="highlighter-rouge">Promise</code> object.
The constructor takes one argument;
this must be a callback function of two arguments,
which by convention are called <code class="highlighter-rouge">resolve</code> and <code class="highlighter-rouge">reject</code>.
Inside the body of the callback,
we call <code class="highlighter-rouge">resolve</code> to return a value if and when everything worked as planned.
That value is then passed to the <code class="highlighter-rouge">then</code> method of the <code class="highlighter-rouge">Promise</code>.</p>

<p>This may seem a roundabout way of doing things,
but it solves several problems at once.
The first and most important is error handling:
if something goes wrong inside the callback passed to <code class="highlighter-rouge">Promise</code>’s constructor,
we can call <code class="highlighter-rouge">reject</code> instead of <code class="highlighter-rouge">resolve</code>.
Just as <code class="highlighter-rouge">then</code> handles whatever we pass to <code class="highlighter-rouge">resolve</code>,
<code class="highlighter-rouge">Promise</code> defines a method called <code class="highlighter-rouge">catch</code> to handle whatever is passed to <code class="highlighter-rouge">reject</code>.
We can therefore build a slightly more robust version of our data fetcher
that will report something sensible if we mis-type a year as <code class="highlighter-rouge">2108</code>:</p>

<div title="src/promises/nasa-catch.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">fetch</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'node-fetch'</span><span class="p">)</span>

<span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">fetch</span><span class="p">(</span><span class="s1">'https://api.nasa.gov/neo/rest/v1/feed?api_key=DEMO_KEY&amp;start_date=20-08-2108'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">resolve</span><span class="p">(</span><span class="s1">'fetched page successfully'</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">reject</span><span class="p">(</span><span class="nb">Error</span><span class="p">(</span><span class="s2">`got HTTP status code </span><span class="p">${</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">}</span><span class="s2">`</span><span class="p">))</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="nx">message</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">message</span><span class="p">))</span>
<span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">))</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>got HTTP status code 400
</code></pre></div></div>

<p>(Note that we didn’t assign our Promise object to a variable in the example above.
We can create promises on the fly if we need them only to define behaviour on
successful completion/exception and won’t need to refer to them again later.)
What makes this all work is that a promise is an object.
Here’s what’s in memory just after this promise has been created:</p>

<figure id="f:promises-object-a"> <img src="../../files/promises-object-a.svg"> <figcaption>Promises as Objects (after creation)</figcaption> </figure>

<p>There are a lot of arrows in this diagram,
but they all serve a purpose:</p>

<ul>
  <li>The promise has three fields:
the initial action (which is the callback passed to the constructor),
the action to be taken if everything succeeds,
and the action to be taken if there’s an error.</li>
  <li>The success and error actions are empty,
because the initial action hasn’t executed yet.</li>
</ul>

<p>Once the promise is created,
the program calls its <code class="highlighter-rouge">then</code> and <code class="highlighter-rouge">catch</code> methods in that order,
giving each a callback.
This happens <em>before</em> the callback passed to the constructor
(i.e., the initial action) is executed,
and leaves the promise in this state:</p>

<figure id="f:promises-object-b"> <img src="../../files/promises-object-b.svg"> <figcaption>Promises as Objects (after then and catch)</figcaption> </figure>

<p>Calling <code class="highlighter-rouge">then</code> and <code class="highlighter-rouge">catch</code> assigns callbacks to the success action and error action members of the promise object.
Those methods are then passed into the initial action callback as <code class="highlighter-rouge">resolve</code> and <code class="highlighter-rouge">reject</code>,
i.e.,
if <code class="highlighter-rouge">resolve</code> is called because the page was fetched successfully,
what’s actually called is the promise’s success action,
which is the callback that was given to <code class="highlighter-rouge">then</code>.
If <code class="highlighter-rouge">reject</code> is called,
on the other hand,
it triggers execution of the error action,
which is the callback that was passed to <code class="highlighter-rouge">catch</code>.</p>

<p>Yes,
this is complicated—so complicated that another layer
(which we will look at <a href="#s:promises-async-await">soon</a>)
has been added to JavaScript to hide these details.
Without this complexity,
though,
it’s extremely difficult to handle errors from delayed computations.
If we try this, using JavaScript’s <code class="highlighter-rouge">try {...} catch {...}</code> syntax for handling exceptions:</p>

<div title="src/promises/try-catch.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">fetch</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'node-fetch'</span><span class="p">)</span>

<span class="k">try</span> <span class="p">{</span>
  <span class="nx">fetch</span><span class="p">(</span><span class="s1">'https://api.nasa.gov/neo/rest/v1/feed?api_key=DEMO_KEY&amp;start_date=20-08-2108'</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<!-- == \noindent -->
<p>then the error message won’t appear
because the call to <code class="highlighter-rouge">fetch</code> doesn’t raise an exception right away.</p>

<p>Going back to the <code class="highlighter-rouge">fs-extra.stat</code> example above,
what if we want to process multiple files,
e.g.,
calculate their total size?
We could write a loop:</p>

<div title="src/promises/promise-loop.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'fs-extra'</span><span class="p">)</span>

<span class="kd">let</span> <span class="nx">total_size</span> <span class="o">=</span> <span class="mi">0</span>
<span class="kd">const</span> <span class="nx">files</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'jane-eyre.txt'</span><span class="p">,</span> <span class="s1">'moby-dick.txt'</span><span class="p">,</span> <span class="s1">'life-of-frederick-douglass.txt'</span><span class="p">]</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">fileName</span> <span class="k">of</span> <span class="nx">files</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">fileName</span><span class="p">).</span><span class="nx">then</span><span class="p">((</span><span class="nx">stats</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">total_size</span> <span class="o">+=</span> <span class="nx">stats</span><span class="p">.</span><span class="nx">size</span>
  <span class="p">})</span>
<span class="p">}</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">total_size</span><span class="p">)</span>
</code></pre></div></div>

<!-- == \noindent -->
<p>but this doesn’t work:
the <code class="highlighter-rouge">stat</code> in each iteration is executed asynchronously,
so the loop finishes and the script prints a total size of zero
before any of the promised code has run.</p>

<p>Plan B is to chain the promises together
to ensure that each executes only after the last has resolved:</p>

<div title="src/promises/promise-nest.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'fs-extra'</span><span class="p">)</span>

<span class="kd">let</span> <span class="nx">total_size</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="s1">'jane-eyre.txt'</span><span class="p">).</span><span class="nx">then</span><span class="p">((</span><span class="nx">jeStats</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="s1">'moby-dick.txt'</span><span class="p">).</span><span class="nx">then</span><span class="p">((</span><span class="nx">mdStats</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="s1">'life-of-frederick-douglass.txt'</span><span class="p">).</span><span class="nx">then</span><span class="p">((</span><span class="nx">fdStats</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">resolve</span><span class="p">(</span><span class="nx">jeStats</span><span class="p">.</span><span class="nx">size</span> <span class="o">+</span> <span class="nx">mdStats</span><span class="p">.</span><span class="nx">size</span> <span class="o">+</span> <span class="nx">fdStats</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span>
      <span class="p">})</span>
    <span class="p">})</span>
  <span class="p">})</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="nx">total</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">total</span><span class="p">))</span>
</code></pre></div></div>

<!-- == \noindent -->
<p>but this obviously doesn’t handle an arbitrary number of files,
since we have to write one level of nesting for each file.
It’s also potentially inefficient,
since we could be waiting for one promise to complete
while other promises further down are ready to be processed.</p>

<p>The answer is <code class="highlighter-rouge">Promise.all</code>,
which returns an array of results from completed promises after all of them have resolved.
The order of results corresponds to the order of the promises in the input array,
which makes processing straightforward:</p>

<div title="src/promises/promise-all.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'fs-extra'</span><span class="p">)</span>

<span class="kd">let</span> <span class="nx">total_size</span> <span class="o">=</span> <span class="mi">0</span>
<span class="kd">const</span> <span class="nx">files</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'jane-eyre.txt'</span><span class="p">,</span> <span class="s1">'moby-dick.txt'</span><span class="p">,</span> <span class="s1">'life-of-frederick-douglass.txt'</span><span class="p">]</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">files</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">f</span> <span class="o">=&gt;</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">f</span><span class="p">))).</span>
  <span class="nx">then</span><span class="p">(</span><span class="nx">stats</span> <span class="o">=&gt;</span> <span class="nx">stats</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">total</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="k">return</span> <span class="nx">total</span> <span class="o">+</span> <span class="nx">s</span><span class="p">.</span><span class="nx">size</span><span class="p">},</span> <span class="mi">0</span><span class="p">)).</span>
  <span class="nx">then</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2594901
</code></pre></div></div>

<p>We can also use <code class="highlighter-rouge">Promise.race</code>,
which takes an array of promises and returns the result of the first one to complete.</p>

<h2 id="s:promises-usage">Using Promises</h2>

<p>Promises don’t really make sense until we start to use them,
so let’s try counting the number of lines in a set of files
that are larger than a specified threshold.
This is a slightly complex example but we will go through and build it up step-by-step.
Step 1 is to find the input files:</p>

<div title="src/promises/step-01.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'fs-extra'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">glob</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'glob-promise'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">srcDir</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<span class="nx">glob</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">srcDir</span><span class="p">}</span><span class="s2">/**/*.txt`</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">files</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'glob'</span><span class="p">,</span> <span class="nx">files</span><span class="p">))</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">))</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>glob [ './common-sense.txt',
  './jane-eyre.txt',
  './life-of-frederick-douglass.txt',
  './moby-dick.txt',
  './sense-and-sensibility.txt',
  './time-machine.txt' ]
</code></pre></div></div>

<p>Step 2 is to get the status of each file.
This approach doesn’t work because <code class="highlighter-rouge">fs.stat</code> is delayed:</p>

<div title="src/promises/step-02.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ...imports and arguments as before...</span>

<span class="nx">glob</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">srcDir</span><span class="p">}</span><span class="s2">/**/*.txt`</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">files</span> <span class="o">=&gt;</span> <span class="nx">files</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">f</span> <span class="o">=&gt;</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">f</span><span class="p">)))</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">files</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'glob + files.map/stat'</span><span class="p">,</span> <span class="nx">files</span><span class="p">))</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">))</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>glob + files.map/stat [ Promise { &lt;pending&gt; },
  Promise { &lt;pending&gt; },
  Promise { &lt;pending&gt; },
  Promise { &lt;pending&gt; },
  Promise { &lt;pending&gt; },
  Promise { &lt;pending&gt; } ]
</code></pre></div></div>

<p>Step 3 is to use <code class="highlighter-rouge">Promise.all</code> to wait for all these promises to resolve:</p>

<div title="src/promises/step-03.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ...imports and arguments as before...</span>

<span class="nx">glob</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">srcDir</span><span class="p">}</span><span class="s2">/**/*.txt`</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">files</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">files</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">f</span> <span class="o">=&gt;</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">f</span><span class="p">))))</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">files</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'glob + Promise.all(files.map/stat)'</span><span class="p">,</span> <span class="nx">files</span><span class="p">))</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">))</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>glob + Promise.all(files.map/stat) [ Stats {
    dev: 16777220,
    mode: 33188,
    ...more information... },
    ...five more Stats objects...
]
</code></pre></div></div>

<p>In step 4,
we remember that we need to keep track of the names of the files we are looking at,
so we need to write our own function that returns an object with two keys
(one for the filename, and one for the stats).
As described <a href="#s:pages">previously</a>,
the notation <code class="highlighter-rouge">{a, b}</code> produces an object <code class="highlighter-rouge">{"a": a, "b", b}</code>:</p>

<div title="src/promises/step-04.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ...imports and arguments as before...</span>

<span class="kd">const</span> <span class="nx">statPair</span> <span class="o">=</span> <span class="p">(</span><span class="nx">filename</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">stats</span> <span class="o">=&gt;</span> <span class="nx">resolve</span><span class="p">({</span><span class="nx">filename</span><span class="p">,</span> <span class="nx">stats</span><span class="p">}))</span>
      <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span> <span class="o">=&gt;</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">))</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="nx">glob</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">srcDir</span><span class="p">}</span><span class="s2">/**/*.txt`</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">files</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">files</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">f</span> <span class="o">=&gt;</span> <span class="nx">statPair</span><span class="p">(</span><span class="nx">f</span><span class="p">))))</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">files</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'glob + Promise.all(files.map/statPair)'</span><span class="p">,</span> <span class="nx">files</span><span class="p">))</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">))</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>glob + Promise.all(files.map/statPair) [ { filename: './common-sense.txt',
    stats:
     Stats {
       dev: 16777220,
       mode: 33188,
       ...more information... }
     },
     ...five more (filename, Stats) pairs...
]
</code></pre></div></div>

<p>Step 5 is to make sure that
we’re only working with files more than 100,000 characters long:</p>

<div title="src/promises/step-05.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ...imports and arguments as before...</span>

<span class="nx">glob</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">srcDir</span><span class="p">}</span><span class="s2">/**/*.txt`</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">files</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">files</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">f</span> <span class="o">=&gt;</span> <span class="nx">statPair</span><span class="p">(</span><span class="nx">f</span><span class="p">))))</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">files</span> <span class="o">=&gt;</span> <span class="nx">files</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">pair</span> <span class="o">=&gt;</span> <span class="nx">pair</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">size</span> <span class="o">&gt;</span> <span class="mi">100000</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">files</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">files</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">f</span> <span class="o">=&gt;</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">filename</span><span class="p">,</span> <span class="s1">'utf8'</span><span class="p">))))</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">contents</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'...readFile'</span><span class="p">,</span> <span class="nx">contents</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">c</span> <span class="o">=&gt;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">length</span><span class="p">)))</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">))</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...readFile [ 148134, 1070331, 248369, 1276201, 706124, 204492 ]
</code></pre></div></div>

<p>In step 6,
we split each file’s content into lines and count:</p>

<div title="src/promises/step-06.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ...imports and arguments as before...</span>

<span class="kd">const</span> <span class="nx">countLines</span> <span class="o">=</span> <span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">text</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'</span><span class="err">\</span><span class="s1">n'</span><span class="p">).</span><span class="nx">length</span>
<span class="p">}</span>

<span class="nx">glob</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">srcDir</span><span class="p">}</span><span class="s2">/**/*.txt`</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">files</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">files</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">f</span> <span class="o">=&gt;</span> <span class="nx">statPair</span><span class="p">(</span><span class="nx">f</span><span class="p">))))</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">files</span> <span class="o">=&gt;</span> <span class="nx">files</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">pair</span> <span class="o">=&gt;</span> <span class="nx">pair</span><span class="p">.</span><span class="nx">stats</span> <span class="o">&gt;</span> <span class="mi">100000</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">files</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">files</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">f</span> <span class="o">=&gt;</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">filename</span><span class="p">,</span> <span class="s1">'utf8'</span><span class="p">))))</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">contents</span> <span class="o">=&gt;</span> <span class="nx">contents</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">c</span> <span class="o">=&gt;</span> <span class="nx">countLines</span><span class="p">(</span><span class="nx">c</span><span class="p">)))</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">lengths</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'lengths'</span><span class="p">,</span> <span class="nx">lengths</span><span class="p">))</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">))</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lengths [ 2654, 21063, 4105, 22334, 13028, 3584 ]
</code></pre></div></div>

<p>There’s a lot going on in the example above
but the important points are:</p>

<ul>
  <li>Promises always return another <code class="highlighter-rouge">Promise</code> object.</li>
  <li>This allows us to chain multiple <code class="highlighter-rouge">then</code> calls.</li>
  <li>This chain is formed of processes that will each wait to run until their predecessor has completed.</li>
  <li>A single <code class="highlighter-rouge">catch</code> method works to handle exceptions raised by <em>any</em> of the previous steps.</li>
</ul>

<h2 id="s:promises-async-await"><code class="highlighter-rouge">async</code> and <code class="highlighter-rouge">await</code></h2>

<p>Programmers are never content to leave well enough alone,
so the latest version of JavaScript offers yet another tool for managing asynchronous computation.
As we saw above,
the result of <code class="highlighter-rouge">Promise.then</code> is another promise,
which allows us to create long chains of <code class="highlighter-rouge">.then(...).then(...).then(...)</code> calls.
It works,
but it isn’t the most readable of notations and has been known to create a feeling of being trapped.</p>

<p>We can avoid this using two new keywords, <code class="highlighter-rouge">async</code> and <code class="highlighter-rouge">await</code>.
<code class="highlighter-rouge">async</code> tells JavaScript that a function is asynchronous,
i.e.,
that it might want to wait for something to complete.
Inside an asynchronous function,
<code class="highlighter-rouge">await</code> tells JavaScript to act as if it had waited for something to finish.
We use the two together like this:</p>

<div title="src/promises/async-await.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'fs-extra'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">statPairAsync</span> <span class="o">=</span> <span class="k">async</span> <span class="p">(</span><span class="nx">filename</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">stats</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">{</span><span class="nx">filename</span><span class="p">,</span> <span class="nx">stats</span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">statPairAsync</span><span class="p">(</span><span class="s1">'moby-dick.txt'</span><span class="p">).</span><span class="nx">then</span><span class="p">((</span><span class="nx">white_whale</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">white_whale</span><span class="p">.</span><span class="nx">stats</span><span class="p">))</span>
</code></pre></div></div>

<p>An <code class="highlighter-rouge">async</code> function still returns a <code class="highlighter-rouge">Promise</code>,
but we can chain those promises together with other <code class="highlighter-rouge">async</code> functions using <code class="highlighter-rouge">await</code>,
which collects the result returned by a resolved promise.
As before, we can use <code class="highlighter-rouge">.catch</code> to handle any errors thrown.</p>

<p>Let’s use these to convert the complete example from the previous section:</p>

<div title="src/promises/async-await-example.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'fs-extra'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">glob</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'glob-promise'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">statPairAsync</span> <span class="o">=</span> <span class="k">async</span> <span class="p">(</span><span class="nx">filename</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">stats</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">{</span><span class="nx">filename</span><span class="p">,</span> <span class="nx">stats</span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">countLines</span> <span class="o">=</span> <span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">text</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'</span><span class="err">\</span><span class="s1">n'</span><span class="p">).</span><span class="nx">length</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">processFiles</span> <span class="o">=</span> <span class="k">async</span> <span class="p">(</span><span class="nx">globpath</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">filenames</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">glob</span><span class="p">(</span><span class="nx">globpath</span><span class="p">)</span>
  <span class="kd">const</span> <span class="nx">pairs</span> <span class="o">=</span> <span class="kr">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">filenames</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">f</span> <span class="o">=&gt;</span> <span class="nx">statPairAsync</span><span class="p">(</span><span class="nx">f</span><span class="p">)))</span>
  <span class="kd">const</span> <span class="nx">filtered</span> <span class="o">=</span> <span class="nx">pairs</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">pair</span> <span class="o">=&gt;</span> <span class="nx">pair</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">size</span> <span class="o">&gt;</span> <span class="mi">100000</span><span class="p">)</span>
  <span class="kd">const</span> <span class="nx">contents</span> <span class="o">=</span> <span class="kr">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">filtered</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">f</span> <span class="o">=&gt;</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">filename</span><span class="p">,</span> <span class="s1">'utf8'</span><span class="p">)))</span>
  <span class="kd">const</span> <span class="nx">lengths</span> <span class="o">=</span> <span class="nx">contents</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">c</span> <span class="o">=&gt;</span> <span class="nx">countLines</span><span class="p">(</span><span class="nx">c</span><span class="p">))</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">lengths</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">srcDir</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<span class="nx">processFiles</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">srcDir</span><span class="p">}</span><span class="s2">/**/*.txt`</span><span class="p">)</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">))</span>
</code></pre></div></div>

<p>Using <code class="highlighter-rouge">async</code> and <code class="highlighter-rouge">await</code> lets us avoid long <code class="highlighter-rouge">then</code> chains;
unless and until JavaScript allows us to define operators like R’s <code class="highlighter-rouge">%&gt;%</code> pipe operator,
they are probably the easiest way to write readable code.
Note,
though,
that we can only use <code class="highlighter-rouge">await</code> inside <code class="highlighter-rouge">async</code> functions:
JavaScript will report a syntax error if we use them elsewhere.
In particular,
we cannot use them interactively unless we wrap whatever we want to do in a wee function.</p>

<h2 id="s:promises-exercises">Exercises</h2>

<h3 id="whats-going-on">What’s Going On?</h3>

<p>This code runs fine:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">1000</span><span class="p">].</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">t</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`about to setTimeout for </span><span class="p">${</span><span class="nx">t</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
  <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`inside timer handler for </span><span class="p">${</span><span class="nx">t</span><span class="p">}</span><span class="s2">`</span><span class="p">)},</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<!-- == \noindent -->
<p>but this code fails:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'starting...'</span><span class="p">)</span>
<span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">1000</span><span class="p">].</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">t</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`about to setTimeout for </span><span class="p">${</span><span class="nx">t</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
  <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`inside timer handler for </span><span class="p">${</span><span class="nx">t</span><span class="p">}</span><span class="s2">`</span><span class="p">)},</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Why?</p>

<h3 id="a-stay-of-execution">A Stay of Execution</h3>

<p>Insert <code class="highlighter-rouge">console.log('This is a sharp Medicine, but it is a Physician for all diseases and miseries.')</code>
in the appropriate place in the code block below so that the output reads</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Waiting...
This is a sharp Medicine, but it is a Physician for all diseases and miseries.
Waiting...
Finished.
</code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">holdingMessage</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Waiting...'</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">swingAxe</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">holdingMessage</span><span class="p">()</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Finished.'</span><span class="p">)</span>
  <span class="p">},</span> <span class="mi">100</span><span class="p">)</span>
  <span class="nx">holdingMessage</span><span class="p">()</span>
<span class="p">}</span>

<span class="nx">swingAxe</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="a-synchronous-or-asynchronous">A Synchronous or Asynchronous?</h3>

<p>Which of these functions would you expect to be asynchronous?
How can you tell?
Does it matter?
And, if so, what is a good strategy to find out for sure if a function is asynchronous?</p>

<ol>
  <li><code class="highlighter-rouge">findNearestTown(coords)</code>: given a set of coordinates (<code class="highlighter-rouge">coords</code>) in Brazil,
looks up and returns the name of the nearest settlement with an estimated population greater than 5000.
The function throws an error if <code class="highlighter-rouge">coords</code> fall outside Brazil.</li>
  <li><code class="highlighter-rouge">calculateSphereVolume(r)</code>: calculates and returns the volume of a sphere with radius <code class="highlighter-rouge">r</code>.</li>
  <li><code class="highlighter-rouge">calculateRoute(A,B)</code>: returns all possible routes by air between airports <code class="highlighter-rouge">A</code> and <code class="highlighter-rouge">B</code>,
including direct routes and those with no more than 2 transfers.</li>
</ol>

<h3 id="handling-exceptions">Handling Exceptions</h3>

<p>What (if any) output would you expect to see in the console
when the code below is executed?</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">checkForBlanks</span> <span class="o">=</span> <span class="p">(</span><span class="nx">inputValue</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">inputValue</span> <span class="o">===</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">reject</span><span class="p">(</span><span class="nb">Error</span><span class="p">(</span><span class="s2">"Blank values are not allowed"</span><span class="p">))</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">resolve</span><span class="p">(</span><span class="nx">inputValue</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">reject</span><span class="p">(</span><span class="nb">Error</span><span class="p">(</span><span class="s1">'Timed out!'</span><span class="p">))</span>
  <span class="p">},</span> <span class="mi">1000</span><span class="p">)</span>
  <span class="nx">resolve</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span>
  <span class="nx">output</span> <span class="o">=&gt;</span> <span class="nx">checkForBlanks</span><span class="p">(</span><span class="nx">output</span><span class="p">),</span> <span class="nx">error</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">)).</span><span class="nx">then</span><span class="p">(</span>
    <span class="nx">checkedOutput</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">checkedOutput</span><span class="p">)).</span><span class="k">catch</span><span class="p">(</span>
      <span class="nx">error</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">))</span>
</code></pre></div></div>

<ol>
  <li><code class="highlighter-rouge">Timed out!</code></li>
  <li>blank output</li>
  <li><code class="highlighter-rouge">Blank values are not allowed</code></li>
  <li>a new <code class="highlighter-rouge">Promise</code> object</li>
</ol>

<h3 id="empty-promises">Empty Promises</h3>

<p>Fill in the blanks (<code class="highlighter-rouge">___</code>)in the code block below so that
the function returns <code class="highlighter-rouge">Array[7, 8, 2, 6, 5]</code>.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">makePromise</span> <span class="o">=</span> <span class="p">(</span><span class="nx">someInteger</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">___</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">___</span><span class="p">(</span><span class="nx">someInteger</span><span class="p">),</span> <span class="nx">someInteger</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">}</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">___</span><span class="p">([</span><span class="nx">makePromise</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="nx">makePromise</span><span class="p">(</span><span class="nx">___</span><span class="p">),</span> <span class="nx">makePromise</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="nx">makePromise</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="nx">makePromise</span><span class="p">(</span><span class="mi">5</span><span class="p">)]).</span><span class="nx">then</span><span class="p">(</span>
  <span class="nx">numbers</span> <span class="o">=&gt;</span> <span class="nx">___</span><span class="p">(</span><span class="nx">numbers</span><span class="p">))</span>
</code></pre></div></div>

<p>Now adapt the function so that it returns only <code class="highlighter-rouge">2</code>.
(Hint: you can achieve this by changing only one of the blank fields.)</p>

<h3 id="async-therefore-i-am"><code class="highlighter-rouge">async</code>, Therefore I Am</h3>

<p>Using <code class="highlighter-rouge">async</code> and <code class="highlighter-rouge">await</code>,
convert the completed function above into an asynchronous function with the same behaviour and output.
Do you find your solution easier to read and follow than the original version?
Do you think that that is only because you wrote this version?</p>


      


<div class="listblock">
  <h2>Key Points</h2>
  <ul>
    <li>JavaScript keeps an execution queue for delayed computations.
</li><li>Use promises to manage delayed computation instead of raw callbacks.
</li><li>Use a callback with two arguments to handle successful completion (resolve) and unsuccessful completion (reject) of a promise.
</li><li>Use <code class="highlighter-rouge">then</code> to express the next step after successful completion and <code class="highlighter-rouge">catch</code> to handle errors.
</li><li>Use <code class="highlighter-rouge">Promise.all</code> to wait for all promises in a list to complete and <code class="highlighter-rouge">Promise.race</code> to wait for the first promise in a set to complete.
</li><li>Use <code class="highlighter-rouge">await</code> to wait for the result of a computation.
</li><li>Mark functions that can be waited on with <code class="highlighter-rouge">async</code>.
</li>
  </ul>
</div>


    </div>
<div class="chapter">
      <h1 id="s:interactive">Interactive Sites</h1>
      


<div class="listblock">
  <h2>Questions</h2>
  <ul>
    <li>How do I tell the browser what to do when someone clicks a button?
</li><li>How should I structure my code to make interactions manageable?
</li><li>How can a web application get data from a server?
</li><li>How does modern JavaScript handle asynchronous operations?
</li>
  </ul>
</div>


      
      <p>Browsers allow us to define <a href="#g:event-handler">event handlers</a>
to specify what to do in response to an externally-triggered action,
such as a page loading or a user pressing a button.
These event handlers are just callback functions
that are (usually) given an <a href="#g:event-object">event object</a> containing information about what happened,
and while we can write them in pure JavaScript,
they’re even easier to build in React.</p>

<p>Let’s switch back to single-page examples for a moment
to show how we pass a callback function as
a specifically-named property of the thing whose behavior we are specifying.
(Don’t forget to load the required libraries in the HTML header, like we did
<a href="#s:dynamic">earlier</a>.)</p>

<div title="src/interactive/hello-button.html" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="o">&lt;</span><span class="nx">body</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s2">"app"</span><span class="o">&gt;&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="s2">"text/babel"</span><span class="o">&gt;</span>
      <span class="kd">let</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="kd">const</span> <span class="nx">sayHello</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Hello, button: </span><span class="p">${</span><span class="nx">counter</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
      <span class="p">}</span>

      <span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span>
        <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{</span><span class="nx">sayHello</span><span class="p">}</span><span class="o">&gt;</span><span class="nx">click</span> <span class="k">this</span><span class="o">&lt;</span><span class="sr">/button&gt;</span><span class="err">,
</span>        <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"app"</span><span class="p">)</span>
      <span class="p">)</span>
    <span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span>  <span class="o">&lt;</span><span class="sr">/body</span><span class="err">&gt;
</span></code></pre></div></div>

<p>As its name suggests,
a button’s <code class="highlighter-rouge">onClick</code> handler is called whenever the button is clicked.
Here,
we are telling React to call <code class="highlighter-rouge">sayHello</code>,
which adds one to the variable <code class="highlighter-rouge">counter</code>
and then prints its value along with a greeting message.</p>

<p>Global variables and functions are a poor way to structure code.
It’s far better to define the component as a class
and then use a method as the event handler:</p>

<div title="src/interactive/display-counter.html" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="o">&lt;</span><span class="nx">body</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s2">"app"</span><span class="o">&gt;&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="s2">"text/babel"</span><span class="o">&gt;</span>
      <span class="kd">class</span> <span class="nx">Counter</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>

        <span class="kd">constructor</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">super</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span><span class="na">counter</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        <span class="p">}</span>

        <span class="nx">increment</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span><span class="na">counter</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">counter</span><span class="o">+</span><span class="mi">1</span><span class="p">})</span>
        <span class="p">}</span>

        <span class="nx">render</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="k">return</span> <span class="p">(</span>
            <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span>
              <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">increment</span><span class="p">}</span><span class="o">&gt;</span><span class="nx">increment</span><span class="o">&lt;</span><span class="sr">/button</span><span class="err">&gt;
</span>              <span class="o">&lt;</span><span class="nx">br</span><span class="o">/&gt;</span>
              <span class="na">current</span><span class="p">:</span> <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">counter</span><span class="p">}</span>
            <span class="o">&lt;</span><span class="sr">/p</span><span class="err">&gt;
</span>          <span class="p">)</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span>
        <span class="o">&lt;</span><span class="nx">Counter</span> <span class="o">/&gt;</span><span class="p">,</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"app"</span><span class="p">)</span>
      <span class="p">)</span>
    <span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span>  <span class="o">&lt;</span><span class="sr">/body</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/html</span><span class="err">&gt;
</span></code></pre></div></div>

<p>Working from bottom to top,
the <code class="highlighter-rouge">ReactDOM.render</code> call inserts whatever HTML is produced by <code class="highlighter-rouge">&lt;Counter /&gt;</code>
into the element whose ID is <code class="highlighter-rouge">"app"</code>.
In this case,
though,
the counter is not a function,
but a class with three parts:</p>

<ol>
  <li>
    <p>Its constructor passes the properties provided by the user up to <code class="highlighter-rouge">React.Component</code>’s constructor.
(There aren’t any properties in this case,
but there will be in future examples,
so it’s a good habit to get into.)
The constructor then creates a property called <code class="highlighter-rouge">state</code>
that holds this component’s state.
This property <em>must</em> have this name so that React knows to watch it for changes.</p>
  </li>
  <li>
    <p>The <code class="highlighter-rouge">increment</code> method uses <code class="highlighter-rouge">setState</code> (inherited from <code class="highlighter-rouge">React.Component</code>)
to change the value of the counter.
We <em>must</em> do this rather than creating and modifying <code class="highlighter-rouge">this.counter</code>
so that React will notice the change in state
and re-draw what it needs to.</p>
  </li>
  <li>
    <p>The <code class="highlighter-rouge">render</code> method takes the place of the functions we have been using so far.
It can do anything it wants, but must return some HTML (using JSX).
Here, it creates a button with an event handler and displays the current value of the counter.</p>
  </li>
</ol>

<p>React calls each component’s <code class="highlighter-rouge">render</code> method each time <code class="highlighter-rouge">setState</code> is used to update the component’s state;
this is an example of a protocol,
which was described <a href="#s:oop-protocols">earlier</a>.
Behind the scenes,
React does some thinking to minimize how much redrawing takes place:
while it may look as though the paragraph, button, and current count are all being redrawn each time,
React will only actually redraw as little as it can.</p>

<h2 id="s:interactive-babel">But It Doesn’t Work</h2>

<p>If we try running this little application from the command line with Parcel:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm run dev <span class="nt">--</span> src/interactive/display-counter.html
</code></pre></div></div>

<!-- == \noindent -->
<p>everything works as planned.
But now try taking the code out of the web page and putting it in its own file:</p>

<div title="src/interactive/counter/index.html" class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>Counter<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"app.js"</span> <span class="na">async</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"app"</span><span class="nt">&gt;&lt;/div&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<div title="src/interactive/counter/app.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="s1">'react'</span>
<span class="k">import</span> <span class="nx">ReactDOM</span> <span class="k">from</span> <span class="s1">'react-dom'</span>

<span class="kd">class</span> <span class="nx">Counter</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>

  <span class="kd">constructor</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...as before...</span>
  <span class="p">}</span>

  <span class="nx">increment</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span><span class="na">counter</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">counter</span><span class="o">+</span><span class="mi">1</span><span class="p">})</span>
  <span class="p">}</span>

  <span class="nx">render</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...as before...</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span>
  <span class="o">&lt;</span><span class="nx">Counter</span> <span class="o">/&gt;</span><span class="p">,</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'app'</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div></div>

<p>Let’s try running this:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm run dev <span class="nt">--</span> src/interactive/counter/index.html
</code></pre></div></div>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; js-vs-ds@0.1.0 dev /Users/stj/js-vs-ds
&gt; parcel serve -p 4000 "src/interactive/counter/index.html"

Server running at http://localhost:4000
!!  /Users/stj/js-vs-ds/src/interactive/counter/app.js:11:12: Unexpected token (11:12)
   9 |   }
  10 |
&gt; 11 |   increment = (event) =&gt; {
     |             ^
  12 |     this.setState({counter: this.state.counter+1})
  13 |   }
  14 |
</code></pre></div></div>

<p>It seems that Parcel doesn’t like fat arrow methods.
This happens because React is still using ES6 JavaScript by default,
and fat arrow methods weren’t included in JavaScript at that point.
All right, let’s try using “normal” function-style method definitions instead:</p>

<div title="src/interactive/counter-functions/app.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ...imports as before...</span>

<span class="kd">class</span> <span class="nx">Counter</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>

  <span class="kd">constructor</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span><span class="na">counter</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">increment</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span><span class="na">counter</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">counter</span><span class="o">+</span><span class="mi">1</span><span class="p">})</span>
  <span class="p">}</span>

  <span class="nx">render</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">increment</span><span class="p">}</span><span class="o">&gt;</span><span class="nx">increment</span><span class="o">&lt;</span><span class="sr">/button</span><span class="err">&gt;
</span>        <span class="o">&lt;</span><span class="nx">br</span><span class="o">/&gt;</span>
        <span class="nx">current</span><span class="p">:</span> <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">counter</span><span class="p">}</span>
      <span class="o">&lt;</span><span class="sr">/p</span><span class="err">&gt;
</span>    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ...render as before...</span>
</code></pre></div></div>

<p>Parcel runs this without complaint,
but clicking on the button doesn’t change the display.
Despair is once again our friend—our <em>only</em> friend—but we persevere.
When we open the debugging console in the browser,
we see the message <code class="highlighter-rouge">TypeError: this is undefined</code>.
The appendix <a href="#s:legacy-prototypes">explains in detail</a> why this happens;
for now, suffice to say that some poor choices were made early in JavaScript’s development about variable scoping.</p>

<p>At this point it appears that we can compile but not run, or not bundle files together.
But wait:
when we used an in-page script, we specified the type as <code class="highlighter-rouge">text/babel</code>
and loaded <code class="highlighter-rouge">https://unpkg.com/babel-standalone@6/babel.js</code> in the page header along with React.
Can Babel save us?</p>

<p>The answer is “yes”,
though it takes a fair bit of searching on the web to find this out
(particularly if you don’t know what you’re looking for).
The magic is to create a file in the project’s root directory called <code class="highlighter-rouge">.babelrc</code>
and add the following lines:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
  <span class="s2">"presets"</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">"react"</span>
  <span class="p">],</span>
  <span class="s2">"plugins"</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">"transform-class-properties"</span>
  <span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Once we’ve done this,
we can use NPM to install <code class="highlighter-rouge">babel-preset-react</code> and <code class="highlighter-rouge">babel-plugin-transform-class-properties</code>
and then switch back to fat arrow methods.
Voila: everything works.</p>

<p>What’s happening here is that
when Babel translates our sparkly modern JavaScript into old-fashioned JavaScript compatible with all browsers,
it reads <code class="highlighter-rouge">.babelrc</code> and obeys that configuration.
The settings above tell it to do everything React needs using the <code class="highlighter-rouge">transform-class-properties</code> plugin;
in particular,
to accept fat arrow method definitions and bind <code class="highlighter-rouge">this</code> correctly.
This works,
but is a form of madness:
something outside our program determines how that program is interpreted,
and the commands controlling it go in yet another configuration file.
Still,
it is a useful form of madness,
so we will press on.</p>

<h2 id="s:interactive-models-views">Models and Views</h2>

<p>Well-designed applications separate models (which store data)
from views (which display it)
so that each can be tested and modified independently.
When we use React,
the models are typically classes,
and the views are typically pure functions.</p>

<p>To introduce this architecture,
let’s re-implement the counter using:</p>

<ul>
  <li><code class="highlighter-rouge">App</code> to store the state and provide methods for altering it,</li>
  <li><code class="highlighter-rouge">NumberDisplay</code> to display a number, and</li>
  <li><code class="highlighter-rouge">UpAndDown</code> to provide buttons that increment and decrement that number.</li>
</ul>

<p>The crucial design feature is that
<code class="highlighter-rouge">NumberDisplay</code> and <code class="highlighter-rouge">UpAndDown</code> don’t know what they’re displaying
or what actions are being taken on their behalf,
which makes them easier to re-use.
Of course,
no good deed goes unpunished.
The price that we pay
for organizing our application into separate components
is that now we must import the dependencies of each component
and export the component itself within each script.</p>

<p>After we’ve done this,
our dependencies will be bundled by parcel.
So we must remove the script loading from the HTML header.
The whole page is:</p>

<div title="src/interactive/multi-component/index.html" class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>Up and Down<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"app"</span><span class="nt">&gt;&lt;/div&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"app.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">NumberDisplay</code> class takes a label and a value and puts them in a paragraph
(remember, the label and value will appear in our function as properties of the <code class="highlighter-rouge">props</code> parameter):</p>

<div title="src/interactive/multi-component/NumberDisplay.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">NumberDisplay</span> <span class="o">=</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">props</span><span class="p">.</span><span class="nx">label</span><span class="p">}:</span> <span class="p">{</span><span class="nx">props</span><span class="p">.</span><span class="nx">value</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/p&gt;</span><span class="err">)
</span><span class="p">}</span>
</code></pre></div></div>

<p>Similarly,
<code class="highlighter-rouge">UpAndDown</code> expects two functions as its <code class="highlighter-rouge">up</code> and <code class="highlighter-rouge">down</code> properties,
and makes each the event handler for an appropriately-labelled button:</p>

<div title="src/interactive/multi-component/UpAndDown.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">UpAndDown</span> <span class="o">=</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{</span><span class="nx">props</span><span class="p">.</span><span class="nx">up</span><span class="p">}</span><span class="o">&gt;</span> <span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="o">&lt;</span><span class="sr">/button</span><span class="err">&gt;
</span>      <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{</span><span class="nx">props</span><span class="p">.</span><span class="nx">down</span><span class="p">}</span><span class="o">&gt;</span> <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="o">&lt;</span><span class="sr">/button</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="sr">/p</span><span class="err">&gt;
</span>  <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Both of these components will use React and ReactDOM when they are rendered
so we must import these.
We do this by adding import statements to the beginning of both components:</p>

<div title="src/interactive/multi-component/NumberDisplay.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="s2">"react"</span>
<span class="k">import</span> <span class="nx">ReactDOM</span> <span class="k">from</span> <span class="s2">"react-dom"</span>
</code></pre></div></div>

<p>Similarly, our application will need to import the
<code class="highlighter-rouge">UpAndDown</code> and <code class="highlighter-rouge">NumberDisplay</code> components,
so we need to export them after they’ve been defined.
This is done by adding <code class="highlighter-rouge">export {&lt;object_name&gt;}</code> to the end of the
component script.
(We will explore why the curly braces are necessary in the exercises.)
After we’ve done this for <code class="highlighter-rouge">UpAndDown</code>,
the complete component script looks like this:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="s2">"react"</span>
<span class="k">import</span> <span class="nx">ReactDOM</span> <span class="k">from</span> <span class="s2">"react-dom"</span>

<span class="kd">const</span> <span class="nx">UpAndDown</span> <span class="o">=</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{</span><span class="nx">props</span><span class="p">.</span><span class="nx">up</span><span class="p">}</span><span class="o">&gt;</span> <span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="o">&lt;</span><span class="sr">/button</span><span class="err">&gt;
</span>      <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{</span><span class="nx">props</span><span class="p">.</span><span class="nx">down</span><span class="p">}</span><span class="o">&gt;</span> <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="o">&lt;</span><span class="sr">/button</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="sr">/p</span><span class="err">&gt;
</span>  <span class="p">)</span>
<span class="p">}</span>

<span class="k">export</span> <span class="p">{</span><span class="nx">UpAndDown</span><span class="p">}</span>
</code></pre></div></div>

<p>We are now ready to build the overall application.
It creates a <code class="highlighter-rouge">state</code> containing a counter
and defines methods to increment or decrement the counter’s value.
Its <code class="highlighter-rouge">render</code> method then lays out the buttons and the current state
using those elements:</p>

<div title="src/interactive/multi-component/app.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">App</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>

  <span class="kd">constructor</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span><span class="na">counter</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">increment</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span><span class="na">counter</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">})</span>
  <span class="p">}</span>

  <span class="nx">decrement</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span><span class="na">counter</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">counter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">})</span>
  <span class="p">}</span>

  <span class="nx">render</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">UpAndDown</span> <span class="nx">up</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">increment</span><span class="p">}</span> <span class="nx">down</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">decrement</span><span class="p">}</span> <span class="sr">/</span><span class="err">&gt;
</span>        <span class="o">&lt;</span><span class="nx">NumberDisplay</span> <span class="nx">label</span><span class="o">=</span><span class="s1">'counter'</span> <span class="nx">value</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">counter</span><span class="p">}</span> <span class="sr">/</span><span class="err">&gt;
</span>      <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<figure id="f:interactive-objects-dom"> <img src="../../files/interactive-objects-dom.svg"> <figcaption>React Objects and the DOM</figcaption> </figure>

<p>We must import the dependencies as we did with the other components.
As well as <code class="highlighter-rouge">React</code> and <code class="highlighter-rouge">ReactDOM</code>,
we need to include the components that we’ve written.
Dependencies stored locally can be imported by providing the path to
the file in which they are defined,
with the <code class="highlighter-rouge">.js</code> removed from the file name:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="s2">"react"</span>
<span class="k">import</span> <span class="nx">ReactDOM</span> <span class="k">from</span> <span class="s2">"react-dom"</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">UpAndDown</span><span class="p">}</span> <span class="k">from</span> <span class="s2">"./UpAndDown"</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">NumberDisplay</span><span class="p">}</span> <span class="k">from</span> <span class="s2">"./NumberDisplay"</span>

<span class="c1">// ...script body...</span>
</code></pre></div></div>

<p>Finally,
we can render the application with <code class="highlighter-rouge">ReactDOM</code> as before:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ...script body...</span>

<span class="kd">const</span> <span class="nx">mount</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"app"</span><span class="p">)</span>
<span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="o">&lt;</span><span class="nx">App</span><span class="o">/&gt;</span><span class="p">,</span> <span class="nx">mount</span><span class="p">)</span>
</code></pre></div></div>

<p>This may seem pretty complicated,
and it is,
because this example would be much simpler to write without all this indirection.
However,
this strategy is widely used to manage large applications:
data and event handlers are defined in one class,
then passed into display components to be displayed and interacted with.</p>

<h2 id="s:interactive-fetching">Fetching Data</h2>

<p>Let’s use what we’ve learned to look at how the world might end.
NASA provides a web API to get information about near-approach asteroids.
We will use it to build a small display with:</p>

<ul>
  <li>a text box for submitting a starting date (get one week by default), and</li>
  <li>a list of asteroids in that time period.</li>
</ul>

<p>Here’s the first version of our <code class="highlighter-rouge">App</code> class:</p>

<div title="src/interactive/asteroids/app.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="s2">"react"</span>
<span class="k">import</span> <span class="nx">ReactDOM</span> <span class="k">from</span> <span class="s2">"react-dom"</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">AsteroidList</span><span class="p">}</span> <span class="k">from</span> <span class="s2">"./AsteroidList"</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">DateSubmit</span><span class="p">}</span> <span class="k">from</span> <span class="s2">"./DateSubmit"</span>

<span class="kd">class</span> <span class="nx">App</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>

  <span class="kd">constructor</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
      <span class="c1">// ...fill in...</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">onNewDate</span> <span class="o">=</span> <span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...fill in...</span>
  <span class="p">}</span>

  <span class="nx">render</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">DateSubmit</span> <span class="nx">newValue</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">onNewDate</span><span class="p">}</span> <span class="sr">/</span><span class="err">&gt;
</span>        <span class="o">&lt;</span><span class="nx">AsteroidList</span> <span class="nx">asteroids</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">asteroids</span><span class="p">}</span> <span class="sr">/</span><span class="err">&gt;
</span>      <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">mount</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"app"</span><span class="p">)</span>
<span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="o">&lt;</span><span class="nx">App</span><span class="o">/&gt;</span><span class="p">,</span> <span class="nx">mount</span><span class="p">)</span>
</code></pre></div></div>

<p>We’ll test it by displaying asteroids using fake data;
as in our first example,
the display component <code class="highlighter-rouge">AsteroidList</code> doesn’t modify data,
but just displays it in a table:</p>

<div title="src/interactive/asteroids/AsteroidList.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="s2">"react"</span>
<span class="k">import</span> <span class="nx">ReactDOM</span> <span class="k">from</span> <span class="s2">"react-dom"</span>

<span class="kd">const</span> <span class="nx">AsteroidList</span> <span class="o">=</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="o">&lt;</span><span class="nx">table</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nx">tbody</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nx">tr</span><span class="o">&gt;&lt;</span><span class="nx">th</span><span class="o">&gt;</span><span class="nx">Name</span><span class="o">&lt;</span><span class="sr">/th&gt;&lt;th&gt;Date&lt;/</span><span class="nx">th</span><span class="o">&gt;&lt;</span><span class="nx">th</span><span class="o">&gt;</span><span class="nx">Diameter</span> <span class="p">(</span><span class="nx">m</span><span class="p">)</span><span class="o">&lt;</span><span class="sr">/th&gt;&lt;th&gt;Approach </span><span class="se">(</span><span class="sr">km</span><span class="se">)</span><span class="sr">&lt;/</span><span class="nx">th</span><span class="o">&gt;&lt;</span><span class="sr">/tr</span><span class="err">&gt;
</span>      <span class="p">{</span><span class="nx">props</span><span class="p">.</span><span class="nx">asteroids</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">a</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span>
          <span class="o">&lt;</span><span class="nx">tr</span> <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="nx">a</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nx">td</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">a</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/td</span><span class="err">&gt;
</span>            <span class="o">&lt;</span><span class="nx">td</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">a</span><span class="p">.</span><span class="nx">date</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/td</span><span class="err">&gt;
</span>            <span class="o">&lt;</span><span class="nx">td</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">a</span><span class="p">.</span><span class="nx">diameter</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/td</span><span class="err">&gt;
</span>            <span class="o">&lt;</span><span class="nx">td</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">a</span><span class="p">.</span><span class="nx">distance</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/td</span><span class="err">&gt;
</span>          <span class="o">&lt;</span><span class="sr">/tr</span><span class="err">&gt;
</span>        <span class="p">)</span>
      <span class="p">})}</span>
      <span class="o">&lt;</span><span class="sr">/tbody</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="sr">/table</span><span class="err">&gt;
</span>  <span class="p">)</span>
<span class="p">}</span>

<span class="k">export</span> <span class="p">{</span><span class="nx">AsteroidList</span><span class="p">}</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">React</code> will complain if we don’t provide a unique key
to distinguish elements that we create,
since having these keys helps it keep track of the component-to-DOM relationship,
which in turn <a href="https://stackoverflow.com/questions/28329382/understanding-unique-keys-for-array-children-in-react-js">makes updates much more efficient</a>.
Since each asteroid’s name is supposed to be unique,
we use that name as the key for each table row.</p>

<p><code class="highlighter-rouge">AsteroidList</code> expects data to arrive in <code class="highlighter-rouge">props.asteroids</code>,
so let’s put some made-up values in <code class="highlighter-rouge">App</code> for now
that we can then pass in:</p>

<div title="src/interactive/asteroids/app.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">App</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>

  <span class="kd">constructor</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">asteroids</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span><span class="na">name</span><span class="p">:</span> <span class="s1">'a30x1000'</span><span class="p">,</span> <span class="na">date</span><span class="p">:</span> <span class="s1">'2017-03-03'</span><span class="p">,</span> <span class="na">diameter</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="na">distance</span><span class="p">:</span> <span class="mi">1000</span><span class="p">},</span>
        <span class="p">{</span><span class="na">name</span><span class="p">:</span> <span class="s1">'a5x500'</span><span class="p">,</span> <span class="na">date</span><span class="p">:</span> <span class="s1">'2017-05-05'</span><span class="p">,</span> <span class="na">diameter</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="na">distance</span><span class="p">:</span> <span class="mi">500</span><span class="p">},</span>
        <span class="p">{</span><span class="na">name</span><span class="p">:</span> <span class="s1">'a2000x200'</span><span class="p">,</span> <span class="na">date</span><span class="p">:</span> <span class="s1">'2017-02-02'</span><span class="p">,</span> <span class="na">diameter</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span> <span class="na">distance</span><span class="p">:</span> <span class="mi">200</span><span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// ...other code...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Let’s also create a placeholder for <code class="highlighter-rouge">DateSubmit</code>:</p>

<div title="src/interactive/asteroids/DateSubmit.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="s2">"react"</span>
<span class="k">import</span> <span class="nx">ReactDOM</span> <span class="k">from</span> <span class="s2">"react-dom"</span>

<span class="kd">const</span> <span class="nx">DateSubmit</span> <span class="o">=</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">DateSubmit</span><span class="o">&lt;</span><span class="sr">/p&gt;</span><span class="err">)
</span><span class="p">}</span>

<span class="k">export</span> <span class="p">{</span><span class="nx">DateSubmit</span><span class="p">}</span>
</code></pre></div></div>

<!-- == \noindent -->
<p>and run it:</p>

<figure id="f:interactive-asteroids-screenshot"> <img src="../../files/interactive-asteroids-screenshot.png"> <figcaption>Asteroids Application</figcaption> </figure>

<p>The next step is to handle date submission.
Since we’re trying to instill good practices,
we will make a reusable component whose caller will pass in:</p>

<ul>
  <li>a text label;</li>
  <li>a variable to update with the current value of a text box;</li>
  <li>a function to call when text box’s value changes, and</li>
  <li>another function to call when a button is clicked to submit.</li>
</ul>

<div title="src/interactive/asteroids/DateSubmit.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ...imports as before...</span>

<span class="kd">const</span> <span class="nx">DateSubmit</span> <span class="o">=</span> <span class="p">({</span><span class="nx">label</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">onChange</span><span class="p">,</span> <span class="nx">onCommit</span><span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span>
      <span class="p">{</span><span class="nx">label</span><span class="p">}:</span>
      <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">"text"</span> <span class="nx">value</span><span class="o">=</span><span class="p">{</span><span class="nx">value</span><span class="p">}</span> <span class="nx">onChange</span><span class="o">=</span><span class="p">{(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">onChange</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">)}</span> <span class="sr">/</span><span class="err">&gt;
</span>      <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">onCommit</span><span class="p">(</span><span class="nx">value</span><span class="p">)}</span><span class="o">&gt;</span><span class="k">new</span><span class="o">&lt;</span><span class="sr">/button</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="sr">/p</span><span class="err">&gt;
</span>  <span class="p">)</span>
<span class="p">}</span>

<span class="c1">// ...export as before...</span>
</code></pre></div></div>

<p>Note the use of destructuring in <code class="highlighter-rouge">DateSubmit</code>’s parameter list;
this was introduced <a href="#s:pages-citations">earlier</a>
and is an easy way to pull values out of the <code class="highlighter-rouge">props</code> parameter.</p>

<p>It’s important to understand the order of operations in the example above.
<code class="highlighter-rouge">value={value}</code> puts a value in the input box to display each time <code class="highlighter-rouge">DateSubmit</code> is called.
We re-bind <code class="highlighter-rouge">onChange</code> and <code class="highlighter-rouge">onClick</code> to functions on each call as well
(remember, JSX gets translated into function calls).
So yes,
this whole paragraph is being re-created every time someone types,
but React and the browser work together to minimize recalculation.</p>

<p>Now let’s go back and re-work our application:</p>

<div title="src/interactive/asteroids/app.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ...imports as before...</span>

<span class="kd">class</span> <span class="nx">App</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>

  <span class="kd">constructor</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">newDate</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span>
      <span class="na">asteroids</span><span class="p">:</span> <span class="p">[...]</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">onEditNewDate</span> <span class="o">=</span> <span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span><span class="na">newDate</span><span class="p">:</span> <span class="nx">text</span><span class="p">})</span>
  <span class="p">}</span>

  <span class="nx">onSubmitNewDate</span> <span class="o">=</span> <span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`new date </span><span class="p">${</span><span class="nx">text</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span><span class="na">newDate</span><span class="p">:</span> <span class="s1">''</span><span class="p">})</span>
  <span class="p">}</span>

  <span class="nx">render</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Asteroids</span><span class="o">&lt;</span><span class="sr">/h1</span><span class="err">&gt;
</span>        <span class="o">&lt;</span><span class="nx">DateSubmit</span>
          <span class="nx">label</span><span class="o">=</span><span class="s1">'Date'</span>
          <span class="nx">value</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">newDate</span><span class="p">}</span>
          <span class="nx">onChange</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">onEditNewDate</span><span class="p">}</span>
          <span class="nx">onCommit</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">onSubmitNewDate</span><span class="p">}</span> <span class="sr">/</span><span class="err">&gt;
</span>        <span class="o">&lt;</span><span class="nx">AsteroidList</span> <span class="nx">asteroids</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">asteroids</span><span class="p">}</span> <span class="sr">/</span><span class="err">&gt;
</span>      <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ...mount as before...</span>
</code></pre></div></div>

<p>It’s safe to pass <code class="highlighter-rouge">this.state.newDate</code> to <code class="highlighter-rouge">value</code>
because we’re re-drawing each time there’s a change;
remember, we’re passing a value for display,
not a reference to be modified.
And note that we are not doing any kind of validation:
the user could type <code class="highlighter-rouge">abc123</code> as a date
and we would blithely try to process it.</p>

<p>It’s now time to get real data,
which we will do using <code class="highlighter-rouge">fetch</code> with a URL.
This returns a <a href="#s:promises">promise</a>,
so we’ll handle the result of the fetch in the promise’s <code class="highlighter-rouge">then</code> method,
and then chain another <code class="highlighter-rouge">then</code> method to transform the data into what we need:</p>

<div title="src/interactive/asteroids/app.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nx">onSubmitNewDate</span> <span class="o">=</span> <span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="s2">`https://api.nasa.gov/neo/rest/v1/feed?api_key=DEMO_KEY&amp;start_date=</span><span class="p">${</span><span class="nx">text</span><span class="p">}</span><span class="s2">`</span>
    <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">).</span><span class="nx">then</span><span class="p">((</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">()</span>
    <span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="nx">raw</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">asteroids</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">transform</span><span class="p">(</span><span class="nx">raw</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
        <span class="na">newDate</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span>
        <span class="na">asteroids</span><span class="p">:</span> <span class="nx">asteroids</span>
      <span class="p">})</span>
    <span class="p">})</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>Line by line,
the steps are:</p>

<ol>
  <li>Build the URL for the data</li>
  <li>Start to fetch data from that URL</li>
  <li>Give a callback to execute when the data arrives</li>
  <li>Give another callback to use when the data has been converted from text to JSON
(which we will look at in more detail <a href="#s:dataman">soon</a>).</li>
  <li>Transform that data from its raw form into the objects we need</li>
  <li>Set state</li>
</ol>

<p>Finally,
the method to transform the data NASA gives us is:</p>

<div title="src/interactive/asteroids/app.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nx">transform</span> <span class="o">=</span> <span class="p">(</span><span class="nx">raw</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">raw</span><span class="p">.</span><span class="nx">near_earth_objects</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">raw</span><span class="p">.</span><span class="nx">near_earth_objects</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">asteroid</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
          <span class="na">name</span><span class="p">:</span> <span class="nx">asteroid</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
          <span class="na">date</span><span class="p">:</span> <span class="nx">asteroid</span><span class="p">.</span><span class="nx">close_approach_data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">close_approach_date</span><span class="p">,</span>
          <span class="na">diameter</span><span class="p">:</span> <span class="nx">asteroid</span><span class="p">.</span><span class="nx">estimated_diameter</span><span class="p">.</span><span class="nx">meters</span><span class="p">.</span><span class="nx">estimated_diameter_max</span><span class="p">,</span>
          <span class="na">distance</span><span class="p">:</span> <span class="nx">asteroid</span><span class="p">.</span><span class="nx">close_approach_data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">miss_distance</span><span class="p">.</span><span class="nx">kilometers</span>
        <span class="p">})</span>
      <span class="p">})</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">result</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>We built this by looking at the structure of the JSON that NASA returned
and figuring out how to index the fields we need.
(Unfortunately,
the top level of <code class="highlighter-rouge">near_earth_objects</code> is an object with dates as keys rather than an array,
so we have to use <code class="highlighter-rouge">let...in...</code> rather than purely <code class="highlighter-rouge">map</code> or <code class="highlighter-rouge">forEach</code>.)</p>

<h2 id="s:interactive-exercises">Exercises</h2>

<h3 id="reset">Reset</h3>

<p>Add a “reset” button to the counter application that always sets the counter’s value to zero.
Does using it to wipe out every change you’ve made to the counter
feel like a metaphor for programming in general?</p>

<h3 id="transform">Transform</h3>

<p>Modify all of the examples <em>after</em> the introduction of Babel
to use external scripts rather than in-pace scripts.</p>

<h3 id="exports">Exports</h3>

<p>Are the curly braces necessary when exporting from a component file?
What happens if you remove them?
Read this <a href="http://2ality.com/2014/09/es6-modules-final.html">blogpost</a> and then consider whether it might
have been more appropriate to use default exports and imports
in the examples above.</p>

<h3 id="validation">Validation</h3>

<p>Modify the application so that if the starting date isn’t valid when the button is clicked,
the application displays a warning message instead of fetching data.</p>

<ol>
  <li>Add a field called <code class="highlighter-rouge">validDate</code> to the state and initialize it to <code class="highlighter-rouge">true</code>.</li>
  <li>Add an <code class="highlighter-rouge">ErrorMessage</code> component that displays a paragraph containing either “date OK” or “date invalid”
depending on the value of <code class="highlighter-rouge">validDate</code>.</li>
  <li>Modify <code class="highlighter-rouge">onSubmitNewDate</code> so that it <em>either</em> fetches new data <em>or</em> modifies <code class="highlighter-rouge">validDate</code>.</li>
</ol>

<p>Once you are done,
search the Internet for React validation and error messages
and explore other tools you could use to do this.</p>


      


<div class="listblock">
  <h2>Key Points</h2>
  <ul>
    <li>Define event handlers to specify what actions the browser should take when the user interacts with an application.
</li><li>The browser passes event objects containing details of events to event handlers.
</li><li>Use classes to keep state and event handlers together.
</li><li>React calls a class’s <code class="highlighter-rouge">render</code> to display it.
</li><li>Separate models (which store data) from views (which display it).
</li><li>Use <code class="highlighter-rouge">fetch</code> to get data from servers.
</li><li>Use destructuring to get individual members from an object in a single step.
</li><li>Modern JavaScript uses promises to manage asynchronous activities.
</li>
  </ul>
</div>


    </div>
<div class="chapter">
      <h1 id="s:dataman">Managing Data</h1>
      


<div class="listblock">
  <h2>Questions</h2>
  <ul>
    <li>What formats are commonly used for small scientific datasets?
</li><li>What are some of the strengths and weaknesses of those formats?
</li><li>How can I parse CSV data?
</li><li>How should I select a subset of data for testing purposes?
</li>
  </ul>
</div>


      
      <p>There’s not much point creating interactive web pages
if they don’t have something to interact with.
To provide that,
we need something to store data and something to serve it.
We could build one program to do both,
but experience teaches that it’s better to create one for each
so that they are easier to understand, test, and maintain.
After tossing a coin,
we decide to start with the data store;
the <a href="#s:server">next lesson</a> will look at how to build a server.</p>

<h2 id="s:data-formats">Data Formats</h2>

<p>The most widely used text format for tabular data is undoubtedly
<a href="#g:csv">comma-separated values</a> or CSV.
Each row of the table is a line in the file;
the values within each row—i.e., the columns—are separated by commas.
Numbers appear as themselves;
strings may or may not be wrapped in quotation marks,
unless they contain commas themselves,
in which case they definitely are:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"maroon",128,0,0
"olive",128,128,0
"aqua",0,255,255
"fuchsia",255,0,255
</code></pre></div></div>

<p>The first line of a CSV file is often a <a href="#g:header-row">header row</a>
that defines the names of the columns.
For example,
the small table shown above would better be represented as:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"name","red","green","blue"
"maroon",128,0,0
"olive",128,128,0
"aqua",0,255,255
"fuchsia",255,0,255
</code></pre></div></div>

<p>Tragically,
CSV doesn’t require the first row to be a header,
and CSV files usually don’t specify units or data types.
We can guess that the values in the table above are integers,
but it’s all too common to have a CSV file whose columns are labelled “height” and “weight”
without any indication of whether the heights are in feet or meters
or the weights in pounds or kilograms.</p>

<p>CSV is good for tabular data,
but a lot of data doesn’t neatly fit into rows and columns.
A format for hierarchical data that is popular with many programmers is <a href="#g:json">JSON</a>,
which stands for JavaScript Object Notation.
It supports a subset of the syntax for values, arrays, and objects in JavaScript,
so that (for example)
we can store configuration values for a program like this:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
  <span class="s2">"name"</span> <span class="p">:</span> <span class="s2">"DataExplorer"</span><span class="p">,</span>
  <span class="s2">"version"</span> <span class="p">:</span> <span class="s2">"1.2.1"</span><span class="p">,</span>
  <span class="s2">"preferences"</span> <span class="p">:</span> <span class="p">{</span>
    <span class="s2">"colorscheme"</span> <span class="p">:</span> <span class="s2">"dark"</span><span class="p">,</span>
    <span class="s2">"autofill"</span> <span class="p">:</span> <span class="kc">true</span>
  <span class="p">},</span>
  <span class="s2">"last_opened"</span> <span class="p">:</span> <span class="p">[</span>
    <span class="s2">"raw/biotic.dat"</span><span class="p">,</span>
    <span class="s2">"raw/genomic.dat"</span><span class="p">,</span>
    <span class="s2">"cooked/inferred.dat"</span>
  <span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>JSON can be used for tabular data as well.
The whole table is an array,
and each record is an object with name-value pairs:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span>
  <span class="p">{</span><span class="s2">"name"</span><span class="p">:</span> <span class="s2">"maroon"</span><span class="p">,</span> <span class="s2">"red"</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span> <span class="s2">"green"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"blue"</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">"name"</span><span class="p">:</span> <span class="s2">"olive"</span><span class="p">,</span> <span class="s2">"red"</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span> <span class="s2">"green"</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span> <span class="s2">"blue"</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">"name"</span><span class="p">:</span> <span class="s2">"aqua"</span><span class="p">,</span> <span class="s2">"red"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"green"</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span> <span class="s2">"blue"</span><span class="p">:</span> <span class="mi">255</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">"name"</span><span class="p">:</span> <span class="s2">"fuchsia"</span><span class="p">,</span> <span class="s2">"red"</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span> <span class="s2">"green"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"blue"</span><span class="p">:</span> <span class="mi">255</span><span class="p">}</span>
<span class="p">]</span>
</code></pre></div></div>

<p>Repeating field names like this is wasteful compared to listing them once at the top of a table,
but it does mean that the fields within rows can be accessed directly
using expressions like <code class="highlighter-rouge">colors[1].red</code>.</p>

<h2 id="s:data-slicing">Slicing Data</h2>

<p>The data we will use as an example is available in a variety of formats from <a href="https://figshare.com/articles/Portal_Project_Teaching_Database/1314459">https://figshare.com/articles/Portal_Project_Teaching_Database/1314459</a>.
We will focus on <code class="highlighter-rouge">surveys.csv</code>,
which has over 35,500 records.
That’s a lot to look at,
so we will create a 10-record slice for testing.</p>

<p>Although it would be easy to take the first ten,
or the last,
there’s a good chance that neither would be representative of the data as a whole.
Instead,
we will write a little script that selects N records at random.
Since it doesn’t need to be efficient,
we will do something simple:</p>

<div title="src/dataman/select-random.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'fs'</span><span class="p">)</span>

<span class="kd">const</span> <span class="p">[</span><span class="nx">inputFile</span><span class="p">,</span> <span class="nx">numLines</span><span class="p">,</span> <span class="nx">outputFile</span><span class="p">]</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">lines</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">inputFile</span><span class="p">,</span> <span class="s1">'utf-8'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'</span><span class="err">\</span><span class="s1">n'</span><span class="p">)</span>
<span class="nx">header</span> <span class="o">=</span> <span class="nx">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="kd">const</span> <span class="nx">sample</span> <span class="o">=</span> <span class="nx">lines</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">line</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">(),</span> <span class="nx">line</span><span class="p">])</span>
    <span class="p">.</span><span class="nx">sort</span><span class="p">((</span><span class="nx">left</span><span class="p">,</span> <span class="nx">right</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">left</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">right</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">})</span>
    <span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">numLines</span><span class="p">))</span>
    <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">pair</span> <span class="o">=&gt;</span> <span class="nx">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileSync</span><span class="p">(</span><span class="nx">outputFile</span><span class="p">,</span> <span class="nx">header</span> <span class="o">+</span> <span class="s1">'</span><span class="err">\</span><span class="s1">n'</span> <span class="o">+</span> <span class="nx">sample</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">'</span><span class="err">\</span><span class="s1">n'</span><span class="p">))</span>
</code></pre></div></div>

<p>We run this on the command line:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>node <span class="k">select</span><span class="nt">-random</span>.js ../../data/surveys.csv 10 slice.csv
</code></pre></div></div>

<p>and get this:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>record_id,month,day,year,plot_id,species_id,sex,hindfoot_length,weight
18501,3,14,1991,13,OT,M,21,28
2283,1,15,1980,11,OL,M,21,23
19941,5,2,1992,1,PP,M,22,13
27413,12,29,1997,5,,,,
16002,5,9,1989,19,SC,,,
28813,11,21,1998,12,DO,M,35,56
9338,7,4,1984,11,DO,F,35,57
28336,8,22,1998,7,PB,M,26,23
25323,3,16,1997,9,DM,F,33,26
6785,10,23,1982,5,DM,F,37,45
</code></pre></div></div>

<p>Running it again will probably generate a different data slice,
since we’re not specifying a random number generation seed.
We are bad people, and will fix this in the exercises.</p>

<h2 id="s:data-manager">Data Manager</h2>

<p>Rather arbitrarily,
we decide that our data manager will be able to answer two questions:</p>

<ol>
  <li>How many records do we have and what range of years do they cover?
This is the kind of opening question that many client programs will ask.</li>
  <li>What are the minimum, average, and maximum values
for weight and hindfoot length by year
for a given range of years?
This would be very specific to a particular kind of client program;
a good service would either provide many such specialized queries
or provide a way to apply common <a href="#g:aggregation-function">aggregation functions</a>
to particular columns.</li>
</ol>

<p>We will use <a href="https://www.papaparse.com/">PapaParse</a> to parse our CSV,
so our first step is to install it:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm <span class="nb">install </span>papaparse
</code></pre></div></div>

<p>After loading the library and reading our test data file a couple of times,
we break down and read the documentation,
then come up with this as the first version of our data manager:</p>

<div title="src/dataman/data-manager.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'fs'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">papa</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'papaparse'</span><span class="p">)</span>

<span class="kd">class</span> <span class="nx">DataManager</span> <span class="p">{</span>

  <span class="kd">constructor</span> <span class="p">(</span><span class="nx">filename</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">raw</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span> <span class="s1">'utf-8'</span><span class="p">)</span>
    <span class="kd">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span><span class="na">header</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">dynamicTyping</span><span class="p">:</span> <span class="kc">true</span><span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">papa</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">raw</span><span class="p">,</span> <span class="nx">options</span><span class="p">).</span><span class="nx">data</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">DataManager</span>
</code></pre></div></div>

<p>What our hubris made us miss in our first couple of attempts was that
the <code class="highlighter-rouge">options</code> object controls how the parser behaves.
Here,
we tell it to interpret the first row as a header (which sets column names)
and to convert things that look like numbers to numbers (the <code class="highlighter-rouge">dynamicTyping</code> option).
The output of <code class="highlighter-rouge">papa.parse</code> looks like this:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span> <span class="nl">data</span><span class="p">:</span>
   <span class="p">[</span> <span class="p">{</span> <span class="na">record_id</span><span class="p">:</span> <span class="mi">18501</span><span class="p">,</span>
       <span class="na">month</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
       <span class="na">day</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
       <span class="na">year</span><span class="p">:</span> <span class="mi">1991</span><span class="p">,</span>
       <span class="na">plot_id</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span>
       <span class="na">species_id</span><span class="p">:</span> <span class="s1">'OT'</span><span class="p">,</span>
       <span class="na">sex</span><span class="p">:</span> <span class="s1">'M'</span><span class="p">,</span>
       <span class="na">hindfoot_length</span><span class="p">:</span> <span class="mi">21</span><span class="p">,</span>
       <span class="na">weight</span><span class="p">:</span> <span class="mi">28</span> <span class="p">},</span>

     <span class="p">...</span><span class="nx">eight</span> <span class="nx">more</span> <span class="nx">records</span><span class="p">...</span>

     <span class="p">{</span> <span class="nl">record_id</span><span class="p">:</span> <span class="mi">6785</span><span class="p">,</span>
       <span class="nx">month</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
       <span class="nx">day</span><span class="p">:</span> <span class="mi">23</span><span class="p">,</span>
       <span class="nx">year</span><span class="p">:</span> <span class="mi">1982</span><span class="p">,</span>
       <span class="nx">plot_id</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
       <span class="nx">species_id</span><span class="p">:</span> <span class="s1">'DM'</span><span class="p">,</span>
       <span class="nx">sex</span><span class="p">:</span> <span class="s1">'F'</span><span class="p">,</span>
       <span class="nx">hindfoot_length</span><span class="p">:</span> <span class="mi">37</span><span class="p">,</span>
       <span class="nx">weight</span><span class="p">:</span> <span class="mi">45</span> <span class="p">}</span> <span class="p">],</span>
  <span class="nx">errors</span><span class="p">:</span> <span class="p">[],</span>
  <span class="nx">meta</span><span class="p">:</span>
   <span class="p">{</span> <span class="nl">delimiter</span><span class="p">:</span> <span class="s1">','</span><span class="p">,</span>
     <span class="nx">linebreak</span><span class="p">:</span> <span class="s1">'</span><span class="err">\</span><span class="s1">n'</span><span class="p">,</span>
     <span class="nx">aborted</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
     <span class="nx">truncated</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
     <span class="nx">cursor</span><span class="p">:</span> <span class="mi">350</span><span class="p">,</span>
     <span class="nx">fields</span><span class="p">:</span>
      <span class="p">[</span> <span class="s1">'record_id'</span><span class="p">,</span>
        <span class="s1">'month'</span><span class="p">,</span>
        <span class="s1">'day'</span><span class="p">,</span>
        <span class="s1">'year'</span><span class="p">,</span>
        <span class="s1">'plot_id'</span><span class="p">,</span>
        <span class="s1">'species_id'</span><span class="p">,</span>
        <span class="s1">'sex'</span><span class="p">,</span>
        <span class="s1">'hindfoot_length'</span><span class="p">,</span>
        <span class="s1">'weight'</span> <span class="p">]</span> <span class="p">}</span> <span class="p">}</span>
</code></pre></div></div>

<!-- == \noindent -->
<p>so using <code class="highlighter-rouge">papa.parse(raw, options).data</code> gets the data we want as JSON.
Let’s write a method to get some overall statistics:</p>

<div title="src/dataman/data-manager.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nx">getSurveyStats</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">minYear</span> <span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_get</span><span class="p">(</span><span class="s1">'year'</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">),</span>
      <span class="na">maxYear</span> <span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_get</span><span class="p">(</span><span class="s1">'year'</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">),</span>
      <span class="na">count</span> <span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">_get</span><span class="p">(</span><span class="nx">field</span><span class="p">,</span> <span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">func</span><span class="p">(...</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">rec</span> <span class="o">=&gt;</span> <span class="nx">rec</span><span class="p">[</span><span class="nx">field</span><span class="p">]))</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>Functions like <code class="highlighter-rouge">Math.min</code> and <code class="highlighter-rouge">Math.max</code> take any number of scalar values as arguments,
but do not directly process arrays.
However, the notation <code class="highlighter-rouge">func(...array)</code> means
“pass all the values in the array as separate arguments”,
which saves us from writing our own minimum and maximum functions.
Thus,
<code class="highlighter-rouge">func(...this.data.map(rec =&gt; rec[field]))</code> means
“select the specified field from each record in <code class="highlighter-rouge">this.data</code> to create an array of fields,
then pass all of those values as arguments to <code class="highlighter-rouge">func</code>.
We include an underscore to the start of the name of <code class="highlighter-rouge">_get</code> to indicate that we
intend it to be used only inside <code class="highlighter-rouge">DataManager</code> and not to be called elsewhere.</p>

<p>Adding the method to get weight and hindfoot length for a range of years
is comparatively straightforward.
First,
we write a function to calculate the average of one or more arguments:</p>

<div title="src/dataman/data-manager.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">_average</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">values</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">sum</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">sum</span> <span class="o">+=</span> <span class="nx">v</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">sum</span> <span class="o">/</span> <span class="nx">values</span><span class="p">.</span><span class="nx">length</span>
<span class="p">}</span>
</code></pre></div></div>

<p>It would be more natural for <code class="highlighter-rouge">_average</code> to take an array rather than a variable number of arguments,
but we want to be able to use it in the same way that we use <code class="highlighter-rouge">Math.min</code> and <code class="highlighter-rouge">Math.max</code>,
so we have to conform to their signature.</p>

<p>After some thought we realize that it’s possible for <code class="highlighter-rouge">subset</code> to be empty -
that is, it’s possible that there are years that have no data in our data set.
We should filter these out,
to prevent unnecessary effort being made to render summary statistics with <code class="highlighter-rouge">NaN</code> values.
Remembering that <a href="#s:basics">empty arrays are not falsy in JavaScript</a>,
we decide to test that the <code class="highlighter-rouge">subset</code> returned by filtering for each year
contains at least one entry.</p>

<p>The last thing that we need to ensure is that each data object has a unique key,
which will make it much easier for React to efficiently update the display of
the data when we are ready to render it.</p>

<p>The method to get the values for a range of years is now:</p>

<div title="src/dataman/data-manager.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nx">getSurveyRange</span> <span class="p">(</span><span class="nx">minYear</span><span class="p">,</span> <span class="nx">maxYear</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Array</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nx">maxYear</span> <span class="o">-</span> <span class="nx">minYear</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">v</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">minYear</span> <span class="o">+</span> <span class="nx">i</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">year</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">subset</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">r</span> <span class="o">=&gt;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">year</span> <span class="o">===</span> <span class="nx">year</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">subset</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span>
          <span class="na">key</span>  <span class="p">:</span> <span class="nx">toString</span><span class="p">(</span><span class="nx">year</span><span class="p">),</span>
          <span class="na">year</span> <span class="p">:</span> <span class="nx">year</span><span class="p">,</span>
          <span class="na">min_hindfoot_length</span> <span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_get</span><span class="p">(</span><span class="nx">subset</span><span class="p">,</span> <span class="s1">'hindfoot_length'</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">),</span>
          <span class="na">ave_hindfoot_length</span> <span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_get</span><span class="p">(</span><span class="nx">subset</span><span class="p">,</span> <span class="s1">'hindfoot_length'</span><span class="p">,</span> <span class="nx">_average</span><span class="p">),</span>
          <span class="na">max_hindfoot_length</span> <span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_get</span><span class="p">(</span><span class="nx">subset</span><span class="p">,</span> <span class="s1">'hindfoot_length'</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">),</span>
          <span class="na">min_weight</span> <span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_get</span><span class="p">(</span><span class="nx">subset</span><span class="p">,</span> <span class="s1">'weight'</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">),</span>
          <span class="na">ave_weight</span> <span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_get</span><span class="p">(</span><span class="nx">subset</span><span class="p">,</span> <span class="s1">'weight'</span><span class="p">,</span> <span class="nx">_average</span><span class="p">),</span>
          <span class="na">max_weight</span> <span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_get</span><span class="p">(</span><span class="nx">subset</span><span class="p">,</span> <span class="s1">'weight'</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">})</span>
  <span class="p">}</span>
</code></pre></div></div>

<h2 id="s:data-exercises">Exercises</h2>

<h3 id="tracing-data">Tracing Data</h3>

<p>Trace the execution of the utility program that creates a small sample of the original data,
explaining what is passed into each of the chained methods calls.</p>

<h3 id="unrandom">Unrandom</h3>

<p>Programs that rely on random numbers are impossible to test
because there’s (deliberately) no way to predict their output.
Luckily, computer programs don’t actually use random numbers:
they use <a href="#g:pseudo-random-number">pseudo-random numbers</a>
that are generated in a repeatable but unpredictable way.
Given the same initial <a href="#g:seed">seed</a>,
a pseudo-random number generator will always produce the same sequence of values.</p>

<p>There is no way to set a seed for <code class="highlighter-rouge">Math.random</code> out of the box,
but the <a href="https://www.npmjs.com/package/seedrandom">seedrandom</a> package provides an add-on function for this purpose.
Install the package and modify the slice selection utility
so that it takes a word or phrase as a command-line argument
and uses it to seed the random number generator.</p>

<h3 id="one-record-per-year">One Record Per Year</h3>

<p>Another way to slice the data for testing purposes is to select one record from each year.
Write a small command-line JavaScript program that:</p>

<ol>
  <li>Reads all the data from the CSV.</li>
  <li>Keeps the first record it finds for each year.</li>
  <li>Prints these records formatted as SQL <code class="highlighter-rouge">insert</code> statements.</li>
</ol>

<h3 id="error-handling">Error Handling</h3>

<p>Modify <code class="highlighter-rouge">DataManager</code>’s constructor so that it checks for errors.</p>

<h3 id="generalization">Generalization</h3>

<p>Modify <code class="highlighter-rouge">getSurveyRange</code> so that it can be called like this:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">getSurveyRange</span><span class="p">(</span><span class="nx">minYear</span><span class="p">,</span> <span class="nx">maxYear</span><span class="p">,</span> <span class="s1">'hindfoot_length'</span><span class="p">,</span> <span class="s1">'weight'</span><span class="p">)</span>
</code></pre></div></div>

<!-- == \noindent -->
<p>i.e., so that the names of the fields whose minimum, average, and maximum values are wanted
can be passed as strings,
and the method will automatically create the right names and values in its result.</p>


      


<div class="listblock">
  <h2>Key Points</h2>
  <ul>
    <li>Small tabular datasets are commonly stored as Comma-Separated Values (CSV).
</li><li>CSV can only represent regular data, and CSV files usually don’t include units.
</li><li>Nested data is commonly stored using JavaScript Object Notation (JSON).
</li><li>JSON representations of tabular data often include redundant (and therefore possibly inconsistent) specifications of column names.
</li><li>PapaParse is a robust CSV parsing library that produces JSON output.
</li>
  </ul>
</div>


    </div>
<div class="chapter">
      <h1 id="s:server">Creating a Server</h1>
      


<div class="listblock">
  <h2>Questions</h2>
  <ul>
    <li>How do browsers and servers communicate?
</li><li>What tools can I use to create a data server in JavaScript?
</li><li>How can I tell a server to handle different URLs differently?
</li><li>How can I serve files from disk?
</li><li>How does a server specify the type of data it’s sending?
</li><li>How can I add new abilities to a server without rewriting it?
</li>
  </ul>
</div>


      
      <p>Now that we have <a href="#s:dataman">a data manager</a>,
the next step is to create a server to share our data with the world,
which we will build using a library called <a href="https://expressjs.org/">Express</a>.
Before we start writing code,
though,
we need to understand how computers talk to each other.</p>

<h2 id="s:server-http">HTTP</h2>

<p>Almost everything on the web communicates via <a href="#g:http">HTTP</a>,
which stands for HyperText Transfer Protocol.
The core of HTTP is a <a href="#g:http-request">request</a>/<a href="#g:http-response">response</a> cycle
that specifies the kinds of requests applications can make of servers,
how they exchange data,
and so on.
The diagram below shows this cycle in action for a page that includes one image:</p>

<ol>
  <li>The client (a browser or some other program) makes a connection to a server.</li>
  <li>It then sends a blob of text specifying what it’s asking for.</li>
  <li>The server replies with a blob of text and the HTML.</li>
  <li>The connection is closed.</li>
  <li>The client parses the text and realizes it needs an image.</li>
  <li>It sends another blob of text to the server asking for that image.</li>
  <li>The server replies with a blob of text and the contents of the image file.</li>
  <li>The connection is closed.</li>
</ol>

<figure id="f:server-cycle"> <img src="../../files/server-cycle.svg"> <figcaption>HTTP Request/Response Cycle</figcaption> </figure>

<p>This cycle might be repeated many times to display a single web page,
since a separate request has to be made for every image,
every CSS or JavaScript file,
and so on.
In practice,
a lot of behind-the-scenes engineering is done to keep connections alive as long as they’re needed,
and to <a href="#g:cache">cache</a> items that are likely to be re-used.</p>

<p>An HTTP request is just a block of text with two important parts:</p>

<ul>
  <li>The <a href="#g:http-method">method</a> is almost always either <code class="highlighter-rouge">GET</code> (to get data) or <code class="highlighter-rouge">POST</code> (to submit data).</li>
  <li>The <a href="#g:url">URL</a> is typically a path to a file,
but as we’ll see below,
it’s completely up to the server to interpret it.</li>
</ul>

<p>The request can also contain <a href="#g:http-header">headers</a>,
which are key-value pairs with more information about what the client wants.
Some examples include:</p>

<ul>
  <li><code class="highlighter-rouge">"Accept: text/html"</code> to specify that the client wants HTML</li>
  <li><code class="highlighter-rouge">"Accept-Language: fr, en"</code> to specify that the client prefers French, but will accept English</li>
  <li><code class="highlighter-rouge">"If-Modified-Since: 16-May-2018"</code> to tell the server that the client is only interested in recent data</li>
</ul>

<p>(Unlike a dictionary, a key may appear any number of times,
which allows a request to do things like specify that it’s willing to accept several types of content.
The <a href="#g:http-body">body</a> of the request is any extra data associated with it,
such as files that are being uploaded.
If a body is present,
the request must contain the <code class="highlighter-rouge">Content-Length</code> header
so that the server knows how much data to read.</p>

<figure id="f:server-request"> <img src="../../files/server-request.svg"> <figcaption>Structure of an HTTP Request</figcaption> </figure>

<p>The headers and body in an HTTP response have the same form, and mean the same thing.
Crucially,
the response also includes a status code to indicate what happened:
200 for OK, 404 for “page not found”, and so on.
Some of the more common are:</p>

<table>
  <thead>
    <tr>
      <th>Code</th>
      <th>Name</th>
      <th>Meaning</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>100</td>
      <td>Continue</td>
      <td>The client should continue sending data</td>
    </tr>
    <tr>
      <td>200</td>
      <td>OK</td>
      <td>The request has succeeded</td>
    </tr>
    <tr>
      <td>204</td>
      <td>No Content</td>
      <td>The server completed the request but doesn’t need to return any data</td>
    </tr>
    <tr>
      <td>301</td>
      <td>Moved Permanently</td>
      <td>The requested resource has moved to a new permanent location</td>
    </tr>
    <tr>
      <td>307</td>
      <td>Temporary Redirect</td>
      <td>The requested resource is temporarily at a different location</td>
    </tr>
    <tr>
      <td>400</td>
      <td>Bad Request</td>
      <td>The request is badly formatted</td>
    </tr>
    <tr>
      <td>401</td>
      <td>Unauthorized</td>
      <td>The request requires authentication</td>
    </tr>
    <tr>
      <td>404</td>
      <td>Not Found</td>
      <td>The requested resource could not be found</td>
    </tr>
    <tr>
      <td>408</td>
      <td>Timeout</td>
      <td>The server gave up waiting for the client</td>
    </tr>
    <tr>
      <td>418</td>
      <td>I’m a Teapot</td>
      <td>Originally an April Fool’s joke, now used to identify devices</td>
    </tr>
    <tr>
      <td>500</td>
      <td>Internal Server Error</td>
      <td>An error occurred in the server while trying to handle the request</td>
    </tr>
    <tr>
      <td>601</td>
      <td>Connection Timed Out</td>
      <td>The server did not respond before the connection timed out</td>
    </tr>
  </tbody>
</table>

<p>One final thing we need to understand is the structure and interpretation of URLs.
This one:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://example.org:1234/some/path?value=deferred&amp;limit=200
</code></pre></div></div>

<!-- == \noindent -->
<p>has five parts:</p>

<ul>
  <li>The protocol <code class="highlighter-rouge">http</code>, which specifies what rules are going to be used to exchange data.</li>
  <li>The <a href="#g:hostname">hostname</a> <code class="highlighter-rouge">example.org</code>, which tells the client where to find the server.
If we are running a server on our own computer for testing,
we can use the name <code class="highlighter-rouge">localhost</code> to connect to it.
(Computers rely on a service called <a href="#g:dns">DNS</a>
to find the machines associated with human-readable hostnames,
but its operation is out of scope for this tutorial.)</li>
  <li>The <a href="#g:port">port</a> <code class="highlighter-rouge">1234</code>, which tells the client where to call the service it wants.
(If a host is like an office building, a port is like a phone number in that building.
The fact that we think of phone numbers as having physical locations
says something about our age…)</li>
  <li>The path <code class="highlighter-rouge">/some/path</code> tells the server what the client wants.</li>
  <li>The <a href="#g:query-parameter">query parameters</a> <code class="highlighter-rouge">value=deferred</code> and <code class="highlighter-rouge">limit=200</code>.
These come after a question mark and are separated by ampersands,
and are used to provide extra information.</li>
</ul>

<p>It used to be common for paths to identify actual files on the server,
but the server can interpret the path however it wants.
In particular,
when we are writing a data service,
the segments of the path can identify what data we are asking for.
Alternatively,
it’s common to think of the path as identifying a function on the server that we want to call,
and to think of the query parameters as the arguments to that function.
We’ll return to these ideas after we’ve seen how a simple server works.</p>

<h2 id="s:server-express">Hello, Express</h2>

<p>A Node-based library called Express handles most of the details of HTTP for us.
When we build a server using Express,
we provide callback functions that take three parameters:</p>

<ul>
  <li>the original request,</li>
  <li>the response we’re building up, and</li>
  <li>what to do next (which we’ll ignore for now).</li>
</ul>

<p>We also provide a pattern with each function that specifies what URLs it is to match.
Here is a simple example:</p>

<div title="src/server/static-page.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">PORT</span> <span class="o">=</span> <span class="mi">3418</span>

<span class="c1">// Main server object.</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">()</span>

<span class="c1">// Return a static page.</span>
<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="s1">'&lt;html&gt;&lt;body&gt;&lt;h1&gt;Asteroids&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;'</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">PORT</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'listening...'</span><span class="p">)</span> <span class="p">})</span>
</code></pre></div></div>

<p>The first line of code loads the Express library.
The next defines the port we will listen on,
and then the third creates the object that will do most of the work.</p>

<p>Further down,
the call to <code class="highlighter-rouge">app.get</code> tells that object to handle any <code class="highlighter-rouge">GET</code> request for ‘/’
by sending a reply whose status is 200 (OK)
and whose body is an HTML page containing only an <code class="highlighter-rouge">h1</code> heading.
There is no actual HTML file on disk,
and in fact no way for the browser to know if there was one or not:
the server can send whatever it wants in response to whatever requests it wants to handle.</p>

<p>Note that <code class="highlighter-rouge">app.get</code> doesn’t actually get anything right away.
Instead,
it registers a callback with Express that says,
“When you see this URL, call this function to handle it.”
As we’ll see below,
we can register as many path/callback pairs as we want to handle different things.</p>

<p>Finally,
the last line of this script tells our application to listen on the specified port,
while the callback tells it to print a message as it starts running.
When we run this, we see:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>node static-page.js
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>listening...
</code></pre></div></div>

<p>Our little server is now waiting for something to ask it for something.
If we go to our browser and request <code class="highlighter-rouge">http://localhost:3418/</code>,
we get a page with a large title <code class="highlighter-rouge">Asteroids</code> on it.
Our server has worked,
and we can now stop it by typing <kbd>Ctrl-C</kbd> in the shell.</p>

<h2 id="s:server-paths">Handling Multiple Paths</h2>

<p>Let’s extend our server to do different things when given different paths,
and to handle the case where the request path is not known:</p>

<div title="src/server/multiple-paths.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">PORT</span> <span class="o">=</span> <span class="mi">3418</span>

<span class="c1">// Main server object.</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">()</span>

<span class="c1">// Root page.</span>
<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="s1">'&lt;html&gt;&lt;body&gt;&lt;h1&gt;Home&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;'</span><span class="p">)</span>
<span class="p">})</span>

<span class="c1">// Alternative page.</span>
<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/asteroids'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="s1">'&lt;html&gt;&lt;body&gt;&lt;h1&gt;Asteroids&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;'</span><span class="p">)</span>
<span class="p">})</span>

<span class="c1">// Nothing else worked.</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="s2">`&lt;html&gt;&lt;body&gt;&lt;h1&gt;ERROR&lt;/h1&gt;&lt;p&gt;URL "</span><span class="p">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">}</span><span class="s2">" not found&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;`</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">PORT</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'listening...'</span><span class="p">)</span> <span class="p">})</span>
</code></pre></div></div>

<p>The first few lines are the same as before.
We then specify handlers for the paths <code class="highlighter-rouge">/</code> and <code class="highlighter-rouge">/asteroids</code>,
each of which sends a different chunk of HTML.</p>

<p>The call to <code class="highlighter-rouge">app.use</code> specifies a default handler:
if none of the <code class="highlighter-rouge">app.get</code> handlers above it took care of the request,
this callback function will send a “page not found” code
<em>and</em> a page containing an error message.
Some sites skip the first part and only return error messages in pages for people to read,
but this is sinful:
making the code explicit makes it a lot easier to write programs to scrape data.</p>

<p>As before, we can run our server from the command line
and then go to various URLs to test it.
<code class="highlighter-rouge">http://localhost:3418/</code> produces a page with the title “Home”,
<code class="highlighter-rouge">http://localhost:3418/asteroids</code> produces one with the title “Asteroids”,
and <code class="highlighter-rouge">http://localhost:3418/test</code> produces an error page.</p>

<h2 id="s:server-files">Serving Files from Disk</h2>

<p>It’s common to generate HTML in memory when building data services,
but it’s also common for the server to return files.
To do this,
we will provide our server with the path to the directory it’s allowed to read pages from,
and then run it with <code>node <em>server-name</em>.js <em>path/to/directory</em></code>.
We have to tell the server whence it’s allowed to read files
because we definitely do <em>not</em> want it to be able to send everything on our computer to whoever asks for it.
(For example,
a request for the <code class="highlighter-rouge">/etc/passwd</code> password file on a Linux server should probably be refused.)</p>

<p>Here’s our updated server:</p>

<div title="src/server/serve-pages.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'path'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'fs'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">PORT</span> <span class="o">=</span> <span class="mi">3418</span>
<span class="kd">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<span class="c1">// Main server object.</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">()</span>

<span class="c1">// Handle all requests.</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">actual</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span>
  <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">actual</span><span class="p">,</span> <span class="s1">'utf-8'</span><span class="p">)</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">PORT</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'listening...'</span><span class="p">)</span> <span class="p">})</span>
</code></pre></div></div>

<p>The steps in handling a request are:</p>

<ol>
  <li>The URL requested by the client is given to us in <code class="highlighter-rouge">req.url</code>.</li>
  <li>We use <code class="highlighter-rouge">path.join</code> to combine that with the path to the root directory,
which we got from a command-line argument when the server was run.</li>
  <li>We try to read that file using <code class="highlighter-rouge">readFileSync</code>,
which blocks the server until the file is read.
We will see later how to do this I/O asynchronously
so that our server is more responsive.</li>
  <li>Once the file has been read, we return it with a status code of 200.</li>
</ol>

<p>If a sub-directory called <code class="highlighter-rouge">web-dir</code> holds a file called <code class="highlighter-rouge">title.html</code>,
and we run the server as:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>node serve-pages.js ./web-dir
</code></pre></div></div>

<!-- == \noindent -->
<p>we can then ask for <code class="highlighter-rouge">http://localhost:3418/title.html</code>
and get the content of <code class="highlighter-rouge">web-dir/title.html</code>.
Notice that the directory <code class="highlighter-rouge">./web-dir</code> doesn’t appear in the URL:
our server interprets all paths as if the directory we’ve given it
is the root of the filesystem.</p>

<p>If we ask for a page that doesn’t exist,
such as <code class="highlighter-rouge">http://localhost:3418/missing.html</code>,
we get this:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error: ENOENT: no such file or directory, open 'web-dir/missing.html'
    at Object.openSync (fs.js:434:3)
    at Object.readFileSync (fs.js:339:35)
    ... etc. ...
</code></pre></div></div>

<p>We will see in the exercises how to add proper error handling to our server.</p>

<blockquote>
  <p><strong>Favorites and Icons</strong></p>

  <p>If we use a browser to request a page such as <code class="highlighter-rouge">title.html</code>,
the browser may actually make two requests:
one for the page,
and one for a file called <code class="highlighter-rouge">favicon.ico</code>.
Browsers do this automatically,
then display that file in tabs, bookmark lists, and so on.
Despite its <code class="highlighter-rouge">.ico</code> suffix,
the file is (usually) a small PNG-formatted image,
and must be placed in the root directory of the website.</p>
</blockquote>

<h2 id="s:server-content-types">Content Types</h2>

<p>So far we have only served HTML,
but the server can send any type of data,
including images and other binary files.
For example,
let’s serve some JSON data:</p>

<div title="src/server/data-server.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ...as before...</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">actual</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">actual</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">'.json'</span><span class="p">))</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">actual</span><span class="p">,</span> <span class="s1">'utf-8'</span><span class="p">)</span>
    <span class="kd">const</span> <span class="nx">json</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">'Content-Type'</span><span class="p">,</span> <span class="s1">'application/json'</span><span class="p">)</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">else</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">actual</span><span class="p">,</span> <span class="s1">'utf-8'</span><span class="p">)</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">})</span>
</code></pre></div></div>

<p>What’s different here is that when the requested path ends with <code class="highlighter-rouge">.json</code>
we explicitly set the <code class="highlighter-rouge">Content-Type</code> header to <code class="highlighter-rouge">application/json</code>
to tell the client how to interpret the bytes we’re sending back.
If we run this server with <code class="highlighter-rouge">web-dir</code> as the directory to serve from
and ask for <code class="highlighter-rouge">http://localhost:3418/data.json</code>,
a modern browser will provide a folding display of the data
rather than displaying the raw text.</p>

<h2 id="s:server-exercises">Exercises</h2>

<h3 id="report-missing-files">Report Missing Files</h3>

<p>Modify the version of the server that returns files from disk
to report a 404 error if a file cannot be found.
What should it return if the file exists but cannot be read
(e.g., if the server does not have permissions)?</p>

<h3 id="serving-images">Serving Images</h3>

<p>Modify the version of the server that returns files from disk
so that if the file it is asked for has a name ending in <code class="highlighter-rouge">.png</code> or <code class="highlighter-rouge">.jpg</code>,
it is returned with the right <code class="highlighter-rouge">Content-Type</code> header.</p>

<h3 id="delayed-replies">Delayed Replies</h3>

<p>Our file server uses <code class="highlighter-rouge">fs.readFileSync</code> to read files,
which means that it stops each time a file is requested
rather than handling other queries while waiting for the file to be read.
Modify the callback given to <code class="highlighter-rouge">app.use</code> so that it uses <code class="highlighter-rouge">fs.readFile</code> with a callback instead.</p>

<h3 id="using-query-parameters">Using Query Parameters</h3>

<p>URLs can contain query parameters in the form <code class="highlighter-rouge">http://site.edu?first=1&amp;second=b</code>.
Read the online documentation for <a href="https://expressjs.org/">Express</a> to find out
how to access them in a server,
and then write a server to do simple arithmetic:
the URL <code class="highlighter-rouge">http://localhost:3654/add?left=1&amp;right=2</code> should return <code class="highlighter-rouge">3</code>,
while the URL <code class="highlighter-rouge">http://localhost:3654/subtract?left=1&amp;right=2</code> should return <code class="highlighter-rouge">-1</code>.</p>


      


<div class="listblock">
  <h2>Key Points</h2>
  <ul>
    <li>An HTTP request or response consists of a plain-text header and an optional body.
</li><li>HTTP is a stateless protocol.
</li><li>Express provides a simple path-based JavaScript server.
</li><li>Write callback functions to handle requests matching specified paths.
</li><li>Provide a default handler for unrecognized requests.
</li><li>Use <code class="highlighter-rouge">Content-Type</code> to specify the type of data being returned.
</li><li>Use dynamic loading to support plugin extensions.
</li>
  </ul>
</div>


    </div>
<div class="chapter">
      <h1 id="s:testing">Testing</h1>
      


<div class="listblock">
  <h2>Questions</h2>
  <ul>
    <li>How should software components be tested?
</li><li>What tools can I use to test JavaScript programs?
</li><li>How can I make software easier to test?
</li><li>How can testing code drive a web server?
</li><li>How can tests check the content of HTML pages?
</li><li>How is HTML represented in a JavaScript program?
</li>
  </ul>
</div>


      
      <p>We are bad people,
because we have been writing code without testing it.
In this lesson we will redeem ourselves (partially)
by correcting that (also partially).</p>

<p>JavaScript uses the same pattern for <a href="#g:unit-test">unit testing</a> as most other modern languages.
Each test is written as a function,
and each of those functions tests one particular aspect of the code.
A standalone program called a <a href="#g:test-runner">test runner</a>
finds test functions,
runs them,
and reports the results.
Any setup code that needs to be run before each test to create a <a href="#g:fixture">fixture</a>
is put in a function of its own.
Similarly (but less frequently),
if some teardown needs to be done <em>after</em> each test,
we put those operations in a function as well.</p>

<p>Each unit test can have one of three results:</p>

<ul>
  <li>pass: everything worked</li>
  <li>fail: the system being tested didn’t do what was expected</li>
  <li>error: something went wrong with the test itself</li>
</ul>

<p>We can combine tests into <a href="#g:test-suite">test suites</a>
(and test suites into larger suites, and so on)
so that we can more easily run related sets of tests.
This makes testing during development faster,
which in turn makes it more likely that we’ll actually do it.</p>

<p>Finally,
we write the tests themselves using <a href="#g:assertion">assertions</a>:
statements that check whether or not some condition holds
and generate an error if it doesn’t.
Node provides an <code class="highlighter-rouge">assert</code> library with some useful functions for asserting various things;
we’ll explore this as we go along.</p>

<h2 id="s:testing-mocha">Introducing Mocha</h2>

<p>JavaScript has almost as many testing libraries as it has front-end frameworks.
We will use one called <a href="https://mochajs.org/">Mocha</a> that is popular and well documented.
Unlike the libraries we have seen before,
we don’t import anything to use it;
instead,
<em>it</em> imports <em>our</em> code and calls our functions.</p>

<p>When we’re writing tests for Mocha to run,
we use a function called <code class="highlighter-rouge">describe</code> to create a group of tests
and another function called <code class="highlighter-rouge">it</code> for each test in that group:</p>

<div title="src/testing/hello-test.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">describe</span><span class="p">(</span><span class="s1">'first test'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">it</span><span class="p">(</span><span class="s1">'should run without errors'</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">done</span><span class="p">()</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<p>As this example shows,
<code class="highlighter-rouge">describe</code>’s arguments are an explanatory string and a callback function.
That callback makes calls to <code class="highlighter-rouge">it</code>, which takes:</p>

<ul>
  <li>another explanatory string describing how the system should behave, and</li>
  <li>a callback that receives a function (called <code class="highlighter-rouge">done</code> by convention).</li>
</ul>

<p>(The name <code class="highlighter-rouge">it</code> was chosen so that when we read tests aloud,
it sounds like we’re saying, “It should do this or that.”)
At the end of each test we call <code class="highlighter-rouge">done</code> to signal that it has finished.
We have to do this because callbacks run out of order,
so Mocha needs to know when each one completes.</p>

<p>We can run our tests from the shell by invoking <code class="highlighter-rouge">mocha</code>
and giving it the path to the file that contains the tests:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>./node_modules/.bin/mocha path/to/test.js
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  first test
    + should run without errors


  1 passing (12ms)
</code></pre></div></div>

<p>As with bundling,
we normally put the <code class="highlighter-rouge">mocha</code> command in <code class="highlighter-rouge">package.json</code>
so that <code class="highlighter-rouge">./node_modules/.bin</code> is automatically included in the path.
After we add this:</p>

<div title="package.json" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
  <span class="p">...</span>
  <span class="s2">"scripts"</span><span class="p">:</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="s2">"test"</span><span class="p">:</span> <span class="s2">"mocha"</span><span class="p">,</span>
    <span class="p">...</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<!-- == \noindent -->
<p>to <code class="highlighter-rouge">package.json</code>, our command becomes:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm <span class="nb">test</span> <span class="nt">--</span> path/to/test.js
</code></pre></div></div>

<p>(Again, everything after <code class="highlighter-rouge">--</code> is passed to the script itself.)</p>

<h2 id="s:testing-refactoring">Refactoring</h2>

<p>The next step is to create testable software.
In the case of our server,
we have to:</p>

<ul>
  <li>move the code that listens on a port into one file, and</li>
  <li>have that import a file that contains the code to do everything else.</li>
</ul>

<p>Once we have done this,
we can run the server code in other contexts.
Here’s the file <code class="highlighter-rouge">standalone.js</code> that actually launches a server:</p>

<div title="src/testing/standalone.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./server'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">PORT</span> <span class="o">=</span> <span class="mi">3418</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">PORT</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`listening on port </span><span class="p">${</span><span class="nx">PORT</span><span class="p">}</span><span class="s2">...`</span><span class="p">)</span> <span class="p">})</span>
</code></pre></div></div>

<p>And here is the application code we’ve extracted into <code class="highlighter-rouge">server.js</code>
so that we can test it:</p>

<div title="src/testing/server.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">)</span>

<span class="c1">// Main server object.</span>
<span class="kd">let</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">()</span>

<span class="c1">// Root page.</span>
<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="s1">'&lt;html&gt;&lt;body&gt;&lt;h1&gt;Home&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;'</span><span class="p">)</span>
<span class="p">})</span>

<span class="c1">// ...as before...</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">app</span>
</code></pre></div></div>

<p>Before going any further,
we can check that we haven’t broken anything by running:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>node standalone.js
</code></pre></div></div>

<h2 id="s:testing-server">Testing the Server</h2>

<p>All right:
now that we have extracted the code that’s specific to our server,
how do we test it?
The answer is yet another library called <a href="https://github.com/visionmedia/supertest">supertest</a>
that sends fake HTTP requests to an Express server
that has been split in the way we just split ours
and lets us interact with that server’s replies.
Here’s a test of a simple request that uses Mocha to manage the test,
and supertest’s <code class="highlighter-rouge">request</code> function to send something to the server
and check the result:</p>

<div title="src/testing/request-test.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">assert</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'assert'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'supertest'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./server'</span><span class="p">)</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">'server'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>

  <span class="nx">it</span><span class="p">(</span><span class="s1">'should return HTML with expected title'</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">request</span><span class="p">(</span><span class="nx">server</span><span class="p">)</span>
      <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="s1">'Content-Type'</span><span class="p">,</span> <span class="sr">/html/</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">end</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">assert</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">'Home'</span><span class="p">),</span> <span class="s1">'Has expected title'</span><span class="p">)</span>
        <span class="nx">done</span><span class="p">()</span>
      <span class="p">})</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Going through this line by line:</p>

<ol>
  <li><code class="highlighter-rouge">request(server)</code> starts building up a request to send.</li>
  <li><code class="highlighter-rouge">.get('/')</code> specifies the path in the URL we are sending.</li>
  <li><code class="highlighter-rouge">.expect(200)</code> checks that the return code is 200 (OK).</li>
  <li><code class="highlighter-rouge">.expect('Content-Type', /html/)</code>
checks the content type in the returned value against a regular expression
(discussed briefly at the end of this section).</li>
  <li><code class="highlighter-rouge">.end</code> is called when the whole response has been received,
i.e., when we can start looking at the content of the page or data
that the server has sent.</li>
  <li>Inside the callback to <code class="highlighter-rouge">end</code>,
<code class="highlighter-rouge">res</code> is the result data.
We make sure that its text (i.e., <code class="highlighter-rouge">res.text</code>) includes the word “Home”.
We really should check <code class="highlighter-rouge">err</code> here to make sure everything worked properly,
but we’re not quite that virtuous.</li>
  <li>Finally, we call <code class="highlighter-rouge">done()</code> to signal the end of the test.
Again,
we have to do this because there’s no way Mocha can know
when the enclosing <code class="highlighter-rouge">.end(...)</code> will be called</li>
</ol>

<p>Let’s run our code:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  server
    + should return HTML with expected title (48ms)


  1 passing (58ms)
</code></pre></div></div>

<p>Excellent: let’s add some more tests.</p>

<div title="src/testing/request-test.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">describe</span><span class="p">(</span><span class="s1">'server'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>

  <span class="nx">it</span><span class="p">(</span><span class="s1">'should return HTML with expected title'</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...as before...</span>
  <span class="p">})</span>

  <span class="nx">it</span><span class="p">(</span><span class="s1">'should return asteroids page as HTML with expected title'</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">request</span><span class="p">(</span><span class="nx">server</span><span class="p">)</span>
      <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/asteroids'</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="s1">'Content-Type'</span><span class="p">,</span> <span class="sr">/html/</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">end</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">assert</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">'Asteroids'</span><span class="p">),</span> <span class="s1">'Has expected title'</span><span class="p">)</span>
        <span class="nx">done</span><span class="p">()</span>
      <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">it</span><span class="p">(</span><span class="s1">'should 404 for other pages'</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">request</span><span class="p">(</span><span class="nx">server</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
      <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/other'</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">end</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">assert</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">'ERROR'</span><span class="p">),</span> <span class="s1">'Has expected error message'</span><span class="p">)</span>
        <span class="nx">done</span><span class="p">()</span>
      <span class="p">})</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  server
    + should return HTML with expected title (42ms)
    + should return asteroids page as HTML with expected title
    + should 404 for other pages


  3 passing (62ms)
</code></pre></div></div>

<p>Notice that we check to make sure that the server sends a 404
when we ask for something that doesn’t exist.
Making sure the system fails gracefully is just as important
as making sure that it provides data when asked to.</p>

<h2 id="s:testing-html">Checking the HTML</h2>

<p>It’s increasingly common for servers to return data that is then rendered by the client,
but some servers still generate HTML.
Do <em>not</em> try to check this with substrings or regular expressions:
the exceptions have exceptions,
and <a href="https://stackoverflow.com/a/1732454">that way lies madness</a>.
Instead,
we should parse the HTML to create a structure in memory and check that;
if parsing fails because the HTML is badly formatted, that’s worth knowing too.
The structure in question is our new friend the DOM,
and to get it,
we will use (yet another) library called <a href="https://cheerio.js.org/">cheerio</a>.
<code class="highlighter-rouge">cheerio.load</code> turns HTML text into a DOM tree;
the resulting object can be used like a function,
and we can use the same selectors we met previously to find things in it.
Here’s our test:</p>

<div title="src/testing/dom-test.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">assert</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'assert'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'supertest'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">cheerio</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'cheerio'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./server'</span><span class="p">)</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">'server'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">it</span><span class="p">(</span><span class="s1">'should have the correct headings'</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">request</span><span class="p">(</span><span class="nx">server</span><span class="p">)</span>
      <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="s1">'Content-Type'</span><span class="p">,</span> <span class="sr">/html/</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">end</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">tree</span> <span class="o">=</span> <span class="nx">cheerio</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">)</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">tree</span><span class="p">(</span><span class="s1">'h1'</span><span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">'Correct number of headings'</span><span class="p">)</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">tree</span><span class="p">(</span><span class="s1">'h1'</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'Home'</span><span class="p">,</span> <span class="s1">'Correct heading text'</span><span class="p">)</span>
        <span class="nx">done</span><span class="p">()</span>
      <span class="p">})</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  server
    + should have the correct headings (67ms)


  1 passing (77ms)
</code></pre></div></div>

<p>This gets the page as before,
parses it,
then looks for <code class="highlighter-rouge">h1</code> elements and checks the text of the first one.
(Note that this <em>doesn’t</em> check if the title is <code class="highlighter-rouge">&lt;em&gt;H&lt;/em&gt;ome</code>
because <code class="highlighter-rouge">.text()</code> concatenates all the text of the children.)
We won’t explore this approach further because we’re going to serve data for rendering
rather than generating HTML and sending that,
but if you’re doing any web scraping at all,
libraries like <code class="highlighter-rouge">cheerio</code> are there to help.</p>

<h2 id="s:testing-exercises">Exercises</h2>

<h3 id="not-done">Not Done</h3>

<p>What happens if we forget to call <code class="highlighter-rouge">done()</code> in a test?</p>

<h3 id="adding-tests">Adding Tests</h3>

<ol>
  <li>What is the most useful test you could add for the asteroids application?
Why?</li>
  <li>Implement it.</li>
  <li>Ask yourself why tutorials like this one don’t say “<em>please</em> implement it”.
Reflect on the fact that this question didn’t say “please” either.
Are you comfortable with the paternalistic power relationship embodied in the absence of that one little word,
and with the somewhat uncomfortable attempt at ironic humor embodied in this question?</li>
</ol>

<h3 id="lifecycle">Lifecycle</h3>

<p>Suppose a JavaScript program contains some JSX expressions that produce HTML
which is then read and displayed by a browser.
Draw a diagram to show the form taken by an H1 heading containing the word “data”
from start to finish.</p>


      


<div class="listblock">
  <h2>Key Points</h2>
  <ul>
    <li>A unit test checks the behavior of one software component in isolation.
</li><li>The result of a unit test can be pass, fail, or error.
</li><li>Use Mocha to write and run unit tests in JavaScript.
</li><li>Put assertions in unit tests to check results.
</li><li>Combine tests in suites for easier management.
</li><li>Divide modules into interactive and non-interactive parts for easier testing.
</li><li>Use <code class="highlighter-rouge">supertest</code> to simulate interaction with a server for testing.
</li><li>HTML is represented in memory using the Document Object Model (DOM).
</li><li>Check the structure of the DOM rather than the textual representation of the HTML when testing.
</li>
  </ul>
</div>


    </div>
<div class="chapter">
      <h1 id="s:capstone">Capstone Project</h1>
      


<div class="listblock">
  <h2>Questions</h2>
  <ul>
    <li>How can I set up test data to use during development?
</li><li>What tests are most cost-effective when testing this kind of application?
</li><li>How should I present data to users?
</li>
  </ul>
</div>


      
      <p>It’s time to bring everything together in an extended example:
a (slightly) interactive visualization of species data from <a href="https://figshare.com/articles/Portal_Project_Teaching_Database/1314459">https://figshare.com/articles/Portal_Project_Teaching_Database/1314459</a>.
Our plan is to:</p>

<ul>
  <li>slice data for testing,</li>
  <li>write a data server to serve that data,</li>
  <li>test the server,</li>
  <li>build an interactive tabular display of our data, and</li>
  <li>add visualization.</li>
</ul>

<p>This will require a few new ideas,
but will mostly recapitulate what’s come before.</p>

<h2 id="s:capstone-data">Data Manager</h2>

<p>The data manager is exactly the same as
<a href="#s:dataman">the one we built earlier</a>.
As a reminder,
the key class is:</p>

<div title="src/capstone/back/data-manager.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">DataManager</span> <span class="p">{</span>

  <span class="kd">constructor</span> <span class="p">(</span><span class="nx">filename</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span><span class="nx">read</span> <span class="nx">and</span> <span class="nx">store</span> <span class="nx">data</span> <span class="k">from</span> <span class="nx">CSV</span> <span class="nx">file</span><span class="p">...</span>
  <span class="p">}</span>

  <span class="nx">getSurveyStats</span> <span class="p">()</span> <span class="p">{...</span><span class="k">return</span> <span class="nx">summary</span> <span class="nx">statistics</span><span class="p">...}</span>

  <span class="nx">getSurveyRange</span> <span class="p">(</span><span class="nx">minYear</span><span class="p">,</span> <span class="nx">maxYear</span><span class="p">)</span> <span class="p">{...</span><span class="k">return</span> <span class="nx">slice</span> <span class="k">of</span> <span class="nx">data</span><span class="p">...}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="s:capstone-server">Server</h2>

<p>The server is going to be almost the same as <a href="#s:server">the previous one</a>.
However, we need to connect it to the data manager class.
We’ll do this by having the driver create a data manager,
and then pass that data manager to the server as the latter is being created:</p>

<div title="src/capstone/back/driver-0.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">DataManager</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./data-manager'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./server-0'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">PORT</span> <span class="o">=</span> <span class="mi">3418</span>

<span class="kd">const</span> <span class="nx">filename</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataManager</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">server</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">PORT</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`listening on port </span><span class="p">${</span><span class="nx">PORT</span><span class="p">}</span><span class="s2">...`</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>As you can probably guess from the fact that we’ve called it <code class="highlighter-rouge">driver-0</code>,
we’re going to be making some changes down the road…</p>

<p>Here’s the start of the server it works with:</p>

<div title="src/capstone/back/server-0.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">)</span>

<span class="c1">// 'dataManager' is a global variable that refers to our database.</span>
<span class="c1">// It must be set when the server is created.</span>
<span class="kd">let</span> <span class="nx">dataManager</span> <span class="o">=</span> <span class="kc">null</span>

<span class="c1">// Main server object.</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">()</span>

<span class="p">...</span><span class="nx">handle</span> <span class="nx">requests</span><span class="p">...</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">(</span><span class="nx">dbm</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">dataManager</span> <span class="o">=</span> <span class="nx">dbm</span>
  <span class="k">return</span> <span class="nx">app</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We’ll look at handling requests for data in the next section.
The most important thing for now is the way we manage the connection to the data manager.
Down at the bottom of <code class="highlighter-rouge">server-0.js</code>,
we export a function that assigns its single argument to a variable called <code class="highlighter-rouge">dataManager</code>.
Inside the methods that handle requests,
we’ll be able to send database queries to <code class="highlighter-rouge">dataManager</code>.</p>

<p>This variable is global within this file,
but since it’s not exported,
it’s invisible outside.
Variables like this are called <a href="#g:module-variable">module variables</a>,
and give us a way to share information among the functions in a module
without giving anything outside the module a way to cause (direct) harm to that information.</p>

<h2 id="s:capstone-api">API</h2>

<p>The next step is to decide what our server’s API will be,
i.e.,
what URLs it will understand and what data they will fetch.
<code class="highlighter-rouge">GET /survey/stats</code> will get summary statistics as a single JSON record,
and <code class="highlighter-rouge">GET /survey/:start/:end</code> gets aggregate values for a range of years.
(We will add error checking on the year range as an exercise.)
Anything else will return a 404 error code and a snippet of HTML telling us we’re bad people.
We will put this code in <code class="highlighter-rouge">server.js</code> and a command-line driver in <code class="highlighter-rouge">driver.js</code> for testability.
The server functions are:</p>

<div title="src/capstone/back/server-0.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Get survey statistics.</span>
<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/survey/stats'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">dataManager</span><span class="p">.</span><span class="nx">getSurveyStats</span><span class="p">()</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">'Content-Type'</span><span class="p">,</span> <span class="s1">'application/json'</span><span class="p">)</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
<span class="p">})</span>

<span class="c1">// Get a slice of the survey data.</span>
<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/survey/:start/:end'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">start</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">start</span><span class="p">)</span>
  <span class="kd">const</span> <span class="nx">end</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">end</span><span class="p">)</span>
  <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">dataManager</span><span class="p">.</span><span class="nx">getSurveyRange</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">)</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">'Content-Type'</span><span class="p">,</span> <span class="s1">'application/json'</span><span class="p">)</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>We also write an error handling function:</p>

<div title="src/capstone/back/server-0.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Nothing else worked.</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">page</span> <span class="o">=</span> <span class="s2">`&lt;html&gt;&lt;body&gt;&lt;p&gt;error: "</span><span class="p">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">}</span><span class="s2">" not found&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;`</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
     <span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">page</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Now let’s write our first test:</p>

<div title="src/capstone/back/test-server.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nx">it</span><span class="p">(</span><span class="s1">'should return statistics about survey data'</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">expected</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">minYear</span><span class="p">:</span> <span class="mi">1979</span><span class="p">,</span>
      <span class="na">maxYear</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span>
      <span class="na">count</span><span class="p">:</span> <span class="mi">10</span>
    <span class="p">}</span>
    <span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataManager</span><span class="p">(</span><span class="s1">'test-data.csv'</span><span class="p">)</span>
    <span class="nx">request</span><span class="p">(</span><span class="nx">server</span><span class="p">(</span><span class="nx">db</span><span class="p">))</span>
      <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/survey/stats'</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="s1">'Content-Type'</span><span class="p">,</span> <span class="s1">'application/json'</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">end</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">body</span><span class="p">,</span> <span class="nx">expected</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
        <span class="nx">done</span><span class="p">()</span>
      <span class="p">})</span>
  <span class="p">})</span>
</code></pre></div></div>

<p>Note that the range of years is 1979-2000,
which is <em>not</em> the range in the full dataset.
We run this with:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm <span class="nb">test</span> <span class="nt">--</span> src/capstone/back/test-server.js
</code></pre></div></div>

<!-- == \noindent -->
<p>and it passes.</p>

<h2 id="s:capstone-display">The Display</h2>

<p>The front end is a straightforward recapitulation of what we’ve done before.
There is a single HTML page called <code class="highlighter-rouge">index.html</code>:</p>

<div title="src/capstone/front/index.html" class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Creatures<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"app.js"</span> <span class="na">async</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"app"</span><span class="nt">&gt;&lt;/div&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>The main application in <code class="highlighter-rouge">app.js</code> imports components to display summary statistics,
choose a range of years,
and display annual data.
There is not usually such a close coupling between API calls and components,
but it’s not a bad place to start.
Note that we are using <code class="highlighter-rouge">import</code> because we’re trying to be modern,
even though the back end still needs <code class="highlighter-rouge">require</code>.</p>

<div title="src/capstone/front/app.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="s1">'react'</span>
<span class="k">import</span> <span class="nx">ReactDOM</span> <span class="k">from</span> <span class="s1">'react-dom'</span>
<span class="k">import</span> <span class="nx">SurveyStats</span> <span class="k">from</span> <span class="s1">'./SurveyStats'</span>
<span class="k">import</span> <span class="nx">ChooseRange</span> <span class="k">from</span> <span class="s1">'./ChooseRange'</span>
<span class="k">import</span> <span class="nx">DataDisplay</span> <span class="k">from</span> <span class="s1">'./DataDisplay'</span>

<span class="kd">class</span> <span class="nx">App</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>

  <span class="kd">constructor</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...constructor...</span>
  <span class="p">}</span>

  <span class="nx">componentDidMount</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...initialize...</span>
  <span class="p">}</span>

  <span class="nx">onStart</span> <span class="o">=</span> <span class="p">(</span><span class="nx">start</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...update start year...</span>
  <span class="p">}</span>

  <span class="nx">onEnd</span> <span class="o">=</span> <span class="p">(</span><span class="nx">end</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...update end year...</span>
  <span class="p">}</span>

  <span class="nx">onNewRange</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...handle submission of year range...</span>
  <span class="p">}</span>

  <span class="nx">render</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...render current application state...</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span>
  <span class="o">&lt;</span><span class="nx">App</span> <span class="o">/&gt;</span><span class="p">,</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"app"</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div></div>

<p>The constructor defines the URL for the data source and sets up the initial state,
which has summary data,
start and end years,
and data for those years:</p>

<div title="src/capstone/front/app.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">constructor</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">baseUrl</span> <span class="o">=</span> <span class="s1">'http://localhost:3418'</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">summary</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="na">start</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span>
      <span class="na">end</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span>
      <span class="na">data</span><span class="p">:</span> <span class="kc">null</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>The method <code class="highlighter-rouge">componentDidMount</code> is new:
it fetches data for the very first time
so that the user sees something useful on the page when they first load it.</p>

<div title="src/capstone/front/app.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nx">componentDidMount</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">baseUrl</span><span class="p">}</span><span class="s2">/survey/stats`</span>
    <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">).</span><span class="nx">then</span><span class="p">((</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">()</span>
    <span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="nx">summary</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
        <span class="na">summary</span><span class="p">:</span> <span class="nx">summary</span>
      <span class="p">})</span>
    <span class="p">})</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>We don’t call this method ourselves;
instead,
React automatically calls it once our application and its children have been loaded and initialized.
We can’t fetch the initial data in the application’s constructor because
we have no control over the order in which bits of display are initialized.
On the upside,
we can use <code class="highlighter-rouge">response.json()</code> directly because we know the source is returning JSON data.
This method is the only place where the summary is updated,
since the data isn’t changing underneath us:</p>

<p>Next up we need to handle typing in the “start” and “end” boxes.
The HTML controls in the web page will capture the characters without our help,
but we need those values in our state variables:</p>

<div title="src/capstone/front/app.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nx">onStart</span> <span class="o">=</span> <span class="p">(</span><span class="nx">start</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
      <span class="na">start</span><span class="p">:</span> <span class="nx">start</span>
    <span class="p">})</span>
  <span class="p">}</span>

  <span class="nx">onEnd</span> <span class="o">=</span> <span class="p">(</span><span class="nx">end</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
      <span class="na">end</span><span class="p">:</span> <span class="nx">end</span>
    <span class="p">})</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>When the button is clicked,
we send a request for JSON data to the appropriate URL
and record the result in the application’s state.
React will notice the state change and call <code class="highlighter-rouge">render</code> for us.
More precisely,
the browser will call the first <code class="highlighter-rouge">then</code> callback when the response arrives,
and the second <code class="highlighter-rouge">then</code> callback when the data has been converted to JSON.</p>

<div title="src/capstone/front/app.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nx">onNewRange</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">method</span><span class="p">:</span> <span class="s1">'GET'</span><span class="p">,</span>
      <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">'Accept'</span><span class="p">:</span> <span class="s1">'application/json'</span><span class="p">,</span>
        <span class="s1">'Content-Type'</span><span class="p">:</span> <span class="s1">'application/json'</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">baseUrl</span><span class="p">}</span><span class="s2">/survey/</span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">start</span><span class="p">}</span><span class="s2">/</span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">end</span><span class="p">}</span><span class="s2">`</span>
    <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">params</span><span class="p">).</span><span class="nx">then</span><span class="p">((</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">()</span>
    <span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
        <span class="na">data</span><span class="p">:</span> <span class="nx">data</span>
      <span class="p">})</span>
    <span class="p">})</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>Now let’s update the display with <code class="highlighter-rouge">SurveyStats</code>, <code class="highlighter-rouge">ChooseRange</code>, <code class="highlighter-rouge">DataChart</code>, and <code class="highlighter-rouge">DataDisplay</code>,
which are all stateless components
(i.e., they display things but don’t change anything):</p>

<div title="src/capstone/front/app.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nx">render</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">tableStyle</span> <span class="o">=</span> <span class="p">{</span><span class="na">overflow</span><span class="p">:</span> <span class="s1">'scroll'</span><span class="p">,</span> <span class="na">height</span><span class="p">:</span> <span class="s1">'200px'</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Creatures</span><span class="o">&lt;</span><span class="sr">/h1</span><span class="err">&gt;
</span>        <span class="o">&lt;</span><span class="nx">SurveyStats</span> <span class="nx">data</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">summary</span><span class="p">}</span> <span class="sr">/</span><span class="err">&gt;
</span>        <span class="o">&lt;</span><span class="nx">ChooseRange</span>
          <span class="nx">start</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">start</span><span class="p">}</span> <span class="nx">onStart</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">onStart</span><span class="p">}</span>
          <span class="nx">end</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">end</span><span class="p">}</span> <span class="nx">onEnd</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">onEnd</span><span class="p">}</span>
          <span class="nx">onNewRange</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">onNewRange</span><span class="p">}</span> <span class="sr">/</span><span class="err">&gt;
</span>        <span class="o">&lt;</span><span class="nx">DataChart</span> <span class="nx">data</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">data</span><span class="p">}</span> <span class="sr">/</span><span class="err">&gt;
</span>        <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">tableStyle</span><span class="p">}</span><span class="o">&gt;</span>
          <span class="o">&lt;</span><span class="nx">DataDisplay</span> <span class="nx">data</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">data</span><span class="p">}</span> <span class="sr">/</span><span class="err">&gt;
</span>        <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>      <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>    <span class="p">)</span>
  <span class="p">}</span>
</code></pre></div></div>

<h2 id="s:capstone-tables">The Tables</h2>

<p>We will display survey stats as tables,
with a paragraph fallback when there’s no data.</p>

<p>First, we display summary statistics for the whole data set
(as returned by the <code class="highlighter-rouge">GET /survey/stats</code> query we wrote a handler for earlier)
as a table at the top of the page.
(Again, we need parentheses around the HTML fragment so that it will parse properly.)</p>

<div title="src/capstone/front/SurveyStats.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="s1">'react'</span>

<span class="kd">const</span> <span class="nx">SurveyStats</span> <span class="o">=</span> <span class="p">({</span><span class="nx">data</span><span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">data</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">no</span> <span class="nx">data</span><span class="o">&lt;</span><span class="sr">/p&gt;</span><span class="err">)
</span>  <span class="p">}</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="o">&lt;</span><span class="nx">table</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nx">tbody</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">tr</span><span class="o">&gt;&lt;</span><span class="nx">th</span><span class="o">&gt;</span><span class="nx">record</span> <span class="nx">count</span><span class="o">&lt;</span><span class="sr">/th&gt;&lt;td&gt;{data.record_count}&lt;/</span><span class="nx">td</span><span class="o">&gt;&lt;</span><span class="sr">/tr</span><span class="err">&gt;
</span>        <span class="o">&lt;</span><span class="nx">tr</span><span class="o">&gt;&lt;</span><span class="nx">th</span><span class="o">&gt;</span><span class="nx">year</span> <span class="nx">low</span><span class="o">&lt;</span><span class="sr">/th&gt;&lt;td&gt;{data.year_low}&lt;/</span><span class="nx">td</span><span class="o">&gt;&lt;</span><span class="sr">/tr</span><span class="err">&gt;
</span>        <span class="o">&lt;</span><span class="nx">tr</span><span class="o">&gt;&lt;</span><span class="nx">th</span><span class="o">&gt;</span><span class="nx">year</span> <span class="nx">high</span><span class="o">&lt;</span><span class="sr">/th&gt;&lt;td&gt;{data.year_high}&lt;/</span><span class="nx">td</span><span class="o">&gt;&lt;</span><span class="sr">/tr</span><span class="err">&gt;
</span>      <span class="o">&lt;</span><span class="sr">/tbody</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="sr">/table</span><span class="err">&gt;
</span>  <span class="p">)</span>
<span class="p">}</span>

<span class="k">export</span> <span class="k">default</span> <span class="nx">SurveyStats</span>
</code></pre></div></div>

<p>Next, we display aggregated statistics for a given range of years
(the <code class="highlighter-rouge">GET /survey/:start/:end</code> query)
in another table.</p>

<div title="src/capstone/front/DataDisplay.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="s1">'react'</span>

<span class="kd">const</span> <span class="nx">DataDisplay</span> <span class="o">=</span> <span class="p">({</span><span class="nx">data</span><span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">no</span> <span class="nx">data</span><span class="o">&lt;</span><span class="sr">/p&gt;</span><span class="err">)
</span>  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">columns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'year'</span><span class="p">,</span>
    <span class="s1">'min_hindfoot_length'</span><span class="p">,</span>
    <span class="s1">'ave_hindfoot_length'</span><span class="p">,</span>
    <span class="s1">'max_hindfoot_length'</span><span class="p">,</span>
    <span class="s1">'min_weight'</span><span class="p">,</span>
    <span class="s1">'ave_weight'</span><span class="p">,</span>
    <span class="s1">'max_weight'</span>
  <span class="p">]</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="o">&lt;</span><span class="nx">table</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nx">tbody</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">tr</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">columns</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">c</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="o">&lt;</span><span class="nx">th</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">c</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/th&gt;</span><span class="se">))</span><span class="sr">}&lt;/</span><span class="nx">tr</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="nx">data</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">r</span> <span class="o">=&gt;</span> <span class="nx">r</span><span class="p">).</span><span class="nx">map</span><span class="p">((</span><span class="nx">record</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="k">return</span> <span class="p">(</span><span class="o">&lt;</span><span class="nx">tr</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">columns</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">c</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="o">&lt;</span><span class="nx">td</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">record</span><span class="p">[</span><span class="nx">c</span><span class="p">]}</span><span class="o">&lt;</span><span class="sr">/td&gt;</span><span class="se">))</span><span class="sr">}&lt;/</span><span class="nx">tr</span><span class="o">&gt;</span><span class="p">)</span>
        <span class="p">})}</span>
      <span class="o">&lt;</span><span class="sr">/tbody</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="sr">/table</span><span class="err">&gt;
</span>  <span class="p">)</span>
<span class="p">}</span>

<span class="k">export</span> <span class="k">default</span> <span class="nx">DataDisplay</span>
</code></pre></div></div>

<p>Like <code class="highlighter-rouge">SurveyStats</code>, <code class="highlighter-rouge">DataDisplay</code> returns a table listing the results returned from the server.
Unlike <code class="highlighter-rouge">SurveyStats</code>,
this component needs to check whether each record exists before it builds the table row.
Remember that,
when we defined how the year range query is handled in <code class="highlighter-rouge">DataManager</code> earlier,
we told it to only return record objects for those years that have data.
Here, we add <code class="highlighter-rouge">.filter(r =&gt; r)</code> before mapping the data to the callback
to ensure that <code class="highlighter-rouge">DataDisplay</code> will only try to make <code class="highlighter-rouge">tr</code> elements from non-<code class="highlighter-rouge">null</code> records.
We do the same when plotting the data.</p>

<h2 id="s:capstone-chart">The Chart</h2>

<p>We initially tried using Vega-Lite directly for the chart,
but after a few failures and some googling,
we switched to <code class="highlighter-rouge">react-vega-lite</code>:
Vega-Lite’s <code class="highlighter-rouge">vega-embed</code> wants to modify an existing DOM element when called,
while <code class="highlighter-rouge">react-vega-lite</code> constructs an element to be put in place at the right time,
which proved easier to use.
The steps are:</p>

<ol>
  <li>Create a paragraph placeholder if there’s no data.</li>
  <li>Re-organize non-<code class="highlighter-rouge">null</code> data into the form the chart needs.</li>
  <li>Construct a spec like the ones we have seen before.</li>
  <li>Create options to turn off the annoying links (also seen before).</li>
  <li>Return an instance of the <code class="highlighter-rouge">VegaLite</code> component.</li>
</ol>

<div title="src/capstone/front/DataChart.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="s1">'react'</span>
<span class="k">import</span> <span class="nx">VegaLite</span> <span class="k">from</span> <span class="s1">'react-vega-lite'</span>

<span class="kd">const</span> <span class="nx">DataChart</span> <span class="o">=</span> <span class="p">({</span><span class="nx">data</span><span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">no</span> <span class="nx">data</span><span class="o">&lt;</span><span class="sr">/p&gt;</span><span class="err">)
</span>  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">values</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">r</span> <span class="o">=&gt;</span> <span class="nx">r</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">r</span> <span class="o">=&gt;</span> <span class="p">({</span><span class="na">x</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">ave_hindfoot_length</span><span class="p">,</span> <span class="na">y</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">ave_weight</span><span class="p">}))</span>
  <span class="kd">let</span> <span class="nx">spec</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'$schema'</span><span class="p">:</span> <span class="s1">'https://vega.github.io/schema/vega-lite/v2.0.json'</span><span class="p">,</span>
    <span class="s1">'description'</span><span class="p">:</span> <span class="s1">'Mean Weight vs Mean Hindfoot Length'</span><span class="p">,</span>
    <span class="s1">'mark'</span><span class="p">:</span> <span class="s1">'point'</span><span class="p">,</span>
    <span class="s1">'encoding'</span><span class="p">:</span> <span class="p">{</span>
      <span class="s1">'x'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'field'</span><span class="p">:</span> <span class="s1">'x'</span><span class="p">,</span> <span class="s1">'type'</span><span class="p">:</span> <span class="s1">'quantitative'</span><span class="p">},</span>
      <span class="s1">'y'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'field'</span><span class="p">:</span> <span class="s1">'y'</span><span class="p">,</span> <span class="s1">'type'</span><span class="p">:</span> <span class="s1">'quantitative'</span><span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="kd">let</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'actions'</span><span class="p">:</span> <span class="p">{</span>
      <span class="s1">'export'</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="s1">'source'</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="s1">'editor'</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="kd">let</span> <span class="nx">scatterData</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'values'</span><span class="p">:</span> <span class="nx">values</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">(</span><span class="o">&lt;</span><span class="nx">VegaLite</span> <span class="nx">spec</span><span class="o">=</span><span class="p">{</span><span class="nx">spec</span><span class="p">}</span> <span class="nx">data</span><span class="o">=</span><span class="p">{</span><span class="nx">scatterData</span><span class="p">}</span> <span class="nx">options</span><span class="o">=</span><span class="p">{</span><span class="nx">options</span><span class="p">}</span><span class="sr">/&gt;</span><span class="err">)
</span><span class="p">}</span>

<span class="k">export</span> <span class="k">default</span> <span class="nx">DataChart</span>
</code></pre></div></div>

<p>The other components are similar to those we have seen before.</p>

<h2 id="s:capstone-run">Running It</h2>

<p>In order to test our application,
we need to run a data server,
and then launch our application with Parcel.
The easiest way to do that is to open two windows on our computer
and make each half the width (or height) of our screen
so that we can see messages from both halves of what we’re doing.</p>

<p>In one window,
we run:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>node src/capstone/back/driver-0.js src/capstone/back/test-data.csv
</code></pre></div></div>

<p>Note that we <em>don’t</em> use <code class="highlighter-rouge">npm run dev</code> to trigger Parcel:
this is running on the server,
so no bundling is necessary.
In our other window,
we run:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm run dev src/capstone/front/index.html
</code></pre></div></div>

<!-- == \noindent -->
<p>which displays:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; js-vs-ds@0.1.0 dev /Users/stj/js-vs-ds
&gt; parcel serve -p 4000 "src/capstone/front/index.html"

Server running at http://localhost:4000
+  Built in 20.15s.
</code></pre></div></div>

<p>We then open <code class="highlighter-rouge">http://localhost:4000</code> in our browser and see this:</p>

<figure id="f:capstone-first-attempt"> <img src="../../files/capstone-first-attempt.png"> <figcaption>First Attempt at Viewing Capstone Project</figcaption> </figure>

<p>That’s unexpected: we should see the initial data displayed.
If we open the console in the browser and reload the page,
we see this error message:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Cross-Origin Request Blocked:
The Same Origin Policy disallows reading the remote resource at http://localhost:3418/survey/stats.
(Reason: CORS header 'Access-Control-Allow-Origin' missing).
</code></pre></div></div>

<p>The “Learn More” link given with the error message takes us to <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS/Errors/CORSMissingAllowOrigin">this page</a>,
which uses many science words we don’t know.
A web search turns up <a href="https://en.wikipedia.org/wiki/Cross-origin_resource_sharing">this article on Wikipedia</a>,
which tells us that <a href="#g:cors">Cross-origin resource sharing</a> (CORS)
is a security mechanism.
If a page loads some JavaScript,
and that JavaScript is allowed to send requests to servers other than the one that the page came from,
then villains would be able to do things like send passwords saved in the browser to themselves.
The details are too complex for this tutorial;
the good news is that they’ve been wrapped up in a Node library called <code class="highlighter-rouge">cors</code>,
which we can add to our server with just a couple of lines of code:</p>

<div title="src/capstone/back/server-1.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'cors'</span><span class="p">)</span>          <span class="c1">// added</span>

<span class="kd">let</span> <span class="nx">dataManager</span> <span class="o">=</span> <span class="kc">null</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">()</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cors</span><span class="p">())</span>                       <span class="c1">// added</span>

<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/survey/stats'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{...</span><span class="k">as</span> <span class="nx">before</span><span class="p">...})</span>

<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/survey/:start/:end'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{...</span><span class="k">as</span> <span class="nx">before</span><span class="p">...})</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{...</span><span class="k">as</span> <span class="nx">before</span><span class="p">...})</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">(</span><span class="nx">dbm</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{...</span><span class="k">as</span> <span class="nx">before</span><span class="p">...}</span>
</code></pre></div></div>

<p>Since this code is saved in <code class="highlighter-rouge">server-1.js</code>,
we need to create a copy of the driver called <code class="highlighter-rouge">driver-1.js</code> that invokes it.
Let’s run that:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>node src/capstone/back/driver-1.js src/capstone/back/test-data.csv
</code></pre></div></div>

<p>and then re-launch our application:</p>

<figure id="f:capstone-second-attempt"> <img src="../../files/capstone-second-attempt.png"> <figcaption>Second Attempt at Viewing Capstone Project</figcaption> </figure>

<p>Much better!
Now we can type some dates into the “start” and “end” boxes and,
after we press “update”,
we get a chart and table of the aggregated statistics for the year range given:</p>

<figure id="f:capstone-complete"> <img src="../../files/capstone-complete.png"> <figcaption>Completed Capstone Project</figcaption> </figure>

<p>We’ve built an interface,
used it to submit queries that are then handled by a server,
which returns data that can be converted to content by our React components,
and our capstone project is complete.</p>

<h2 id="s:capstone-exercises">Exercises</h2>

<h3 id="reporting-other-data">Reporting Other Data</h3>

<p>A user has asked for the number of male and female animals observed for each year.</p>

<ol>
  <li>Should you add this to the existing query for yearly data or create a new API call?</li>
  <li>Implement your choice.</li>
</ol>

<h3 id="error-checking">Error Checking</h3>

<ol>
  <li>Modify the server to return 400 with an error message
if the range of years requested is invalid</li>
  <li>Compare your implementation to someone else’s.
Did you define “invalid” in the same way?
I.e., will your programs always return the same status codes for every query?</li>
</ol>

<h3 id="use-all-the-data">Use All the Data</h3>

<p>Create a database using all of the survey data and test the display.
What bugs or shortcomings do you notice compared to displaying test data?</p>

<h3 id="merging-displays">Merging Displays</h3>

<p>The <code class="highlighter-rouge">SurveyStats</code> and <code class="highlighter-rouge">DataDisplay</code> components in the front end both display tables.</p>

<ol>
  <li>Write a new component <code class="highlighter-rouge">TableDisplay</code> that will display an arbitrary table
given a list of column names
and a list of objects which all have (at least) those fields.</li>
  <li>Replace <code class="highlighter-rouge">SurveyStats</code> and <code class="highlighter-rouge">DataDisplay</code> with your new component.</li>
  <li>Modify your component so that it generates a unique ID for each value in the table.
(Hint: you may need to pass in a third parameter to each call
to serve as the root or stem of those unique IDs.)</li>
</ol>

<h3 id="formatting">Formatting</h3>

<p>Modify <code class="highlighter-rouge">DataDisplay</code> to format fractional numbers with a single decimal place,
but leave the integers as they are.
Ask yourself why,
seven decades after the invention of digital computers,
this isn’t easier.</p>

<h3 id="data-data-everywhere">Data, Data Everywhere</h3>

<p>Modify <code class="highlighter-rouge">DataChart</code> so that the word <code class="highlighter-rouge">data</code> isn’t used in so many different ways.
Does doing this make you feel better about yourself as a person?
Modify it again so that the height and width of the chart are passed in as well.
Did that help?</p>


      


<div class="listblock">
  <h2>Key Points</h2>
  <ul>
    <li>Use slices of actual data to test applications.
</li><li>Test summaries and small cases so that results can be checked by hand.
</li><li>Store state in a class, use pure functions to display it.
</li>
  </ul>
</div>


    </div>
<div class="chapter">
      <h1 id="s:finale">Conclusion</h1>
      


<div class="listblock">
  <h2>Questions</h2>
  <ul>
    <li>What have we learned?
</li>
  </ul>
</div>


      
      <p>We have come a long way since <code class="highlighter-rouge">console.log('hello, world')</code> in <a href="#s:basics">the first lesson</a>.
Callbacks and promises,
JSON and web servers,
packaging, unit tests, and visualization:
every modern language can do them,
but JavaScript is an increasingly popular choice.
Yes,
it has its flaws,
but if we avoid some of its <a href="#s:legacy">legacy features</a>,
it’s both usable and powerful.</p>

<p>Our journey doesn’t stop here, though.
The appendices explore some next steps,
such as <a href="#s:logging">logging what our server does</a>
and <a href="#s:db">using a relational database</a> instead of a text file
as a data store.
Beyond that,
you could look at more advanced techniques in JavaScript [<a href="#b:Have2018">Have2018</a>],
explore the full power of the <a href="https://d3js.org/">D3</a> library for interactive visualization [<a href="#b:Meek2017">Meek2017</a>],
dive into data wrangling [<a href="#b:Davi2018">Davi2018</a>],
or start over completely the way JavaScript programmers do every eight months
and rewrite everything with <a href="https://developer.mozilla.org/en-US/docs/Web/Web_Components">Web Components</a>.
Whatever you do,
we hope that this tutorial has helped you get started.</p>

<p>Contributions of all kinds are welcome,
from errata and minor improvements to entirely new sections and chapters.
Please <a href="mailto:gvwilson@third-bit.com">email us</a>,
<a href="https://github.com/software-tools-in-javascript/js-vs-ds/issues">file an issue</a> in <a href="https://github.com/software-tools-in-javascript/js-vs-ds/">our GitHub repository</a>,
or <a href="https://github.com/software-tools-in-javascript/js-vs-ds/pulls">submit a pull request</a>.
Everyone whose work is incorporated will be acknowledged.
Please see <a href="#s:contributing">the contributors’s guide</a> for more information,
and please note that all contributors are required to abide by
our <a href="#s:conduct">Code of Conduct</a>.</p>


      


<div class="listblock">
  <h2>Key Points</h2>
  <ul>
    <li>We have learned a lot.
</li><li>Contributions are very welcome.
</li>
  </ul>
</div>


    </div>
<div class="chapter">
      <h1 id="s:bib">Bibliography</h1>
      



      
      <dl>
  <dt><strong id="b:Davi2018">Davi2018</strong>:</dt>
  <dd>Ashley Davis:
<em><a href="https://www.manning.com/books/data-wrangling-with-javascript">Data Wrangling with JavaScript</a></em>.
Manning,
2018,
978-1617294846.
<em>A step-by-step guide to managing data with JavaScript.</em></dd>
  <dt><strong id="b:Have2018">Have2018</strong>:</dt>
  <dd>Martijn Haverbeke:
<em><a href="https://eloquentjavascript.net/">Eloquent Javascript</a></em>
(3rd ed.).
No Starch Press,
2018,
978-1593279509.
<em>The best all-around guide to JavaScript on the market today.</em></dd>
  <dt><strong id="b:Meek2017">Meek2017</strong>:</dt>
  <dd>Elijah Meeks:
<em><a href="https://www.manning.com/books/d3js-in-action-second-edition">D3.js in Action</a></em>
(2nd ed.).
Manning,
2017,
978-1617294488.
<em>A comprehensive guide to the D3 visualization framework.</em></dd>
  <dt><strong id="b:Wils2018">Wils2018</strong>:</dt>
  <dd>Greg Wilson:
<em><a href="http://teachtogether.tech">Teaching Tech Together</a></em>.
Lulu.com,
2018,
978-0988113701.
<em>How to create and deliver lessons that work and build a teaching community around them.</em></dd>
</dl>


      



    </div>
<div class="chapter">
      <h1 id="s:license">License</h1>
      



      
      <p><em>This is a human-readable summary of (and not a substitute for) the license.
Please see <a href="https://creativecommons.org/licenses/by/4.0/legalcode">https://creativecommons.org/licenses/by/4.0/legalcode</a> for the full legal text.</em></p>

<!-- == \bigskip -->

<p>This work is licensed under the Creative Commons Attribution 4.0
International license (CC-BY-4.0).</p>

<p><strong>You are free to:</strong></p>

<ul>
  <li>
    <p><strong>Share</strong>—copy and redistribute the material in any medium or
format</p>
  </li>
  <li>
    <p><strong>Remix</strong>—remix, transform, and build upon the material for any
purpose, even commercially.</p>
  </li>
</ul>

<p>The licensor cannot revoke these freedoms as long as you follow the
license terms.</p>

<p><strong>Under the following terms:</strong></p>

<ul>
  <li>
    <p><strong>Attribution</strong>—You must give appropriate credit, provide a link
to the license, and indicate if changes were made. You may do so in
any reasonable manner, but not in any way that suggests the licensor
endorses you or your use.</p>
  </li>
  <li>
    <p><strong>No additional restrictions</strong>—You may not apply legal terms or
technological measures that legally restrict others from doing
anything the license permits.</p>
  </li>
</ul>

<p><strong>Notices:</strong></p>

<p>You do not have to comply with the license for elements of the
material in the public domain or where your use is permitted by an
applicable exception or limitation.</p>

<p>No warranties are given. The license may not give you all of the
permissions necessary for your intended use. For example, other rights
such as publicity, privacy, or moral rights may limit how you use the
material.</p>


      



    </div>
<div class="chapter">
      <h1 id="s:conduct">Code of Conduct</h1>
      



      
      <p>In the interest of fostering an open and welcoming environment, we as
contributors and maintainers pledge to making participation in our
project and our community a harassment-free experience for everyone,
regardless of age, body size, disability, ethnicity, gender identity
and expression, level of experience, education, socio-economic status,
nationality, personal appearance, race, religion, or sexual identity
and orientation.</p>

<h2 id="s:conduct-standards">Our Standards</h2>

<p>Examples of behavior that contributes to creating a positive
environment include:</p>

<ul>
  <li>using welcoming and inclusive language,</li>
  <li>being respectful of differing viewpoints and experiences,</li>
  <li>gracefully accepting constructive criticism,</li>
  <li>focusing on what is best for the community, and</li>
  <li>showing empathy towards other community members.</li>
</ul>

<p>Examples of unacceptable behavior by participants include:</p>

<ul>
  <li>the use of sexualized language or imagery and unwelcome sexual
attention or advances,</li>
  <li>trolling, insulting/derogatory comments, and personal or political
attacks,</li>
  <li>public or private harassment,</li>
  <li>publishing others’ private information, such as a physical or
electronic address, without explicit permission, and</li>
  <li>other conduct which could reasonably be considered inappropriate in
a professional setting</li>
</ul>

<h2 id="s:conduct-responsibilities">Our Responsibilities</h2>

<p>Project maintainers are responsible for clarifying the standards of
acceptable behavior and are expected to take appropriate and fair
corrective action in response to any instances of unacceptable
behavior.</p>

<p>Project maintainers have the right and responsibility to remove, edit,
or reject comments, commits, code, wiki edits, issues, and other
contributions that are not aligned to this Code of Conduct, or to ban
temporarily or permanently any contributor for other behaviors that
they deem inappropriate, threatening, offensive, or harmful.</p>

<h2 id="s:conduct-scope">Scope</h2>

<p>This Code of Conduct applies both within project spaces and in public
spaces when an individual is representing the project or its
community. Examples of representing a project or community include
using an official project e-mail address, posting via an official
social media account, or acting as an appointed representative at an
online or offline event. Representation of a project may be further
defined and clarified by project maintainers.</p>

<h2 id="s:conduct-enforcement">Enforcement</h2>

<p>Instances of abusive, harassing, or otherwise unacceptable behavior
may be reported by <a href="gvwilson@third-bit.com">emailing the project team</a>. All
complaints will be reviewed and investigated and will result in a
response that is deemed necessary and appropriate to the
circumstances. The project team is obligated to maintain
confidentiality with regard to the reporter of an incident.  Further
details of specific enforcement policies may be posted separately.</p>

<p>Project maintainers who do not follow or enforce the Code of Conduct
in good faith may face temporary or permanent repercussions as
determined by other members of the project’s leadership.</p>

<h2 id="s:conduct-attribution">Attribution</h2>

<p>This Code of Conduct is adapted from
the <a href="https://www.contributor-covenant.org">Contributor Covenant</a> version 1.4.</p>


      



    </div>
<div class="chapter">
      <h1 id="s:citation">Citation</h1>
      



      
      <p>Please cite this work as:</p>

<blockquote>
  <p>Toby Hodges and Greg Wilson: “JavaScript versus Data Science: A Brief Guide for Those Who Regret That This Has Become Necessary”.  <a href="https://software-tools-in-javascript.github.io/js-vs-ds/">https://software-tools-in-javascript.github.io/js-vs-ds/</a>, 2018.</p>
</blockquote>


      



    </div>
<div class="chapter">
      <h1 id="s:contributing">Contributing</h1>
      



      
      <p>Contributions of all kinds are welcome,
from errata and minor improvements to entirely new sections and chapters.
Please <a href="mailto:gvwilson@third-bit.com">email us</a>,
<a href="https://github.com/software-tools-in-javascript/js-vs-ds/issues">file an issue</a> in <a href="https://github.com/software-tools-in-javascript/js-vs-ds/">our GitHub repository</a>,
or <a href="https://github.com/software-tools-in-javascript/js-vs-ds/pulls">submit a pull request</a>.
Everyone whose work is incorporated will be acknowledged.
Please see <a href="#s:contributing">the contributors’s guide</a> for more information,
and please note that all contributors are required to abide by
our <a href="#s:conduct">Code of Conduct</a>.</p>

<ul>
  <li>
    <p>If you wish to report errata or suggest improvements to wording,
please include the chapter name and section name
(e.g., <code class="highlighter-rouge">Callbacks/Anonymous Functions</code>)
in the first line of the body of your report.
Please note that we use Simplified English rather than Traditional English,
i.e., American spelling rather than British.</p>
  </li>
  <li>
    <p>If you would like to add code fragments,
please put the source in <code class="highlighter-rouge">src/chapter/long-name.js</code>.
Include it in a triple-backquoted code block of type <code class="highlighter-rouge">js</code>;
use <code class="highlighter-rouge">sh</code> for shell commands and <code class="highlighter-rouge">text</code> for output (including error output).
If you want to leave out sections of code,
use <code class="highlighter-rouge">// ...comment...</code> (i.e., a double-slash comment and triple dots enclosing the text).</p>
  </li>
  <li>If you would like to add or fix a diagram, please:
    <ol>
      <li>Edit the XML file in <code class="highlighter-rouge">./files/</code> corresponding to the chapter using <a href="https://www.draw.io/">draw.io</a>.</li>
      <li>Select the drawing and export as SVG with a 4-pixel boundary and transparency turned on,
but <em>without</em> including the diagram source in the exported SVG.</li>
      <li>Export a second time as PDF (selection only, cropped).
We have tried automating the SVG-to-PDF conversion with various tools,
but the results have been unsatisfying.</li>
      <li>Edit the Markdown file and include an HTML <code class="highlighter-rouge">figure</code> element with an ID
containing (in order) an <code class="highlighter-rouge">img</code> element with a <code class="highlighter-rouge">src</code> attribute but nothing else
and a <code class="highlighter-rouge">figcaption</code> element with the figure’s label.
<strong>These elements all have to be on one line</strong>
so that the <code class="highlighter-rouge">sed</code> magic in the Makefile that gets around Pandoc’s handling of figures
can find and translate the elements correctly.</li>
    </ol>
  </li>
  <li>The naming conventions for labels are:
    <ul>
      <li><code class="highlighter-rouge">s:chapter-section</code> for section labels</li>
      <li><code class="highlighter-rouge">f:chapter-slug</code> for figure labels</li>
      <li><code class="highlighter-rouge">g:slug</code> for glossary references</li>
      <li><code class="highlighter-rouge">b:item</code> for bibliography references</li>
    </ul>
  </li>
  <li>
    <p>If you need to embed a one-line LaTeX command in a Markdown file and have it passed through,
format it thusly:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;!-- == \noindent --&gt;
</code></pre></div>    </div>

    <p>(i.e., as an HTML comment with a double equals sign and then the command).
Note that these comments will appear in the generated HTML as well.</p>
  </li>
</ul>

<p>The <a href="https://jekyllrb.com/">Jekyll</a> template used in this tutorial can support multiple languages.
We encourage translations;
if you would like to take this on,
please <a href="mailto:gvwilson@third-bit.com">email us</a>.</p>


      



    </div>
<div class="chapter">
      <h1 id="s:gloss">Glossary</h1>
      



      
      <dl>
  <dt><strong id="g:absolute-path">absolute path</strong>:</dt>
  <dd>a path that points to the same location in the filesystem regardless of where
it’s evaluated.  An absolute path is the equivalent of latitude and longitude
in geography.  See also <a href="#g:relative-path">relative path</a>.</dd>
  <dt><strong id="g:aggregation-function">aggregation function</strong>:</dt>
  <dd>a function that combines many values into one, such as <code class="highlighter-rouge">sum</code> or <code class="highlighter-rouge">max</code>.</dd>
  <dt><strong id="g:anonymous-function">anonymous function</strong>:</dt>
  <dd>a function that is defined without giving it a name, such as a callback
defined where it is used.  Anonymous functions are sometimes called <em>lambda
functions</em> because the Greek letter lambda is used for them in mathematics.</dd>
  <dt><strong id="g:argument">argument</strong>:</dt>
  <dd>see <a href="#g:parameter">parameter</a>.</dd>
  <dt><strong id="g:array">array</strong>:</dt>
  <dd>a collection of values stored in a particular order and indexed numerically.
Arrays are written as comma-separated values in square brackets, such as
<code class="highlighter-rouge">['a', 'b', 'c']</code>.  The term <a href="#g:list">list</a> is often used synonymously.</dd>
  <dt><strong id="g:ascii">ASCII</strong>:</dt>
  <dd>a widely-used set of numeric codes for representing characters from the Latin
alphabet and common punctuation symbols, now superseded by
<a href="#g:unicode">Unicode</a>.</dd>
  <dt><strong id="g:assertion">assertion</strong>:</dt>
  <dd>a statement that something is true at a certain point in a program.
Assertions are often used to define tests, but are also used in <a href="#g:production-code">production
code</a> to check that software is behaving as it should.</dd>
  <dt><strong id="g:attribute">attribute</strong>:</dt>
  <dd>a named property attached to an HTML <a href="#g:element">element</a>.</dd>
  <dt><strong id="g:backward-compatible">backward-compatible</strong>:</dt>
  <dd>able to work consistently with older systems.</dd>
  <dt><strong id="g:http-body">body</strong> (of an HTTP message):</dt>
  <dd>any optional data sent after the message’s headers.</dd>
  <dt><strong id="g:bundler">bundler</strong>:</dt>
  <dd>a tool that combines JavaScript files, web pages, images, and other assets
into a single bundle for deployment.</dd>
  <dt><strong id="g:cache">cache</strong>:</dt>
  <dd>a place where copies of recently-used values are stored for quicker access.</dd>
  <dt><strong id="g:call-stack">call stack</strong>:</dt>
  <dd>a data structure that stores information about function calls that are
currently in progress.  Each function call adds another table of
variable-value pairs to the top of the stack; when the function completes,
that table is discarded.  See also <a href="#g:closure">closure</a>.</dd>
  <dt><strong id="g:callback-function">callback function</strong>:</dt>
  <dd>a function A that is passed to another function B for B to call at a later
time.  Callback functions are used to implement delayed actions, such as what
to do when data arrives in response to a network request.</dd>
  <dt><strong id="g:css">Cascading Style Sheets</strong> (CSS):</dt>
  <dd>a way to describe how HTML should be rendered.</dd>
  <dt><strong id="g:catch">catch</strong>:</dt>
  <dd>to take responsibility for handling an <a href="#g:exception">exception</a>.  Catch is
the counterpart of <a href="#g:throw">throw</a>.</dd>
  <dt><strong id="g:character-encoding">character encoding</strong>:</dt>
  <dd>a specification of how characters are stored as bytes.  The most commonly-used
encoding today is <a href="#g:utf-8">UTF-8</a>.</dd>
  <dt><strong id="g:child-class">child class</strong>:</dt>
  <dd>a new <a href="#g:class">class</a> that <a href="#g:extend">extends</a> an existing class (called
the <a href="#g:parent-class">parent class</a>).</dd>
  <dt><strong id="g:child-node">child node</strong>:</dt>
  <dd>a <a href="#g:node">node</a> in a <a href="#g:tree">tree</a> that is below some other node (which is
called the child node’s <a href="#g:parent-node">parent</a>).</dd>
  <dt><strong id="g:class">class</strong>:</dt>
  <dd>a programming structure that defines the properties and behavior of a family
of related <a href="#g:object">objects</a>.  Classes can <a href="#g:inherit">inherit</a> from other
classes to specify or change behavior incrementally.</dd>
  <dt><strong id="g:client">client</strong>:</dt>
  <dd>a program such as a browser that sends requests to a <a href="#g:server">server</a> and
does something with the response.  It is sometimes helpful to think of clients
as sorcerors petitioning ancient gods for favors.  Sometimes.</dd>
  <dt><strong id="g:client-page-gen">client-side page generation</strong>:</dt>
  <dd>to create an HTML page within a <a href="#g:client">client</a> using data provided by a
<a href="#g:server">server</a>.  See also <a href="#g:server-page-gen">server-side page
generation</a>.</dd>
  <dt><strong id="g:closure">closure</strong>:</dt>
  <dd>a set of variables defined in the same <a href="#g:scope">scope</a> whose existence has
been preserved after that scope has ended.  Closures are one of the trickiest
ideas in programming.</dd>
  <dt><strong id="g:csv">Comma-Separated Values</strong> (CSV):</dt>
  <dd>a text format for tabular data in which each record is one row and fields are
separated by commas.  There are many minor variations, particularly around
quoting of strings.</dd>
  <dt><strong id="g:connection-manager">connection manager</strong>:</dt>
  <dd>an object that maintains a connection to a database.  When the code is
finished working with the database, the connection manager ensures that the
connection is closed gracefully, which helps to avoid the corruption of data.</dd>
  <dt><strong id="g:cdn">Content Delivery Network</strong> (CDN):</dt>
  <dd>a geographically distributed set of servers that store commonly-used or
recently-used data such as web pages so that they can be served more quickly.</dd>
  <dt><strong id="g:constant">constant</strong>:</dt>
  <dd>a variable whose value cannot be changed.  Note that the value itself might be
changed: for example, after the statement <code class="highlighter-rouge">const v = ['a', 'b']</code>, the name <code class="highlighter-rouge">v</code>
will always refer to the same array, but the array’s contents can be changed.</dd>
  <dt><strong id="g:cors">Cross-Origin Resource Sharing</strong> (CORS):</dt>
  <dd>a way to control requests made for data and other resources that aren’t served
by the site that gave the browser the original page.</dd>
  <dt><strong id="g:declarative">declarative programming</strong>:</dt>
  <dd>a style of programming in which the user specifies what they want, and the
computer figures out how to deliver it.</dd>
  <dt><strong id="g:destructuring">destructuring</strong>:</dt>
  <dd>a form of assignment that unpacks a data structure in one step, such as <code class="highlighter-rouge">[a,
b] = [1, 2]</code> or <code class="highlighter-rouge">{left, right} = {left: 1, right: 2}</code>.</dd>
  <dt><strong id="g:dns">Domain Name System</strong> (DNS):</dt>
  <dd>a decentralized naming system for computers that translates logical names such
as <code class="highlighter-rouge">third-bit.com</code> into the addresses of particular computers.</dd>
  <dt><strong id="g:document">document</strong>:</dt>
  <dd>an entire HTML page.</dd>
  <dt><strong id="g:dom">Document Object Model</strong> (DOM):</dt>
  <dd>a standard way to represent HTML in memory.  The <a href="#g:element">elements</a> and
<a href="#g:attribute">attributes</a> of the page, along with its text, are stored as
<a href="#g:node">nodes</a> organized in a tree.</dd>
  <dt><strong id="g:dotted-notation">dotted notation</strong>:</dt>
  <dd>a common way to refer to the parts of structures in programming languages.
<code class="highlighter-rouge">whole.part</code> means “the thing called <code class="highlighter-rouge">part</code> belonging to <code class="highlighter-rouge">whole</code>”.</dd>
  <dt><strong id="g:driver">driver</strong>:</dt>
  <dd>a program that provides a standard interface through which to communicate with
another piece of hardware or software.  Every graphics card has a driver that
translates generic drawing commands into card-specific operations; every
database comes with drivers that (theoretically) allow other programs to talk
to them all in the same way.</dd>
  <dt><strong id="g:element">element</strong>:</dt>
  <dd>an individual component of a web page.  In HTML, elements are enclosed in
matching <code class="highlighter-rouge">&lt;tag&gt;</code> and <code class="highlighter-rouge">&lt;/tag&gt;</code> pairs, or written as <code class="highlighter-rouge">&lt;tag/&gt;</code> if they contain no
content.  Elements are represented as <a href="#g:node">nodes</a> in the <a href="#g:dom">DOM</a>.</dd>
  <dt><strong id="g:entry-point">entry point</strong>:</dt>
  <dd>a function with a known name and <a href="#g:signature">signature</a> that a framework
requires every plugin or other dynamically-loaded content to have.  The entry
point is (as the name suggests) how the framework gets into the plugin.</dd>
  <dt><strong id="g:escape-sequence">escape sequence</strong>:</dt>
  <dd>a sequence of characters used to represent some other character that would
otherwise have a special meaning.  For example, the escape sequence <code class="highlighter-rouge">\"</code> is
used to represent a double-quote character inside a double-quoted string.</dd>
  <dt><strong id="g:event-handler">event handler</strong>:</dt>
  <dd>a <a href="#g:callback-function">callback function</a> that does something in response to
a particular interaction with a browser, such as a key being pressed or a link
being clicked.</dd>
  <dt><strong id="g:event-listener">event listener</strong>:</dt>
  <dd>see <a href="#g:event-handler">event handler</a>.</dd>
  <dt><strong id="g:event-loop">event loop</strong>:</dt>
  <dd>the fundamental processing cycle in JavaScript that takes the next task from a
list and runs it, possibly adding more tasks to the list as it does so.</dd>
  <dt><strong id="g:event-object">event object</strong>:</dt>
  <dd>an <a href="#g:object">object</a> that the system passes to an <a href="#g:event-handler">event
handler</a> that contains information about the event, such as
which key was pressed.</dd>
  <dt><strong id="g:exception">exception</strong>:</dt>
  <dd>an object that stores information about an error or other unusual event in a
program.  One part of a program will create and <a href="#g:throw">throw</a> an exception
to signal that something unexpected has happened; another part will
<a href="#g:catch">catch</a> it.</dd>
  <dt><strong id="g:extend">extend</strong>:</dt>
  <dd>to create a new class from an existing class.  We say that the new class
<a href="#g:inherit">inherits</a> from the old one.</dd>
  <dt><strong id="g:falsy">falsy</strong>:</dt>
  <dd>a horrible neologism meaning “equivalent to false”.  See also the equally
horrible <a href="#g:truthy">truthy</a>.</dd>
  <dt><strong id="g:fat-arrow">fat arrow function</strong>:</dt>
  <dd>a JavaScript function defined using the syntax <code class="highlighter-rouge">(...parameters...) =&gt;
{...body...}</code>.  Fat arrow functions treat the special value <code class="highlighter-rouge">this</code> in a less
inconsistent way than their older equivalents.</dd>
  <dt><strong id="g:field">field</strong>:</dt>
  <dd>a named part of a <a href="#g:record">record</a> in a <a href="#g:relational-database">relational
database</a>.  Fields are typically shown as columns in a
<a href="#g:table">table</a>.</dd>
  <dt><strong id="g:fixture">fixture</strong>:</dt>
  <dd>the data on which a <a href="#g:unit-test">unit test</a> is run.</dd>
  <dt><strong id="g:functional-programming">functional programming</strong>:</dt>
  <dd>a style of programming in which data is transformed through successive
application of functions, rather than by using control structures such as
loops.  Functional programming in JavaScript relies heavily on
<a href="#g:callback-function">callbacks</a> and <a href="#g:higher-order-function">higher-order
functions</a>.</dd>
  <dt><strong id="g:global-installation">global installation</strong>:</dt>
  <dd>a JavaScript library placed in a location where it can be accessed by all
users and projects.  See also <a href="#g:local-installation">local installation</a>.</dd>
  <dt><strong id="g:global-variable">global variable</strong>:</dt>
  <dd>a variable defined outside any particular function, which is therefore visible
to all functions.  See also <a href="#g:local-variable">local variable</a>.</dd>
  <dt><strong id="g:header-row">header row</strong>:</dt>
  <dd>if present, the first of a <a href="#g:csv">CSV</a> file that defines column names (but
tragically, not their data types or units).</dd>
  <dt><strong id="g:heterogeneous">heterogeneous</strong>:</dt>
  <dd>having mixed type.  For example, an <a href="#g:array">array</a> is said to be
heterogeneous if it contains a mix of numbers, character strings, and values
of other types.  See also <a href="#g:homogeneous">homogeneous</a>.</dd>
  <dt><strong id="g:higher-order-function">higher-order function</strong>:</dt>
  <dd>a function that operates on other functions.  For example, the higher-order
function <code class="highlighter-rouge">forEach</code> executes a given function once on each value in an
<a href="#g:array">array</a>.  Higher-order functions are heavily used in <a href="#g:functional-programming">functional
programming</a>.</dd>
  <dt><strong id="g:homogeneous">homogeneous</strong>:</dt>
  <dd>having a single type.  For example, an <a href="#g:array">array</a> is said to be
homogeneous if it contains only numbers or only character strings, but not a
mix of the two.</dd>
  <dt><strong id="g:hostname">hostname</strong>:</dt>
  <dd>the part of a URL that specifies the computer to talk to.  In
<code class="highlighter-rouge">http://example.com/something/</code>, the hostname is <code class="highlighter-rouge">example.com</code>; in
<code class="highlighter-rouge">http://localhost:1234/</code>, it is <code class="highlighter-rouge">localhost</code>.</dd>
  <dt><strong id="g:http">HTTP</strong>:</dt>
  <dd>the HyperText Transfer Protocol used to exchange information between browsers
and websites, and more generally between other <a href="#g:client">clients</a> and
<a href="#g:server">servers</a>.  HTTP is a <a href="#g:stateless">stateless</a> protocol in which
communication consists of <a href="#g:http-request">requests</a> and
<a href="#g:http-response">responses</a>.</dd>
  <dt><strong id="g:http-header">HTTP header</strong>:</dt>
  <dd>a name-value pair at the start of an HTTP <a href="#g:http-request">request</a> or
<a href="#g:http-response">response</a>.  Headers are used to specify what data formats
the sender can handle, the date and time the message was sent, and so on.</dd>
  <dt><strong id="g:http-method">HTTP method</strong>:</dt>
  <dd>the verb in an <a href="#g:http-request">HTTP request</a> that defines what the client
wants to do.  Common methods are <code class="highlighter-rouge">GET</code> (to get data) and <code class="highlighter-rouge">POST</code> (to submit
data).</dd>
  <dt><strong id="g:http-request">HTTP request</strong>:</dt>
  <dd>a precisely-formatted block of text sent from a <a href="#g:client">client</a> (such as a
browser) to a <a href="#g:server">server</a> that specifies what resource is being
requested, what data formats the client will accept, and so on.</dd>
  <dt><strong id="g:http-response">HTTP response</strong>:</dt>
  <dd>a precisely-formatted block of text sent from a <a href="#g:server">server</a> back to a
<a href="#g:client">client</a> in reply to a <a href="#g:http-request">request</a>.</dd>
  <dt><strong id="g:http-status-code">HTTP status code</strong>:</dt>
  <dd>a numerical code that indicates what happened when an <a href="#g:http-request">HTTP
request</a> was processed, such as 200 (OK), 404 (not found), or
500 (internal server error).</dd>
  <dt><strong id="g:in-memory-database">in-memory database</strong>:</dt>
  <dd>a database that is stored in memory rather than in permanent storage.
In-memory databases are often used for testing.</dd>
  <dt><strong id="g:inherit">inherit</strong>:</dt>
  <dd>to acquire properties and methods from a parent class.  See also
<a href="#g:extend">extend</a>.</dd>
  <dt><strong id="g:internal-style-sheet">internal style sheet</strong>:</dt>
  <dd>a set of <a href="#g:css">CSS</a> definitions placed inside a web page rather than in an
external file.</dd>
  <dt><strong id="g:json">JSON</strong>:</dt>
  <dd>a way to represent data by combining basic values like numbers and character
strings in <a href="#g:array">arrays</a> and name/value structures.  The acronym stands
for “JavaScript Object Notation”; unlike better-defined standards like
<a href="#g:xml">XML</a>, it is unencumbered by a syntax for comments or ways to define
<a href="#g:schema">schemas</a>.</dd>
  <dt><strong id="g:library">library</strong>:</dt>
  <dd>see <a href="#g:module">module</a>.</dd>
  <dt><strong id="g:list">list</strong>:</dt>
  <dd>see <a href="#g:array">array</a>.</dd>
  <dt><strong id="g:local-installation">local installation</strong>:</dt>
  <dd>a JavaScript library placed inside a particular project, and only accessible
within that project.  See also <a href="#g:global-installation">global installation</a>.</dd>
  <dt><strong id="g:local-server">local server</strong>:</dt>
  <dd>a <a href="#g:server">server</a> run on the user’s own computer, usually for testing
purposes during development.</dd>
  <dt><strong id="g:local-variable">local variable</strong>:</dt>
  <dd>a variable defined inside a function which is only visible within that
function.  See also <a href="#g:global-variable">global variable</a> and
<a href="#g:closure">closure</a>.</dd>
  <dt><strong id="g:logging">logging</strong>:</dt>
  <dd>to record information about a program’s execution in a structured way.</dd>
  <dt><strong id="g:logging-transport">logging transport</strong>:</dt>
  <dd>a channel through which <a href="#g:logging">logging</a> messages are sent, such as
standard output (for the user’s screen) or a database connection.</dd>
  <dt><strong id="g:member-variable">member variable</strong>:</dt>
  <dd>see <a href="#g:property">property</a>.</dd>
  <dt><strong id="g:memory-diagram">memory diagram</strong>:</dt>
  <dd>a picture showing the variables a program contains and the data they refer to.</dd>
  <dt><strong id="g:method">method</strong>:</dt>
  <dd>a function attached to an <a href="#g:object">object</a>, typically called using <a href="#g:dotted-notation">dotted
notation</a>.  In JavaScript and many other languages, a
special variable called <code class="highlighter-rouge">this</code> is provided to methods to refer to the
particular object for which the method is being called.</dd>
  <dt><strong id="g:minimization">minimization</strong>:</dt>
  <dd>to remove spaces and other extraneous characters from source files (and
possibly even rename variables).  This makes those files smaller and faster to
deploy at the expense of readability.</dd>
  <dt><strong id="g:module">module</strong>:</dt>
  <dd>a set of variables, functions, and/or classes grouped together for easier
management (typically but not always in a single file).  Modules are sometimes
also called <a href="#g:library">libraries</a>.</dd>
  <dt><strong id="g:module-variable">module variable</strong>:</dt>
  <dd>a variable that is visible within a module but not outside it.  See
<a href="#g:scope">scope</a>.</dd>
  <dt><strong id="g:mutation">mutation</strong>:</dt>
  <dd>changing data in place, such as modifying an element of an array or adding a
record to a database.</dd>
  <dt><strong id="g:name-collision">name collision</strong>:</dt>
  <dd>the ambiguity that arises when two or more things in a program that have the
same name are active at the same time.  The <a href="#g:call-stack">call stack</a> was
invented in part to address this problem.</dd>
  <dt><strong id="g:node-js">Node</strong>:</dt>
  <dd>an open source implementation of JavaScript for use outside the browser.</dd>
  <dt><strong id="g:node">node</strong>:</dt>
  <dd>an in-memory representation of an element in an HTML page.  See also
<a href="#g:dom">DOM</a>. Not to be confused with <a href="#g:node-js">Node.js</a>.</dd>
  <dt><strong id="g:nosql-database">NoSQL database</strong>:</dt>
  <dd>any database that doesn’t use the <a href="#g:relational-database">relational</a> model.
The awkward name comes from the fact that such databases don’t use
<a href="#g:sql">SQL</a> as a query language.</dd>
  <dt><strong id="g:object">object</strong>:</dt>
  <dd>a clump of variables and/or <a href="#g:method">methods</a> grouped together in a
program.  In most languages, objects can only be created as instances of
<a href="#g:class">classes</a>, but JavaScript calls anything created using <code class="highlighter-rouge">{...}</code> an
object.  Do not seek to walk in the footsteps of the sages; seek rather what
they sought.</dd>
  <dt><strong id="g:observer-observable">observer-observable</strong>:</dt>
  <dd>a widely-used programming pattern in which some <a href="#g:object">objects</a> are
notified and take action when other objects change state or take action.</dd>
  <dt><strong id="g:override-method">override</strong>:</dt>
  <dd>to replace a definition of a [method] in a <a href="#g:parent-class">parent-class</a>
with a new definition in a <a href="#g:child-class">child class</a>.</dd>
  <dt><strong id="g:query-parameter">query parameter</strong>:</dt>
  <dd>a placeholder in an <a href="#g:sql">SQL</a> query that must be filled in with an actual
value in order for the query to run.</dd>
  <dt><strong id="g:package-manager">package manager</strong>:</dt>
  <dd>a program that does its best to keep track of the bits and bobs of software
installed on a computer.  The most widely used package manager for JavaScript
is called NPM; it does its best, but really, without proper discipline on the
part of programmers, it’s like Boromir trying to hold back the orcs or a
kindergarten teacher trying to keep everyone’s shirt clean during
finger-painting.</dd>
  <dt><strong id="g:parameter">parameter</strong>:</dt>
  <dd>a variable whose value is passed into a function when the function is called.
Some writers distinguish parameters (the variables) from
<a href="#g:argument">arguments</a> (the values passed in), but others use the terms in
the opposite sense.  It’s all very confusing.</dd>
  <dt><strong id="g:parent-class">parent class</strong>:</dt>
  <dd>an existing <a href="#g:class">class</a> that has been <a href="#g:extend">extended</a> to create a
new class.  (The new class is called the <a href="#g:child-class">child class</a>.)</dd>
  <dt><strong id="g:parent-node">parent node</strong>:</dt>
  <dd>the <a href="#g:node">node</a> in a <a href="#g:tree">tree</a> that is above some other node.  Every
node has a parent except the [root]{#root-node}.</dd>
  <dt><strong id="g:parse">parse</strong>:</dt>
  <dd>to translate the text of a program or web page into a data structure in memory
that the program can then manipulate.</dd>
  <dt><strong id="g:polymorphism">polymorphism</strong>:</dt>
  <dd>literally, “having many forms”.  The term refers to the way in which
<a href="#g:object">objects</a> whose <a href="#g:method">methods</a> have the same names and
<a href="#g:parameter">parameters</a> can be used interchangeably.</dd>
  <dt><strong id="g:port">port</strong>:</dt>
  <dd>a logical endpoint for communication, corresponding to a phone number in an
office building.  In a URL such as <code class="highlighter-rouge">http://example.com:8081/something</code>, the
port is <code class="highlighter-rouge">8081</code>.  Only one program may use a port at any time.</dd>
  <dt><strong id="g:production-code">production code</strong>:</dt>
  <dd>software that is delivered to an end user.  The term is used to distinguish
such code from test code, deployment infrastructure, and everything else that
programmers write along the way.</dd>
  <dt><strong id="g:promise">promise</strong>:</dt>
  <dd>a way to handle delayed computations in JavaScript.  Promises were supposed to
make programmers’ lives simpler.</dd>
  <dt><strong id="g:protocol">protocol</strong>:</dt>
  <dd>a set of rules specifying how two things will interact.  The HTTP protocol
defines the format of <a href="#g:http-request">requests</a>,
<a href="#g:http-response">responses</a>, and <a href="#g:http-status-code">status codes</a>; a
protocol for application plugins defines how they will be referred to and what
<a href="#g:entry-point">entry points</a> they must contain.</dd>
  <dt><strong id="g:prototype">prototype</strong>:</dt>
  <dd>an idiosyncratic mechanism used in the original definition of JavaScript for
sharing properties between objects that we unfortunately still have to cope
with.</dd>
  <dt><strong id="g:property">property</strong>:</dt>
  <dd>a variable associated with an <a href="#g:object">object</a>.  The term is used to
distinguish an object’s passive data from its executable <a href="#g:method">methods</a>.
Properties are sometimes called <a href="#g:member-variable">member variables</a>.</dd>
  <dt><strong id="g:pseudo-random-number">pseudo-random number</strong>:</dt>
  <dd>a value generated in a repeatable way that has the properties of being truly
random.</dd>
  <dt><strong id="g:prng">pseudo-random number generator</strong> (PRNG):</dt>
  <dd>a function that can generate a series of <a href="#g:pseudo-random-number">pseudo-random
numbers</a> after being initialized with a
<a href="#g:seed">seed</a>.</dd>
  <dt><strong id="g:race-condition">race condition</strong>:</dt>
  <dd>a situation in which the result of a computation can vary due to operations
being performed in different orders.</dd>
  <dt><strong id="g:raise">raise</strong>:</dt>
  <dd>see <a href="#g:throw">throw</a>.</dd>
  <dt><strong id="g:repl">read-evaluate-print loop</strong> (REPL):</dt>
  <dd>an interactive program that reads a command typed in by a user, executes it,
prints the result, and then waits patiently for the next command.  REPLs are
often used to explore new ideas or for debugging.</dd>
  <dt><strong id="g:record">record</strong>:</dt>
  <dd>a set of related values.  In a <a href="#g:relational-database">relational database</a>,
a record is typically shown as a single row in a <a href="#g:table">table</a>.  See also
<a href="#g:field">field</a>.</dd>
  <dt><strong id="g:regular-expression">regular expression</strong>:</dt>
  <dd>a pattern for matching text.</dd>
  <dt><strong id="g:relational-database">relational database</strong>:</dt>
  <dd>a database that organizes information into <a href="#g:table">tables</a>, each of which
has a fixed set of named <a href="#g:field">fields</a> (shown as columns) and a variable
number of <a href="#g:record">records</a> (shown as rows).  See also <a href="#g:sql">SQL</a>.</dd>
  <dt><strong id="g:relative-path">relative path</strong>:</dt>
  <dd>a path whose destination is interpreted relative to some other location, such
as the current directory.  A relative path is the equivalent of giving
directions using terms like “straight” and “left”.  See also <a href="#g:absolute-path">absolute
path</a>.</dd>
  <dt><strong id="g:responsive-design">responsive design</strong>:</dt>
  <dd>an approach to building web pages and other applications that resizes and
reorganizes things smoothly for different sizes of screens.</dd>
  <dt><strong id="g:rgb">RGB</strong>:</dt>
  <dd>a way to represent colors as triples of red, green, and blue intensities, each
of which ranges from 0 to 255.  RGB is often augmented in modern systems to
create RGBA, where the fourth component is the pixel’s transparency.</dd>
  <dt><strong id="g:root-node">root</strong>:</dt>
  <dd>the only node in a <a href="#g:tree">tree</a> that <em>doesn’t</em> have a <a href="#g:parent-node">parent</a>.</dd>
  <dt><strong id="g:root-directory">root directory</strong>:</dt>
  <dd>the directory that contains everything else, directly or indirectly.  The root
directory is written <code class="highlighter-rouge">/</code> (a bare forward slash).</dd>
  <dt><strong id="g:root-element">root element</strong>:</dt>
  <dd>the <a href="#g:element">element</a> in a document that contains every other element.
The root element of a web page is the <code class="highlighter-rouge">html</code> element.</dd>
  <dt><strong id="g:schema">schema</strong>:</dt>
  <dd>a specification of the “shape” of data, such as the <a href="#g:field">fields</a> making
up a database table or the ways in which structures can be nested in
<a href="#g:json">JSON</a>.</dd>
  <dt><strong id="g:scope">scope</strong>:</dt>
  <dd>the portion of a program within which a definition can be seen and used.  See
<a href="#g:global-variable">global-variable</a>, <a href="#g:local-variable">local-variable</a>,
<a href="#g:module-variable">module-variable</a>, and (if you are brave)
<a href="#g:closure">closure</a>.</dd>
  <dt><strong id="g:seed">seed</strong>:</dt>
  <dd>a value used to initialize a <a href="#g:prng">pseudo-random number generator</a>.</dd>
  <dt><strong id="g:selector">selector</strong>:</dt>
  <dd>a way to identify elements within an HTML document.  The selector
<code class="highlighter-rouge">h2#contents</code>, for example, means “the <code class="highlighter-rouge">h2</code> element with the ID <code class="highlighter-rouge">contents</code>”.</dd>
  <dt><strong id="g:server">server</strong>:</dt>
  <dd>a program that waits for requests from <a href="#g:client">clients</a> and sends them
data in response.  It is sometimes helpful to think of servers as harassed
parents trying to babysit a room full of unruly children.</dd>
  <dt><strong id="g:server-page-gen">server-side page generation</strong>:</dt>
  <dd>to create an HTML page on a server.  That HTML is then delivered as-is to a
browser for display.  See also <a href="#g:client-page-gen">client-side page
generation</a>.</dd>
  <dt><strong id="g:sql">SQL</strong>:</dt>
  <dd>the language used for writing queries for <a href="#g:relational-database">relational
databases</a>.  The term was originally an acronym for
Structured Query Language.</dd>
  <dt><strong id="g:signature">signature</strong>:</dt>
  <dd>the ordered list of argument data types required by a function or
<a href="#g:method">method</a>.  If two functions or methods have the same signature,
they can be called in the same way.</dd>
  <dt><strong id="g:stateful">stateful</strong>:</dt>
  <dd>to retain information from one operation to the next.</dd>
  <dt><strong id="g:stateless">stateless</strong>:</dt>
  <dd>to <em>not</em> retain information from one operation to the next.</dd>
  <dt><strong id="g:string">string</strong>:</dt>
  <dd>a block of text in a program.  The term is short for “character string”.</dd>
  <dt><strong id="g:string-interpolation">string interpolation</strong>:</dt>
  <dd>the process of inserting text corresponding to specified values into a string,
usually to make output human-readable.</dd>
  <dt><strong id="g:table">table</strong>:</dt>
  <dd>a set of uniformly-formatted <a href="#g:record">records</a> in a <a href="#g:relational-database">relational
database</a>.  Tables are usually drawn with rows (each
of which represents one record) and columns (each of which represents a
<a href="#g:field">field</a>).</dd>
  <dt><strong id="g:tag">tag</strong>:</dt>
  <dd>a short textual label identifying a kind of element in an HTML page.
Commonly-used tags include <code class="highlighter-rouge">p</code> (for a paragraph) and <code class="highlighter-rouge">h1</code> (for a level-1
heading).</dd>
  <dt><strong id="g:template">template</strong>:</dt>
  <dd>a document with some placeholders that can be filled in with specific values.
Templates are often used to create personalized email messages and web pages,
though their efficacy is predicated upon relentless commercialization and
devaluation of modern society’s sense of what constitutes “personal”.</dd>
  <dt><strong id="g:test-runner">test runner</strong>:</dt>
  <dd>a program that finds and runs <a href="#g:unit-test">unit tests</a> and reports their
results.</dd>
  <dt><strong id="g:test-suite">test suite</strong>:</dt>
  <dd>a set of <a href="#g:unit-test">unit tests</a>, usually stored in files that follow a
prescribed naming convention.</dd>
  <dt><strong id="g:throw">throw</strong>:</dt>
  <dd>to signal that something unexpected or unusual has happened in a program by
creating an <a href="#g:exception">exception</a> and handing it to the error-handling
system, which then tries to find a point in the program that will
<a href="#g:catch">catch</a> it.  (Some languages call this <em><a href="#g:raise">raising</a></em> an
exception.)</dd>
  <dt><strong id="g:tree">tree</strong>:</dt>
  <dd>a data structure containing strictly-nested <a href="#g:node">nodes</a>.  Every node
except the <a href="#g:root-node">root node</a> must have exactly one <a href="#g:parent-node">parent
node</a>, but each node may have zero or more
<a href="#g:child-node">children</a>.</dd>
  <dt><strong id="g:truthy">truthy</strong>:</dt>
  <dd>a truly horrible neologism meaning “not equivalent to false”.  See also
<a href="#g:falsy">falsy</a>, but only if you are able to set aside your respect for the
English language.</dd>
  <dt><strong id="g:unicode">Unicode</strong>:</dt>
  <dd>a standard that defines numeric codes for many thousands of characters and
symbols.  Unicode does <em>not</em> define how those numbers are stored; that is done
by standards like <a href="#g:utf-8">UTF-8</a>.</dd>
  <dt><strong id="g:unit-test">unit test</strong>:</dt>
  <dd>a test that exercises one property or expected behavior of a system.</dd>
  <dt><strong id="g:url">URL</strong> (Uniform Resource Locator):</dt>
  <dd>a multi-part identifier that specifies something on a computer network.  A URL
may contain a protocol (such as <code class="highlighter-rouge">http</code>), a hostname (such as <code class="highlighter-rouge">example.com</code>), a
port (such as <code class="highlighter-rouge">80</code>), a path (such as <code class="highlighter-rouge">/homepage.html</code>), and <a href="#g:query-parameter">query
parameters</a></dd>
  <dt><strong id="g:utf-8">UTF-8</strong>:</dt>
  <dd>a way to store the numeric codes representing Unicode characters in memory
that is <a href="#g:backward-compatible">backward-compatible</a> with the older
<a href="#g:ascii">ASCII</a> standard.</dd>
  <dt><strong id="g:variable">variable</strong>:</dt>
  <dd>a name in a program that has some data associated with it.  A variable’s value
can be changed after definition.  See also <a href="#g:constant">constant</a>.</dd>
  <dt><strong id="g:xml">XML</strong>:</dt>
  <dd>a set of rules for defining HTML-like tags and using them to format documents
(typically data).  XML achieved license plate popularity in the early 2000s,
but its complexity led many programmers to adopt <a href="#g:json">JSON</a> instead.</dd>
</dl>


      



    </div>
<div class="chapter">
      <h1 id="s:keypoints">Key Points</h1>
      



      
      
<h2><a href="#s:intro">Introduction</a></h2>

<ul><li>Modern JavaScript is a good tool for building desktop and web-based applications.
</li><li>This course is for people who know what loops and functions are, but have never used JavaScript or built web applications.
</li><li>Node is a command-line interpreter for JavaScript, which can be used interactively or to run scripts in files.
</li><li>NPM is the Node Package Manager, which can be used to find, install, and update libraries.
</li></ul>
<h2><a href="#s:basics">Basic Features</a></h2>

<ul><li>Use <code class="highlighter-rouge">console.log</code> to print messages.
</li><li>Use dotted notation <code class="highlighter-rouge">X.Y</code> to get part <code class="highlighter-rouge">Y</code> of object <code class="highlighter-rouge">X</code>.
</li><li>Basic data types are Booleans, numbers, and character strings.
</li><li>Arrays store multiple values in order.
</li><li>The special values <code class="highlighter-rouge">null</code> and <code class="highlighter-rouge">undefined</code> mean ‘no value’ and ‘does not exist’.
</li><li>Define constants with <code class="highlighter-rouge">const</code> and variables with <code class="highlighter-rouge">let</code>.
</li><li><code class="highlighter-rouge">typeof</code> returns the type of a value.
</li><li><code class="highlighter-rouge">for (let variable of collection) {...}</code> iterates through the values in an array.
</li><li><code class="highlighter-rouge">if (condition) {...} else {...}</code> conditionally executes some code.
</li><li><code class="highlighter-rouge">false</code>, 0, the empty string, <code class="highlighter-rouge">null</code>, and <code class="highlighter-rouge">undefined</code> are false; everything else is true.
</li><li>Use back quotes and <code class="highlighter-rouge">${...}</code> to interpolate values into strings.
</li><li>An object is a collection of name/value pairs written in `{…}.
</li><li><code class="highlighter-rouge">object[key]</code> or <code class="highlighter-rouge">object.key</code> gets a value from an object.
</li><li>Functions are objects that can be assigned to variables, stored in lists, etc.
</li><li><code class="highlighter-rouge">function (...parameters...) {...body...}</code> is the old way to define a function.
</li><li><code class="highlighter-rouge">name = (...parameters...) =&gt; {...body...}</code> is the new way to define a function.
</li><li>Use <code class="highlighter-rouge">return</code> inside a function body to return a value at any point.
</li><li>Use modules to divide code between multiple files for re-use.
</li><li>Assign to <code class="highlighter-rouge">module.exports</code> to specify what a module exports.
</li><li><code class="highlighter-rouge">require(...path...)</code> imports a module.
</li><li>Paths beginning with ‘.’ or ‘/’ are imported locally, but paths without ‘.’ or ‘/’ look in the library.
</li></ul>
<h2><a href="#s:callbacks">Callbacks</a></h2>

<ul><li>JavaScript stores the instructions making up a function in memory like any other object.
</li><li>Function objects can be assigned to variables, put in lists, passed as arguments to other functions, etc.
</li><li>Functions can be defined in place without ever being given a name.
</li><li>A callback function is one that is passed in to another function for it to execute at a particular moment.
</li><li>Functional programming uses higher-order functions on immutable data.
</li><li><code class="highlighter-rouge">Array.some</code> is true if any element in an array passes a test, while <code class="highlighter-rouge">Array.every</code> is true if they all do.
</li><li><code class="highlighter-rouge">Array.filter</code> selects elements of an array that pass a test.
</li><li><code class="highlighter-rouge">Array.map</code> creates a new array by transforming values in an existing one.
</li><li><code class="highlighter-rouge">Array.reduce</code> reduces an array to a single value.
</li><li>A closure is a set of variables captured during the definition of a function.
</li></ul>
<h2><a href="#s:oop">Objects and Classes</a></h2>

<ul><li>Create classes to define combinations of data and behavior.
</li><li>Use the class’s constructor to initialize objects.
</li><li><code class="highlighter-rouge">this</code> refers to the current object.
</li><li>Use polymorphism to express common behavior patterns.
</li><li>Extend existing classes to create new ones-sometimes.
</li><li>Override methods to change or extend their behavior.
</li><li>Creating extensible systems by defining interfaces and protocols.
</li></ul>
<h2><a href="#s:htmlcss">HTML and CSS</a></h2>

<ul><li>HTML is the latest in a long line of markup languages.
</li><li>HTML documents contain elements (represented by tags in angle brackets) and text.
</li><li>Elements must be strictly nested.
</li><li>Elements can contain attributes.
</li><li>Use escape sequences beginning with ampersand to represent special characters.
</li><li>Every page should have one <code class="highlighter-rouge">html</code> element containing a <code class="highlighter-rouge">head</code> and a <code class="highlighter-rouge">body</code>.
</li><li>Use <code class="highlighter-rouge">&lt;!--...--&gt;</code> to include comments in HTML.
</li><li>Use <code class="highlighter-rouge">ul</code> and <code class="highlighter-rouge">ol</code> for unordered and ordered lists, and <code class="highlighter-rouge">li</code> for list elements.
</li><li>Use <code class="highlighter-rouge">table</code> for tables, <code class="highlighter-rouge">tr</code> for rows, <code class="highlighter-rouge">th</code> for headings, and <code class="highlighter-rouge">td</code> for regular data.
</li><li>Use <code class="highlighter-rouge">&lt;a href="..."&gt;...&lt;/a&gt;</code> to create links.
</li><li>Use <code class="highlighter-rouge">&lt;img src="..." title="..." alt="..." /&gt;</code> to include images.
</li><li>Use CSS to define appearance of elements.
</li><li>Use <code class="highlighter-rouge">class</code> and <code class="highlighter-rouge">id</code> to identify elements.
</li><li>Use selectors to specify the elements that CSS applies to.
</li></ul>
<h2><a href="#s:pages">Manipulating Pages</a></h2>

<ul><li>Use a <code class="highlighter-rouge">meta</code> tag in a page’s header to specify the page’s character encoding.
</li><li>Pages are represented in memory using a Document Object Model (DOM).
</li><li>The <code class="highlighter-rouge">document</code> object represents the page a script is in.
</li><li>Use the <code class="highlighter-rouge">querySelectorAll</code> method to find DOM nodes that match a condition.
</li><li>Assign HTML text to a node’s <code class="highlighter-rouge">innerHTML</code> property to change the node’s content.
</li><li>Use <code class="highlighter-rouge">((params) =&gt; {...})(arguments)</code> to create and call a function in a single step.
</li><li>An event listener is a function run by the browser when some specific event occurs.
</li><li>Create an event listener for <code class="highlighter-rouge">'DOMContentLoaded'</code> to trigger execution of scripts <em>after</em> the DOM has been constructed.
</li><li>Check the <code class="highlighter-rouge">nodeType</code> or <code class="highlighter-rouge">nodeName</code> property of a DOM node to find out what kind of node it is.
</li><li>Destructuring assignment allows us to assign to multiple variables by name in a single statement.
</li><li>Use <code class="highlighter-rouge">setTimeout</code> to trigger execution of a function after a delay.
</li><li>To make something run forever, have the function called by <code class="highlighter-rouge">setTimeout</code> set another timeout of the same function.
</li></ul>
<h2><a href="#s:dynamic">Dynamic Pages</a></h2>

<ul><li>Older dynamic web sites generated pages on the server.
</li><li>Newer dynamic web sites generate pages in the client.
</li><li>React is a JavaScript library for client-side page generation that represents HTML elements as function calls.
</li><li>React replaces page elements with dynamically-generated content in memory (not on disk).
</li><li>React functions can be customized with elements.
</li><li>JSX translates HTML into React function calls so that HTML and JavaScript can be mixed freely.
</li><li>Use Babel to translate JSX into JavaScript in the browser.
</li><li>Define new React components with a pseudo-HTML element and a corresponding function.
</li><li>Attributes to pseudo-HTML are passed to the JavaScript function as a <code class="highlighter-rouge">props</code> object.
</li></ul>
<h2><a href="#s:vis">Visualizing Data</a></h2>

<ul><li>Vega-Lite is a simple way to build common visualizations.
</li><li>Vega-Lite is declarative: the user creates a data structure describing what they want, and the library creates the visualization.
</li><li>A Vega-List specification contains a schema identifier, a description, data, marks, and encodings.
</li><li>The overall layout of a Vega-Lite visualization can be controlled by setting options.
</li><li>Some applications will use <code class="highlighter-rouge">require</code> for server-side code and <code class="highlighter-rouge">import</code> for client-side code.
</li></ul>
<h2><a href="#s:promises">Promises</a></h2>

<ul><li>JavaScript keeps an execution queue for delayed computations.
</li><li>Use promises to manage delayed computation instead of raw callbacks.
</li><li>Use a callback with two arguments to handle successful completion (resolve) and unsuccessful completion (reject) of a promise.
</li><li>Use <code class="highlighter-rouge">then</code> to express the next step after successful completion and <code class="highlighter-rouge">catch</code> to handle errors.
</li><li>Use <code class="highlighter-rouge">Promise.all</code> to wait for all promises in a list to complete and <code class="highlighter-rouge">Promise.race</code> to wait for the first promise in a set to complete.
</li><li>Use <code class="highlighter-rouge">await</code> to wait for the result of a computation.
</li><li>Mark functions that can be waited on with <code class="highlighter-rouge">async</code>.
</li></ul>
<h2><a href="#s:interactive">Interactive Sites</a></h2>

<ul><li>Define event handlers to specify what actions the browser should take when the user interacts with an application.
</li><li>The browser passes event objects containing details of events to event handlers.
</li><li>Use classes to keep state and event handlers together.
</li><li>React calls a class’s <code class="highlighter-rouge">render</code> to display it.
</li><li>Separate models (which store data) from views (which display it).
</li><li>Use <code class="highlighter-rouge">fetch</code> to get data from servers.
</li><li>Use destructuring to get individual members from an object in a single step.
</li><li>Modern JavaScript uses promises to manage asynchronous activities.
</li></ul>
<h2><a href="#s:dataman">Managing Data</a></h2>

<ul><li>Small tabular datasets are commonly stored as Comma-Separated Values (CSV).
</li><li>CSV can only represent regular data, and CSV files usually don’t include units.
</li><li>Nested data is commonly stored using JavaScript Object Notation (JSON).
</li><li>JSON representations of tabular data often include redundant (and therefore possibly inconsistent) specifications of column names.
</li><li>PapaParse is a robust CSV parsing library that produces JSON output.
</li></ul>
<h2><a href="#s:server">Creating a Server</a></h2>

<ul><li>An HTTP request or response consists of a plain-text header and an optional body.
</li><li>HTTP is a stateless protocol.
</li><li>Express provides a simple path-based JavaScript server.
</li><li>Write callback functions to handle requests matching specified paths.
</li><li>Provide a default handler for unrecognized requests.
</li><li>Use <code class="highlighter-rouge">Content-Type</code> to specify the type of data being returned.
</li><li>Use dynamic loading to support plugin extensions.
</li></ul>
<h2><a href="#s:testing">Testing</a></h2>

<ul><li>A unit test checks the behavior of one software component in isolation.
</li><li>The result of a unit test can be pass, fail, or error.
</li><li>Use Mocha to write and run unit tests in JavaScript.
</li><li>Put assertions in unit tests to check results.
</li><li>Combine tests in suites for easier management.
</li><li>Divide modules into interactive and non-interactive parts for easier testing.
</li><li>Use <code class="highlighter-rouge">supertest</code> to simulate interaction with a server for testing.
</li><li>HTML is represented in memory using the Document Object Model (DOM).
</li><li>Check the structure of the DOM rather than the textual representation of the HTML when testing.
</li></ul>
<h2><a href="#s:capstone">Capstone Project</a></h2>

<ul><li>Use slices of actual data to test applications.
</li><li>Test summaries and small cases so that results can be checked by hand.
</li><li>Store state in a class, use pure functions to display it.
</li></ul>
<h2><a href="#s:finale">Conclusion</a></h2>

<ul><li>We have learned a lot.
</li><li>Contributions are very welcome.
</li></ul>


      



    </div>
<div class="chapter">
      <h1 id="s:legacy">Legacy JavaScript Issues</h1>
      



      
      <p>JavaScript is now twenty-five years old,
and like many twenty-somethings,
it is still struggling with issues from its childhood.
This appendix explores three of them.</p>

<h2 id="s:legacy-equality">Equality</h2>

<p>Gary Bernhardt’s <a href="https://www.destroyallsoftware.com/talks/wat">lightning talk from 2012</a>
may be the most-watched presentation on JavaScript ever.
In it,
he rattles through some truths about the language that may surprise you:</p>

<table>
  <thead>
    <tr>
      <th>Operation</th>
      <th>Code</th>
      <th>Result</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>empty array plus empty array</td>
      <td><code class="highlighter-rouge">[] + []</code></td>
      <td><code class="highlighter-rouge">""</code> (empty string)</td>
    </tr>
    <tr>
      <td>empty array plus empty object</td>
      <td><code class="highlighter-rouge">[] + {}</code></td>
      <td><code class="highlighter-rouge">{}</code> (empty object)</td>
    </tr>
    <tr>
      <td>empty object plus empty array</td>
      <td><code class="highlighter-rouge">{} + []</code></td>
      <td><code class="highlighter-rouge">0</code> (number zero)</td>
    </tr>
    <tr>
      <td>empty object plus empty object</td>
      <td><code class="highlighter-rouge">{} + {}</code></td>
      <td><code class="highlighter-rouge">NaN</code> (not a number)</td>
    </tr>
  </tbody>
</table>

<p>In order to understand this, we need to know several things
(which are laid out in more detail in <a href="https://medium.com/dailyjs/the-why-behind-the-wat-an-explanation-of-javascripts-weird-type-system-83b92879a8db">this article</a> by Abhinav Suri):</p>

<ol>
  <li>Arrays are objects whose keys happen to be sequential integers.</li>
  <li>When JavaScript tries to add things that aren’t numbers,
it tries to convert them to numbers,
and if that doesn’t work,
to strings (because it can always concatenate strings).</li>
  <li>To convert an array to a string,
JavaScript converts the elements to strings and concatenates them.
If the array is empty, the result is an empty string.</li>
  <li>When converting an object to a string,
JavaScript produces <code class="highlighter-rouge">[object CLASS]</code>,
where <code class="highlighter-rouge">CLASS</code> is the name of the object’s class.</li>
  <li><code class="highlighter-rouge">{}</code> can be interpreted as either an empty object <em>or</em> an empty block of code.</li>
</ol>

<p>So:</p>

<ul>
  <li>Empty array plus empty array becomes empty string plus empty string.</li>
  <li>Empty array plus empty object becomes empty string plus <code class="highlighter-rouge">[object Object]</code>
(because the class of an empty object is just <code class="highlighter-rouge">Object</code>).</li>
  <li><code class="highlighter-rouge">{} + []</code> is “an empty block of code producing nothing, followed by <code class="highlighter-rouge">+[]</code>”,
which becomes “+ of the numeric value of the string value of an empty array”,
which becomes “+ of 0”.</li>
  <li>Empty object plus empty object is interpreted as an empty object plus an empty block of code,
and since an empty block of code doesn’t produce a result,
its “value” is <code class="highlighter-rouge">NaN</code> (not a number).</li>
</ul>

<p>This is one of many cases in programming (and real life) where
doing something that’s convenient in a simple case
produces confusion in less common cases.
Every language except Canadian English has warts like these.</p>

<h2 id="s:legacy-iteration">Iteration</h2>

<p>We wrote above that arrays are objects.
This led to some undesirable behavior with JavaScript’s original <code class="highlighter-rouge">for</code> loop,
which used the word <code class="highlighter-rouge">in</code> rather than <code class="highlighter-rouge">of</code>,
and which looped over all of an object’s enumerable keys:</p>

<div title="src/legacy/for-loops.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">things</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'x'</span><span class="p">,</span> <span class="s1">'y'</span><span class="p">,</span> <span class="s1">'z'</span><span class="p">]</span>
<span class="nx">things</span><span class="p">.</span><span class="nx">someProperty</span> <span class="o">=</span> <span class="s1">'someValue'</span>

<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">things</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0
1
2
someProperty
</code></pre></div></div>

<p>That phrase “enumerable keys” conceals some strangeness of its own,
but in brief,
a <code class="highlighter-rouge">for-in</code> loop will loop over keys inherited from the object’s parents
as well as those defined in the object itself.
Since this is usually not what programmers want (especially for arrays),
older code often used a C-style loop:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">things</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0
1
2
</code></pre></div></div>

<p>Today’s solution is to use <code class="highlighter-rouge">for-of</code> to get the <em>values</em> from an array,
which is usually what we want:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">things</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>x
y
z
</code></pre></div></div>

<p>Better yet, use <code class="highlighter-rouge">forEach</code> and take advantage of its optional second and third arguments:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">things</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">val</span><span class="p">,</span> <span class="nx">loc</span><span class="p">,</span> <span class="nx">array</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`element </span><span class="p">${</span><span class="nx">loc</span><span class="p">}</span><span class="s2"> of </span><span class="p">${</span><span class="nx">array</span><span class="p">}</span><span class="s2"> is </span><span class="p">${</span><span class="nx">val</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>element 0 of x,y,z is x
element 1 of x,y,z is y
element 2 of x,y,z is z
</code></pre></div></div>

<h2 id="s:legacy-prototypes">Prototypes</h2>

<p>We come finally to an aspect of JavaScript that has been the cause of a great deal of confusion: prototypes.
Every JavaScript object has an internal property called its <a href="#g:prototype">prototype</a>.
If you try to access some property of an object and it’s not found,
JavaScript automatically looks in the object that the first object’s prototype refers to.
If the desired property isn’t there,
JavaScript looks in the prototype object’s prototype, and so on.</p>

<p>So where do prototypes come from?
If an object is created with <code class="highlighter-rouge">new Something()</code>,
and the function <code class="highlighter-rouge">Something</code> has a property called <code class="highlighter-rouge">prototype</code>,
then the new object’s prototype is set to the object to which that
<code class="highlighter-rouge">prototype</code> property points.</p>

<p>This will all make sense with an example and a diagram.
Let’s create an object to store the default properties of ice cream cones,
then create a function <code class="highlighter-rouge">Cone</code> that creates an actual cone:</p>

<div title="src/legacy/prototypes.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">iceCream</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">size</span><span class="p">:</span> <span class="s1">'large'</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">Cone</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">flavor</span> <span class="o">=</span> <span class="nx">f</span>
<span class="p">}</span>

<span class="nx">Cone</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">iceCream</span>
</code></pre></div></div>

<p>We can now create a cone and look at its properties:</p>

<div title="src/legacy/prototypes.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">dessert</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Cone</span><span class="p">(</span><span class="s1">'mustard'</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`initial flavor "</span><span class="p">${</span><span class="nx">dessert</span><span class="p">.</span><span class="nx">flavor</span><span class="p">}</span><span class="s2">" and size "</span><span class="p">${</span><span class="nx">dessert</span><span class="p">.</span><span class="nx">size</span><span class="p">}</span><span class="s2">"`</span><span class="p">)</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>initial flavor "mustard" and size "large"
</code></pre></div></div>

<figure id="f:legacy-prototype"> <img src="../../files/legacy-prototype.svg"> <figcaption>Prototypes</figcaption> </figure>

<p>If we change the <code class="highlighter-rouge">size</code> of our dessert,
lookup finds the object’s property before looking up the chain to find the parent object’s:</p>

<div title="src/legacy/prototypes.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">dessert</span><span class="p">.</span><span class="nx">size</span> <span class="o">=</span> <span class="s1">'extra-large'</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`modified flavor "</span><span class="p">${</span><span class="nx">dessert</span><span class="p">.</span><span class="nx">flavor</span><span class="p">}</span><span class="s2">" and size "</span><span class="p">${</span><span class="nx">dessert</span><span class="p">.</span><span class="nx">size</span><span class="p">}</span><span class="s2">"`</span><span class="p">)</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>modified flavor "mustard" and size "extra-large"
</code></pre></div></div>

<p>Prototypes are a way to implement inheritance for object-oriented programming;
the problem is that the mechanics are rather clumsy,
and very different from what most programmers are used to,
so people built a variety of layers on top of prototypes.
To make things even more confusing,
<code class="highlighter-rouge">this</code> can behave in some rather odd ways,
and again,
people built layers to try to insulate themselves from those oddities.
Prototypes still have their fans,
but most people find modern JavaScript’s classes easier to use.</p>


      



    </div>
<div class="chapter">
      <h1 id="s:regexp">Regular Expressions</h1>
      



      
      <p>A <a href="#g:regular-expression">regular expression</a> is
a pattern for matching text which is itself written as text.
Alphanumeric characters match themselves,
so the regexp <code class="highlighter-rouge">/abc/</code> matches the strings <code class="highlighter-rouge">"abc"</code> and <code class="highlighter-rouge">"some abc here"</code>,
but not the string <code class="highlighter-rouge">"no a-b-c here"</code>.
Most punctuation characters have special meaning:
the character <code class="highlighter-rouge">.</code>, for example, matches any single character,
while <code class="highlighter-rouge">+</code> means “one or more”,
so <code class="highlighter-rouge">/a.+c/</code> matches an ‘a’ followed by one or more characters followed by a ‘c’.
Regular expressions are widely used in JavaScript,
but are outside the scope of this tutorial.</p>

      



    </div>
<div class="chapter">
      <h1 id="s:logging">Logging</h1>
      



      
      <p>The <code class="highlighter-rouge">console.log</code> function we have been using
is a simple form of <a href="#g:logging">logging</a>.
We can use a library called <a href="https://github.com/winstonjs/winston">Winston</a> to get more control and structure.
By control,
we mean that we can define levels for messages and a threshold for the logger,
and only log things that are at least that important.
This is much better than commenting and uncommenting messages,
both because it involves less typing
and because we can leave the logging code in place when we put our application into production
to debug the problems that inevitably arise after we thought we were done.
The standard error levels provided by Winston (and similar logging libraries)
are <code class="highlighter-rouge">'error'</code>, <code class="highlighter-rouge">'warn'</code>, <code class="highlighter-rouge">'info'</code>, <code class="highlighter-rouge">'verbose'</code>, and <code class="highlighter-rouge">'debug'</code>,
so if we set the threshold to <code class="highlighter-rouge">'info'</code>,
then <code class="highlighter-rouge">'verbose'</code> and <code class="highlighter-rouge">'debug'</code> messages won’t be displayed.</p>

<p>As for structure,
Winston produces log messages as JSON objects by default
so that other programs can easily read them.
We can also configure it to produce CSV,
or even define some custom format,
though doing that will make everyone’s life more difficult.</p>

<p>Whatever format we choose,
we have to create and add a <a href="#g:logging-transport">transport</a> to tell Winston where messages should go.
We will use one called <code class="highlighter-rouge">Console</code> that sends messages to the screen;
we can also send messages to files, to remote logging servers, and so on.
Note that we do <em>not</em> create a variable called <code class="highlighter-rouge">console</code> for the transport,
because that will overwrite the <code class="highlighter-rouge">console</code> we have been using up until now,
and yes, that took a couple of minutes to figure out…</p>

<div title="src/logging/logging-server.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'path'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'fs'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">winston</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'winston'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">PORT</span> <span class="o">=</span> <span class="mi">3418</span>
<span class="kd">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="kd">const</span> <span class="nx">level</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

<span class="kd">const</span> <span class="nx">transport</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">winston</span><span class="p">.</span><span class="nx">transports</span><span class="p">.</span><span class="nx">Console</span><span class="p">()</span>
<span class="nx">winston</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">transport</span><span class="p">)</span>
<span class="nx">winston</span><span class="p">.</span><span class="nx">level</span> <span class="o">=</span> <span class="nx">level</span>

<span class="c1">// Main server object.</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">()</span>

<span class="c1">// Handle all requests.</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">actual</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span>
  <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">actual</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">stats</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">winston</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">`Unable to find "</span><span class="p">${</span><span class="nx">actual</span><span class="p">}</span><span class="s2">"`</span><span class="p">)</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="s2">`&lt;html&gt;&lt;body&gt;&lt;p&gt;cannot read </span><span class="p">${</span><span class="nx">actual</span><span class="p">}</span><span class="s2">&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;`</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">stats</span><span class="p">.</span><span class="nx">isFile</span><span class="p">())</span> <span class="p">{</span>
      <span class="nx">winston</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">`"</span><span class="p">${</span><span class="nx">actual</span><span class="p">}</span><span class="s2">" is not a file`</span><span class="p">)</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="s2">`&lt;html&gt;&lt;body&gt;&lt;p&gt;cannot read </span><span class="p">${</span><span class="nx">actual</span><span class="p">}</span><span class="s2">&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;`</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">winston</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">`Serving "</span><span class="p">${</span><span class="nx">actual</span><span class="p">}</span><span class="s2">"`</span><span class="p">)</span>
      <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">actual</span><span class="p">,</span> <span class="s1">'utf-8'</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
      <span class="p">})</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">PORT</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">winston</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">`Running on port </span><span class="p">${</span><span class="nx">PORT</span><span class="p">}</span><span class="s2"> with root </span><span class="p">${</span><span class="nx">root</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>In the script above,
we set the logging level with an extra command-line parameter.
If we run the script with the <code class="highlighter-rouge">'debug'</code> level, all messages appear.
If we run it with the <code class="highlighter-rouge">'info'</code> level,
the startup message and the 404 error messages appear,
and if we run it with the level <code class="highlighter-rouge">'error'</code> only the latter appear.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>node src/logging/logging-server.js src/logging/web-dir/ info
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{"message":"Running on port 3418 with root src/logging/web-dir/","level":"info"}
{"message":"Unable to find \"src/logging/web-dir/missing.html\"","level":"error"}
</code></pre></div></div>


      



    </div>
<div class="chapter">
      <h1 id="s:db">Using a Database</h1>
      



      
      <p>Our <a href="#s:dataman">data manager</a> got information from a single CSV file.
That’s fine for testing purposes,
but real applications almost always use a database of some kind.
There are many options these days for what kind,
but <a href="#g:relational-database">relational databases</a> continue to be
the workhorses of the web.</p>

<p>Relational databases are manipulated using a language called <a href="#g:sql">SQL</a>,
which originally stood for “Structured Query Language”
and is pronounced “sequel” or “ess cue ell” depending on whether the speaker is
left or right handed.
(Alternatives are collectively known as <a href="#g:nosql-database">NoSQL databases</a>,
and use many different storage models.)
We will use a SQL database because it’s still the most common choice,
but we won’t try to introduce SQL itself:
for that,
see <a href="https://swcarpentry.github.io/sql-novice-survey/">this short tutorial</a>.</p>

<p>As an example problem,
we will store information about workshops.
Our database begins with a single <a href="#g:table">table</a>
with three <a href="#g:field">fields</a>
and two <a href="#g:record">records</a>:</p>

<div title="src/db/fixture.sql" class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">drop</span> <span class="k">table</span> <span class="n">if</span> <span class="k">exists</span> <span class="n">Workshop</span><span class="p">;</span>

<span class="k">create</span> <span class="k">table</span> <span class="n">Workshop</span><span class="p">(</span>
  <span class="n">ident</span>         <span class="n">integer</span> <span class="k">unique</span> <span class="k">not</span> <span class="k">null</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
  <span class="n">name</span>          <span class="n">text</span> <span class="k">unique</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
  <span class="n">duration</span>      <span class="n">integer</span> <span class="k">not</span> <span class="k">null</span> <span class="c1">-- duration in minutes</span>
<span class="p">);</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">Workshop</span> <span class="k">values</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">"Building Community"</span><span class="p">,</span> <span class="mi">60</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">Workshop</span> <span class="k">values</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nv">"ENIAC Programming"</span><span class="p">,</span> <span class="mi">150</span><span class="p">);</span>
</code></pre></div></div>

<p>In the rest of this tutorial,
we will build a class to handle our interactions with a SQLite database,
test it,
and then put a web service on top of it.</p>

<h2 id="s:db-start">Starting Point</h2>

<p>Our class, imaginatively named <code class="highlighter-rouge">Database</code>,
takes the path to the SQLite database file as a constructor parameter
and creates a <a href="#g:connection-manager">connection manager</a>
through which we can send queries and get results.
We will create one method for each query we want to run,
and one helper method to display query results.
We will give all of the query methods the same <a href="#g:signature">signature</a>
so that can be handled interchangeably.
The whole thing looks like this:</p>

<div title="src/db/database-initial.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">sqlite3</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'sqlite3'</span><span class="p">)</span>

<span class="kd">class</span> <span class="nx">Database</span> <span class="p">{</span>

  <span class="kd">constructor</span> <span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">sqlite3</span><span class="p">.</span><span class="nx">Database</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">sqlite3</span><span class="p">.</span><span class="nx">OPEN_READWRITE</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s2">`Database open error </span><span class="p">${</span><span class="nx">err</span><span class="p">}</span><span class="s2"> for "</span><span class="p">${</span><span class="nx">path</span><span class="p">}</span><span class="s2">"`</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">}</span>

  <span class="nx">getAll</span> <span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">Q_WORKSHOP_GET_ALL</span><span class="p">,</span> <span class="p">[],</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rows</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">display</span><span class="p">(</span><span class="nx">rows</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">}</span>

  <span class="nx">getOne</span> <span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">Q_WORKSHOP_GET_ONE</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rows</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">display</span><span class="p">(</span><span class="nx">rows</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">}</span>

  <span class="nx">display</span> <span class="p">(</span><span class="nx">rows</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">r</span> <span class="k">of</span> <span class="nx">rows</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">fail</span> <span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This makes a lot more sense once we see what the queries look like:</p>

<div title="src/db/database-initial.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">Q_WORKSHOP_GET_ALL</span> <span class="o">=</span> <span class="s2">`
select
  Workshop.ident        as workshopId,
  Workshop.name         as workshopName,
  Workshop.duration     as workshopDuration
from
  Workshop
`</span>

<span class="kd">const</span> <span class="nx">Q_WORKSHOP_GET_ONE</span> <span class="o">=</span> <span class="s2">`
select
  Workshop.ident        as workshopId,
  Workshop.name         as workshopName,
  Workshop.duration     as workshopDuration
from
  Workshop
where
  Workshop.ident = ?
`</span>
</code></pre></div></div>

<p>It’s easy to overlook,
but the query to get details of one workshop has a question mark <code class="highlighter-rouge">?</code> as the value of <code class="highlighter-rouge">Workshop.ident</code>.
This means that the query expects us to provide a parameter when we call it
that will be substituted in for the question mark
to specify which workshop we’re interested in.
This is why the arguments passed to <code class="highlighter-rouge">getOne</code> as <code class="highlighter-rouge">args</code>
are then passed through to <code class="highlighter-rouge">db.all</code>;
it’s also why <code class="highlighter-rouge">getAll</code> takes an <code class="highlighter-rouge">args</code> parameter,
but ignores it and always passed <code class="highlighter-rouge">[]</code> (no extra values) to <code class="highlighter-rouge">db.all</code> when running the query.</p>

<p>All right:
what does the <a href="#g:driver">driver</a> look like?</p>

<div title="src/db/database-initial.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">main</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
  <span class="kd">const</span> <span class="nx">action</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
  <span class="kd">const</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
  <span class="kd">const</span> <span class="nx">database</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Database</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
  <span class="nx">database</span><span class="p">[</span><span class="nx">action</span><span class="p">](</span><span class="nx">args</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">main</span><span class="p">()</span>
</code></pre></div></div>

<p>This is simple enough:
it gets the path to the database file,
the desired action,
and any extra arguments from <code class="highlighter-rouge">process.argv</code>,
then creates an instance of the <code class="highlighter-rouge">Database</code> class and—um.
And then it calls <code class="highlighter-rouge">database[action](args)</code>,
which takes a moment to figure out.
What’s going on here is that an instance of a class is just a special kind of object,
and we can always look up an object’s fields by name using <code class="highlighter-rouge">object[name]</code>,
so if the string <code class="highlighter-rouge">action</code> (taken from the command-line argument) is <code class="highlighter-rouge">getAll</code> or <code class="highlighter-rouge">getOne</code>,
then <code class="highlighter-rouge">database[action](args)</code> is either <code class="highlighter-rouge">database.getAll(args)</code> or database.getOne(args)<code class="highlighter-rouge">.
This is lever,
but if we ask for an action like </code>show<code class="highlighter-rouge"> or </code>help<code class="highlighter-rouge"> or </code>GetOne<code class="highlighter-rouge"> (with an upper-case 'G'),
then </code>database[action]` doesn’t exist and we get a very confusing error message.
We really should try to do better…</p>

<p>But before then,
let’s try running this:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>node database-initial.js fixture.db getAll
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{ workshopId: 1,
  workshopName: 'Building Community',
  workshopDuration: 60 }
{ workshopId: 2,
  workshopName: 'ENIAC Programming',
  workshopDuration: 150 }
</code></pre></div></div>

<p>That seems to have worked:
<code class="highlighter-rouge">getAll</code> was called,
and the result is an array of objects,
one per record,
whose names are the derived in an obvious way from the names of the columns.</p>

<h2 id="s:db-in-memory">In-Memory Database</h2>

<p>The previous example always manipulates database on disk.
For testing purposes,
it’s faster and safer to use an <a href="#g:in-memory-database">in-memory database</a>.
Let’s modify the constructor of <code class="highlighter-rouge">Database</code> to set this up:</p>

<div title="src/db/database-mode.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">constructor</span> <span class="p">(</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="nx">path</span>
    <span class="k">switch</span> <span class="p">(</span><span class="nx">mode</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="s1">'memory'</span> <span class="p">:</span>
      <span class="kd">const</span> <span class="nx">setup</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="s1">'utf-8'</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">sqlite3</span><span class="p">.</span><span class="nx">Database</span><span class="p">(</span><span class="s1">':memory:'</span><span class="p">,</span> <span class="nx">sqlite3</span><span class="p">.</span><span class="nx">OPEN_READWRITE</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s2">`IN-MEMORY DATABASE OPEN ERROR "</span><span class="p">${</span><span class="nx">err</span><span class="p">}</span><span class="s2">"`</span><span class="p">)</span>
      <span class="p">})</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">setup</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s2">`UNABLE TO INITIALIZE IN-MEMORY DATABASE FROM "</span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">}</span><span class="s2">"`</span><span class="p">)</span>
      <span class="p">})</span>
      <span class="k">break</span>

    <span class="k">case</span> <span class="s1">'file'</span> <span class="p">:</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">sqlite3</span><span class="p">.</span><span class="nx">Database</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="nx">sqlite3</span><span class="p">.</span><span class="nx">OPEN_READWRITE</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s2">`DATABASE OPEN ERROR </span><span class="p">${</span><span class="nx">err</span><span class="p">}</span><span class="s2"> for "</span><span class="p">${</span><span class="nx">path</span><span class="p">}</span><span class="s2">"`</span><span class="p">)</span>
      <span class="p">})</span>
      <span class="k">break</span>

    <span class="k">default</span> <span class="p">:</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s2">`UNKNOWN MODE "</span><span class="p">${</span><span class="nx">mode</span><span class="p">}</span><span class="s2">"`</span><span class="p">)</span>
      <span class="k">break</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>If the <code class="highlighter-rouge">mode</code> parameter is the string <code class="highlighter-rouge">"memory"</code>,
we create an in-memory database and initialize it by executing
a file full of setup commands specified by the user—in our case,
exactly the commands we showed at the start of the lesson.
If the <code class="highlighter-rouge">mode</code> is <code class="highlighter-rouge">"file"</code>,
we interpret the file argument as the name of an on-disk database
and proceed as before.</p>

<p>We put our error messages in ALL CAPS because that’s the most annoying option easily available to us.
Less annoyingly,
we can use destructuring to handle command-line arguments in the driver:</p>

<div title="src/db/database-mode.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">main</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">...</span><span class="nx">args</span><span class="p">]</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
  <span class="kd">const</span> <span class="nx">database</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Database</span><span class="p">(</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span>
  <span class="nx">database</span><span class="p">[</span><span class="nx">action</span><span class="p">](</span><span class="nx">args</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here, the expression <code class="highlighter-rouge">...args</code> means
“take anything left over after the fixed names have been matched and put it in an array called <code class="highlighter-rouge">args</code>”.
With these changes in place,
we can run a query to get details of the second workshop like this:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>node database-mode.js memory fixture.sql getOne 2
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{ workshopId: 2,
  workshopName: 'ENIAC Programming',
  workshopDuration: 150 }
</code></pre></div></div>

<p>After a bit of experimentation,
we decide to take this even further to make testing easier.
We will allow the driver to read the SQL script itself and pass that into <code class="highlighter-rouge">Database</code>
so that we can do the file I/O once and then repeatedly build a database in memory for testing.
That way,
each of our tests will start with the database in a known, predictable state,
regardless of what other tests may have run before
and what changes they might have made to the database.
Here are the changes to the constructor:</p>

<div title="src/db/database-mixed.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">constructor</span> <span class="p">(</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">arg</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="nx">mode</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="s1">'direct'</span> <span class="p">:</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_inMemory</span><span class="p">(</span><span class="nx">arg</span><span class="p">)</span>
        <span class="k">break</span>

      <span class="k">case</span> <span class="s1">'memory'</span> <span class="p">:</span>
        <span class="kd">const</span> <span class="nx">setup</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">arg</span><span class="p">,</span> <span class="s1">'utf-8'</span><span class="p">)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_inMemory</span><span class="p">(</span><span class="nx">setup</span><span class="p">)</span>
        <span class="k">break</span>

      <span class="k">case</span> <span class="s1">'file'</span> <span class="p">:</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_inFile</span><span class="p">(</span><span class="nx">arg</span><span class="p">)</span>
        <span class="k">break</span>

      <span class="k">default</span> <span class="p">:</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s2">`Unknown mode "</span><span class="p">${</span><span class="nx">mode</span><span class="p">}</span><span class="s2">"`</span><span class="p">)</span>
        <span class="k">break</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>And here are the supporting methods:</p>

<div title="src/db/database-mixed.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nx">_inMemory</span> <span class="p">(</span><span class="nx">script</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">sqlite3</span><span class="p">.</span><span class="nx">Database</span><span class="p">(</span><span class="s1">':memory:'</span><span class="p">,</span> <span class="nx">sqlite3</span><span class="p">.</span><span class="nx">OPEN_READWRITE</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s2">`In-memory database open error "</span><span class="p">${</span><span class="nx">err</span><span class="p">}</span><span class="s2">"`</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">script</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s2">`Unable to initialize in-memory database from "</span><span class="p">${</span><span class="nx">script</span><span class="p">}</span><span class="s2">"`</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">}</span>

  <span class="nx">_inFile</span> <span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">sqlite3</span><span class="p">.</span><span class="nx">Database</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">sqlite3</span><span class="p">.</span><span class="nx">OPEN_READWRITE</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s2">`Database open error "</span><span class="p">${</span><span class="nx">err</span><span class="p">}</span><span class="s2">" for "</span><span class="p">${</span><span class="nx">path</span><span class="p">}</span><span class="s2">"`</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>We also need to change the driver
(and check, finally, that the requested action is actually supported):</p>

<div title="src/db/database-mixed.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">main</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="p">[</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">setup</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">...</span><span class="nx">args</span><span class="p">]</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">mode</span> <span class="o">===</span> <span class="s1">'direct'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">setup</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">setup</span><span class="p">,</span> <span class="s1">'utf-8'</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="kd">const</span> <span class="nx">database</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Database</span><span class="p">(</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">setup</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">action</span> <span class="k">in</span> <span class="nx">database</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">database</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s2">`No such operation "</span><span class="p">${</span><span class="nx">action</span><span class="p">}</span><span class="s2">"`</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="nx">database</span><span class="p">[</span><span class="nx">action</span><span class="p">](</span><span class="nx">args</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="s:db-testable">Making It Testable</h2>

<p>We put the database class and its driver in separate files
so that applications can load just the former.
We will now change the database query methods to return results for display
rather than displaying them directly,
since we will eventually want to compare them or return them to a server rather than printing them:</p>

<div title="src/db/separate-database.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">Database</span> <span class="p">{</span>

  <span class="c1">// ...as before...</span>

  <span class="nx">getAll</span> <span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">Q_WORKSHOP_GET_ALL</span><span class="p">,</span> <span class="p">[],</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rows</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">rows</span>
    <span class="p">})</span>
  <span class="p">}</span>

  <span class="c1">// ...as before...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The driver then looks like this:</p>

<div title="src/db/separate-driver.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">Database</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./separate-database'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">display</span> <span class="o">=</span> <span class="p">(</span><span class="nx">rows</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">r</span> <span class="k">of</span> <span class="nx">rows</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">main</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="p">[</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">...</span><span class="nx">args</span><span class="p">]</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
  <span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Database</span><span class="p">(</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">action</span> <span class="k">in</span> <span class="nx">db</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s2">`No such operation "</span><span class="p">${</span><span class="nx">action</span><span class="p">}</span><span class="s2">"`</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">db</span><span class="p">[</span><span class="nx">action</span><span class="p">](</span><span class="nx">args</span><span class="p">)</span>
  <span class="nx">display</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">main</span><span class="p">()</span>
</code></pre></div></div>

<p>Let’s try running it:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>node separate-driver.js file fixture.db getAll
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  for (let r of rows) {
              ^

TypeError: Cannot read property 'Symbol(Symbol.iterator)' of undefined
    at display (/project/src/db/separate-driver.js:4:15)
    at main (/project/src/db/separate-driver.js:16:3)
</code></pre></div></div>

<p>Whoops: the <code class="highlighter-rouge">run</code> method of the database delivers results to a callback;
its own result is therefore <code class="highlighter-rouge">undefined</code>,
so there’s nothing in the caller to print.</p>

<p>The solution is to give the <code class="highlighter-rouge">get</code> methods a callback of their own:</p>

<div title="src/db/callback-database.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">Database</span> <span class="p">{</span>

  <span class="c1">// ...as before...</span>

  <span class="nx">getAll</span> <span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">Q_WORKSHOP_GET_ALL</span><span class="p">,</span> <span class="p">[],</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rows</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
      <span class="nx">callback</span><span class="p">(</span><span class="nx">rows</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">}</span>

  <span class="c1">// ...as before...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We then change the driver to pass <code class="highlighter-rouge">display</code> to the database method it’s calling:</p>

<div title="src/db/callback-driver.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">Database</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./callback-database'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">display</span> <span class="o">=</span> <span class="p">(</span><span class="nx">rows</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">r</span> <span class="k">of</span> <span class="nx">rows</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">main</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="p">[</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">...</span><span class="nx">args</span><span class="p">]</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
  <span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Database</span><span class="p">(</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">action</span> <span class="k">in</span> <span class="nx">db</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s2">`No such operation "</span><span class="p">${</span><span class="nx">action</span><span class="p">}</span><span class="s2">"`</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="nx">db</span><span class="p">[</span><span class="nx">action</span><span class="p">](</span><span class="nx">display</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">main</span><span class="p">()</span>
</code></pre></div></div>

<p>This looks strange the first few (dozen) times,
but it’s the way JavaScript works:
instead of asking for something and then operating on it,
we say,
“Here’s what we want to do once results are available.”</p>

<h2 id="s:db-testing">Testing</h2>

<p>We can finally write some tests:</p>

<div title="src/db/basic-tests.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">assert</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'assert'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">Database</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./callback-database'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">FIXTURE</span> <span class="o">=</span> <span class="s2">`
drop table if exists Workshop;

create table Workshop(
  ident           integer unique not null primary key,
  name            text unique not null,
  duration        integer not null -- duration in minutes
);

insert into Workshop values(1, "Building Community", 60);
insert into Workshop values(2, "ENIAC Programming", 150);
`</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">'database'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>

  <span class="nx">it</span><span class="p">(</span><span class="s1">'should return all workshops'</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">expected</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">{</span> <span class="na">workshopName</span><span class="p">:</span> <span class="s1">'Building Community'</span><span class="p">,</span> <span class="na">workshopDuration</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span> <span class="na">workshopId</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">workshopName</span><span class="p">:</span> <span class="s1">'ENIAC Programming'</span><span class="p">,</span> <span class="na">workshopDuration</span><span class="p">:</span> <span class="mi">150</span><span class="p">,</span> <span class="na">workshopId</span><span class="p">:</span> <span class="mi">2</span> <span class="p">}</span>
    <span class="p">]</span>
    <span class="k">new</span> <span class="nx">Database</span><span class="p">(</span><span class="s1">'direct'</span><span class="p">,</span> <span class="nx">FIXTURE</span><span class="p">).</span><span class="nx">getAll</span><span class="p">([],</span> <span class="p">(</span><span class="nx">results</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span><span class="nx">results</span><span class="p">,</span> <span class="nx">expected</span><span class="p">,</span> <span class="s1">'Got expected workshops'</span><span class="p">)</span>
      <span class="nx">done</span><span class="p">()</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">it</span><span class="p">(</span><span class="s1">'should return one workshop'</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">expected</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">{</span> <span class="na">workshopName</span><span class="p">:</span> <span class="s1">'Building Community'</span><span class="p">,</span> <span class="na">workshopDuration</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span> <span class="na">workshopId</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}</span>
    <span class="p">]</span>
    <span class="k">new</span> <span class="nx">Database</span><span class="p">(</span><span class="s1">'direct'</span><span class="p">,</span> <span class="nx">FIXTURE</span><span class="p">).</span><span class="nx">getOne</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nx">results</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span><span class="nx">results</span><span class="p">,</span> <span class="nx">expected</span><span class="p">,</span> <span class="s1">'Got single expected workshop'</span><span class="p">)</span>
      <span class="nx">done</span><span class="p">()</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">it</span><span class="p">(</span><span class="s1">'can only get workshops that exist'</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">new</span> <span class="nx">Database</span><span class="p">(</span><span class="s1">'direct'</span><span class="p">,</span> <span class="nx">FIXTURE</span><span class="p">).</span><span class="nx">getOne</span><span class="p">(</span><span class="mi">99</span><span class="p">,</span> <span class="p">(</span><span class="nx">results</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span><span class="nx">results</span><span class="p">,</span> <span class="p">[],</span> <span class="s1">'Got no workshops matching nonexistent key'</span><span class="p">)</span>
      <span class="nx">done</span><span class="p">()</span>
    <span class="p">})</span>
  <span class="p">})</span>

<span class="p">})</span>
</code></pre></div></div>

<p>Each test has the same structure:
we define the expected result,
create an entirely new database in memory,
and then call the method being tested,
passing it the fixture and the callback that will receives results.
That callback uses <code class="highlighter-rouge">assert</code> to check results
and <code class="highlighter-rouge">done</code> to signal that the test has completed.</p>

<h2 id="s:db-mutate">Updating the Database</h2>

<p>The <a href="#s:dataman">data manager we built earlier</a> only let us read data;
we couldn’t modify it.
Let’s add a bit more to our database class to support <a href="#g:mutation">mutation</a>:</p>

<div title="src/db/mutate-database.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ...imports as before...</span>

<span class="kd">const</span> <span class="nx">Q_WORKSHOP_GET_ALL</span> <span class="o">=</span> <span class="c1">// ...as before...</span>
<span class="kd">const</span> <span class="nx">Q_WORKSHOP_GET_ONE</span> <span class="o">=</span> <span class="c1">// ...as before...</span>

<span class="kd">const</span> <span class="nx">Q_WORKSHOP_ADD</span> <span class="o">=</span> <span class="s2">`
insert into Workshop(name, duration) values(?, ?);
`</span>

<span class="kd">const</span> <span class="nx">Q_WORKSHOP_DELETE</span> <span class="o">=</span> <span class="s2">`
delete from Workshop where ident = ?;
`</span>

<span class="kd">class</span> <span class="nx">Database</span> <span class="p">{</span>

  <span class="kd">constructor</span> <span class="p">(</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">arg</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...as before...</span>
  <span class="p">}</span>
  <span class="nx">getAll</span> <span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...as before...</span>
  <span class="p">}</span>
  <span class="nx">getOne</span> <span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...as before...</span>
  <span class="p">}</span>

  <span class="nx">addOne</span> <span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="nx">Q_WORKSHOP_ADD</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rows</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
      <span class="nx">callback</span><span class="p">([],</span> <span class="k">this</span><span class="p">.</span><span class="nx">lastID</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">}</span>

  <span class="nx">deleteOne</span> <span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="nx">Q_WORKSHOP_DELETE</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rows</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
      <span class="nx">callback</span><span class="p">([],</span> <span class="kc">undefined</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">}</span>

  <span class="nx">fail</span> <span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...as before...</span>
  <span class="p">}</span>
  <span class="nx">_inMemory</span> <span class="p">(</span><span class="nx">script</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...as before...</span>
  <span class="p">}</span>
  <span class="nx">_inFile</span> <span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...as before...</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Database</span>
</code></pre></div></div>

<p>The additions are straightforward:
the query that does the work is passed to <code class="highlighter-rouge">this.db.run</code> along with the incoming arguments
that specify what is to be added or deleted,
and an empty list of rows is passed to the action callback
(since adding and deleting don’t return anything).
Testing involves a little more typing,
since want to check that the database is in the right state after the operation:</p>

<div title="src/db/mutate-test.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ...imports as before...</span>

<span class="kd">const</span> <span class="nx">FIXTURE</span> <span class="o">=</span> <span class="c1">// ...as before...</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">'mutating database'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>

  <span class="nx">it</span><span class="p">(</span><span class="s1">'can add a workshop'</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">duration</span> <span class="o">=</span> <span class="mi">35</span><span class="p">,</span> <span class="nx">name</span> <span class="o">=</span> <span class="s1">'Creating Bugs'</span>
    <span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Database</span><span class="p">(</span><span class="s1">'direct'</span><span class="p">,</span> <span class="nx">FIXTURE</span><span class="p">)</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">addOne</span><span class="p">([</span><span class="nx">name</span><span class="p">,</span> <span class="nx">duration</span><span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">results</span><span class="p">,</span> <span class="nx">lastID</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span><span class="nx">results</span><span class="p">,</span> <span class="p">[],</span> <span class="s1">'Got empty list as result when adding'</span><span class="p">)</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">lastID</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">'Got the correct last ID after adding'</span><span class="p">)</span>
      <span class="nx">db</span><span class="p">.</span><span class="nx">getAll</span><span class="p">([],</span> <span class="p">(</span><span class="nx">results</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">expected</span> <span class="o">=</span> <span class="p">[</span>
          <span class="p">{</span> <span class="na">workshopName</span><span class="p">:</span> <span class="s1">'Building Community'</span><span class="p">,</span> <span class="na">workshopDuration</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span> <span class="na">workshopId</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
          <span class="p">{</span> <span class="na">workshopName</span><span class="p">:</span> <span class="s1">'ENIAC Programming'</span><span class="p">,</span> <span class="na">workshopDuration</span><span class="p">:</span> <span class="mi">150</span><span class="p">,</span> <span class="na">workshopId</span><span class="p">:</span> <span class="mi">2</span> <span class="p">},</span>
          <span class="p">{</span> <span class="na">workshopName</span><span class="p">:</span> <span class="nx">name</span><span class="p">,</span> <span class="na">workshopDuration</span><span class="p">:</span> <span class="nx">duration</span><span class="p">,</span> <span class="na">workshopId</span><span class="p">:</span> <span class="mi">3</span> <span class="p">}</span>
        <span class="p">]</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span><span class="nx">results</span><span class="p">,</span> <span class="nx">expected</span><span class="p">,</span> <span class="s1">'Got expected workshops after add'</span><span class="p">)</span>
        <span class="nx">done</span><span class="p">()</span>
      <span class="p">})</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">it</span><span class="p">(</span><span class="s1">'can delete a workshop'</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Database</span><span class="p">(</span><span class="s1">'direct'</span><span class="p">,</span> <span class="nx">FIXTURE</span><span class="p">)</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">deleteOne</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="nx">results</span><span class="p">,</span> <span class="nx">lastID</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">lastID</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="s1">'Expected last ID to be undefined'</span><span class="p">)</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span><span class="nx">results</span><span class="p">,</span> <span class="p">[],</span> <span class="s1">'Got empty list as result when deleting'</span><span class="p">)</span>
      <span class="nx">db</span><span class="p">.</span><span class="nx">getAll</span><span class="p">([],</span> <span class="p">(</span><span class="nx">results</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">expected</span> <span class="o">=</span> <span class="p">[</span>
          <span class="p">{</span> <span class="na">workshopName</span><span class="p">:</span> <span class="s1">'ENIAC Programming'</span><span class="p">,</span> <span class="na">workshopDuration</span><span class="p">:</span> <span class="mi">150</span><span class="p">,</span> <span class="na">workshopId</span><span class="p">:</span> <span class="mi">2</span> <span class="p">}</span>
        <span class="p">]</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span><span class="nx">results</span><span class="p">,</span> <span class="nx">expected</span><span class="p">,</span> <span class="s1">'Got expected workshops after delete'</span><span class="p">)</span>
        <span class="nx">done</span><span class="p">()</span>
      <span class="p">})</span>
    <span class="p">})</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<h2 id="s:db-exercises">Exercises</h2>

<h3 id="copying-records">Copying Records</h3>

<p>Write a program that copies all the rows
from the table <code class="highlighter-rouge">Workshop</code> in a database <code class="highlighter-rouge">source.db</code>
to a table with the same name in a new database <code class="highlighter-rouge">backup.db</code>.</p>

<h3 id="filtering-records">Filtering Records</h3>

<p>Add a new method to the <code class="highlighter-rouge">Database</code> class
to get all workshops that are longer than a specified time:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Database</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">rows</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">getLongerThan</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="nx">assert</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span><span class="nx">rows</span><span class="p">,</span> <span class="p">[</span>
  <span class="p">{</span><span class="na">workshopName</span><span class="p">:</span> <span class="s1">'ENIAC Programming'</span><span class="p">,</span> <span class="na">workshopDuration</span><span class="p">:</span> <span class="mi">150</span><span class="p">,</span> <span class="na">workshopId</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
<span class="p">])</span>
</code></pre></div></div>

<p>Your <code class="highlighter-rouge">Database.getLongerThan</code> method’s SQL query
will need to use a <code class="highlighter-rouge">where</code> clause
that selects specific records.</p>

<h3 id="more-filtering">More Filtering</h3>

<p>The SQL query encapsulated in the variable below can be used to
find all workshop whose duration falls within a range.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">Q_WORKSHOP_DURATION_RANGE</span> <span class="o">=</span> <span class="s2">`
select
  Workshop.ident        as workshopId,
  Workshop.name         as workshopName,
  Workshop.duration     as workshopDuration
from
  Workshop
where
  (Workshop.duration &lt;= ?) and (Workshop.duration &gt;= ?)
`</span>
</code></pre></div></div>

<p>What do the <code class="highlighter-rouge">?</code>s mean in this query?
Write another method for the <code class="highlighter-rouge">Database</code> class called <code class="highlighter-rouge">getWithinLengthRange([args])</code>
that uses this query, taking arguments from the commandline as before.
What happens when you provide the wrong number of arguments to this function? Or
if you provide them in the wrong order?
Can you write a test that provides more useful feedback than this?</p>

<h3 id="handling-errors">Handling Errors</h3>

<p>The <code class="highlighter-rouge">Database</code> class prints a message and exits when it detects an error.
This is bad practice,
and I should be ashamed of having done it.
The right thing to do is to <a href="#g:throw">throw</a>
an <a href="#g:exception">exception</a>
that main program can <a href="#g:catch">catch</a>
and handle however it wants.</p>

<ol>
  <li>Modify the code to do this.</li>
  <li>Modify the tests to check that the right exceptions are thrown when they should be.</li>
</ol>

<h3 id="using-a-database-with-a-server">Using a Database with a Server</h3>

<p>Rewrite the <a href="#s:capstone">capstone project</a> to use a database instead of a file for data storage.</p>


      



    </div>
<div class="chapter">
      <h1 id="s:extensible">Extensible Servers</h1>
      



      
      <p>Suppose we want to extend our <a href="#s:server">server</a> in some way.
We could edit the source file and add some more URL handlers,
or we could have it load JavaScript dynamically and run that.</p>

<div title="src/extensible/dynamic.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">PORT</span> <span class="o">=</span> <span class="mi">3418</span>

<span class="c1">// Main server object.</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">()</span>

<span class="c1">// Handle all requests.</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">'.js'</span><span class="p">))</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">libName</span> <span class="o">=</span> <span class="s1">'./'</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">))</span>
    <span class="kd">const</span> <span class="nx">dynamic</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">libName</span><span class="p">)</span>
    <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">dynamic</span><span class="p">.</span><span class="nx">page</span><span class="p">()</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">else</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="s2">`&lt;html&gt;&lt;body&gt;&lt;p&gt;"</span><span class="p">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">}</span><span class="s2">" not found&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;`</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">PORT</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`listening on port </span><span class="p">${</span><span class="nx">PORT</span><span class="p">}</span><span class="s2">...`</span><span class="p">)</span> <span class="p">})</span>
</code></pre></div></div>

<p>This simple server checks whether the path specified in the URL ends with <code class="highlighter-rouge">.js</code>.
If so,
it constructs something that looks like the name of a library by stripping off the <code class="highlighter-rouge">.js</code>
and prefixing the stem with <code class="highlighter-rouge">./</code>,
then uses <code class="highlighter-rouge">require</code> to load that file.
Assuming the load is successful,
it then calls the <code class="highlighter-rouge">page</code> function defined in that file.
We can create a very simple plugin like this:</p>

<div title="src/extensible/plugin.js" class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">page</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="s1">'&lt;html&gt;&lt;body&gt;&lt;h1&gt;Plugin Content&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;'</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">page</span><span class="p">:</span> <span class="nx">page</span>
<span class="p">}</span>
</code></pre></div></div>

<p>If we run the server:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>node src/extensible/dynamic.js
</code></pre></div></div>

<!-- == \noindent -->
<p>and then go to <code class="highlighter-rouge">http://localhost:4000/plugin.js</code>,
we get back a page containing the title “Plugin Content”.</p>

<p>This is an example of a very powerful technique.
Rather than building everything into one program,
we can provide a <a href="#g:protocol">protocol</a> for plugins
so that people can add new functionality without rewriting what’s already there.
Each plugin must have an <a href="#g:entry-point">entry point</a> like the function <code class="highlighter-rouge">page</code>
so that the framework knows where to start.</p>

      



    </div>